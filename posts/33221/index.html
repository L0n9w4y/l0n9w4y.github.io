<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"l0n9w4y.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文总结MacOS平台下应急响应与入侵取证的基本思路与方法...">
<meta property="og:type" content="article">
<meta property="og:title" content="MacOS响应取证速查">
<meta property="og:url" content="https://l0n9w4y.cc/posts/33221/index.html">
<meta property="og:site_name" content="L0n9w4y">
<meta property="og:description" content="本文总结MacOS平台下应急响应与入侵取证的基本思路与方法...">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-03-09T13:39:32.000Z">
<meta property="article:modified_time" content="2023-01-03T06:08:11.702Z">
<meta property="article:author" content="L0n9w4y">
<meta property="article:tag" content="DFIR">
<meta property="article:tag" content="Incident Response">
<meta property="article:tag" content="MacOS">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://l0n9w4y.cc/posts/33221/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://l0n9w4y.cc/posts/33221/","path":"posts/33221/","title":"MacOS响应取证速查"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MacOS响应取证速查 | L0n9w4y</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L0n9w4y</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-攻防"><a href="/A&D/" rel="section"><i class="fa fa-navicon fa-fw"></i>攻防</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E7%9B%AE%E5%BD%95-x2F-%E6%96%87%E4%BB%B6"><span class="nav-text">0x01 目录&#x2F;文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%85%B3%E9%94%AE%E7%9B%AE%E5%BD%95"><span class="nav-text">1. 关键目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6"><span class="nav-text">2. 系统文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%94%A8%E6%88%B7PROFILE"><span class="nav-text">3. 用户PROFILE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="nav-text">4. 日志文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E9%80%9F%E6%9F%A5%E5%91%BD%E4%BB%A4"><span class="nav-text">0x02 速查命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%94%A8%E6%88%B7%E6%8E%92%E6%9F%A5"><span class="nav-text">1. 用户排查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%AB%AF%E5%8F%A3%E6%8E%92%E6%9F%A5"><span class="nav-text">2. 端口排查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5"><span class="nav-text">3. 网络排查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%BF%9B%E7%A8%8B%E6%8E%92%E6%9F%A5"><span class="nav-text">4. 进程排查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E6%9F%A5%E7%9C%8B"><span class="nav-text">5. 计划任务查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E4%B8%B4%E6%97%B6-x2F-%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95"><span class="nav-text">6. 临时&#x2F;共享目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-shells%E6%96%87%E4%BB%B6"><span class="nav-text">7. shells文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-DB%E6%95%B0%E6%8D%AE%E6%9F%A5%E7%9C%8B"><span class="nav-text">8. DB数据查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-plist%E6%96%87%E4%BB%B6%E6%9F%A5%E7%9C%8B"><span class="nav-text">9. plist文件查看</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="nav-text">0x03 自动化脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-collect-sh"><span class="nav-text">1. collect.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-collect-basics-sh"><span class="nav-text">2. collect_basics.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-yarafly-sh"><span class="nav-text">3. yarafly.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-collect-bash-commands-sh"><span class="nav-text">4. collect_bash_commands.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-collect-aseps-sh"><span class="nav-text">5. collect_aseps.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-collection-filesystem-sh"><span class="nav-text">6. collection_filesystem.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-file-walker-py"><span class="nav-text">7. file_walker.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-storyline-py"><span class="nav-text">8. storyline.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-browser-collect-sh"><span class="nav-text">9. browser_collect.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-browser-parser-py"><span class="nav-text">10. browser_parser.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-memory-collection-sh"><span class="nav-text">11. memory_collection.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-exfiltrator-py"><span class="nav-text">12. exfiltrator.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xFF-Reference"><span class="nav-text">0xFF Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="L0n9w4y"
      src="/images/hexo.png">
  <p class="site-author-name" itemprop="name">L0n9w4y</p>
  <div class="site-description" itemprop="description">問道遠兮，求索未止...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/L0n9w4y" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;L0n9w4y" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/l0n9w4y" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;l0n9w4y" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/_L0n9_" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;_L0n9_" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://l0n9w4y.cc/posts/33221/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hexo.png">
      <meta itemprop="name" content="L0n9w4y">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L0n9w4y">
      <meta itemprop="description" content="問道遠兮，求索未止...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MacOS响应取证速查 | L0n9w4y">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MacOS响应取证速查
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-09 21:39:32" itemprop="dateCreated datePublished" datetime="2022-03-09T21:39:32+08:00">2022-03-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8F%96%E8%AF%81%E5%93%8D%E5%BA%94/" itemprop="url" rel="index"><span itemprop="name">取证响应</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>本文总结MacOS平台下应急响应与入侵取证的基本思路与方法...</center>

<span id="more"></span>

<h2 id="0x01-目录-x2F-文件"><a href="#0x01-目录-x2F-文件" class="headerlink" title="0x01 目录&#x2F;文件"></a>0x01 目录&#x2F;文件</h2><h3 id="1-关键目录"><a href="#1-关键目录" class="headerlink" title="1. 关键目录"></a>1. 关键目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Applications/：应用程序的默认文件夹</span><br><span class="line">Library/：包含 OS X 文件和支持的操作系统项目，用于系统全局功能并适用于所有用户</span><br><span class="line">System/：为 OS X 系统文件保留，包含系统设置和系统功能等项目</span><br><span class="line">Users/：本地用户的主文件夹。还将有一个 &quot;Public&quot; 文件夹，用于在用户之间共享文件</span><br><span class="line">etc 或 private/etc/：配置和其他系统文件</span><br><span class="line">private/sbin/：提供给管理员使用的 Linux-styled的二进制文件</span><br><span class="line">var/ 或 private/var：重要数据文件、日志文件等所在目录</span><br><span class="line">Volumes/：已挂载的设备，例如硬盘、CD、DMG 和 USB 驱动器</span><br></pre></td></tr></table></figure>

<h3 id="2-系统文件"><a href="#2-系统文件" class="headerlink" title="2. 系统文件"></a>2. 系统文件</h3><p><strong>操作系统版本</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/System/Library/CoreServices/SystemVersion.plist</span><br></pre></td></tr></table></figure>

<p><strong>时区</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/.GlobalPreferences.plist</span><br></pre></td></tr></table></figure>

<p><strong>语言</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/.GlobalPreferences.plist</span><br></pre></td></tr></table></figure>

<p><strong>MAC地址</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/private/var/log/daily.out</span><br></pre></td></tr></table></figure>

<p><strong>启动文件夹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/Library/LaunchAgents/</span><br><span class="line">/Library/LaunchDaemons/</span><br><span class="line">/System/Library/LaunchAgents/</span><br><span class="line">/System/Library/LaunchDaemons/</span><br></pre></td></tr></table></figure>

<p><strong>系统偏好应用程序</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/PreferencePanes/</span><br></pre></td></tr></table></figure>

<p><strong>防火墙</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/com.apple.alf.plist</span><br></pre></td></tr></table></figure>

<p><strong>蓝牙</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/com.apple.Bluetooth.plist</span><br></pre></td></tr></table></figure>

<p><strong>键盘</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/com.apple.HIToolbox.plist</span><br></pre></td></tr></table></figure>

<p><strong>最近用户登录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/com.apple.loginwindow.plist</span><br></pre></td></tr></table></figure>

<p><strong>最近更新信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/com.apple.SoftwareUpdate.plist</span><br></pre></td></tr></table></figure>

<p><strong>Time Machine</strong></p>
<p>最后备份，最旧备份，快照编号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/com.apple.TimeMachine.plist</span><br><span class="line">/private/var/db/com.apple.TimeMAchine.SnapshotDates.plist</span><br></pre></td></tr></table></figure>

<p><strong>打印机</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/org.cups.printers.plist</span><br></pre></td></tr></table></figure>

<p><strong>Airport - Remembered Network</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/SystemConfiguration(s)/com.apple.airport.preferences.plist</span><br></pre></td></tr></table></figure>

<p><strong>最后睡眠时间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/SystemConfiguration(s)/com.apple.PowerManagement.plist</span><br></pre></td></tr></table></figure>

<p><strong>网络接口名称</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/SystemConfiguration(s)/NetworkInterfaces.plist</span><br></pre></td></tr></table></figure>

<p><strong>网络信息</strong></p>
<p>&#x2F;Library&#x2F;Preferences&#x2F;SystemConfiguration(s)&#x2F;preferences.plist</p>
<p><strong>主机名</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/SystemConfiguration(s)/preferences.plist</span><br></pre></td></tr></table></figure>

<p><strong>VMWare Fusion Network</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Preferences/VMWare Fusion/networking</span><br></pre></td></tr></table></figure>

<p><strong>Keychains</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Keychains/ /System/Keychains/</span><br></pre></td></tr></table></figure>

<p><strong>主机文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/private/etc/hosts Path /private/etc/paths</span><br></pre></td></tr></table></figure>

<p><strong>DNS</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/private/etc/resolv.conf</span><br></pre></td></tr></table></figure>

<p><strong>用户信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 可以查找password、name、uid、gid等信息</span><br><span class="line">/private/var/db/dslocal/nodes/[user].plist</span><br></pre></td></tr></table></figure>

<p><strong>组信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/private/var/db/dslocal/nodes/[group].plist</span><br><span class="line"></span><br><span class="line">* admin.plist for admin user * staff.plist for root user</span><br></pre></td></tr></table></figure>

<p><strong>休眠文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/private/var/vm/sleepimage</span><br></pre></td></tr></table></figure>

<p><strong>Swap文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/private/var/vm/swapfile[x]</span><br></pre></td></tr></table></figure>

<p><strong>已安装打印机</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/Library/Printers/</span><br><span class="line">/Library/Printers/InstalledPrinters.plist</span><br></pre></td></tr></table></figure>

<h3 id="3-用户PROFILE"><a href="#3-用户PROFILE" class="headerlink" title="3. 用户PROFILE"></a>3. 用户PROFILE</h3><p><strong>用户默认文件夹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">删除的文件 (Trash bin): ~/.Trash/</span><br><span class="line">桌面文件: ~/Desktop/</span><br><span class="line">Document文件夹 (default): ~/Documents/</span><br><span class="line">Download文件夹 (default): ~/Downloads/</span><br><span class="line">Library配置和设置: ~/Library/</span><br><span class="line">Movies文件夹 (default): ~/Movies/</span><br><span class="line">Music文件夹 (default): ~/Music/</span><br><span class="line">共享文件夹: ~/Public</span><br></pre></td></tr></table></figure>

<p><strong>Bash 命令历史</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/bash_history</span><br></pre></td></tr></table></figure>

<p><strong>SSH连接信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/.ssh/known_hosts</span><br></pre></td></tr></table></figure>

<p><strong>App访问通讯录的设置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Application Support/com.apple.TCC/TCC.db</span><br></pre></td></tr></table></figure>

<p><strong>应用程序崩溃时间戳</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Application Support/CrashReporter/[App]_[GUID].plist</span><br></pre></td></tr></table></figure>

<p><strong>崩溃计数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Application Support/User_Crash_History_[GUID].plist</span><br></pre></td></tr></table></figure>

<p><strong>通知中心</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Application Support/NotificationCenter/[GUID].db</span><br></pre></td></tr></table></figure>

<p><strong>沙盒容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Containers/</span><br></pre></td></tr></table></figure>

<p><strong>Keychains (用户)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Keychains/</span><br><span class="line">~/Library/Keychains/login.keychain</span><br><span class="line">~/Library/Keychains/metadata.keychain</span><br><span class="line">~/Library/Keychains/[XXXX].keychain</span><br></pre></td></tr></table></figure>

<p><strong>LaunchAgents（用户）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/LaunchAgents/[App].plist</span><br></pre></td></tr></table></figure>

<p><strong>Quicktime - 在线多媒体的 URL</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Caches/Quicktime/downloads/TOC.plist</span><br></pre></td></tr></table></figure>

<p><strong>Recent文件夹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.finder.plist</span><br></pre></td></tr></table></figure>

<p><strong>语言</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/.GlobalPreferences.plist</span><br></pre></td></tr></table></figure>

<p><strong>AppStore - 可用更新</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.appstore.plist</span><br></pre></td></tr></table></figure>

<p><strong>Recent磁盘映像 (ISO&#x2F;DMG)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.DiskUtility.plist</span><br></pre></td></tr></table></figure>

<p><strong>Dock</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.dock.plist</span><br></pre></td></tr></table></figure>

<p><strong>Dashboard - gadget&#x2F;widget</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.dashboard.plist</span><br></pre></td></tr></table></figure>

<p><strong>Recent信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.recentitems.plist</span><br></pre></td></tr></table></figure>

<p><strong>调度程序</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.scheduler.plist</span><br></pre></td></tr></table></figure>

<p><strong>屏幕保护程序</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.screensaver.plist</span><br></pre></td></tr></table></figure>

<p><strong>Finder 侧边栏</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.sidebarlists.plist</span><br></pre></td></tr></table></figure>

<p><strong>Spaces</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.spaces.plist</span><br></pre></td></tr></table></figure>

<p><strong>打印机</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Printers/</span><br></pre></td></tr></table></figure>

<p><strong>Connected iDevices</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a) 设备类型</span><br><span class="line">b) 上次连接时间戳</span><br><span class="line">c) 固件版本</span><br><span class="line">d) 序列号和 IMEI</span><br><span class="line"></span><br><span class="line">~/Library/Preferences/com.apple.iPod.plist</span><br></pre></td></tr></table></figure>

<p><strong>Connected storage</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.sidebarlists.plist</span><br></pre></td></tr></table></figure>

<p><strong>Recent Documents</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Preview</span><br><span class="line">~/Library/Preferences/com.apple.Preview.plist</span><br><span class="line"></span><br><span class="line"># Quicktime</span><br><span class="line">~/Library/Preferences/com.apple.QuickTimePlayerX.LSSharedFileList.plist</span><br><span class="line"></span><br><span class="line"># Console</span><br><span class="line">~/Library/Preferences/com.apple.Console.LSSharedFileList</span><br><span class="line"></span><br><span class="line"># Textedit</span><br><span class="line">~/Library/Preferences/com.apple.TextEdit.LSSharedFileList.plist</span><br></pre></td></tr></table></figure>

<p><strong>RSS订阅服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/Library/PubSub/Database/Database.sqlite3</span><br><span class="line">~/Library/PubSub/Clients.plist</span><br><span class="line">~/Library/PubSub/Feeds/</span><br></pre></td></tr></table></figure>

<p><strong>Download Quarantine Events</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2</span><br></pre></td></tr></table></figure>

<h3 id="4-日志文件"><a href="#4-日志文件" class="headerlink" title="4. 日志文件"></a>4. 日志文件</h3><p><strong>应用防火墙</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/private/var/log/appfirewall.log</span><br><span class="line">/private/var/log/appfirewall.log.[x].bz2</span><br></pre></td></tr></table></figure>

<p><strong>系统日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/private/var/log/asl/YYYY.MM.DD.U[XX].asl</span><br><span class="line">/private/var/log/DiagnosticMessages/YYYY.MM.DD.asl</span><br><span class="line">/private/var/log/install.log</span><br><span class="line">/private/var/log/install.log.[x].bz2</span><br><span class="line">/private/var/log/opendirectoryd.log</span><br><span class="line">/private/var/log/opendirectoryd.log.[x].bz2</span><br><span class="line">/private/var/log/system.log</span><br><span class="line">/private/var/log/system.log.[x].bz2</span><br><span class="line">/private/var/log/vnetlib</span><br><span class="line">/private/var/log/weekly.out</span><br><span class="line">/private/var/log/zzz.log</span><br></pre></td></tr></table></figure>

<p><strong>关机&#x2F;启动日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/private/var/log/com.apple.xpc.launchd/launchd.log</span><br><span class="line">/private/var/log/com.apple.launchd/launchd-shutdown.system.log</span><br></pre></td></tr></table></figure>

<p><strong>系统配置信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/private/var/log/install.log</span><br><span class="line"></span><br><span class="line">a. wirelessconnection</span><br><span class="line">b. registered country and city</span><br><span class="line">c. firmware version at logged time</span><br><span class="line">d. created username</span><br><span class="line">e. Install apps</span><br></pre></td></tr></table></figure>

<p><strong>磁盘状态</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/private/var/log/daily.out MAC address/</span><br></pre></td></tr></table></figure>

<p><strong>网络状态</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/private/var/log/daily.out</span><br></pre></td></tr></table></figure>

<p><strong>USB设备连接</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查找 &quot;USBMSC&quot;</span><br><span class="line">/private/var/log/System.log</span><br></pre></td></tr></table></figure>

<p><strong>开机时间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查找&quot;BOOT_TIME&quot;</span><br><span class="line">/private/var/log/System.log</span><br></pre></td></tr></table></figure>

<p><strong>关机时间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查找 &quot;SHUTDOWN_TIME&quot;</span><br><span class="line">/private/var/log/System.log</span><br></pre></td></tr></table></figure>

<p><strong>用户日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Logs/AMRestore.txt</span><br><span class="line">~/Library/Logs/appstore.log</span><br><span class="line">~/Library/Logs/DiagnosticReports/</span><br><span class="line">~Library/Logs/SMSMigrator/SMSMigrator.log</span><br><span class="line">~/Library/Logs/sync/syncservices.log</span><br><span class="line">~/Library/Logs/Ubiquity/[User]/ubiquity-digest.log</span><br><span class="line">~/Library/Logs/Ubiquity/[User]/ubiquity.log</span><br></pre></td></tr></table></figure>

<p><strong>光盘刻录日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Logs/DiskRecording.log</span><br></pre></td></tr></table></figure>

<p><strong>磁盘Utility日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Logs/DiskUtility.log</span><br></pre></td></tr></table></figure>

<p><strong>文件系统日志</strong></p>
<p>~&#x2F;Library&#x2F;Logs&#x2F;fsck_hfs.log</p>
<p><strong>VMWare</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/Library/Logs/VMWare</span><br><span class="line">~/Library/Logs/VMWare Fusion/</span><br></pre></td></tr></table></figure>

<h2 id="0x02-速查命令"><a href="#0x02-速查命令" class="headerlink" title="0x02 速查命令"></a>0x02 速查命令</h2><h3 id="1-用户排查"><a href="#1-用户排查" class="headerlink" title="1. 用户排查"></a>1. 用户排查</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dscl . list /Users UniqueID</span><br><span class="line"></span><br><span class="line">dscl . list /Users UniqueID | grep -v ^_</span><br></pre></td></tr></table></figure>

<h3 id="2-端口排查"><a href="#2-端口排查" class="headerlink" title="2. 端口排查"></a>2. 端口排查</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">netstat -na | egrep &#x27;LISTEN|ESTABLISHED&#x27;</span><br><span class="line"></span><br><span class="line">netstat -A -a -l -n -v  # Active网络连接</span><br><span class="line"></span><br><span class="line">netstat -n -r -a -l   # 路由表信息</span><br><span class="line"></span><br><span class="line">lsof -i</span><br></pre></td></tr></table></figure>

<h3 id="3-网络排查"><a href="#3-网络排查" class="headerlink" title="3. 网络排查"></a>3. 网络排查</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看详细网络信息</span><br><span class="line">plutil -p /Library/Preferences/SystemConfiguration/preferences.plist</span><br><span class="line"></span><br><span class="line"># 查看代理配置</span><br><span class="line">scutil --proxy</span><br></pre></td></tr></table></figure>

<h3 id="4-进程排查"><a href="#4-进程排查" class="headerlink" title="4. 进程排查"></a>4. 进程排查</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -axo user,pid,ppid,%cpu,%mem,start,time,command</span><br><span class="line"></span><br><span class="line">lsappinfo list</span><br></pre></td></tr></table></figure>

<h3 id="5-计划任务查看"><a href="#5-计划任务查看" class="headerlink" title="5. 计划任务查看"></a>5. 计划任务查看</h3><p><strong>守护进程服务文件路径</strong></p>
<p>plist按照如下优先级排列（由高到低）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/System/Library/LaunchDaemons # 由Mac OS X定义的守护进程任务项</span><br><span class="line">/System/Library/LaunchAgents  # 由Mac OS X为用户定义的任务项</span><br><span class="line">/Library/LaunchDaemons  # 由管理员定义的守护进程任务项</span><br><span class="line">/Library/LaunchAgents   # 由管理员为用户定义的任务项</span><br><span class="line">~/Library/LaunchAgents  # 由用户自己定义的任务项，接触最多</span><br></pre></td></tr></table></figure>

<p><strong>crontab命令</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">crontab [-u user] file</span><br><span class="line">crontab [-u user] [ -e | -l | -r ]</span><br><span class="line"></span><br><span class="line">-u user：用来设定某个用户的crontab服务；</span><br><span class="line">file：file是命令文件的名字,表示将file做为crontab的任务列表文件并载入crontab。</span><br><span class="line">-e：编辑某个用户的crontab文件内容。如果不指定用户，则表示编辑当前用户的crontab文件。</span><br><span class="line">-l：显示某个用户的crontab文件内容，如果不指定用户，则表示显示当前用户的crontab文件内容。</span><br><span class="line">-r：从/var/spool/cron目录中删除某个用户的crontab文件，如果不指定用户，则默认删除当前用户的crontab文件。</span><br><span class="line">-i：在删除用户的crontab文件时给确认提示。</span><br><span class="line"></span><br><span class="line"># 查看当前用户定时任务</span><br><span class="line"></span><br><span class="line">crontab -l</span><br></pre></td></tr></table></figure>

<p><strong>launchctl命令</strong></p>
<p>launchctl 通过配置文件指定执行周期和任务，不同于 crontab，launchctl 的最小时间间隔是 1s。plist 文件存放路径为 <code>/Library/LaunchAgents</code> 或 <code>/Library/LaunchDaemons</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Library/LaunchAgents</span><br><span class="line">launchctl load com.test.launchctl.plist      # 加载任务</span><br><span class="line">launchctl unload com.felink.gitmirror.plist  # 卸载任务</span><br><span class="line">launchctl start ccom.test.launchctl.plist    # 立即执行</span><br><span class="line">launchctl stop ccom.test.launchctl.plist     # 停止任务</span><br></pre></td></tr></table></figure>

<h3 id="6-临时-x2F-共享目录"><a href="#6-临时-x2F-共享目录" class="headerlink" title="6. 临时&#x2F;共享目录"></a>6. 临时&#x2F;共享目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls -al /Users/Shared</span><br><span class="line">$ ls -al /private/tmp</span><br><span class="line">$ ls -al $TMPDIR</span><br></pre></td></tr></table></figure>

<h3 id="7-shells文件"><a href="#7-shells文件" class="headerlink" title="7. shells文件"></a>7. shells文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~/.bash_profile  # 如果存在，登录shell时读取一次</span><br><span class="line">~/.bash_login    # 如果存在，如果.bash_profile不存在，则读取一次</span><br><span class="line">~/.profile       # 如果存在，上面两个不存在则读取一次</span><br><span class="line">/etc/profile     # 只有在以上都不存在时才读取</span><br><span class="line">~/.bashrc        # 如果存在，每次启动新的 shell 时读取</span><br><span class="line">~/.bash_logout   # 如果存在，在登录 shell 退出时读取</span><br></pre></td></tr></table></figure>

<h3 id="8-DB数据查看"><a href="#8-DB数据查看" class="headerlink" title="8. DB数据查看"></a>8. DB数据查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sqlite3 /path to db/ .dump</span><br><span class="line"></span><br><span class="line">$ sqlite3 /path to db/ .tables</span><br><span class="line"></span><br><span class="line">$ sqlite3 /path to db/ &#x27;select * from [tablename]&#x27;</span><br><span class="line"></span><br><span class="line">$ sqlite3 /path to db/ .schema</span><br><span class="line"></span><br><span class="line"># 隐藏数据库查看: Apple 将一些数据库隐藏在 /var/folders/ 文件夹中。当登录为给定用户，可以利用 DARWIN_USER_DIR 环境变量访问</span><br><span class="line"></span><br><span class="line">$ cd $(getconf DARWIN_USER_DIR)</span><br></pre></td></tr></table></figure>

<h3 id="9-plist文件查看"><a href="#9-plist文件查看" class="headerlink" title="9. plist文件查看"></a>9. plist文件查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plutil -p system.plist</span><br></pre></td></tr></table></figure>

<h2 id="0x03-自动化脚本"><a href="#0x03-自动化脚本" class="headerlink" title="0x03 自动化脚本"></a>0x03 自动化脚本</h2><h3 id="1-collect-sh"><a href="#1-collect-sh" class="headerlink" title="1. collect.sh"></a>1. collect.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ensure that the script is being executed as root</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$EUID</span> -ne 0 ]]; <span class="keyword">then</span> </span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&#x27;Incident Response Script needs to be executed as root!&#x27;</span></span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">originalUser=`sh -c <span class="string">&#x27;echo $SUDO_USER&#x27;</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Collecting data as root escalated from the <span class="variable">$originalUser</span> account&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#insert company message here explaining the situation</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----------------------------------------------------------------------</span></span><br><span class="line"><span class="string">COLLECTING CRITICAL SYSTEM DATA. PLEASE DO NOT TURN OFF YOUR SYSTEM...</span></span><br><span class="line"><span class="string">-----------------------------------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Start time-&gt; `date`&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Create a pf rule to block all network access except for access to file server over ssh</span></span><br><span class="line">quarentineRule=/etc/activeIr.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Writing quarentine rule to <span class="variable">$quarentineRule</span>&quot;</span></span><br><span class="line">serverIP=192.168.1.111</span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$quarentineRule</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">block in all</span></span><br><span class="line"><span class="string">block out all</span></span><br><span class="line"><span class="string">pass in proto tcp from $serverIP to any port 22</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#load the pfconf rule and inform the user there is no internet access</span></span><br><span class="line">pfctl -f <span class="variable">$quarentineRule</span> 2&gt;/dev/null</span><br><span class="line">pfctl -e 2&gt;/dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Quarentine Enabled. Internet access unavailable&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running system commands...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#set up variables</span></span><br><span class="line">IRfolder=collection</span><br><span class="line">logFile=<span class="variable">$IRfolder</span>/collectlog.txt</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$IRfolder</span></span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$logFile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#redirect errors</span></span><br><span class="line"><span class="built_in">exec</span> 2&gt; <span class="variable">$logFile</span></span><br><span class="line"></span><br><span class="line">systemCommands=<span class="variable">$IRfolder</span>/sysCalls</span><br><span class="line"></span><br><span class="line"><span class="comment">#create output directory</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$systemCommands</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#basic system info</span></span><br><span class="line">systemInfo=<span class="variable">$systemCommands</span>/sysInfo.txt</span><br><span class="line"><span class="comment">#create file</span></span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$systemInfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#echo ---command name to be used---; use command; append a blank line</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">date</span>--- &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">date</span> &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---hostname--- &gt;&gt; <span class="variable">$systemInfo</span>; hostname &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">uname</span> -a--- &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">uname</span> -a &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---sw_vers--- &gt;&gt; <span class="variable">$systemInfo</span>; sw_vers &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---nvram--- &gt;&gt; <span class="variable">$systemInfo</span>; nvram &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">uptime</span>--- &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">uptime</span> &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---spctl --status--- &gt;&gt; <span class="variable">$systemInfo</span>; spctl --status &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> --bash --version--- &gt;&gt; <span class="variable">$systemInfo</span>; bash --version &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect who-based data</span></span><br><span class="line">whoInfo=<span class="variable">$systemCommands</span>/whoInfo.txt</span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$whoInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">ls</span> -la /Users--- &gt;&gt; <span class="variable">$whoInfo</span>; <span class="built_in">ls</span> -la /Users &gt;&gt; <span class="variable">$whoInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$whoInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">whoami</span>--- &gt;&gt; <span class="variable">$whoInfo</span>; <span class="built_in">whoami</span> &gt;&gt; <span class="variable">$whoInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$whoInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">who</span>--- &gt;&gt; <span class="variable">$whoInfo</span>; <span class="built_in">who</span> &gt;&gt; <span class="variable">$whoInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$whoInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---w--- &gt;&gt; <span class="variable">$whoInfo</span>; w &gt;&gt; <span class="variable">$whoInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$whoInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---last--- &gt;&gt; <span class="variable">$whoInfo</span>; last &gt;&gt; <span class="variable">$whoInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$whoInfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect user info</span></span><br><span class="line">userInfo=<span class="variable">$systemCommands</span>/userInfo.txt</span><br><span class="line"><span class="built_in">echo</span> ---Users on this system--- &gt;&gt;<span class="variable">$userInfo</span>; dscl . -<span class="built_in">ls</span> /Users &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line"><span class="comment">#for each user</span></span><br><span class="line">dscl . -<span class="built_in">ls</span> /Users | egrep -v ^_ | <span class="keyword">while</span> <span class="built_in">read</span> user </span><br><span class="line">	<span class="keyword">do</span> </span><br><span class="line">		<span class="built_in">echo</span> *****<span class="variable">$user</span>***** &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> ---<span class="built_in">id</span> \(<span class="variable">$user</span>\)--- &gt;&gt;<span class="variable">$userInfo</span>; <span class="built_in">id</span> <span class="variable">$user</span> &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> ---<span class="built_in">groups</span> \(<span class="variable">$user</span>\)--- &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">groups</span> <span class="variable">$user</span> &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> ---finger \(<span class="variable">$user</span>\) --- &gt;&gt; <span class="variable">$userInfo</span>; finger -m <span class="variable">$user</span> &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="comment"># find a way to provide printenv</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Collect network-based info</span></span><br><span class="line">networkInfo=<span class="variable">$systemCommands</span>/networkInfo.txt</span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$networkInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---netstat--- &gt;&gt; <span class="variable">$networkInfo</span>; netstat &gt;&gt; <span class="variable">$networkInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$networkInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---netstat -ru--- &gt;&gt; <span class="variable">$networkInfo</span>; netstat -ru &gt;&gt; <span class="variable">$networkInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$networkInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---networksetup -listallhardwareports--- &gt;&gt; <span class="variable">$networkInfo</span>; networksetup -listallhardwareports &gt;&gt; <span class="variable">$networkInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$networkInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---lsof -i--- &gt;&gt; <span class="variable">$networkInfo</span>; lsof -i &gt;&gt; <span class="variable">$networkInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$networkInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---arp -a--- &gt;&gt; <span class="variable">$networkInfo</span>; arp -a &gt;&gt; <span class="variable">$networkInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$networkInfo</span></span><br><span class="line"><span class="built_in">echo</span> security dump-trust-settings &gt;&gt; <span class="variable">$networkInfo</span>; security dump-trust-settings &gt;&gt; <span class="variable">$networkInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$networkInfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect process-based info</span></span><br><span class="line">processInfo=<span class="variable">$systemCommands</span>/processInfo.txt</span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$processInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---ps aux--- &gt;&gt; <span class="variable">$processInfo</span>; ps aux &gt;&gt; <span class="variable">$processInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$processInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---lsof--- &gt;&gt; <span class="variable">$processInfo</span>; lsof &gt;&gt; <span class="variable">$processInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$processInfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect startup-based info</span></span><br><span class="line">startupInfo=<span class="variable">$systemCommands</span>/startupInfo.txt</span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$startupInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---launchctl list--- &gt;&gt; <span class="variable">$startupInfo</span>; launchctl list &gt;&gt; <span class="variable">$startupInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$startupInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---atq--- &gt;&gt; <span class="variable">$startupInfo</span>; atq &gt;&gt; <span class="variable">$startupInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$startupInfo</span></span><br><span class="line"><span class="comment">#crontab will be collected later from /usr/lib/cron/&lt;usernames&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect driver-based info</span></span><br><span class="line">driverInfo=<span class="variable">$systemCommands</span>/driverInfo.txt</span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$driverInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---kextstat--- &gt;&gt; <span class="variable">$driverInfo</span>; kextstat &gt;&gt; <span class="variable">$driverInfo</span>; <span class="built_in">echo</span> &gt;&gt;<span class="variable">$driverInfo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect hard drive info</span></span><br><span class="line">hardDriveInfo=<span class="variable">$systemCommands</span>/hardDriveInfo.txt</span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$hardDriveInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---diskutil list--- &gt;&gt; <span class="variable">$hardDriveInfo</span>; diskutil list &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">echo</span> &gt;&gt;<span class="variable">$hardDriveInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">df</span> -h--- &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">df</span> -h &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$hardDriveInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">du</span> -h--- &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">du</span> -h &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$hardDriveInfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Collecting file system data</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect artifiacts</span></span><br><span class="line"><span class="built_in">mkdir</span> artifacts</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect the audit logs</span></span><br><span class="line"><span class="comment">#mkdir artifacts/audit</span></span><br><span class="line"><span class="comment">#ditto /var/audit artifacts/audit</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -a directories=(</span><br><span class="line">	<span class="comment">#list dirs to collect here. Don&#x27;t include a slash at the end of the dir</span></span><br><span class="line">	<span class="string">&quot;/var/audit&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -a files=(</span><br><span class="line">	<span class="string">&quot;/var/log/system.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/accountpolicy.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/apache2/access_log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/apache2/error_log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/opendirectoryd.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/secinitd&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/wifi.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/alf.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/appstore.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/authd.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/commerce.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/hdiejectd.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/install.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/Library/Preferences/SystemConfiguration/com.apple.airport.preferences.plist&quot;</span></span><br><span class="line">	<span class="string">&quot;/etc/kcpassword&quot;</span> </span><br><span class="line">	<span class="string">&quot;/etc/sudoers&quot;</span></span><br><span class="line">	<span class="string">&quot;/etc/hosts&quot;</span> </span><br><span class="line">	<span class="string">&quot;/etc/resolv.conf&quot;</span></span><br><span class="line">	<span class="string">&quot;/private/var/log/fsck_hfs.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/private/var/db/launchd.db/com.apple.launchd/overrides.plist&quot;</span> </span><br><span class="line">	<span class="string">&quot;/Library/Logs/AppleFileService/AppleFileServiceError.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/appfirewall.log&quot;</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -a userFiles=(</span><br><span class="line">	<span class="comment">#these are user files paths without the ~ at the beginning. The home directories will be concated later</span></span><br><span class="line">	<span class="string">&quot;Library/Preferences/com.apple.finder.plist&quot;</span></span><br><span class="line">	<span class="string">&quot;Library/Preferences/com.apple.recentitems.plist&quot;</span></span><br><span class="line">	<span class="string">&quot;Library/Preferences/com.apple.loginitems.plist&quot;</span></span><br><span class="line">	<span class="string">&quot;Library/Logs/DiskUtility.log&quot;</span></span><br><span class="line">	<span class="string">&quot;Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect files</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;files[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	ditto <span class="string">&quot;<span class="variable">$x</span>&quot;</span>* artifacts</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect user files for each user</span></span><br><span class="line">dscl . -<span class="built_in">ls</span> /Users | egrep -v ^_ | <span class="keyword">while</span> <span class="built_in">read</span> user </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;userFiles[@]&#125;</span>&quot;</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		fileLocation=<span class="string">&quot;/Users/<span class="variable">$user</span>/<span class="variable">$x</span>&quot;</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;Trying to ditto <span class="variable">$fileLocation</span>&quot;</span></span><br><span class="line">		<span class="keyword">if</span> [ -f <span class="variable">$fileLocation</span> ]; <span class="keyword">then</span></span><br><span class="line">			ditto <span class="string">&quot;<span class="variable">$fileLocation</span>&quot;</span>* artifacts</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect dirs</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;directories[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="built_in">dirname</span>=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$x</span>&quot;</span> | awk -F <span class="string">&quot;/&quot;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>`</span><br><span class="line">	<span class="built_in">echo</span> created <span class="string">&quot;<span class="variable">$dirname</span>&quot;</span> from <span class="string">&quot;<span class="variable">$x</span>&quot;</span></span><br><span class="line">	<span class="built_in">mkdir</span> artifacts/<span class="string">&quot;<span class="variable">$dirname</span>&quot;</span></span><br><span class="line">	ditto <span class="string">&quot;<span class="variable">$x</span>&quot;</span> artifacts/<span class="string">&quot;<span class="variable">$dirname</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ASEP COLLECTION</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Collecting system ASEPS&quot;</span></span><br><span class="line"><span class="comment">#the $IRfolder variable was assigned in our original script</span></span><br><span class="line">ASEPS=<span class="variable">$IRfolder</span>/aseps</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$ASEPS</span></span><br><span class="line"></span><br><span class="line">ditto /System/Library/LaunchDaemons <span class="variable">$ASEPS</span>/systemLaunchDaemons</span><br><span class="line">ditto /System/Library/LaunchAgents <span class="variable">$ASEPS</span>/systemLaunchAgents</span><br><span class="line">ditto /Library/LaunchDaemons <span class="variable">$ASEPS</span>/launchDaemons</span><br><span class="line">ditto /Library/LaunchAgents <span class="variable">$ASEPS</span>/launchAgents</span><br><span class="line"><span class="comment">#ditto &lt;user entry&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect crontabs and set permissions so that the analyst can read the results</span></span><br><span class="line">ditto /usr/lib/cron/tabs/ <span class="variable">$ASEPS</span>/crontabs; </span><br><span class="line"></span><br><span class="line"><span class="comment">#collect at tasks</span></span><br><span class="line">ditto /private/var/at/jobs/ <span class="variable">$ASEPS</span>/atTasks</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect plist overrides</span></span><br><span class="line">ditto /var/db/launchd.db <span class="variable">$ASEPS</span>/overrides;</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect StartupItems</span></span><br><span class="line">ditto /etc/rc* <span class="variable">$ASEPS</span>/</span><br><span class="line">ditto /Library/StartupItems/ <span class="variable">$ASEPS</span>/</span><br><span class="line">ditto /System/Library/StartupItems/ <span class="variable">$ASEPS</span>/systemStartupItems</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect Login/Logout Hooks</span></span><br><span class="line">ditto /private/var/root/Library/Preferences/com.apple.loginwindow.plist <span class="variable">$ASEPS</span>/loginLogouthooks</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect launchd configs</span></span><br><span class="line"><span class="comment">#file may or may not exist</span></span><br><span class="line">ditto /etc/launchd.conf <span class="variable">$ASEPS</span>/launchdConfs/</span><br><span class="line"></span><br><span class="line"><span class="comment">#copy user specific data for each user</span></span><br><span class="line">dscl . -<span class="built_in">ls</span> /Users | egrep -v ^_ | <span class="keyword">while</span> <span class="built_in">read</span> user</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	ditto /Users/<span class="variable">$user</span>/Library/LaunchAgents <span class="variable">$ASEPS</span>/<span class="variable">$user</span>-launchAgents</span><br><span class="line">	ditto /Users/<span class="variable">$user</span>/Library/Preferences/com.apple.loginitems.plist <span class="variable">$ASEPS</span>/<span class="variable">$user</span>-com.apple.loginitems.plist;</span><br><span class="line">	ditto /Users/<span class="variable">$user</span>/.launchd.conf <span class="variable">$ASEPS</span>/launchdConfs/<span class="variable">$user</span>-launchd.conf</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#copy kext files in the extension directories</span></span><br><span class="line">ditto /System/Library/Extensions <span class="variable">$ASEPS</span>/systemExtensions</span><br><span class="line">ditto /Library/Extensions <span class="variable">$ASEPS</span>/extensions</span><br><span class="line"></span><br><span class="line"><span class="comment">#create a function that will scan all files in a directory using codesign</span></span><br><span class="line"><span class="function"><span class="title">codesignDirScan</span></span>()&#123;</span><br><span class="line">	<span class="keyword">for</span> filename <span class="keyword">in</span> <span class="variable">$1</span>/*; <span class="keyword">do</span></span><br><span class="line">        codesign -vv -d <span class="variable">$filename</span> &amp;&gt;tmp.txt;</span><br><span class="line">        <span class="keyword">if</span> grep -q <span class="string">&quot;not signed&quot;</span> tmp.txt; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">cat</span> tmp.txt &gt;&gt; <span class="variable">$ASEPS</span>/unsignedKexts.txt</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">	<span class="built_in">rm</span> tmp.txt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#run a codesign scan on all kext files</span></span><br><span class="line">codesignDirScan /System/Library/Extensions</span><br><span class="line">codesignDirScan /Library/Extensions</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect browser history</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Copying Web Data...&quot;</span></span><br><span class="line">dscl . -<span class="built_in">ls</span> /Users | egrep -v ^_ | <span class="keyword">while</span> <span class="built_in">read</span> user </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">	<span class="comment">#check for and copy Safari data</span></span><br><span class="line">	<span class="comment">#Safari is pretty much garenteed to be installed</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Looking for /Users/<span class="variable">$user</span>/Library/Safari&quot;</span></span><br><span class="line">	<span class="keyword">if</span> [ -d  <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Safari/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		plutil -convert xml1 /Users/<span class="variable">$user</span>/Library/Safari/History.plist -o <span class="string">&quot;<span class="variable">$user</span>&quot;</span>_safariHistory.plist</span><br><span class="line">		plutil -convert xml1 /Users/<span class="variable">$user</span>/Library/Safari/Downloads.plist -o <span class="string">&quot;<span class="variable">$user</span>&quot;</span>_safariDownloads.plist</span><br><span class="line">		<span class="comment">#plutil -p &quot;/Users/$user/Library/Safari/History.plist&quot; &gt; &quot;$user&quot;_safariHistory.plist</span></span><br><span class="line">		<span class="comment">#plutil -p &quot;/Users/$user/Library/Safari/Downloads.plist&quot; &gt; &quot;$user&quot;_safariDownloads.plist</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">#grab the sqlite3 version of the history if you prefer</span></span><br><span class="line">		ditto <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Safari/Downloads.plist&quot;</span> <span class="string">&quot;<span class="variable">$user</span>&quot;</span>_safariDownloads.db</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#check for and copy Chrome data</span></span><br><span class="line">	<span class="keyword">if</span> [ -d  <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/Google/Chrome/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		ditto <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/Google/Chrome/Default/History&quot;</span> <span class="string">&quot;<span class="variable">$user</span>&quot;</span>_chromeHistory.db</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#check for and copy firefox data</span></span><br><span class="line">	<span class="comment">#there should only be one profile inside the Profiles directory</span></span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/Firefox/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">for</span> PROFILE <span class="keyword">in</span> /Users/<span class="variable">$user</span>/Library/Application\ Support/Firefox/Profiles/*; <span class="keyword">do</span></span><br><span class="line">			ditto <span class="string">&quot;<span class="variable">$PROFILE</span>/places.sqlite&quot;</span> <span class="string">&quot;<span class="variable">$user</span>&quot;</span>_firefoxHistory.db</span><br><span class="line">		<span class="keyword">done</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#check for and copy Opera data</span></span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/com.operasoftware.Opera/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		ditto <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/com.operasoftware.Opera/History&quot;</span> <span class="string">&quot;<span class="variable">$user</span>&quot;</span>_operaHistory.db</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#create a zip file of all the data in the current directory</span></span><br><span class="line"><span class="comment">#this will always be the last thing we do. Do not add code below this section through this book</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Archiving Data&quot;</span></span><br><span class="line">cname=`scutil --get ComputerName | <span class="built_in">tr</span> <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;_&#x27;</span>`</span><br><span class="line">now=`<span class="built_in">date</span> +<span class="string">&quot;_%Y-%m-%d&quot;</span>`</span><br><span class="line">ditto -k --zlibCompressionLevel 5 -c . $cname<span class="variable">$now</span>.zip</span><br></pre></td></tr></table></figure>

<h3 id="2-collect-basics-sh"><a href="#2-collect-basics-sh" class="headerlink" title="2. collect_basics.sh"></a>2. collect_basics.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#create a文件夹 where all collected data will go</span></span><br><span class="line">IRfolder=collection</span><br><span class="line"><span class="comment">#ensure that the script is being executed as root</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$EUID</span> -ne 0 ]]; <span class="keyword">then</span> </span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Incident Response Script needs to be executed as root!&quot;</span> </span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sudo -k</span><br><span class="line"></span><br><span class="line"><span class="comment">#save which user executed the analysis script as we may need it later</span></span><br><span class="line">originalUser=`sh -c <span class="string">&#x27;echo $SUDO_USER&#x27;</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Collecting data as root escalated from the <span class="variable">$originalUser</span> account&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#insert company message here explaining the situation</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">-----------------------------------------------------------------------</span></span><br><span class="line"><span class="string">COLLECTING CRITICAL SYSTEM DATA. PLEASE DO NOT TURN OFF YOUR SYSTEM...</span></span><br><span class="line"><span class="string">-----------------------------------------------------------------------</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Start time-&gt; `date`&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#we will start tracing connections with dtrace below this line#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#we will collect memory below this line#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#we will collect volatile data using shell below this line#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Create a pf rule to block all network access except for access to file server over ssh#</span></span><br><span class="line">quarentineRule=/etc/activeIr.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Writing quarentine rule to <span class="variable">$quarentineRule</span>&quot;</span></span><br><span class="line">serverIP=192.168.1.111 <span class="comment">#IP of the server you want to stay in contact with this system</span></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$quarentineRule</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">block in all</span></span><br><span class="line"><span class="string">block out all</span></span><br><span class="line"><span class="string">pass in proto tcp from $serverIP to any port 22</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#load the pfconf rule and inform the user there is no internet access#</span></span><br><span class="line">pfctl -f <span class="variable">$quarentineRule</span> 2&gt;/dev/null</span><br><span class="line">pfctl -e 2&gt;/dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Quarentine Enabled. Internet access unavailable&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#we will collect a file listing here#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#we will collect file artifacts here#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#we will collect system startup artificats and ASEPS here#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#we will collect web browser artifacts here#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#create a zip file of all the data in the current directory#</span></span><br><span class="line"><span class="comment">#this will always be the last thing we do. Do not add code below this section through this book</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Archiving Data&quot;</span></span><br><span class="line">cname=`scutil --get ComputerName | <span class="built_in">tr</span> <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;_&#x27;</span> | <span class="built_in">tr</span> -d \’`</span><br><span class="line">now=`<span class="built_in">date</span> +<span class="string">&quot;_%Y-%m-%d&quot;</span>`</span><br><span class="line">ditto -k --zlibCompressionLevel 5 -c <span class="variable">$IRfolder</span> $cname<span class="variable">$now</span>.zip</span><br></pre></td></tr></table></figure>

<h3 id="3-yarafly-sh"><a href="#3-yarafly-sh" class="headerlink" title="3. yarafly.sh"></a>3. yarafly.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Yara on the fly</span></span><br><span class="line"></span><br><span class="line">tmpFile=<span class="string">&quot;.yara.tmp&quot;</span></span><br><span class="line">yaraRule=<span class="string">&quot;yarafly.yar&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--add indicators you want to scan for below this line--&quot;</span> &gt; <span class="variable">$tmpFile</span></span><br><span class="line">pico <span class="variable">$tmpFile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#build rule with temp file contents</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;rule onTheFly : fly\n&#123;\n\tstrings:&quot;</span> &gt; <span class="variable">$yaraRule</span></span><br><span class="line"></span><br><span class="line">counter=0</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">	<span class="comment">#if statement skips the first line of the temp file</span></span><br><span class="line">	<span class="keyword">if</span> [ <span class="variable">$counter</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> -e <span class="string">&quot;\t\t\$<span class="variable">$counter</span> = \&quot;<span class="variable">$line</span>\&quot;&quot;</span> &gt;&gt; <span class="variable">$yaraRule</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	((counter++))</span><br><span class="line"><span class="keyword">done</span> &lt;<span class="variable">$tmpFile</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\tcondition:\n\t\tany of them\n&#125;&quot;</span> &gt;&gt; <span class="variable">$yaraRule</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> <span class="variable">$tmpFile</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Rule created - <span class="variable">$yaraRule</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$yaraRule</span></span><br></pre></td></tr></table></figure>

<h3 id="4-collect-bash-commands-sh"><a href="#4-collect-bash-commands-sh" class="headerlink" title="4. collect_bash_commands.sh"></a>4. collect_bash_commands.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#set up variables</span></span><br><span class="line">IRfolder=collection</span><br><span class="line">systemCommands=<span class="variable">$IRfolder</span>/bashCalls</span><br><span class="line"></span><br><span class="line"><span class="comment">#create output directory</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$IRfolder</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$systemCommands</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#start tracing tcp connections in the background</span></span><br><span class="line">scripts/soconnect_mac.d -o <span class="variable">$IRfolder</span>/soconnect.log &amp;</span><br><span class="line"><span class="comment">#get pid. avoid using pgrep incase dtrace was already running</span></span><br><span class="line">dtracePid=`ps aux | grep dtrace.*soconnect_mac.d | grep -v grep | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Started tracing outbound TCP connections. Dtrace PID is <span class="variable">$dtracePid</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect volatile bash data</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running system commands...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect bash history</span></span><br><span class="line"><span class="built_in">history</span> &gt; <span class="variable">$systemCommands</span>/history.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#basic system info</span></span><br><span class="line">systemInfo=<span class="variable">$systemCommands</span>/sysInfo.txt</span><br><span class="line"><span class="comment">#create file</span></span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$systemInfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#echo ---command name to be used---; use command; append a blank line</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">date</span>--- &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">date</span> &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---hostname--- &gt;&gt; <span class="variable">$systemInfo</span>; hostname &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">uname</span> -a--- &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">uname</span> -a &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---sw_vers--- &gt;&gt; <span class="variable">$systemInfo</span>; sw_vers &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---nvram--- &gt;&gt; <span class="variable">$systemInfo</span>; nvram &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">uptime</span>--- &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">uptime</span> &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---spctl --status--- &gt;&gt; <span class="variable">$systemInfo</span>; spctl --status &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"><span class="built_in">echo</span> --bash --version--- &gt;&gt; <span class="variable">$systemInfo</span>; bash --version &gt;&gt; <span class="variable">$systemInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$systemInfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect who-based data</span></span><br><span class="line"><span class="built_in">ls</span> -la /Users &gt; <span class="variable">$systemCommands</span>/ls_la_users.txt</span><br><span class="line"><span class="built_in">whoami</span> &gt; <span class="variable">$systemCommands</span>/whoami.txt</span><br><span class="line"><span class="built_in">who</span> &gt; <span class="variable">$systemCommands</span>/who.txt</span><br><span class="line">w &gt; <span class="variable">$systemCommands</span>/w.txt</span><br><span class="line">last &gt; <span class="variable">$systemCommands</span>/last.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect user info</span></span><br><span class="line">userInfo=<span class="variable">$systemCommands</span>/userInfo.txt</span><br><span class="line"><span class="built_in">echo</span> ---Users on this system--- &gt;&gt;<span class="variable">$userInfo</span>; dscl . -<span class="built_in">ls</span> /Users &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line"><span class="comment">#for each user</span></span><br><span class="line">dscl . -<span class="built_in">ls</span> /Users | egrep -v ^_ | <span class="keyword">while</span> <span class="built_in">read</span> user </span><br><span class="line">	<span class="keyword">do</span> </span><br><span class="line">		<span class="built_in">echo</span> *****<span class="variable">$user</span>***** &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> ---<span class="built_in">id</span> \(<span class="variable">$user</span>\)--- &gt;&gt;<span class="variable">$userInfo</span>; <span class="built_in">id</span> <span class="variable">$user</span> &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> ---<span class="built_in">groups</span> \(<span class="variable">$user</span>\)--- &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">groups</span> <span class="variable">$user</span> &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> ---finger \(<span class="variable">$user</span>\) --- &gt;&gt; <span class="variable">$userInfo</span>; finger -m <span class="variable">$user</span> &gt;&gt; <span class="variable">$userInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">		<span class="built_in">echo</span> &gt;&gt; <span class="variable">$userInfo</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Collect network-based info</span></span><br><span class="line">netstat &gt; <span class="variable">$systemCommands</span>/netstat.txt</span><br><span class="line">netstat -ru &gt; <span class="variable">$systemCommands</span>/netstat_ru.txt</span><br><span class="line">networksetup -listallhardwareports &gt; <span class="variable">$systemCommands</span>/networksetup_listallhadwarereports.txt</span><br><span class="line">lsof -i &gt; <span class="variable">$systemCommands</span>/lsof_i.txt</span><br><span class="line">arp -a &gt; <span class="variable">$systemCommands</span>/arp_a.txt</span><br><span class="line">smbutil statshares -a &gt; <span class="variable">$systemCommands</span>/smbutil_statshares.txt</span><br><span class="line">security dump-trust-settings &gt; <span class="variable">$systemCommands</span>/security_dump_trust_settings.txt</span><br><span class="line">ifconfig &gt; <span class="variable">$systemCommands</span>/ifconfig.txt</span><br><span class="line">smbutil statshares -a &gt; <span class="variable">$systemCommands</span>/smbutil_statshares.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect process-based info</span></span><br><span class="line">ps aux &gt; <span class="variable">$systemCommands</span>/ps_aux.txt</span><br><span class="line">ps axo user,pid,ppid,start,<span class="built_in">command</span> &gt; <span class="variable">$systemCommands</span>/ps_axo.txt</span><br><span class="line">lsof &gt; <span class="variable">$systemCommands</span>/lsof.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect driver-based info</span></span><br><span class="line">kextstat &gt; <span class="variable">$systemCommands</span>/kextstat.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect hard drive info</span></span><br><span class="line">hardDriveInfo=<span class="variable">$systemCommands</span>/hardDriveInfo.txt</span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$hardDriveInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---diskutil list--- &gt;&gt; <span class="variable">$hardDriveInfo</span>; diskutil list &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">echo</span> &gt;&gt;<span class="variable">$hardDriveInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">df</span> -h--- &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">df</span> -h &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$hardDriveInfo</span></span><br><span class="line"><span class="built_in">echo</span> ---<span class="built_in">du</span> -h--- &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">du</span> -h &gt;&gt; <span class="variable">$hardDriveInfo</span>; <span class="built_in">echo</span> &gt;&gt; <span class="variable">$hardDriveInfo</span></span><br><span class="line"><span class="comment">#stop tracing outgoing TCP data</span></span><br><span class="line"><span class="built_in">kill</span> -9 <span class="variable">$dtracePid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#create a zip file of all the data in the current directory</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Archiving Data&quot;</span></span><br><span class="line">cname=`scutil --get ComputerName | <span class="built_in">tr</span> <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;_&#x27;</span> | <span class="built_in">tr</span> -d \’`</span><br><span class="line">now=`<span class="built_in">date</span> +<span class="string">&quot;_%Y-%m-%d&quot;</span>`</span><br><span class="line">ditto -k --zlibCompressionLevel 5 -c . $cname<span class="variable">$now</span>.zip</span><br></pre></td></tr></table></figure>

<h3 id="5-collect-aseps-sh"><a href="#5-collect-aseps-sh" class="headerlink" title="5. collect_aseps.sh"></a>5. collect_aseps.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ASEP COLLECTION</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Collecting system ASEPS&quot;</span></span><br><span class="line"><span class="comment">#the $IRfolder variable was assigned in our original script</span></span><br><span class="line">ASEPS=<span class="variable">$IRfolder</span>/aseps</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$ASEPS</span></span><br><span class="line"></span><br><span class="line">ditto /System/Library/LaunchDaemons <span class="variable">$ASEPS</span>/systemLaunchDaemons</span><br><span class="line">ditto /System/Library/LaunchAgents <span class="variable">$ASEPS</span>/systemLaunchAgents</span><br><span class="line">ditto /Library/LaunchDaemons <span class="variable">$ASEPS</span>/launchDaemons</span><br><span class="line">ditto /Library/LaunchAgents <span class="variable">$ASEPS</span>/launchAgents</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect crontabs and set permissions so that the analyst can read the results</span></span><br><span class="line">ditto /usr/lib/cron/tabs/ <span class="variable">$ASEPS</span>/crontabs; </span><br><span class="line"></span><br><span class="line"><span class="comment">#collect at tasks</span></span><br><span class="line">ditto /private/var/at/jobs/ <span class="variable">$ASEPS</span>/atTasks</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect plist overrides</span></span><br><span class="line">ditto /var/db/launchd.db <span class="variable">$ASEPS</span>/overrides;</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect StartupItems</span></span><br><span class="line">ditto /etc/rc* <span class="variable">$ASEPS</span>/</span><br><span class="line">ditto /Library/StartupItems/ <span class="variable">$ASEPS</span>/</span><br><span class="line">ditto /System/Library/StartupItems/ <span class="variable">$ASEPS</span>/systemStartupItems</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect Login/Logout Hooks</span></span><br><span class="line">ditto /private/var/root/Library/Preferences/com.apple.loginwindow.plist <span class="variable">$ASEPS</span>/loginLogouthooks</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect launchd configs</span></span><br><span class="line"><span class="comment">#file may or may not exist</span></span><br><span class="line">ditto /etc/launchd.conf <span class="variable">$ASEPS</span>/launchdConfs/</span><br><span class="line"></span><br><span class="line"><span class="comment">#copy user specific data for each user</span></span><br><span class="line">dscl . -<span class="built_in">ls</span> /Users | egrep -v ^_ | <span class="keyword">while</span> <span class="built_in">read</span> user</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	ditto /Users/<span class="variable">$user</span>/Library/LaunchAgents <span class="variable">$ASEPS</span>/<span class="variable">$user</span>-launchAgents</span><br><span class="line">	ditto /Users/<span class="variable">$user</span>/Library/Preferences/com.apple.loginitems.plist <span class="variable">$ASEPS</span>/<span class="variable">$user</span>-com.apple.loginitems.plist;</span><br><span class="line">	ditto /Users/<span class="variable">$user</span>/.launchd.conf <span class="variable">$ASEPS</span>/launchdConfs/<span class="variable">$user</span>-launchd.conf</span><br><span class="line"></span><br><span class="line">	<span class="built_in">touch</span> <span class="variable">$user</span>\_launchctl_list.txt</span><br><span class="line">	<span class="built_in">chmod</span> 766 <span class="variable">$user</span>\_launchctl_list.txt </span><br><span class="line">	su <span class="variable">$user</span> -c <span class="string">&quot;launchctl list &gt; <span class="variable">$user</span>\_launchctl_list.txt&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#copy kext files in the extension directories</span></span><br><span class="line">ditto /System/Library/Extensions <span class="variable">$ASEPS</span>/systemExtensions</span><br><span class="line">ditto /Library/Extensions <span class="variable">$ASEPS</span>/extensions</span><br><span class="line"></span><br><span class="line"><span class="comment">#create a function that will scan all files in a directory using codesign</span></span><br><span class="line"><span class="function"><span class="title">codesignDirScan</span></span>()&#123;</span><br><span class="line">	<span class="keyword">for</span> filename <span class="keyword">in</span> <span class="variable">$1</span>/*; <span class="keyword">do</span></span><br><span class="line">        codesign -vv -d <span class="variable">$filename</span> &amp;&gt;tmp.txt;</span><br><span class="line">        <span class="keyword">if</span> grep -q <span class="string">&quot;not signed&quot;</span> tmp.txt; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">cat</span> tmp.txt &gt;&gt; <span class="variable">$ASEPS</span>/unsignedKexts.txt</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">rm</span> tmp.txt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#run a codesign scan on all kext files</span></span><br><span class="line">codesignDirScan /System/Library/Extensions</span><br><span class="line">codesignDirScan /Library/Extensions</span><br></pre></td></tr></table></figure>

<h3 id="6-collection-filesystem-sh"><a href="#6-collection-filesystem-sh" class="headerlink" title="6. collection_filesystem.sh"></a>6. collection_filesystem.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect artifiacts</span></span><br><span class="line"><span class="built_in">mkdir</span> artifacts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#list of entire directories you wish to collect</span></span><br><span class="line"><span class="built_in">declare</span> -a directories=(</span><br><span class="line">	<span class="comment">#list dirs to collect here. Don&#x27;t include a slash at the end of the dir</span></span><br><span class="line">	<span class="string">&quot;/var/audit&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#list of files you want to collect at the privileged level</span></span><br><span class="line"><span class="built_in">declare</span> -a files=(</span><br><span class="line">	<span class="string">&quot;/var/log/system.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/accountpolicy.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/apache2/access_log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/apache2/error_log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/opendirectoryd.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/secinitd&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/wifi.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/alf.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/appstore.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/authd.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/commerce.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/hdiejectd.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/install.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/Library/Preferences/SystemConfiguration/com.apple.airport.preferences.plist&quot;</span></span><br><span class="line">	<span class="string">&quot;/private/etc/kcpassword&quot;</span> </span><br><span class="line">	<span class="string">&quot;/private/etc/sudoers&quot;</span></span><br><span class="line">	<span class="string">&quot;/private/etc/hosts&quot;</span> </span><br><span class="line">	<span class="string">&quot;/private/etc/resolv.conf&quot;</span></span><br><span class="line">	<span class="string">&quot;/private/var/log/fsck_hfs.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/private/var/db/launchd.db/com.apple.launchd/overrides.plist&quot;</span> </span><br><span class="line">	<span class="string">&quot;/Library/Logs/AppleFileService/AppleFileServiceError.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/var/log/appfirewall.log&quot;</span></span><br><span class="line">	<span class="string">&quot;/etc/profile&quot;</span></span><br><span class="line">	<span class="string">&quot;/etc/bashrc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#list the files at the user level you want to collect here</span></span><br><span class="line"><span class="built_in">declare</span> -a userFiles=(</span><br><span class="line">	<span class="comment">#these are user files paths without the ~ at the beginning. The home directories will be concated later</span></span><br><span class="line">	<span class="string">&quot;Library/Preferences/com.apple.finder.plist&quot;</span></span><br><span class="line">	<span class="string">&quot;Library/Preferences/com.apple.recentitems.plist&quot;</span></span><br><span class="line">	<span class="string">&quot;Library/Preferences/com.apple.loginitems.plist&quot;</span></span><br><span class="line">	<span class="string">&quot;Library/Logs/DiskUtility.log&quot;</span></span><br><span class="line">	<span class="string">&quot;Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2&quot;</span></span><br><span class="line">	<span class="string">&quot;.bash_history&quot;</span></span><br><span class="line">	<span class="string">&quot;.profile&quot;</span></span><br><span class="line">	<span class="string">&quot;.bash_profile&quot;</span></span><br><span class="line">	<span class="string">&quot;.bash_login&quot;</span></span><br><span class="line">	<span class="string">&quot;.bash_logout&quot;</span></span><br><span class="line">	<span class="string">&quot;.bashrc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Collect parsed Apple System Logs with UTC timestamps</span></span><br><span class="line">syslog -T UTC &gt; artifacts/appleSystemLogs.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#collect dirs</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;directories[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="built_in">dirname</span>=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$x</span>&quot;</span> | awk -F <span class="string">&quot;/&quot;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>`</span><br><span class="line">	<span class="built_in">echo</span> created <span class="string">&quot;<span class="variable">$dirname</span>&quot;</span> from <span class="string">&quot;<span class="variable">$x</span>&quot;</span></span><br><span class="line">	<span class="built_in">mkdir</span> artifacts/<span class="string">&quot;<span class="variable">$dirname</span>&quot;</span></span><br><span class="line">	ditto <span class="string">&quot;<span class="variable">$x</span>&quot;</span> artifacts/<span class="string">&quot;<span class="variable">$dirname</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect privileged files</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;files[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	ditto <span class="string">&quot;<span class="variable">$x</span>&quot;</span>* artifacts</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#collect user files for each user</span></span><br><span class="line">dscl . -<span class="built_in">ls</span> /Users | egrep -v ^_ | <span class="keyword">while</span> <span class="built_in">read</span> user </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;userFiles[@]&#125;</span>&quot;</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		fileLocation=<span class="string">&quot;/Users/<span class="variable">$user</span>/<span class="variable">$x</span>&quot;</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;Trying to ditto <span class="variable">$fileLocation</span>&quot;</span></span><br><span class="line">		<span class="keyword">if</span> [ -f <span class="variable">$fileLocation</span> ]; <span class="keyword">then</span></span><br><span class="line">			ditto <span class="string">&quot;<span class="variable">$fileLocation</span>&quot;</span>* artifacts</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="7-file-walker-py"><a href="#7-file-walker-py" class="headerlink" title="7. file_walker.py"></a>7. file_walker.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> stat</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileWalker</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, startDir, dumpdir, md5Bool, whitelist</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(dumpdir):</span><br><span class="line">            os.makedirs(dumpdir)</span><br><span class="line">        self.fileInfo = <span class="string">&quot;%s/fileinfo.txt&quot;</span> % (dumpdir)</span><br><span class="line">        self.fileTimeline = <span class="string">&quot;%s/filetimeline.txt&quot;</span> % (dumpdir)</span><br><span class="line">        self.startDir = startDir</span><br><span class="line">        self.md5Bool = md5Bool</span><br><span class="line">        self.dumpdir = dumpdir</span><br><span class="line">        self.errors = []</span><br><span class="line">        self.fileTypes = &#123;<span class="string">&quot;010&quot;</span>:<span class="string">&quot;file&quot;</span>, <span class="string">&quot;014&quot;</span>:<span class="string">&quot;socket&quot;</span>, <span class="string">&quot;012&quot;</span>:<span class="string">&quot;link&quot;</span>, <span class="string">&quot;060&quot;</span>:<span class="string">&quot;block dev&quot;</span>, <span class="string">&quot;004&quot;</span>:<span class="string">&quot;dir&quot;</span>, <span class="string">&quot;020&quot;</span>:<span class="string">&quot;char dev&quot;</span>, <span class="string">&quot;001&quot;</span>:<span class="string">&quot;FIFO&quot;</span>&#125;</span><br><span class="line">        self.specialbits = &#123;<span class="string">&quot;0&quot;</span>:<span class="string">&quot;None&quot;</span>, <span class="string">&quot;2048&quot;</span>:<span class="string">&quot;SETUID&quot;</span>, <span class="string">&quot;1024&quot;</span>:<span class="string">&quot;SETGID&quot;</span>, <span class="string">&quot;512&quot;</span>:<span class="string">&quot;STICKYBIT&quot;</span>, <span class="string">&quot;3072&quot;</span>:<span class="string">&quot;SETUID/SETGID&quot;</span>, <span class="string">&quot;2560&quot;</span>:<span class="string">&quot;SETUID/STICKYBIT&quot;</span>, <span class="string">&quot;1536&quot;</span>:<span class="string">&quot;SETGID/STICYKBIT&quot;</span>, <span class="string">&quot;3584&quot;</span>:<span class="string">&quot;SETUID/SETGIT/STICKYBIT&quot;</span>&#125;</span><br><span class="line">        self.whitelist = whitelist <span class="keyword">or</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getHash</span>(<span class="params">self, fp</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(fp, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">            m = hashlib.md5()</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                data = fh.read(<span class="number">8192</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                m.update(data)</span><br><span class="line">            <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">formatTime</span>(<span class="params">self, timestamp</span>):</span><br><span class="line">        ts = time.strftime(<span class="string">&quot;%Y-%m-%dT%H:%M:%S&quot;</span>, time.gmtime(timestamp))</span><br><span class="line">        <span class="keyword">return</span> ts</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkTypeSpecial</span>(<span class="params">self, filePath</span>):</span><br><span class="line">        special = filePath.st_mode &amp; stat.S_ISUID + filePath.st_mode &amp; stat.S_ISGID + filePath.st_mode &amp; stat.S_ISVTX</span><br><span class="line">        <span class="keyword">return</span> self.specialbits[<span class="built_in">str</span>(special)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">statFile</span>(<span class="params">self,filePath</span>):</span><br><span class="line">            sr = os.stat(filePath)</span><br><span class="line">            <span class="keyword">return</span> sr, <span class="built_in">getattr</span>(sr, <span class="string">&#x27;st_birthtime&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">collect</span>(<span class="params">self, fileName, fi_fd, time_fd</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            (mode, ino, dev, nlink, uid, gid, size, atime, mtime, ctime), btime = self.statFile(fileName)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#create a string entry for each timestamp</span></span><br><span class="line">            aString = <span class="string">&quot;%s, accessed, %s\n&quot;</span> % (self.formatTime(atime), fileName)</span><br><span class="line">            mString = <span class="string">&quot;%s, modified, %s\n&quot;</span> % (self.formatTime(mtime), fileName)</span><br><span class="line">            cString = <span class="string">&quot;%s, changed, %s\n&quot;</span> % (self.formatTime(ctime), fileName)</span><br><span class="line">            <span class="comment">#add birth time if it exists</span></span><br><span class="line">            <span class="keyword">if</span> btime != <span class="literal">None</span>: bString = <span class="string">&quot;%s, birth, %s\n&quot;</span> % (self.formatTime(btime), fileName)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">#check for special file bits - stickybit should not be found since we aren&#x27;t collecting directories</span></span><br><span class="line">            x = (mode &amp; stat.S_ISUID) + (mode &amp; stat.S_ISGID) + (mode &amp; stat.S_ISVTX)</span><br><span class="line">            special = self.specialbits[<span class="built_in">str</span>(x)]</span><br><span class="line"></span><br><span class="line">            <span class="comment">#create file data for seperate file</span></span><br><span class="line">            filetype = self.fileTypes[<span class="built_in">str</span>(<span class="built_in">oct</span>(mode)[:<span class="number">3</span>])]</span><br><span class="line">            <span class="keyword">if</span> self.md5Bool == <span class="literal">True</span> <span class="keyword">and</span> os.path.isfile(fileName):</span><br><span class="line">                md5 = self.getHash(fileName)</span><br><span class="line">                fileData = <span class="string">&quot;%s, %s, %s, %s, %s, %s, %s, %s\n&quot;</span> % (fileName, <span class="built_in">oct</span>(mode)[-<span class="number">3</span>:], self.fileTypes[<span class="built_in">str</span>(<span class="built_in">oct</span>(mode)[:<span class="number">3</span>])], uid, gid, size, special, md5)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                fileData = <span class="string">&quot;%s, %s, %s, %s, %s, %s, %s\n&quot;</span> % (fileName, <span class="built_in">oct</span>(mode)[-<span class="number">3</span>:], self.fileTypes[<span class="built_in">str</span>(<span class="built_in">oct</span>(mode)[:<span class="number">3</span>])],uid, gid, size, special)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#write data to files</span></span><br><span class="line">            fi_fd.write(fileData)</span><br><span class="line">            time_fd.write(aString)</span><br><span class="line">            time_fd.write(mString)</span><br><span class="line">            time_fd.write(cString)</span><br><span class="line">            <span class="keyword">if</span> btime!=<span class="literal">None</span>:</span><br><span class="line">                time_fd.write(bString)</span><br><span class="line">        <span class="keyword">except</span> OSError:</span><br><span class="line">            self.errors.append(fileName)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Collecting file listing...&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.fileInfo, <span class="string">&#x27;w+a&#x27;</span>) <span class="keyword">as</span> fi_fd, <span class="built_in">open</span>(self.fileTimeline, <span class="string">&#x27;w+a&#x27;</span>) <span class="keyword">as</span> time_fd:</span><br><span class="line">            <span class="keyword">for</span> dirname, dirnames, filenames <span class="keyword">in</span> os.walk(self.startDir, topdown=<span class="literal">True</span>):</span><br><span class="line">                dirnames[:] = [d <span class="keyword">for</span> d <span class="keyword">in</span> dirnames <span class="keyword">if</span> d <span class="keyword">not</span> <span class="keyword">in</span> self.whitelist]</span><br><span class="line">                <span class="keyword">for</span> filename <span class="keyword">in</span> filenames:</span><br><span class="line">                    fileWithPath = os.path.join(dirname, filename)</span><br><span class="line">                    self.collect(fileWithPath, fi_fd, time_fd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#create script arguments</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-s&quot;</span>, <span class="string">&quot;--start&quot;</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&quot;Specify a starting directory&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-d&quot;</span>, <span class="string">&quot;--dumpdir&quot;</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&quot;Specify a directory to store the created files&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-m&quot;</span>, <span class="string">&quot;--md5&quot;</span>, required=<span class="literal">False</span>, action=<span class="string">&#x27;store_true&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;Collect MD5 Hashes&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-w&quot;</span>, <span class="string">&quot;--whitelist&quot;</span>, nargs=<span class="string">&#x27;*&#x27;</span>, required=<span class="literal">False</span>, <span class="built_in">help</span>=<span class="string">&quot;Skip specified directories&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#create a run filewalker</span></span><br><span class="line">    fileWalker = FileWalker(args.start, args.dumpdir, args.md5, args.whitelist)</span><br><span class="line">    fileWalker.run()</span><br></pre></td></tr></table></figure>

<h3 id="8-storyline-py"><a href="#8-storyline-py" class="headerlink" title="8. storyline.py"></a>8. storyline.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line"></span><br><span class="line"><span class="comment">#fix standard log to write UTC timestamps</span></span><br><span class="line"><span class="comment">#fix year timestamp to reflect the year the file was created</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">writeToStory</span>(<span class="params">string</span>):</span><br><span class="line">	outputFile = <span class="string">&#x27;storyline.txt&#x27;</span></span><br><span class="line">	f = <span class="built_in">open</span>(outputFile, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">	f.write(string)</span><br><span class="line">	f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gunzipFiles</span>(<span class="params">fileLocation</span>):</span><br><span class="line">	fileWildcarded = <span class="string">&quot;%s*&quot;</span> % (fileLocation)</span><br><span class="line">	<span class="keyword">for</span> fileName <span class="keyword">in</span> glob.glob(fileWildcarded):</span><br><span class="line">		newFileName = fileName.replace(<span class="string">&#x27;.gz&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">		outputFile = <span class="built_in">open</span>(newFileName, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			inputFile = gzip.<span class="built_in">open</span>(fileName, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">			file_content = inputFile.read()</span><br><span class="line">			outputFile.write(file_content)</span><br><span class="line">			outputFile.close()</span><br><span class="line">		<span class="keyword">except</span> IOError:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#many logs on OS X store entries with this format so we can re-use this function</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">timelineStandardLog</span>(<span class="params">title, fileLocation</span>):</span><br><span class="line">	<span class="built_in">print</span> fileLocation</span><br><span class="line">	now = datetime.datetime.now()</span><br><span class="line">	gunzipFiles(fileLocation)</span><br><span class="line"></span><br><span class="line">	fileWildCarded = <span class="string">&quot;%s*&quot;</span> % (fileLocation)</span><br><span class="line">	<span class="keyword">for</span> fileName <span class="keyword">in</span> glob.glob(fileWildCarded):</span><br><span class="line">		<span class="keyword">with</span> <span class="built_in">open</span>(fileName) <span class="keyword">as</span> f:</span><br><span class="line">			<span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">				<span class="comment">#grab the timestamp</span></span><br><span class="line">				ts = line.split()[:<span class="number">3</span>]</span><br><span class="line">				ts = <span class="string">&#x27; &#x27;</span>.join(ts)</span><br><span class="line">				<span class="comment">#add the current year to the syslog becase it does not contain it</span></span><br><span class="line">				ts = <span class="string">&quot;%s %s&quot;</span> % (now.year, ts)</span><br><span class="line"></span><br><span class="line">				<span class="comment">#grab the rest of the log</span></span><br><span class="line">				info = line.split()[<span class="number">4</span>:]</span><br><span class="line">				info = <span class="string">&#x27; &#x27;</span>.join (info)</span><br><span class="line">				<span class="keyword">try</span>:</span><br><span class="line">					t = time.strptime(ts, <span class="string">&quot;%Y %b %d %H:%M:%S&quot;</span>)</span><br><span class="line">					logEntry = <span class="string">&quot;%s, %s, %s\n&quot;</span> % (time.strftime(<span class="string">&quot;%Y-%m-%dT%H:%M:%S&quot;</span>, t), title, info)</span><br><span class="line">					<span class="built_in">print</span> logEntry</span><br><span class="line">					writeToStory(logEntry)</span><br><span class="line"></span><br><span class="line">				<span class="keyword">except</span> ValueError:</span><br><span class="line">					<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">timelineQuarantine</span>(<span class="params">fileName</span>):</span><br><span class="line">    conn = sqlite3.connect(fileName)</span><br><span class="line">	c = conn.cursor()</span><br><span class="line">	<span class="comment">#EventIdentifier, TimeStamp, AgentBundleIdentifier, Name, DataURLString SenderName SenderAddress TypeNumber OriginTitle OriginURLString LSQuarantineOriginAlias</span></span><br><span class="line">	<span class="keyword">for</span> row <span class="keyword">in</span> c.execute(<span class="string">&#x27;SELECT * FROM LSQuarantineEvent&#x27;</span>):</span><br><span class="line">		ts = time.gmtime(row[<span class="number">1</span>])</span><br><span class="line">		</span><br><span class="line">		ose = (<span class="built_in">int</span>(time.mktime(datetime.date(<span class="number">2001</span>,<span class="number">1</span>,<span class="number">1</span>).timetuple())) - time.timezone)</span><br><span class="line">		nts = (time.strftime(<span class="string">&#x27;%Y-%m-%dT%H:%M:%S&#x27;</span>, time.gmtime(ose+row[<span class="number">1</span>])))</span><br><span class="line">		</span><br><span class="line">		info = row[<span class="number">2</span>:]</span><br><span class="line">		info = <span class="string">&quot;&quot;</span>.join(<span class="built_in">str</span>(info))</span><br><span class="line">		logEntry = <span class="string">&quot;%s, QUARANTINE, %s\n&quot;</span> % (nts, info)</span><br><span class="line">		<span class="built_in">print</span> logEntry</span><br><span class="line">		writeToStory(logEntry)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	timelineStandardLog(<span class="string">&#x27;SYSLOG&#x27;</span>, <span class="string">&#x27;artifacts/system.log&#x27;</span>)</span><br><span class="line">	timelineStandardLog(<span class="string">&#x27;APPFirewall&#x27;</span>, <span class="string">&#x27;artifacts/appfirewall.log&#x27;</span>)</span><br><span class="line">	timelineStandardLog(<span class="string">&#x27;INSTALL&#x27;</span>, <span class="string">&#x27;artifacts/install.log&#x27;</span>)</span><br><span class="line">	timelineStandardLog(<span class="string">&#x27;ACCOUNTPOLICY&#x27;</span>, <span class="string">&#x27;artifacts/accountpolicy.log&#x27;</span>)</span><br><span class="line">	timelineQuarantine(<span class="string">&#x27;artifacts/com.apple.LaunchServices.QuarantineEventsV2&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="9-browser-collect-sh"><a href="#9-browser-collect-sh" class="headerlink" title="9. browser_collect.sh"></a>9. browser_collect.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Copying browser data...&quot;</span></span><br><span class="line">browserfolder=<span class="string">&quot;browserHistory&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$browserfolder</span></span><br><span class="line"></span><br><span class="line">dscl . -<span class="built_in">ls</span> /Users | egrep -v ^_ | <span class="keyword">while</span> <span class="built_in">read</span> user </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">	<span class="comment">#check for and copy Safari data</span></span><br><span class="line">	<span class="comment">#Safari is pretty much garenteed to be installed</span></span><br><span class="line">	<span class="keyword">if</span> [ -d  <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Safari/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		plutil -convert xml1 /Users/<span class="variable">$user</span>/Library/Safari/History.plist -o <span class="string">&quot;<span class="variable">$browserfolder</span>/<span class="variable">$user</span>&quot;</span>_safariHistory.plist</span><br><span class="line">		plutil -convert xml1 /Users/<span class="variable">$user</span>/Library/Safari/Downloads.plist -o <span class="string">&quot;<span class="variable">$browserfolder</span>/<span class="variable">$user</span>&quot;</span>_safariDownloads.plist</span><br><span class="line"></span><br><span class="line">		<span class="comment">#grab the sqlite3 version of the history if you prefer</span></span><br><span class="line">		ditto <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Safari/Downloads.plist&quot;</span> <span class="string">&quot;<span class="variable">$browserfolder</span>/<span class="variable">$user</span>&quot;</span>_safariDownloads.plist</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#check for and copy Chrome data</span></span><br><span class="line">	<span class="keyword">if</span> [ -d  <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/Google/Chrome/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		ditto <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/Google/Chrome/Default/History&quot;</span> <span class="string">&quot;<span class="variable">$browserfolder</span>/<span class="variable">$user</span>&quot;</span>_chromeHistory.db</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#check for and copy firefox data</span></span><br><span class="line">	<span class="comment">#there should only be one profile inside the Profiles directory</span></span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/Firefox/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">for</span> PROFILE <span class="keyword">in</span> /Users/<span class="variable">$user</span>/Library/Application\ Support/Firefox/Profiles/*; <span class="keyword">do</span></span><br><span class="line">			ditto <span class="string">&quot;<span class="variable">$PROFILE</span>/places.sqlite&quot;</span> <span class="string">&quot;<span class="variable">$browserfolder</span>/<span class="variable">$user</span>&quot;</span>_firefoxHistory.db</span><br><span class="line">		<span class="keyword">done</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#check for and copy Opera data</span></span><br><span class="line">	<span class="keyword">if</span> [ -d <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/com.operasoftware.Opera/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		ditto <span class="string">&quot;/Users/<span class="variable">$user</span>/Library/Application Support/com.operasoftware.Opera/History&quot;</span> <span class="string">&quot;<span class="variable">$browserfolder</span>/<span class="variable">$user</span>&quot;</span>_operaHistory.db</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="10-browser-parser-py"><a href="#10-browser-parser-py" class="headerlink" title="10. browser_parser.py"></a>10. browser_parser.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> plistlib</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">dt_lookup = &#123;</span><br><span class="line">    <span class="number">0</span>: <span class="string">&#x27;CLEAN&#x27;</span>, </span><br><span class="line">    <span class="number">1</span>: <span class="string">&#x27;DANGEROUS_FILE&#x27;</span>, </span><br><span class="line">    <span class="number">2</span>: <span class="string">&#x27;DANGEROUS_URL&#x27;</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">&#x27;DANGEROUS_CONTENT&#x27;</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="string">&#x27;MAYBE_DANGEROUS_CONTENT&#x27;</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="string">&#x27;UNCOMMON_CONTENT&#x27;</span>,</span><br><span class="line">    <span class="number">6</span>: <span class="string">&#x27;USER_VALIDATED&#x27;</span>,</span><br><span class="line">    <span class="number">7</span>: <span class="string">&#x27;DANGEROUS_HOST&#x27;</span>,</span><br><span class="line">    <span class="number">8</span>: <span class="string">&#x27;POTENTIALLY_UNWANTED&#x27;</span>,</span><br><span class="line">    <span class="number">9</span>: <span class="string">&#x27;MAX&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printToFile</span>(<span class="params">string</span>):</span><br><span class="line">    output_file = <span class="string">&#x27;browserHistory.txt&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> fd:</span><br><span class="line">        fd.write(string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convertAppleTime</span>(<span class="params">appleFormattedDate</span>):</span><br><span class="line">    ose = (<span class="built_in">int</span>(time.mktime(datetime.date(<span class="number">2001</span>,<span class="number">1</span>,<span class="number">1</span>).timetuple())) - time.timezone)</span><br><span class="line">    appleFormattedDate = <span class="built_in">float</span>(appleFormattedDate)</span><br><span class="line">    ts = (time.strftime(<span class="string">&#x27;%Y-%m-%dT%H:%M:%S&#x27;</span>, time.gmtime(ose+appleFormattedDate)))</span><br><span class="line">    <span class="keyword">return</span> ts</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parseSafariHistoryplist</span>(<span class="params">histFile</span>):</span><br><span class="line">    historyData = plistlib.readPlist(histFile)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> historyData[<span class="string">&#x27;WebHistoryDates&#x27;</span>]:</span><br><span class="line">        string = <span class="string">&quot;%s, safari_history, %s\n&quot;</span> % (convertAppleTime(x[<span class="string">&#x27;lastVisitedDate&#x27;</span>]), x[<span class="string">&#x27;&#x27;</span>])</span><br><span class="line">        printToFile(string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parseSafariHistorydb</span>(<span class="params">histFile</span>):</span><br><span class="line">    <span class="comment">#need to convert timestamp still.</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Parsing Safari&quot;</span>)</span><br><span class="line">    conn = sqlite3.connect(histFile)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    query = <span class="string">&quot;&quot;&quot;SELECT </span></span><br><span class="line"><span class="string">                    h.visit_time,</span></span><br><span class="line"><span class="string">                    i.url</span></span><br><span class="line"><span class="string">                FROM </span></span><br><span class="line"><span class="string">                    history_visits h</span></span><br><span class="line"><span class="string">                INNER JOIN</span></span><br><span class="line"><span class="string">                    history_items i ON h.history_item = i.id&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> visit_t, url <span class="keyword">in</span> c.execute(query):</span><br><span class="line">        string = <span class="string">&quot;%s, safari_history, %s\n&quot;</span> % (convertAppleTime(visit_t), url)</span><br><span class="line">        printToFile(string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parseSafariDownloadsplist</span>(<span class="params">histfile</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Parsing Safari Downloads&quot;</span>)</span><br><span class="line">    historyData = plistlib.readPlist(histfile)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> historyData[<span class="string">&#x27;DownloadHistory&#x27;</span>]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            string = <span class="string">&quot;%s, safari_download, %s, %s\n&quot;</span> % (x[<span class="string">&#x27;DownloadEntryDateAddedKey&#x27;</span>], x[<span class="string">&#x27;DownloadEntryURL&#x27;</span>], x[<span class="string">&#x27;DownloadEntryPath&#x27;</span>])</span><br><span class="line">            printToFile(string)</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            string = <span class="string">&quot;safari_download, %s, %s\n&quot;</span> % (x[<span class="string">&#x27;DownloadEntryURL&#x27;</span>], x[<span class="string">&#x27;DownloadEntryPath&#x27;</span>])</span><br><span class="line">            printToFile(string)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parseChromeHistory</span>(<span class="params">histFile</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Parsing Chrome&quot;</span>)</span><br><span class="line">    conn = sqlite3.connect(histFile)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    query = <span class="string">&quot;&quot;&quot;SELECT </span></span><br><span class="line"><span class="string">                    strftime(&#x27;%Y-%m-%dT%H:%M:%S&#x27;, (v.visit_time/1000000)-11644473600, &#x27;unixepoch&#x27;),</span></span><br><span class="line"><span class="string">                    u.url</span></span><br><span class="line"><span class="string">                FROM</span></span><br><span class="line"><span class="string">                    visits v </span></span><br><span class="line"><span class="string">                INNER JOIN </span></span><br><span class="line"><span class="string">                    urls u ON u.id = v.url;&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> dt, url <span class="keyword">in</span> c.execute(query):</span><br><span class="line">        string = <span class="string">&quot;%s, chrome_history, %s\n&quot;</span> % (dt, url)</span><br><span class="line">        printToFile(string)</span><br><span class="line"></span><br><span class="line">    query = <span class="string">&quot;&quot;&quot;SELECT </span></span><br><span class="line"><span class="string">                    strftime(&#x27;%Y-%m-%dT%H:%M:%S&#x27;, (d.start_time/1000000)-11644473600, &#x27;unixepoch&#x27;),</span></span><br><span class="line"><span class="string">                    dc.url,</span></span><br><span class="line"><span class="string">                    d.target_path,</span></span><br><span class="line"><span class="string">                    d.danger_type,</span></span><br><span class="line"><span class="string">                    d.opened</span></span><br><span class="line"><span class="string">                FROM </span></span><br><span class="line"><span class="string">                    downloads d</span></span><br><span class="line"><span class="string">                INNER JOIN</span></span><br><span class="line"><span class="string">                    downloads_url_chains dc ON dc.id = d.id;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> dt, referrer, target, danger_type, opened <span class="keyword">in</span> c.execute(query):</span><br><span class="line">        string = <span class="string">&quot;%s, chrome_download, %s, %s, danger_type:%s, opened:%s\n&quot;</span> % (dt, referrer, target, </span><br><span class="line">                                                                               dt_lookup[danger_type], opened)</span><br><span class="line">        printToFile(string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parseOperaHistory</span>(<span class="params">histFile</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Parsing Opera&quot;</span>)</span><br><span class="line">    conn = sqlite3.connect(histFile)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    query = <span class="string">&quot;&quot;&quot;SELECT </span></span><br><span class="line"><span class="string">                    strftime(&#x27;%Y-%m-%dT%H:%M:%S&#x27;, (v.visit_time/1000000)-11644473600, &#x27;unixepoch&#x27;),</span></span><br><span class="line"><span class="string">                    u.url, </span></span><br><span class="line"><span class="string">                    u.title </span></span><br><span class="line"><span class="string">                FROM </span></span><br><span class="line"><span class="string">                    visits v</span></span><br><span class="line"><span class="string">                INNER JOIN </span></span><br><span class="line"><span class="string">                    urls u ON u.id = v.url;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> c.execute(query):</span><br><span class="line">        string = <span class="string">&quot;%s, opera_history, %s\n&quot;</span> % (row[<span class="number">0</span>], row[<span class="number">1</span>])</span><br><span class="line">        printToFile(string)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#parse Opera downloads  </span></span><br><span class="line">    query = <span class="string">&quot;&quot;&quot;SELECT </span></span><br><span class="line"><span class="string">                    strftime(&#x27;%Y-%m-%dT%H:%M:%S&#x27;, (d.start_time/1000000)-11644473600, &#x27;unixepoch&#x27;),</span></span><br><span class="line"><span class="string">                    dc.url,</span></span><br><span class="line"><span class="string">                    d.target_path,</span></span><br><span class="line"><span class="string">                    d.danger_type,</span></span><br><span class="line"><span class="string">                    d.opened</span></span><br><span class="line"><span class="string">                FROM </span></span><br><span class="line"><span class="string">                    downloads d</span></span><br><span class="line"><span class="string">                INNER JOIN</span></span><br><span class="line"><span class="string">                    downloads_url_chains dc ON dc.id = d.id;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> c.execute(query):</span><br><span class="line">        string = <span class="string">&quot;%s, opera_download, %s, %s, danger_type:%s, opened:%s\n&quot;</span> % (row[<span class="number">0</span>], row[<span class="number">1</span>], row[<span class="number">2</span>], dt_lookup[row[<span class="number">3</span>]], row[<span class="number">4</span>])</span><br><span class="line">        printToFile(string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parseFirefoxHistory</span>(<span class="params">histFile</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Parsing Firefox&quot;</span>)</span><br><span class="line">    conn = sqlite3.connect(histFile)</span><br><span class="line">    c = conn.cursor()</span><br><span class="line">    query = <span class="string">&quot;&quot;&quot;SELECT </span></span><br><span class="line"><span class="string">                    strftime(&#x27;%Y-%m-%dT%H:%M:%S&#x27;,hv.visit_date/1000000, &#x27;unixepoch&#x27;) as dt, </span></span><br><span class="line"><span class="string">                    p.url</span></span><br><span class="line"><span class="string">                FROM </span></span><br><span class="line"><span class="string">                    moz_historyvisits hv</span></span><br><span class="line"><span class="string">                INNER JOIN</span></span><br><span class="line"><span class="string">                    moz_places p ON hv.place_id = p.id</span></span><br><span class="line"><span class="string">                ORDER by dt ASC;&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> dt, url <span class="keyword">in</span> c.execute(query):</span><br><span class="line">        string = <span class="string">&quot;%s, firefox_history, %s\n&quot;</span> % (dt, url)</span><br><span class="line">        printToFile(string)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#FireFox parse firefox downloads</span></span><br><span class="line">    query = <span class="string">&quot;&quot;&quot;SELECT </span></span><br><span class="line"><span class="string">                    strftime(&#x27;%Y-%m-%dT%H:%M:%S&#x27;, a.dateAdded/1000000, &#x27;unixepoch&#x27;) as dt,</span></span><br><span class="line"><span class="string">                    a.content, </span></span><br><span class="line"><span class="string">                    p.url </span></span><br><span class="line"><span class="string">                FROM </span></span><br><span class="line"><span class="string">                    moz_annos a </span></span><br><span class="line"><span class="string">                INNER JOIN  </span></span><br><span class="line"><span class="string">                    moz_places p ON p.id = a.place_id</span></span><br><span class="line"><span class="string">                WHERE</span></span><br><span class="line"><span class="string">                    a.anno_attribute_id = 6</span></span><br><span class="line"><span class="string">                ORDER BY dt ASC;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> dt, content, url <span class="keyword">in</span> c.execute(query):</span><br><span class="line">        string = <span class="string">&quot;%s, firefox_download, %s, %s\n&quot;</span> % (dt, content, url)</span><br><span class="line">        printToFile(string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Parsing Browser History...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    safariDBFound = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> glob.glob(<span class="string">&#x27;browserHistory/*.db&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> filename.endswith(<span class="string">&#x27;chromeHistory.db&#x27;</span>):</span><br><span class="line">            parseChromeHistory(filename)</span><br><span class="line">        <span class="keyword">elif</span> filename.endswith(<span class="string">&#x27;firefoxHistory.db&#x27;</span>):</span><br><span class="line">            parseFirefoxHistory(filename)</span><br><span class="line">        <span class="keyword">elif</span> filename.endswith(<span class="string">&#x27;operaHistory.db&#x27;</span>):</span><br><span class="line">            parseOperaHistory(filename)</span><br><span class="line">        <span class="keyword">elif</span> filename.endswith(<span class="string">&#x27;safariHistory.db&#x27;</span>):</span><br><span class="line">            parseSafariHistorydb(filename)</span><br><span class="line">            safariDBFound = <span class="literal">True</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> glob.glob(<span class="string">&#x27;browserHistory/*.plist&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> filename.endswith(<span class="string">&#x27;safariHistory.plist&#x27;</span>) <span class="keyword">and</span> safariDBFound == <span class="literal">False</span>:</span><br><span class="line">            parseSafariHistoryplist(filename)</span><br><span class="line">        <span class="keyword">elif</span> filename.endswith(<span class="string">&#x27;safariDownloads.plist&#x27;</span>):</span><br><span class="line">            parseSafariDownloadsplist(filename)</span><br></pre></td></tr></table></figure>

<h3 id="11-memory-collection-sh"><a href="#11-memory-collection-sh" class="headerlink" title="11. memory_collection.sh"></a>11. memory_collection.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#collect memory</span></span><br><span class="line"><span class="comment">#requires osxpmem.zip be inside the tools directory</span></span><br><span class="line"><span class="comment">#requires rekall be inside the tools directory</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#scenario 1 -&gt; full memory acquisition</span></span><br><span class="line"><span class="comment">#scenario 2 -&gt; collect memory strings and live memory commands</span></span><br><span class="line"><span class="comment">#scenario 3 -&gt; collect only live memory commands</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#scenario 1 set by default</span></span><br><span class="line">scenario=1</span><br><span class="line">IRfolder=collection</span><br><span class="line">rekallOutputFolder=<span class="variable">$IRfolder</span>/rekall</span><br><span class="line">memArtifacts=<span class="variable">$IRfolder</span>/memory.aff4</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">$IRfolder</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#if going with the live memory scenario, set Rekall commands here</span></span><br><span class="line"><span class="keyword">function</span> runRekallCommands &#123; </span><br><span class="line">	<span class="built_in">mkdir</span> <span class="variable">$rekallOutputFolder</span></span><br><span class="line">	tools/rekall/rekal -f /dev/pmem arp --output <span class="variable">$rekallOutputFolder</span>/rekall_arp.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem lsmod --output <span class="variable">$rekallOutputFolder</span>/rekall_lsmod.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem check_syscalls --output <span class="variable">$rekallOutputFolder</span>/rekall_check_syscalls.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem psxview --output <span class="variable">$rekallOutputFolder</span>/rekall_psxview.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem pstree --output <span class="variable">$rekallOutputFolder</span>/rekall_pstree.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem dead_procs --output <span class="variable">$rekallOutputFolder</span>/rekall_dead_procs.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem psaux --output <span class="variable">$rekallOutputFolder</span>/rekall_psaux.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem route --output <span class="variable">$rekallOutputFolder</span>/rekall_route.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem sessions --output <span class="variable">$rekallOutputFolder</span>/rekall_sessions.txt</span><br><span class="line">	tools/rekall/rekal -f /dev/pmem netstat --output <span class="variable">$rekallOutputFolder</span>/rekall_netstat.txt</span><br><span class="line">	<span class="comment">#add any additional Rekall commands you want to run here</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> collectSwap &#123;</span><br><span class="line">	<span class="comment">#Check if swap files are encrpyted and collect if they&#x27;re not</span></span><br><span class="line">	<span class="keyword">if</span> ! sysctl vm.swapusage | grep -q encrypted; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;Collecting swap memory...&quot;</span></span><br><span class="line">		osxpmem.app/osxpmem -i /private/var/vm/sleepimage -o <span class="variable">$memArtifacts</span></span><br><span class="line">		osxpmem.app/osxpmem -i /private/var/vm/swapfile* -o <span class="variable">$memArtifacts</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;Swapfiles encrypted. Skipping...&quot;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Starting memory collection...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#unzip osxpmem app to current directory</span></span><br><span class="line">unzip tools/osxpmem.zip &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment">#modify permissionbs on kext file so we can load it</span></span><br><span class="line"><span class="built_in">chown</span> -R root:wheel osxpmem.app/MacPmem.kext</span><br><span class="line"></span><br><span class="line"><span class="comment">#try to load kext</span></span><br><span class="line"><span class="keyword">if</span> kextload osxpmem.app/MacPmem.kext; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;MacPmem Kext loaded&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;ERROR: MacPmem Kext failed to load. Can not collect memory.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$scenario</span> <span class="keyword">in</span></span><br><span class="line">	1)</span><br><span class="line">		<span class="comment">#scenario 1 -&gt; full memory acquisition</span></span><br><span class="line">		osxpmem.app/osxpmem -o <span class="variable">$memArtifacts</span> &gt; /dev/null</span><br><span class="line">		collectSwap</span><br><span class="line">		;;</span><br><span class="line">	2)</span><br><span class="line">		<span class="comment">#scenario 2 -&gt; collect memory strings and live memory commands</span></span><br><span class="line">		osxpmem.app/osxpmem -o <span class="variable">$memArtifacts</span> &gt; /dev/null</span><br><span class="line">		osxpmem.app/osxpmem --<span class="built_in">export</span> /dev/pmem --output memory.dmp <span class="variable">$memArtifacts</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;Running strings on memory dump...&quot;</span></span><br><span class="line">		strings memory.dmp &gt; <span class="variable">$IRfolder</span>/memory.strings</span><br><span class="line"></span><br><span class="line">		<span class="comment">#run Recall commands</span></span><br><span class="line">		runRekallCommands</span><br><span class="line">		</span><br><span class="line">		<span class="comment">#clean up since these files may take up a lot of hard drive space</span></span><br><span class="line">		<span class="built_in">rm</span> <span class="variable">$memArtifacts</span></span><br><span class="line">		<span class="built_in">rm</span> memory.dmp</span><br><span class="line">		<span class="comment">#test</span></span><br><span class="line">		;;</span><br><span class="line">	3)</span><br><span class="line">		<span class="comment">#scenario 3 -&gt; collect only live memory commands</span></span><br><span class="line">		runRekallCommands</span><br><span class="line">		;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Unloading MacPmem.kext&quot;</span></span><br><span class="line">kextunload osxpmem.app/MacPmem.kext</span><br></pre></td></tr></table></figure>

<h3 id="12-exfiltrator-py"><a href="#12-exfiltrator-py" class="headerlink" title="12. exfiltrator.py"></a>12. exfiltrator.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Exfiltrator</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, outputFile</span>):</span><br><span class="line">		self.whiteList = [<span class="string">&quot;zip&quot;</span>, <span class="string">&quot;jar&quot;</span>, <span class="string">&quot;rar&quot;</span>, <span class="string">&quot;egg&quot;</span>, <span class="string">&quot;package&quot;</span>, <span class="string">&quot;plist&quot;</span>, <span class="string">&quot;xlsx&quot;</span>, <span class="string">&quot;docx&quot;</span>, <span class="string">&quot;pptx&quot;</span>, <span class="string">&quot;cdt&quot;</span>, <span class="string">&quot;xpi&quot;</span>, <span class="string">&quot;ots&quot;</span>, <span class="string">&quot;ods&quot;</span>, <span class="string">&quot;dotm&quot;</span>, <span class="string">&quot;apk&quot;</span> ]</span><br><span class="line">		self.enableOutput = <span class="literal">False</span></span><br><span class="line">		self.outputFile = outputFile</span><br><span class="line">		<span class="keyword">if</span> self.outputFile != <span class="literal">None</span>:</span><br><span class="line">			self.enableOutput = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">getFileHeader</span>(<span class="params">self, fileLocation</span>):</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			f = <span class="built_in">open</span>(fileLocation)</span><br><span class="line">			header = f.read(<span class="number">4</span>)</span><br><span class="line">			header = header.encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">			<span class="keyword">return</span> header</span><br><span class="line">		<span class="keyword">except</span> IOError:</span><br><span class="line">			<span class="built_in">print</span> <span class="string">&quot;\nError reading %s. Skipping...&quot;</span> % (fileLocation)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">checkWhiteList</span>(<span class="params">self,fileLocation</span>):</span><br><span class="line">		found = <span class="literal">False</span></span><br><span class="line">		<span class="keyword">for</span> extension <span class="keyword">in</span> self.whiteList:</span><br><span class="line">			<span class="keyword">if</span> fileLocation.endswith(extension):</span><br><span class="line">				found = <span class="literal">True</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">return</span> found</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">checkFile</span>(<span class="params">self, fileLocation</span>):</span><br><span class="line">		<span class="built_in">print</span> fileLocation</span><br><span class="line">		isFile = os.path.isfile(fileLocation)</span><br><span class="line">		isWhiteListed = self.checkWhiteList(fileLocation)</span><br><span class="line">		<span class="keyword">if</span> isFile == <span class="literal">False</span>:</span><br><span class="line">			header = <span class="literal">None</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			header = self.getFileHeader(fileLocation)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> header <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> isWhiteListed == <span class="literal">True</span>:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line">		<span class="keyword">elif</span> header == <span class="string">&quot;504b0304&quot;</span>:</span><br><span class="line">			<span class="built_in">print</span> <span class="string">&quot;\nPKzip file format found&quot;</span></span><br><span class="line">			ts = datetime.datetime.fromtimestamp(os.path.getmtime(fileLocation))</span><br><span class="line">			string = <span class="string">&quot;%s %s&quot;</span> % (ts, fileLocation)</span><br><span class="line">			<span class="keyword">if</span> self.enableOutput == <span class="literal">True</span>:</span><br><span class="line">				<span class="built_in">print</span> fileLocation</span><br><span class="line">				self.writeToFile(string + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				<span class="built_in">print</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">writeToFile</span>(<span class="params">self, data</span>):</span><br><span class="line">		f = <span class="built_in">open</span>(self.outputFile, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">		f.write(data)</span><br><span class="line">		f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">	parser = argparse.ArgumentParser()</span><br><span class="line">	parser.add_argument(<span class="string">&quot;-a&quot;</span>, <span class="string">&quot;--all&quot;</span>, required=<span class="literal">False</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Scan all files on system&quot;</span>)</span><br><span class="line">	parser.add_argument(<span class="string">&quot;-s&quot;</span>, <span class="string">&quot;--start&quot;</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&quot;Specify a starting directory&quot;</span>)</span><br><span class="line">	parser.add_argument(<span class="string">&quot;-o&quot;</span>, <span class="string">&quot;--output&quot;</span>, required=<span class="literal">False</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&quot;Output results to specified file&quot;</span>)</span><br><span class="line"></span><br><span class="line">	args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">	exfiltrator = Exfiltrator(args.output)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#walk each directory</span></span><br><span class="line">	<span class="keyword">for</span> dirname, dirnames, filenames <span class="keyword">in</span> os.walk(args.start):</span><br><span class="line">		<span class="keyword">for</span> filename <span class="keyword">in</span> filenames:</span><br><span class="line">			fileWithPath = os.path.join(dirname, filename)</span><br><span class="line">			<span class="comment">#print &quot;scanning %s&quot; % (fileWithPath)</span></span><br><span class="line">			exfiltrator.checkFile(fileWithPath)</span><br></pre></td></tr></table></figure>

<h2 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF Reference"></a>0xFF Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.sentinelone.com/wp-content/uploads/2017/06/SentinalOne_macOS_Threat_Hunting_and_Incident_Response_A_Complete_Guide_17032020-1.pdf">macOS_Threat_Hunting_and_Incident_Response_A_Complete_Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elsevier.com/books/os-x-incident-response/bradley/978-0-12-804456-8">OS X Incident Response: Scripting and Analysis</a></li>
<li><a target="_blank" rel="noopener" href="https://davidkoepi.wordpress.com/category/mac-forensics/">https://davidkoepi.wordpress.com/category/mac-forensics/</a></li>
<li><a target="_blank" rel="noopener" href="https://objective-see.org/tools.html">https://objective-see.org/tools.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Yelp/osxcollector">https://github.com/Yelp/osxcollector</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jipegit/OSXAuditor">https://github.com/jipegit/OSXAuditor</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/DFIR/" rel="tag" <i class="fa fa-tag"></i> DFIR</a>
              <a href="/tags/Incident-Response/" rel="tag" <i class="fa fa-tag"></i> Incident Response</a>
              <a href="/tags/MacOS/" rel="tag" <i class="fa fa-tag"></i> MacOS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/72019/" rel="prev" title="HIDS数据采集项总结">
                  <i class="fa fa-chevron-left"></i> HIDS数据采集项总结
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/19880/" rel="next" title="反弹shell检测技术研究">
                  反弹shell检测技术研究 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">L0n9w4y</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
