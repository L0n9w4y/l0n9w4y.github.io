<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"l0n9w4y.cc","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Wazuh 是一款开源和企业级的安全平台，诞生于OSSEC HIDS，后来与Elastic Stack和OpenSCAP集成，演变成更全面的解决方案，用于威胁检测、完整性监控、事件响应和合规审计，本文记录Wazuh使用体验、探究各项检测能力...">
<meta property="og:type" content="article">
<meta property="og:title" content="开源HIDS之Wazuh探究">
<meta property="og:url" content="https://l0n9w4y.cc/posts/22306/index.html">
<meta property="og:site_name" content="L0n9w4y">
<meta property="og:description" content="Wazuh 是一款开源和企业级的安全平台，诞生于OSSEC HIDS，后来与Elastic Stack和OpenSCAP集成，演变成更全面的解决方案，用于威胁检测、完整性监控、事件响应和合规审计，本文记录Wazuh使用体验、探究各项检测能力...">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/deployment1.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/data-flow1.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/architecture-agent1.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/architecture-server1.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/wazuh_port.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/log-analysis-flow1.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/fim-flow1.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/rootcheck-flow1.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/rootkitcheck.png">
<meta property="og:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/automatic-remediation1.png">
<meta property="article:published_time" content="2022-07-16T14:33:29.000Z">
<meta property="article:modified_time" content="2022-12-06T15:28:20.641Z">
<meta property="article:author" content="L0n9w4y">
<meta property="article:tag" content="Intrusion Detection">
<meta property="article:tag" content="HIDS">
<meta property="article:tag" content="Wazuh">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/deployment1.png">


<link rel="canonical" href="https://l0n9w4y.cc/posts/22306/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://l0n9w4y.cc/posts/22306/","path":"posts/22306/","title":"开源HIDS之Wazuh探究"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>开源HIDS之Wazuh探究 | L0n9w4y</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L0n9w4y</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-攻防"><a href="/security/" rel="section"><i class="fa fa-navicon fa-fw"></i>攻防</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%9F%BA%E7%A1%80%E7%AE%80%E4%BB%8B"><span class="nav-text">0x01 基础简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%BB%84%E6%88%90%E6%9E%B6%E6%9E%84"><span class="nav-text">1. 组成架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="nav-text">2. 安装部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-text">0x02 配置管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Server%E7%AE%A1%E7%90%86"><span class="nav-text">1. Server管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="nav-text">a. 远程服务配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6%E7%AD%89%E7%BA%A7%E9%98%88%E5%80%BC"><span class="nav-text">b. 定义告警等级阈值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E9%9B%86%E6%88%90%E5%A4%96%E9%83%A8API"><span class="nav-text">c. 集成外部API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E9%85%8D%E7%BD%AE-syslog-%E8%BE%93%E5%87%BA"><span class="nav-text">d. 配置 syslog 输出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#e-%E7%94%9F%E6%88%90%E8%87%AA%E5%8A%A8%E5%8C%96%E6%8A%A5%E5%91%8A"><span class="nav-text">e. 生成自动化报告</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#f-%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E8%AD%A6%E6%8A%A5"><span class="nav-text">f. 配置邮件警报</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Agent-%E7%AE%A1%E7%90%86"><span class="nav-text">2. Agent 管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-Agent%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">a. Agent生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E5%88%97%E5%87%BAagent"><span class="nav-text">b. 列出agent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E7%A7%BB%E9%99%A4agent"><span class="nav-text">c. 移除agent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E6%A3%80%E6%9F%A5%E4%B8%8EServer%E7%9A%84%E8%BF%9E%E6%8E%A5"><span class="nav-text">d. 检查与Server的连接</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%8F%82%E8%80%83%E9%80%9F%E6%9F%A5"><span class="nav-text">3. 参考速查</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E6%9C%AC%E5%9C%B0%E9%85%8D%E7%BD%AE%EF%BC%88ossec-conf%EF%BC%89"><span class="nav-text">a. 本地配置（ossec.conf）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E9%9B%86%E4%B8%AD%E9%85%8D%E7%BD%AE%EF%BC%88agent-conf%EF%BC%89"><span class="nav-text">b. 集中配置（agent.conf）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E8%A1%A8"><span class="nav-text">c. 守护进程表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E5%B7%A5%E5%85%B7%E9%80%9F%E6%9F%A5%E8%A1%A8"><span class="nav-text">d. 工具速查表</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E8%A7%84%E5%88%99%E8%AF%A6%E8%A7%A3"><span class="nav-text">0x03 规则详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6"><span class="nav-text">1. 目录文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Json%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="nav-text">2. Json解码器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99-x2F-%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="nav-text">3. 自定义规则&#x2F;解码器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8%E5%92%8C%E8%A7%84%E5%88%99"><span class="nav-text">a. 添加新的解码器和规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E6%9B%B4%E6%94%B9%E7%8E%B0%E6%9C%89%E8%A7%84%E5%88%99"><span class="nav-text">b. 更改现有规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E6%9B%B4%E6%94%B9%E7%8E%B0%E6%9C%89%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="nav-text">c. 更改现有解码器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%8A%A8%E6%80%81%E5%AD%97%E6%AE%B5"><span class="nav-text">4. 动态字段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E4%BC%A0%E7%BB%9F%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="nav-text">a. 传统解码器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E5%8A%A8%E6%80%81%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="nav-text">b. 动态解码器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-XML%E6%A0%BC%E5%BC%8F%E8%A7%84%E5%88%99%E9%9B%86"><span class="nav-text">5. XML格式规则集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E8%A7%A3%E7%A0%81%E5%99%A8%E8%AF%AD%E6%B3%95"><span class="nav-text">a. 解码器语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E8%A7%84%E5%88%99%E8%AF%AD%E6%B3%95"><span class="nav-text">b. 规则语法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-%E5%AE%89%E5%85%A8%E8%83%BD%E5%8A%9B"><span class="nav-text">0x04 安全能力</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="nav-text">1. 日志数据分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="nav-text">a. 日志文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E8%BF%9C%E7%A8%8Bsyslog"><span class="nav-text">b. 远程syslog</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-text">c. 日志分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="nav-text">4. 日志配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%87%E4%BB%B6%E5%AE%8C%E6%95%B4%E6%80%A7%E7%9B%91%E6%8E%A7"><span class="nav-text">2. 文件完整性监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-text">a. 实现原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-FIM-%E5%AD%97%E6%AE%B5-%E8%A7%84%E5%88%99%E6%98%A0%E5%B0%84"><span class="nav-text">b. FIM 字段-规则映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-FIM%E9%85%8D%E7%BD%AE"><span class="nav-text">c. FIM配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%BC%82%E5%B8%B8%E5%92%8C%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6%E6%A3%80%E6%B5%8B"><span class="nav-text">3. 异常和恶意软件检测</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E6%96%87%E4%BB%B6%E5%AE%8C%E6%95%B4%E6%80%A7%E7%9B%91%E6%8E%A7"><span class="nav-text">a. 文件完整性监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E6%A3%80%E6%9F%A5%E8%BF%90%E8%A1%8C%E7%9A%84%E8%BF%9B%E7%A8%8B"><span class="nav-text">b. 检查运行的进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E6%A3%80%E6%9F%A5%E9%9A%90%E8%97%8F%E7%AB%AF%E5%8F%A3"><span class="nav-text">c. 检查隐藏端口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E6%A3%80%E6%9F%A5%E5%BC%82%E5%B8%B8%E6%96%87%E4%BB%B6%E5%92%8C%E6%9D%83%E9%99%90"><span class="nav-text">d. 检查异常文件和权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#e-%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%A3%80%E6%9F%A5%E9%9A%90%E8%97%8F%E6%96%87%E4%BB%B6"><span class="nav-text">e. 使用系统调用检查隐藏文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#f-%E6%89%AB%E6%8F%8F-x2F-dev-%E7%9B%AE%E5%BD%95"><span class="nav-text">f. 扫描 &#x2F;dev 目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#g-%E6%A3%80%E6%B5%8B%E7%BD%91%E5%8D%A1%E6%B7%B7%E6%9D%82%E6%A8%A1%E5%BC%8F"><span class="nav-text">g. 检测网卡混杂模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#h-Rootkit-%E6%96%87%E4%BB%B6%E6%A3%80%E6%9F%A5"><span class="nav-text">h. Rootkit 文件检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#i-rootkit%E6%A3%80%E6%B5%8B%E9%85%8D%E7%BD%AE"><span class="nav-text">i. rootkit检测配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-text">4. 监控系统调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-Audit%E8%A7%84%E5%88%99%E7%B1%BB%E5%9E%8B"><span class="nav-text">a. Audit规则类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-Audit%E5%91%BD%E4%BB%A4"><span class="nav-text">b. Audit命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="nav-text">c. 定义文件系统规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E5%AE%9A%E4%B9%89%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E8%A7%84%E5%88%99"><span class="nav-text">d. 定义系统调用规则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E7%9B%91%E6%8E%A7%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-text">5. 监控命令执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E9%85%8D%E7%BD%AE-Wazuh-agent%E4%BB%A5%E6%8E%A5%E5%8F%97%E6%9D%A5%E8%87%AA%E7%AE%A1%E7%90%86%E5%99%A8%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4"><span class="nav-text">a. 配置 Wazuh agent以接受来自管理器的远程命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7%E5%91%BD%E4%BB%A4"><span class="nav-text">b. 配置监控命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E6%A3%80%E6%9F%A5%E8%BE%93%E5%87%BA%E6%98%AF%E5%90%A6%E6%94%B9%E5%8F%98"><span class="nav-text">c. 检查输出是否改变</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E4%B8%BB%E5%8A%A8%E9%98%B2%E5%BE%A1"><span class="nav-text">6. 主动防御</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">a. 工作原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E4%B8%BB%E5%8A%A8%E5%93%8D%E5%BA%94%E9%85%8D%E7%BD%AE"><span class="nav-text">b. 主动响应配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E9%BB%98%E8%AE%A4%E4%B8%BB%E5%8A%A8%E5%93%8D%E5%BA%94%E8%84%9A%E6%9C%AC"><span class="nav-text">c. 默认主动响应脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-text">d. 配置示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#e-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%BB%E5%8A%A8%E5%93%8D%E5%BA%94"><span class="nav-text">e. 自定义主动响应</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E7%B3%BB%E7%BB%9F%E8%B5%84%E4%BA%A7%E7%9B%98%E7%82%B9"><span class="nav-text">7. 系统资产盘点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="nav-text">a. 硬件信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="nav-text">b. 操作系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-Packege%E4%BF%A1%E6%81%AF"><span class="nav-text">c. Packege信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF"><span class="nav-text">d. 网络接口信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#e-%E7%AB%AF%E5%8F%A3%E4%BF%A1%E6%81%AF"><span class="nav-text">e. 端口信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#f-%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF"><span class="nav-text">f. 进程信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#g-%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8"><span class="nav-text">g. 配置使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8%E7%9B%91%E6%8E%A7"><span class="nav-text">8. 容器安全监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-text">a. 安装依赖项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E7%9B%91%E6%8E%A7%E5%AE%B9%E5%99%A8%E6%B4%BB%E5%8A%A8"><span class="nav-text">b. 监控容器活动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E9%9B%86%E6%88%90Osquery"><span class="nav-text">9. 集成Osquery</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E5%AE%89%E8%A3%85Osquery"><span class="nav-text">a. 安装Osquery</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-text">b. 配置示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E5%91%8A%E8%AD%A6%E7%A4%BA%E4%BE%8B"><span class="nav-text">c. 告警示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-%E5%AE%9E%E6%88%98%E7%94%A8%E4%BE%8B"><span class="nav-text">0x05 实战用例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%96%87%E4%BB%B6%E5%AE%8C%E6%95%B4%E6%80%A7%E7%9B%91%E6%8E%A7"><span class="nav-text">1. 文件完整性监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%A3%80%E6%B5%8B%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E6%94%BB%E5%87%BB"><span class="nav-text">2. 检测暴力破解攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%A3%80%E6%B5%8B%E5%BC%82%E5%B8%B8%E8%BF%9B%E7%A8%8B"><span class="nav-text">3. 检测异常进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%A3%80%E6%B5%8B-SQL-%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="nav-text">4. 检测 SQL 注入攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%A3%80%E6%B5%8B%E5%8F%AF%E7%96%91%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-text">5. 检测可疑的二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E7%9B%91%E6%8E%A7%E6%81%B6%E6%84%8F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-text">6. 监控恶意命令执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E6%A3%80%E6%B5%8B%E9%9A%90%E8%97%8F%E8%BF%9B%E7%A8%8B"><span class="nav-text">7. 检测隐藏进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E9%9B%86%E6%88%90-Yara-%E6%A3%80%E6%B5%8B%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6"><span class="nav-text">8. 集成 Yara 检测恶意软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E9%9B%86%E6%88%90-Network-IDS"><span class="nav-text">9. 集成 Network IDS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F%E4%B8%8E%E6%A3%80%E6%B5%8B"><span class="nav-text">10. 漏洞扫描与检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-%E9%98%BB%E6%96%AD%E5%B7%B2%E7%9F%A5%E7%9A%84%E6%81%B6%E6%84%8F%E8%A1%8C%E4%B8%BA"><span class="nav-text">11. 阻断已知的恶意行为</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0xFF-Reference"><span class="nav-text">0xFF Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="L0n9w4y"
      src="/images/hexo.png">
  <p class="site-author-name" itemprop="name">L0n9w4y</p>
  <div class="site-description" itemprop="description">攻防对抗，問道遠兮，求索未止...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/L0n9w4y" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;L0n9w4y" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/l0n9w4y" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;l0n9w4y" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/_L0n9_" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;_L0n9_" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://l0n9w4y.cc/posts/22306/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hexo.png">
      <meta itemprop="name" content="L0n9w4y">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L0n9w4y">
      <meta itemprop="description" content="攻防对抗，問道遠兮，求索未止...">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="开源HIDS之Wazuh探究 | L0n9w4y">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          开源HIDS之Wazuh探究
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-16 22:33:29" itemprop="dateCreated datePublished" datetime="2022-07-16T22:33:29+08:00">2022-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A8%81%E8%83%81%E6%A3%80%E6%B5%8B/" itemprop="url" rel="index"><span itemprop="name">威胁检测</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>Wazuh 是一款开源和企业级的安全平台，诞生于OSSEC HIDS，后来与Elastic Stack和OpenSCAP集成，演变成更全面的解决方案，用于威胁检测、完整性监控、事件响应和合规审计，本文记录Wazuh使用体验、探究各项检测能力...</center>

<span id="more"></span>

<h2 id="0x01-基础简介"><a href="#0x01-基础简介" class="headerlink" title="0x01 基础简介"></a>0x01 基础简介</h2><h3 id="1-组成架构"><a href="#1-组成架构" class="headerlink" title="1. 组成架构"></a>1. 组成架构</h3><p><strong>架构图</strong></p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/deployment1.png"></p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/data-flow1.png"></p>
<p>Wazuh 架构基于agent，在受监控的端点上运行，采集数据转发到服务端server，agent 与 server 之间的通信是通过 AES 加密后传输；server对传入的信息进行解码和分析，并将结果传递给 Wazuh 索引器进行索引和存储；Wazuh 索引器集群是一个或多个节点的集合，这些节点相互通信以对索引执行读写操作；当数据被 Wazuh 索引器索引，可使用Wazuh 仪表板挖掘和查看信息。</p>
<p><em><strong>agent - server通信：</strong></em> 代理与服务器服务建立连接以进行代理连接，默认情况下监听端口 1514（可配置），Wazuh 消息协议默认使用 AES 加密，每个块 128 位和 256 位密钥。</p>
<p><em><strong>server - index通信：</strong></em> Wazuh 服务器使用 Filebeat 将警报和事件数据发送到 Wazuh 索引器，使用 TLS 加密。Filebeat 读取 Wazuh 服务器输出数据并将其发送到 Wazuh 索引器（默认监听端口 9200&#x2F;TCP）。Wazuh 仪表板查询 Wazuh RESTful API（默认监听 Wazuh 服务器上的端口 55000&#x2F;TCP）以显示 Wazuh 服务器和代理的配置和状态相关信息</p>
<p><strong>Agent</strong></p>
<p>Wazuh Agent支持多平台部署，可部署在电脑、台式机、服务器、云实例或虚拟机等端点上。它们提供威胁预防、检测和响应功能。Agent具有模块化架构，其中不同组件负责各自的任务：监视文件系统，读取日志消息，收集清单数据，扫描系统配置，查找恶意软件等,用户可以通过配置启用或禁用代理模块设置。</p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/architecture-agent1.png"></p>
<table>
<thead>
<tr>
<th align="left">模块</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Log collector</td>
<td align="left">收集系统和应用程序日志及windows事件等日志</td>
</tr>
<tr>
<td align="left">Command execution</td>
<td align="left">代理周期性运行命令并将输出结果发送到server端进行分析</td>
</tr>
<tr>
<td align="left">File integrity monitoring (FIM)</td>
<td align="left">文件信息监控,在文件修改时将相关信息发送给server端进行分析</td>
</tr>
<tr>
<td align="left">Security configuration assessment (SCA)</td>
<td align="left">根据CIS标准来检查现有的安全策略,也可以自定义SCA</td>
</tr>
<tr>
<td align="left">System inventory</td>
<td align="left">定期扫描系统信息(比如系统版本,网卡,运行进程,已安装的程序,打开的端口等信息)</td>
</tr>
<tr>
<td align="left">Malware detection</td>
<td align="left">恶意软件扫描,基于non-signature检测异常的程序或rootkit的存在,通过监视系统调用,它将查找隐藏的进程,隐藏的文件和隐藏的端口等</td>
</tr>
<tr>
<td align="left">Active response</td>
<td align="left">检测到威胁时,此模块将自动执行相关操作,比如阻止网络连接，停止正在运行的进程或删除恶意文件,用户也可以在必要时创建自定义响应</td>
</tr>
<tr>
<td align="left">Containers security monitoring</td>
<td align="left">此代理模块与Docker Engine API集成在一起以监视容器化环境中的更改,例如它检测到容器镜像,网络配置或数据量的更改,它还会警告以特权模式运行的容器以及正在运行的容器中执行命令的用户</td>
</tr>
<tr>
<td align="left">Cloud security monitoring</td>
<td align="left">云提供商安全检测,它能够检测到云基础架构的更改(例如，创建新用户，修改安全组，停止云实例等),并收集云服务日志数据(AWS Cloudtrail,AWS Macie,AWS GuardDuty,Azure Active Directory等)</td>
</tr>
</tbody></table>
<p><strong>Server</strong></p>
<p>Wazuh 服务器分析从代理接收的数据。它通过解码器和规则对其进行处理，使用威胁情报来寻找公开信标 (IOC)，在检测到威胁或异常时触发警报, 它还用于远程管理代理配置并监视其状态。</p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/architecture-server1.png"></p>
<table>
<thead>
<tr>
<th align="left">模块</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Agents registration service</td>
<td align="left">给每个代理分配一个唯一的预共享身份验证密钥来注册新代理,并支持通过TLS&#x2F;SSL证书或提供固定密码进行身份验证</td>
</tr>
<tr>
<td align="left">Agents connection service</td>
<td align="left">该组件用于接受agent发送来的数据,利用预共享密钥来验证代理身份和加密代理与Wazuh服务器之间的通信及此将配置推送给远程的agent</td>
</tr>
<tr>
<td align="left">Analysis engine</td>
<td align="left">进行数据分析,将agent传送过来的数据进行分析,利用解码器来识别正在处理的信息的类型,通过使用规则,它可以识别解码事件中的特定模式,从而触发警报,甚至可能要求采取自动对策(比如防火墙禁止ip等)</td>
</tr>
<tr>
<td align="left">Wazuh RESTful API</td>
<td align="left">管理代理和服务器配置设置,监视基础结构状态和整体运行状况,管理和编辑Wazuh解码器和规则等</td>
</tr>
<tr>
<td align="left">Wazuh cluster daemon</td>
<td align="left">此服务用于水平扩展Wazuh server,将它们部署为群集,这种配置与网络负载平衡器相结合,可提供高可用性和负载平衡(Wazuh server用来相互通信并保持同步的工具)</td>
</tr>
<tr>
<td align="left">Filebeat</td>
<td align="left">用于将事件和警报发送到es,它读取Wazuh分析引擎的输出并实时发送事件,当连接到多节点Elasticsearch集群时,它还提供负载均衡</td>
</tr>
</tbody></table>
<p><strong>默认端口列表</strong></p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/wazuh_port.png"></p>
<h3 id="2-安装部署"><a href="#2-安装部署" class="headerlink" title="2. 安装部署"></a>2. 安装部署</h3><p><strong>快速安装</strong></p>
<pre class="language-none"><code class="language-none">curl -sO https:&#x2F;&#x2F;packages.wazuh.com&#x2F;4.3&#x2F;wazuh-install.sh &amp;&amp; sudo bash .&#x2F;wazuh-install.sh -a

# 重装命令：sudo bash .&#x2F;wazuh-install.sh -a -i -o

# 卸载命令：sudo bash .&#x2F;wazuh-install.sh -u</code></pre>

<p>安装完成后，输出会显示访问凭证和一条确认安装成功的消息</p>
<pre class="language-none"><code class="language-none">INFO: --- Summary ---
INFO: You can access the web interface https:&#x2F;&#x2F;&lt;wazuh-dashboard-ip&gt;
    User: admin
    Password: &lt;ADMIN_PASSWORD&gt;
INFO: Installation finished.</code></pre>

<p>查找Wazuh 索引器和 Wazuh API 用户的密码</p>
<pre class="language-none"><code class="language-none">sudo tar -O -xvf wazuh-install-files.tar wazuh-install-files&#x2F;wazuh-passwords.txt</code></pre>

<p><strong>Agent安装</strong></p>
<pre class="language-none"><code class="language-none">1） Linux安装

rpm -ivh https:&#x2F;&#x2F;packages.wazuh.com&#x2F;4.x&#x2F;yum&#x2F;wazuh-agent-4.3.10-1.x86_64.rpm --nodeps --force

# 修改&#x2F;var&#x2F;ossec&#x2F;etc&#x2F;ossec.conf，MANAGER_IP修改为server的地址

systemctl daemon-reload
systemctl enable wazuh-agent
systemctl start wazuh-agent

# 默认安装位置：&#x2F;var&#x2F;ossec

2）Windows安装

Invoke-WebRequest -Uri https:&#x2F;&#x2F;packages.wazuh.com&#x2F;4.x&#x2F;windows&#x2F;wazuh-agent-4.3.10-1.msi -OutFile $&#123;env:tmp&#125;\wazuh-agent-4.3.10.msi; msiexec.exe &#x2F;i $&#123;env:tmp&#125;\wazuh-agent-4.3.10.msi &#x2F;q WAZUH_MANAGER&#x3D;&#39;192.168.10.10&#39; WAZUH_REGISTRATION_SERVER&#x3D;&#39;192.168.10.10&#39;

NET START WazuhSvc

# 默认安装位置：C:\Program Files (x86)\ossec-agent

3）macOS安装

curl -sO https:&#x2F;&#x2F;packages.wazuh.com&#x2F;4.x&#x2F;macos&#x2F;wazuh-agent-4.3.10-1.pkg

launchctl setenv WAZUH_MANAGER &quot;10.0.0.2&quot; &amp;&amp; installer -pkg wazuh-agent-4.3.10-1.pkg -target &#x2F;

&#x2F;Library&#x2F;Ossec&#x2F;bin&#x2F;wazuh-control start

# 默认安装位置：&#x2F;Library&#x2F;Ossec&#x2F;</code></pre>

<h2 id="0x02-配置管理"><a href="#0x02-配置管理" class="headerlink" title="0x02 配置管理"></a>0x02 配置管理</h2><h3 id="1-Server管理"><a href="#1-Server管理" class="headerlink" title="1. Server管理"></a>1. Server管理</h3><p>Wazuh 管理器是一个系统，它分析从所有注册代理收到的数据，并在事件符合规则时触发警报。管理器在本地机器上充当代理，它具有代理所具有的所有功能。此外，管理器可以转发它通过系统日志、电子邮件或集成的外部 API 触发的警报。</p>
<h4 id="a-远程服务配置"><a href="#a-远程服务配置" class="headerlink" title="a. 远程服务配置"></a>a. 远程服务配置</h4><p>远程服务的配置是通过 <code>ossec.conf</code> 文件使用 <code>&lt;remote&gt;</code> XML 标记完成</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remote</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>local_ip</span><span class="token punctuation">></span></span>10.0.0.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>local_ip</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>remote</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>设置管理器监听 IP 地址 10.0.0.10</p>
<p>修改后需重启服务生效</p>
<pre class="language-none"><code class="language-none">systemctl restart wazuh-manager</code></pre>

<h4 id="b-定义告警等级阈值"><a href="#b-定义告警等级阈值" class="headerlink" title="b. 定义告警等级阈值"></a>b. 定义告警等级阈值</h4><p>管理器将根据事件匹配规则集中的规则为事件分配严重性级别，默认情况下，只会记录严重级别为 3 或更高的警报</p>
<p>警报级别阈值使用 <code>&lt;alerts&gt;</code> XML 标记在 <code>ossec.conf</code> 文件中配置</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alerts</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_alert_level</span><span class="token punctuation">></span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_alert_level</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>alerts</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>设置存储在 alerts.log 或 alerts.json 文件中的警报的最低严重性级别</p>
<p>修改后需重启服务生效</p>
<pre class="language-none"><code class="language-none">systemctl restart wazuh-manager</code></pre>

<h4 id="c-集成外部API"><a href="#c-集成外部API" class="headerlink" title="c. 集成外部API"></a>c. 集成外部API</h4><p>Integrator 守护进程允许 Wazuh 连接到外部 API 和警报工具，例如 Slack、PagerDuty 和 VirusTotal等</p>
<p>在&#x2F;var&#x2F;ossec&#x2F;etc&#x2F; 目录下 ossec.conf 文件中配置，在 <code>&lt;ossec_config&gt;</code> 部分添加以下配置</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>integration</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hook_url</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hook_url</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- Required for Slack --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>api_key</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>api_key</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- Required for PagerDuty and VirusTotal --></span>

  <span class="token comment">&lt;!-- Optional filters --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule_id</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule_id</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event_location</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event_location</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>integration</span><span class="token punctuation">></span></span></code></pre>

<p>修改后需重启服务生效</p>
<pre class="language-none"><code class="language-none">systemctl restart wazuh-manager</code></pre>

<h4 id="d-配置-syslog-输出"><a href="#d-配置-syslog-输出" class="headerlink" title="d. 配置 syslog 输出"></a>d. 配置 syslog 输出</h4><p>Syslog 输出在 ossec.conf 文件中配置</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syslog_output</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span>9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">></span></span>192.168.1.241<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syslog_output</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syslog_output</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server</span><span class="token punctuation">></span></span>192.168.1.240<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>server</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syslog_output</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>上述配置将向 192.168.1.240 发送警报，如果警报级别高于 9，也会向 192.168.1.241 发送警报</p>
<p>修改后需重启服务生效</p>
<pre class="language-none"><code class="language-none">systemctl restart wazuh-manager</code></pre>

<h4 id="e-生成自动化报告"><a href="#e-生成自动化报告" class="headerlink" title="e. 生成自动化报告"></a>e. 生成自动化报告</h4><p>可使用 ossec.conf 文件中的 report 选项来配置您自己的自定义报告</p>
<p>将所有 syscheck 警报的每日报告发送到 <a href="mailto:&#101;&#120;&#x61;&#109;&#x70;&#x6c;&#x65;&#64;&#116;&#x65;&#x73;&#116;&#x2e;&#x63;&#x6f;&#x6d;">&#101;&#120;&#x61;&#109;&#x70;&#x6c;&#x65;&#64;&#116;&#x65;&#x73;&#116;&#x2e;&#x63;&#x6f;&#x6d;</a></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>reports</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span><span class="token punctuation">></span></span>syscheck<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>category</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Daily report: File changes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>example@test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>reports</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>规则也可以按级别、来源、用户名、规则 ID 等进行过滤</p>
<p>发送报告，其中包含所有触发级别高于 10 的规则</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>reports</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Daily report: Alerts with level higher than 10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>example@test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>reports</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<h4 id="f-配置邮件警报"><a href="#f-配置邮件警报" class="headerlink" title="f. 配置邮件警报"></a>f. 配置邮件警报</h4><p>Wazuh 可以配置为在触发某些规则或每日事件报告时向一个或多个电子邮件地址发送电子邮件警报</p>
<p><strong>通用邮件选项</strong></p>
<p>在 ossec.conf 文件 <code>&lt;global&gt;</code> 中配置电子邮件设置</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>global</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_notification</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_notification</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>me@test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>smtp_server</span><span class="token punctuation">></span></span>mail.test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>smtp_server</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_from</span><span class="token punctuation">></span></span>wazuh@test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_from</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>global</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>配置完成后，需要将 email_alert_level 设置为将触发电子邮件的最低警报级别。默认情况下，此级别设置为 12</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alerts</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alert_level</span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alert_level</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>alerts</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p><strong>精细化邮件配置</strong></p>
<p>基于级别的邮件</p>
<p>当级别大于或等于 4 的规则被触发时，向 <a href="mailto:&#x79;&#111;&#117;&#x40;&#x65;&#120;&#x61;&#x6d;&#x70;&#x6c;&#101;&#x2e;&#99;&#x6f;&#109;">&#x79;&#111;&#117;&#x40;&#x65;&#120;&#x61;&#x6d;&#x70;&#x6c;&#101;&#x2e;&#99;&#x6f;&#109;</a> 发送电子邮件</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alerts</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>you@example.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>do_not_delay</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alerts</span><span class="token punctuation">></span></span></code></pre>

<p>基于级别和agent的邮件</p>
<p>event_location 字段可以配置为监控特定日志、主机名或网络 (IP)，当规则在server1机器上触发时发送告警</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alerts</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>you@example.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event_location</span><span class="token punctuation">></span></span>server1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event_location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>do_not_delay</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alerts</span><span class="token punctuation">></span></span></code></pre>

<p>基于规则 ID 的邮件</p>
<p>当触发规则 515 或 516 时发送邮件警报</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alerts</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>you@example.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule_id</span><span class="token punctuation">></span></span>515, 516<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule_id</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>do_not_delay</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alerts</span><span class="token punctuation">></span></span></code></pre>

<p>基于 group 的邮件</p>
<p>当属于 pci_dss_10.6.1 组的任何规则在任何 Wazuh 监控设备上触发时，将发送警报</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alerts</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>you@example.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span>pci_dss_10.6.1,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alerts</span><span class="token punctuation">></span></span></code></pre>

<p>多选项&#x2F;多邮件配置</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alerts</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>alice@test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event_location</span><span class="token punctuation">></span></span>server1|server2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event_location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alerts</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alerts</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>is@test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event_location</span><span class="token punctuation">></span></span>/log/secure$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event_location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alerts</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alerts</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>bob@test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>event_location</span><span class="token punctuation">></span></span>192.168.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>event_location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alerts</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_alerts</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email_to</span><span class="token punctuation">></span></span>david@test.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_to</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span>12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email_alerts</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>配置说明：</p>
<pre class="language-none"><code class="language-none">1) 如果server1 或server2 上的任何警报被触发，请发送电子邮件至 alice@test.com

2) 如果警报来自 &#x2F;log&#x2F;secure&#x2F;，则发送电子邮件至 is@test.com

3) 如果警报来自 192.168.0.0&#x2F;24 网络上的任何机器，则发送电子邮件至 bob@test.com

4) 如果警报级别等于或高于 12，则发送电子邮件至 david@test.com</code></pre>

<h3 id="2-Agent-管理"><a href="#2-Agent-管理" class="headerlink" title="2. Agent 管理"></a>2. Agent 管理</h3><h4 id="a-Agent生命周期"><a href="#a-Agent生命周期" class="headerlink" title="a. Agent生命周期"></a>a. Agent生命周期</h4><p><strong>注册agent</strong></p>
<p>注册代理将保留在管理器中，直到被用户删除。代理在任何给定时间可能处于四种不同的状态</p>
<p><strong>agent状态</strong></p>
<table>
<thead>
<tr>
<th align="left">状态</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Never connected</td>
<td align="left">代理已注册但尚未连接到管理器</td>
</tr>
<tr>
<td align="left">Pending</td>
<td align="left">身份验证过程尚未完成，管理器收到了来自agent的连接请求，但未收到其他内容，长期此状态可能防火墙导致</td>
</tr>
<tr>
<td align="left">Active</td>
<td align="left">agent已成功连接，现在可以与管理器通信</td>
</tr>
<tr>
<td align="left">Disconnected</td>
<td align="left">如果在 agents_disconnection_time（默认 10m 时间）内没有收到任何keep alive消息，管理器将认为agent已断开连接</td>
</tr>
</tbody></table>
<p><strong>删除agent</strong></p>
<p>当agent从管理器中移除时，生命周期结束。可以通过 Wazuh API、命令行或 Authd（如果启用了强制选项）来完成</p>
<h4 id="b-列出agent"><a href="#b-列出agent" class="headerlink" title="b. 列出agent"></a>b. 列出agent</h4><pre class="language-none"><code class="language-none">1) 使用CLI

&#x2F;var&#x2F;ossec&#x2F;bin&#x2F;agent_control -l

&#x2F;var&#x2F;ossec&#x2F;bin&#x2F;manage_agents -l

2) 使用Wazuh API

curl -k -X GET &quot;https:&#x2F;&#x2F;localhost:55000&#x2F;agents?pretty&#x3D;true&amp;sort&#x3D;-ip,name&quot; -H  &quot;Authorization: Bearer $TOKEN&quot;

3) 使用Wazuh app

可以转到 Wazuh app中的Agent选项，列出并查看所有注册agent的基本信息</code></pre>

<h4 id="c-移除agent"><a href="#c-移除agent" class="headerlink" title="c. 移除agent"></a>c. 移除agent</h4><pre class="language-none"><code class="language-none">1) 使用CLI

&#x2F;var&#x2F;ossec&#x2F;bin&#x2F;manage_agents

&#x2F;var&#x2F;ossec&#x2F;bin&#x2F;manage_agents -r 001

2）使用Wazuh API

TOKEN&#x3D;$(curl -u &lt;user&gt;:&lt;password&gt; -k -X GET &quot;https:&#x2F;&#x2F;localhost:55000&#x2F;security&#x2F;user&#x2F;authenticate?raw&#x3D;true&quot;)

# Removing agents in a list
curl -k -X DELETE &quot;https:&#x2F;&#x2F;localhost:55000&#x2F;agents?pretty&#x3D;true&amp;older_than&#x3D;0s&amp;agents_list&#x3D;005,006,007&amp;status&#x3D;all&quot; -H  &quot;Authorization: Bearer $TOKEN&quot;

# Removing disconnected agents
curl -k -X DELETE &quot;https:&#x2F;&#x2F;localhost:55000&#x2F;agents?pretty&#x3D;true&amp;older_than&#x3D;21d&amp;agents_list&#x3D;all&amp;status&#x3D;never_connected,disconnected&quot; -H  &quot;Authorization: Bearer $TOKEN&quot;</code></pre>

<h4 id="d-检查与Server的连接"><a href="#d-检查与Server的连接" class="headerlink" title="d. 检查与Server的连接"></a>d. 检查与Server的连接</h4><pre class="language-none"><code class="language-none">1) 通过Wazuh dashboard查看

2）通过agent_control命令查看

&#x2F;var&#x2F;ossec&#x2F;bin&#x2F;agent_control -l

&#x2F;var&#x2F;ossec&#x2F;bin&#x2F;agent_control -i &lt;YOUR_AGENT_ID&gt; | grep Status

3）使用Wazuh API

GET &#x2F;agents&#x2F;&lt;YOUR_AGENT_ID&gt;&#x2F;stats&#x2F;agent

4）读取本地 wazuh-agentd.state 文件

sudo grep ^status &#x2F;var&#x2F;ossec&#x2F;var&#x2F;run&#x2F;wazuh-agentd.state  # Linux

Select-String -Path C:\Program Files (x86)\ossec-agent\wazuh-agent.state -Pattern &quot;^status&quot;    # Windows

sudo grep ^status &#x2F;Library&#x2F;Ossec&#x2F;var&#x2F;run&#x2F;wazuh-agentd.state    # macOS

5）检查网络通信

netstat -vatunp|grep wazuh-agentd          # Linux

Get-NetTCPConnection -RemotePort 1514      # Windows

lsof -i -P | grep ESTABLISHED | grep 1514  # mscOS</code></pre>

<p><strong>Agent日志排查</strong></p>
<pre class="language-none"><code class="language-none">Linux&#x2F;Unix: &#x2F;var&#x2F;ossec&#x2F;logs&#x2F;ossec.log

Windows: C:\Program Files (x86)\ossec-agent\ossec.log

macOS: &#x2F;Library&#x2F;Ossec&#x2F;logs&#x2F;ossec.log</code></pre>

<h3 id="3-参考速查"><a href="#3-参考速查" class="headerlink" title="3. 参考速查"></a>3. 参考速查</h3><h4 id="a-本地配置（ossec-conf）"><a href="#a-本地配置（ossec-conf）" class="headerlink" title="a. 本地配置（ossec.conf）"></a>a. 本地配置（ossec.conf）</h4><p><code>ossec.conf</code> 文件是Wazuh manager上的主要配置文件，Linux文件位置<code>/var/ossec/etc/ossec.conf</code>, Windows 文件位置 <code>C:\Program Files (x86)\ossec-agent\ossec.conf</code></p>
<p>ossec.conf 文件为 XML 格式，其所有配置选项都嵌套在文件的相应部分中。在这个文件中，最外层的 XML 标签是<code>&lt;ossec_config&gt;</code>。可以有多个<code>&lt;ossec_config&gt;</code>标签</p>
<p>agent.conf 文件与ossec.conf 相似，但agent.conf 用于将配置信息集中分发给代理</p>
<p><strong>配置项</strong></p>
<table>
<thead>
<tr>
<th align="left">配置部分</th>
<th align="left">支持安装</th>
</tr>
</thead>
<tbody><tr>
<td align="left">active-response</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">agentless</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">agent-upgrade</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">alerts</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">auth</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">client</td>
<td align="left">agent</td>
</tr>
<tr>
<td align="left">client_buffer</td>
<td align="left">agent</td>
</tr>
<tr>
<td align="left">cluster</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">command</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">database_output</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">email_alerts</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">fluent-forward</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">global</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">github</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">integration</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">labels</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">localfile</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">logging</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">office365</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">remote</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">reports</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">rootcheck</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">rule_test</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">ruleset</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">sca</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">socket</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">syscheck</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">syslog_output</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">task-manager</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">vulnerability-detector</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”agent-key-polling”</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”aws-s3”</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”azure-logs”</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”cis-cat”</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”command”</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”docker-listener”</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”open-scap”</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”osquery”</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wodle name&#x3D;”syscollector”</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">gcp-pubsub</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">gcp-bucket</td>
<td align="left">manager, agent</td>
</tr>
</tbody></table>
<h4 id="b-集中配置（agent-conf）"><a href="#b-集中配置（agent-conf）" class="headerlink" title="b. 集中配置（agent.conf）"></a>b. 集中配置（agent.conf）</h4><p>使用 agent.conf 文件远程配置代理。可以远程配置以下功能：</p>
<ul>
<li><p>File Integrity monitoring (syscheck)</p>
</li>
<li><p>Rootkit detection (rootcheck)</p>
</li>
<li><p>Log data collection (localfile)</p>
</li>
<li><p>Security policy monitoring (wodle name&#x3D;”open-scap”, wodle name&#x3D;”cis-cat”)</p>
</li>
<li><p>Remote commands (wodle name&#x3D;”command”)</p>
</li>
<li><p>Labels for agent alerts (labels)</p>
</li>
<li><p>Security Configuration Assessment (sca)</p>
</li>
<li><p>System inventory (syscollector)</p>
</li>
<li><p>Avoid events flooding (client_buffer)</p>
</li>
<li><p>Configure osquery wodle (wodle name&#x3D;”osquery”)</p>
</li>
<li><p>force_reconnect_interval setting (client)</p>
</li>
</ul>
<p>在共享代理配置中设置远程命令时，必须为代理模块启用远程命令，在agent中<code>/var/ossec/etc/local_internal_options.conf</code> 文件添加如下行：</p>
<pre class="language-none"><code class="language-none">wazuh_command.remote_commands&#x3D;1</code></pre>

<p><strong>Agent组</strong></p>
<p>Agent可以组合在一起，以便向他们发送特定于组的唯一集中配置</p>
<ul>
<li><p><code>/var/ossec/etc/shared/default</code> 中的所有文件将被推送到所有属于 default 组的代理</p>
</li>
<li><p>文件 <code>ar.conf</code>（活动响应状态）将始终发送给代理</p>
</li>
<li><p>agent 会将共享文件存储在<code>/var/ossec/etc/shared</code> 中，而不是组文件夹中</p>
</li>
</ul>
<p><strong>集中配置流程</strong></p>
<p>1）配置 agent.conf 文件</p>
<p>编辑agent组对应的文件。对于默认组，编辑文件 <code>/var/ossec/etc/shared/default/agent.conf</code>。如果文件不存在，则创建</p>
<pre class="language-none"><code class="language-none">touch &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;shared&#x2F;default&#x2F;agent.conf
chown wazuh:wazuh &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;shared&#x2F;default&#x2F;agent.conf
chmod 640 &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;shared&#x2F;default&#x2F;agent.conf</code></pre>

<p>根据agent的name, OS 或 profile创建多个配置</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent_config</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>agent_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/my.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent_config</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent_config</span> <span class="token attr-name">os</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Linux<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/linux.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent_config</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent_config</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>database<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/database.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent_config</span><span class="token punctuation">></span></span></code></pre>

<p>2）运行 <code>/var/ossec/bin/verify-agent-conf</code></p>
<p>更改 agent.conf 文件时，需检查配置错误，检查报告任何错误，则必须在下一步之前修复。</p>
<p>3）将配置推送给agent</p>
<p>重新启动管理器将使新的 agent.conf 文件更快地可供agent使用。</p>
<p>4）确认agent收到配置</p>
<p>agent_groups 工具或 Wazuh API 端点 <code>GET /agents/&#123;agent_id&#125;/group/is_sync</code> 可以显示组是否在代理中同步：</p>
<pre class="language-none"><code class="language-none">curl -k -X GET &quot;https:&#x2F;&#x2F;localhost:55000&#x2F;agents&#x2F;001&#x2F;group&#x2F;is_sync?pretty&#x3D;true&quot; -H  &quot;Authorization: Bearer $TOKEN&quot;</code></pre>

<p>输出</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"error"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"affected_items"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"001"</span><span class="token punctuation">,</span>
                <span class="token property">"synced"</span><span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"total_affected_items"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"total_failed_items"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">"failed_items"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Sync info was returned for all selected agents"</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-none"><code class="language-none">&#x2F;var&#x2F;ossec&#x2F;bin&#x2F;agent_groups -S -i 001</code></pre>

<p>输出</p>
<pre class="language-none"><code class="language-none">Agent &#39;001&#39; is synchronized.</code></pre>

<p>5）重启agent</p>
<p>默认情况下，agent会在收到新的共享配置时自动重新启动。如果 auto_restart 已被禁用（在本地配置的 <code>&lt;client&gt;</code> 部分），则必须手动重新启动代理：</p>
<pre class="language-none"><code class="language-none">&#x2F;var&#x2F;ossec&#x2F;bin&#x2F;agent_control -R -u 1032</code></pre>

<h4 id="c-守护进程表"><a href="#c-守护进程表" class="headerlink" title="c. 守护进程表"></a>c. 守护进程表</h4><table>
<thead>
<tr>
<th align="left">Daemons进程</th>
<th align="left">描述</th>
<th align="left">安装支持</th>
</tr>
</thead>
<tbody><tr>
<td align="left">wazuh-agentd</td>
<td align="left">与服务器通信的客户端守护进程</td>
<td align="left">agent</td>
</tr>
<tr>
<td align="left">wazuh-agentlessd</td>
<td align="left">在未安装agent的系统上运行完整性检查</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-analysisd</td>
<td align="left">接收日志消息并将它们与规则进行比较</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-authd</td>
<td align="left">将agent添加到 Wazuh 管理器</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-csyslogd</td>
<td align="left">通过syslog转发 Wazuh 警报</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-dbd</td>
<td align="left">将警报日志插入数据库</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-execd</td>
<td align="left">执行主动响应</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wazuh-logcollector</td>
<td align="left">监视配置的文件和命令以获取新的日志消息</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wazuh-maild</td>
<td align="left">通过电子邮件发送 Wazuh 警报</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-monitord</td>
<td align="left">监控agent连接并压缩日志文件</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-remoted</td>
<td align="left">与agents通信</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-reportd</td>
<td align="left">从 Wazuh 警报创建报告</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-syscheckd</td>
<td align="left">检查配置文件的安全更改</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wazuh-clusterd</td>
<td align="left">管理 Wazuh 集群管理器</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-modulesd</td>
<td align="left">管理 Wazuh 模块</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wazuh-db</td>
<td align="left">管理 Wazuh 数据库</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-integratord</td>
<td align="left">允许 Wazuh 连接到外部 API 和警报工具</td>
<td align="left">manager</td>
</tr>
</tbody></table>
<p>more: <a target="_blank" rel="noopener" href="https://documentation.wazuh.com/current/user-manual/reference/daemons/index.html">https://documentation.wazuh.com/current/user-manual/reference/daemons/index.html</a></p>
<h4 id="d-工具速查表"><a href="#d-工具速查表" class="headerlink" title="d. 工具速查表"></a>d. 工具速查表</h4><table>
<thead>
<tr>
<th align="left">工具</th>
<th align="left">描述</th>
<th align="left">安装支持</th>
</tr>
</thead>
<tbody><tr>
<td align="left">wazuh-control</td>
<td align="left">管理 Wazuh 进程的状态</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">agent-auth</td>
<td align="left">将agent添加到 Wazuh 管理器</td>
<td align="left">agent</td>
</tr>
<tr>
<td align="left">agent_control</td>
<td align="left">允许管理器查询以获取agent相关信息</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">manage_agents</td>
<td align="left">提供一个接口来处理与agent的认证</td>
<td align="left">manager, agent</td>
</tr>
<tr>
<td align="left">wazuh-logtest</td>
<td align="left">允许根据提供的日志记录测试和验证规则</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">clear_stats</td>
<td align="left">清除事件统计</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">wazuh-regex</td>
<td align="left">验证正则表达式</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">update_ruleset</td>
<td align="left">更新解码器、规则和 Rootcheck</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">verify-agent-conf</td>
<td align="left">验证 Wazuh agent.conf 配置</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">agent_groups</td>
<td align="left">管理和分配组</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">agent_upgrade</td>
<td align="left">列出过时的agent并升级</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">cluster_control</td>
<td align="left">管理和检索集群信息</td>
<td align="left">manager</td>
</tr>
<tr>
<td align="left">fim_migrate</td>
<td align="left">将旧的 FIM 数据库迁移到 Wazuh-DB</td>
<td align="left">manager</td>
</tr>
</tbody></table>
<p>more: <a target="_blank" rel="noopener" href="https://documentation.wazuh.com/current/user-manual/reference/tools/index.html">https://documentation.wazuh.com/current/user-manual/reference/tools/index.html</a></p>
<h2 id="0x03-规则详解"><a href="#0x03-规则详解" class="headerlink" title="0x03 规则详解"></a>0x03 规则详解</h2><p>OSSEC 提供了一组开箱即用的规则，Wazuh基于此规则进行更新和扩展，来检测攻击、入侵、软件滥用、配置问题、应用程序错误、恶意软件、rootkit、系统异常或违反安全策略</p>
<h3 id="1-目录文件"><a href="#1-目录文件" class="headerlink" title="1. 目录文件"></a>1. 目录文件</h3><p>规则集目录结构如下所示：</p>
<pre class="language-none"><code class="language-none">&#x2F;var&#x2F;ossec&#x2F;
        ├─ etc&#x2F;
        │   ├─ decoders&#x2F;
        |   |        └─ local_decoder.xml
        │   └─ rules&#x2F;
        |         └─ local_rules.xml
        └─ ruleset&#x2F;
                ├─ decoders&#x2F;
                └─ rules&#x2F;</code></pre>

<ul>
<li><p>在 ruleset&#x2F; 目录中存放通用规则和解码器。此目录内的所有文件在Wazuh更新过程中都会被覆盖或修改，请勿在此目录内编辑文件或添加自定义文件。</p>
</li>
<li><p>如需执行自定义更改，使用 etc&#x2F; 目录。可以在此处添加自己的解码器&#x2F;规则文件或使用默认的 <code>local_decoder.xml</code> 和 <code>local_rules.xml</code> 文件</p>
</li>
</ul>
<h3 id="2-Json解码器"><a href="#2-Json解码器" class="headerlink" title="2. Json解码器"></a>2. Json解码器</h3><p>Wazuh 集成了一个用于 JSON 日志的解码器，可以从任何来源提取这种格式的数据，该解码器能够提取以下数据类型：</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Numbers</td>
<td align="left">整型、浮点型</td>
</tr>
<tr>
<td align="left">Strings</td>
<td align="left">字符类型</td>
</tr>
<tr>
<td align="left">Booleans</td>
<td align="left">布尔类型</td>
</tr>
<tr>
<td align="left">Null values</td>
<td align="left">空值</td>
</tr>
<tr>
<td align="left">Arrays</td>
<td align="left">具有零个或多个值的列表。上述类型组合，不支持对象数组</td>
</tr>
<tr>
<td align="left">Objects</td>
<td align="left">键&#x2F;值对的集合，其中键是字符串</td>
</tr>
</tbody></table>
<p><strong>示例一：展示Wazuh 如何解码 JSON 日志并为 Suricata 生成警报</strong></p>
<p>Suricata事件日志:</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
   <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2016-05-02T17:46:48.515262+0000"</span><span class="token punctuation">,</span>
   <span class="token property">"flow_id"</span><span class="token operator">:</span> <span class="token number">1234</span><span class="token punctuation">,</span>
   <span class="token property">"in_iface"</span><span class="token operator">:</span> <span class="token string">"eth0"</span><span class="token punctuation">,</span>
   <span class="token property">"event_type"</span><span class="token operator">:</span> <span class="token string">"alert"</span><span class="token punctuation">,</span>
   <span class="token property">"src_ip"</span><span class="token operator">:</span> <span class="token string">"16.10.10.10"</span><span class="token punctuation">,</span>
   <span class="token property">"src_port"</span><span class="token operator">:</span> <span class="token number">5555</span><span class="token punctuation">,</span>
   <span class="token property">"dest_ip"</span><span class="token operator">:</span> <span class="token string">"16.10.10.11"</span><span class="token punctuation">,</span>
   <span class="token property">"dest_port"</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
   <span class="token property">"proto"</span><span class="token operator">:</span> <span class="token string">"TCP"</span><span class="token punctuation">,</span>
   <span class="token property">"alert"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"allowed"</span><span class="token punctuation">,</span>
      <span class="token property">"gid"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"signature_id"</span><span class="token operator">:</span> <span class="token number">2019236</span><span class="token punctuation">,</span>
      <span class="token property">"rev"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">"signature"</span><span class="token operator">:</span> <span class="token string">"ET WEB_SERVER Possible CVE-2014-6271 Attempt in HTTP Version Number"</span><span class="token punctuation">,</span>
      <span class="token property">"category"</span><span class="token operator">:</span> <span class="token string">"Attempted Administrator Privilege Gain"</span><span class="token punctuation">,</span>
      <span class="token property">"severity"</span><span class="token operator">:</span> <span class="token number">1</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token property">"payload"</span><span class="token operator">:</span> <span class="token string">"21YW5kXBtgdW5zIGRlcHJY2F0QgYWI"</span><span class="token punctuation">,</span>
   <span class="token property">"payload_printable"</span><span class="token operator">:</span> <span class="token string">"this_is_an_example"</span><span class="token punctuation">,</span>
   <span class="token property">"stream"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
   <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"suricata.com"</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>JSON 解码器从日志数据中提取每个字段以与规则进行比较，因此不需要特定的 Suricata 解码器。这些规则将用于根据特定于生成 JSON 事件的源的特定字段的存在来识别 JSON 事件的源。</p>
<p>以下示例显示文件 0470-suricata_rules.xml 中包含的规则如何工作，首先有一个父规则检查”timestamp”和”event_type”字段是否存在以确定日志类型 (Suricata)，然后子规则使用提取字段的值显示警报。</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>86600<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoded_as</span><span class="token punctuation">></span></span>json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoded_as</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>timestamp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\.+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>event_type<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\.+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Suricata messages.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>86601<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>86600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>event_type<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>^alert$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Suricata: Alert - $(alert.signature)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<p>wazuh-logtest 从上面的 JSON 记录输出如下:</p>
<pre class="language-none"><code class="language-none">Type one log per line

&#123;&quot;timestamp&quot;:&quot;2016-05-02T17:46:48.515262+0000&quot;,&quot;flow_id&quot;:1234,&quot;in_iface&quot;:&quot;eth0&quot;,&quot;event_type&quot;:&quot;alert&quot;,&quot;src_ip&quot;:&quot;16.10.10.10&quot;,&quot;src_port&quot;:5555,&quot;dest_ip&quot;:&quot;16.10.10.11&quot;,&quot;dest_port&quot;:80,&quot;proto&quot;:&quot;TCP&quot;,&quot;alert&quot;:&#123;&quot;action&quot;:&quot;allowed&quot;,&quot;gid&quot;:1,&quot;signature_id&quot;:2019236,&quot;rev&quot;:3,&quot;signature&quot;:&quot;ET WEB_SERVER Possible CVE-2014-6271 Attempt in HTTP Version Number&quot;,&quot;category&quot;:&quot;Attempted Administrator Privilege Gain&quot;,&quot;severity&quot;:1&#125;,&quot;payload&quot;:&quot;21YW5kXBtgdW5zIGRlcHJY2F0QgYWI&quot;,&quot;payload_printable&quot;:&quot;this_is_an_example&quot;,&quot;stream&quot;:0,&quot;host&quot;:&quot;suricata.com&quot;&#125;

**Phase 1: Completed pre-decoding.

**Phase 2: Completed decoding.
        name: &#39;json&#39;
        alert.action: &#39;allowed&#39;
        alert.category: &#39;Attempted Administrator Privilege Gain&#39;
        alert.gid: &#39;1&#39;
        alert.rev: &#39;3&#39;
        alert.severity: &#39;1&#39;
        alert.signature: &#39;ET WEB_SERVER Possible CVE-2014-6271 Attempt in HTTP Version Number&#39;
        alert.signature_id: &#39;2019236&#39;
        dest_ip: &#39;16.10.10.11&#39;
        dest_port: &#39;80&#39;
        event_type: &#39;alert&#39;
        flow_id: &#39;1234&#39;
        host: &#39;suricata.com&#39;
        in_iface: &#39;eth0&#39;
        payload: &#39;21YW5kXBtgdW5zIGRlcHJY2F0QgYWI&#39;
        payload_printable: &#39;this_is_an_example&#39;
        proto: &#39;TCP&#39;
        src_ip: &#39;16.10.10.10&#39;
        src_port: &#39;5555&#39;
        stream: &#39;0&#39;
        timestamp: &#39;2016-05-02T17:46:48.515262+0000&#39;

**Phase 3: Completed filtering (rules).
        id: &#39;86601&#39;
        level: &#39;3&#39;
        description: &#39;Suricata: Alert - ET WEB_SERVER Possible CVE-2014-6271 Attempt in HTTP Version Number&#39;
        groups: &#39;[&#39;ids&#39;, &#39;suricata&#39;]&#39;
        firedtimes: &#39;1&#39;
        mail: &#39;False&#39;
**Alert to be generated.</code></pre>

<p><strong>示例二：使用 JSON 解码器提取包含在传入日志中的 JSON</strong></p>
<p>解码器选项中引入的新属性偏移量(offset)，它允许丢弃输入字符串的某些部分</p>
<p>输入日志：</p>
<pre class="language-none"><code class="language-none">2018 Apr 04 13:11:52 nba_program: this_is_an_example: &quot; player_information: &quot;&#123; &quot;name&quot;: &quot;Stephen&quot;, &quot;surname&quot;: &quot;Curry&quot;, &quot;team&quot;: &quot;Golden State Warriors&quot;, &quot;number&quot;: 30, &quot;position&quot;: &quot;point guard&quot;&#125;</code></pre>

<p>使用该新功能的解码器声明如下：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>raw_json<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>program_name</span><span class="token punctuation">></span></span>nba_program<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>program_name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prematch</span><span class="token punctuation">></span></span>player_information: "<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prematch</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin_decoder</span> <span class="token attr-name">offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>after_prematch<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>JSON_Decoder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin_decoder</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">></span></span></code></pre>

<p>JSON 解码器会将 JSON 事件中包含的字段提取为动态字段，并从预匹配文本的末尾开始过滤</p>
<p>wazuh-logtest 的输出如下：</p>
<pre class="language-none"><code class="language-none">Type one log per line

2018 Apr 04 13:11:52 nba_program: this_is_an_example: &quot; player_information: &quot;&#123; &quot;name&quot;: &quot;Stephen&quot;, &quot;surname&quot;: &quot;Curry&quot;, &quot;team&quot;: &quot;Golden State Warriors&quot;, &quot;number&quot;: 30, &quot;position&quot;: &quot;point guard&quot;&#125;

**Phase 1: Completed pre-decoding.
        full event: &#39;2018 Apr 04 13:11:52 nba_program: this_is_an_example: &quot; player_information: &quot;&#123; &quot;name&quot;: &quot;Stephen&quot;, &quot;surname&quot;: &quot;Curry&quot;, &quot;team&quot;: &quot;Golden State Warriors&quot;, &quot;number&quot;: 30, &quot;position&quot;: &quot;point guard&quot;&#125;&#39;
        timestamp: &#39;2018 Apr 04 13:11:52&#39;
        program_name: &#39;nba_program&#39;

**Phase 2: Completed decoding.
        name: &#39;raw_json&#39;
        name: &#39;Stephen&#39;
        number: &#39;30&#39;
        position: &#39;point guard&#39;
        surname: &#39;Curry&#39;
        team: &#39;Golden State Warriors&#39;</code></pre>

<p>可见，JSON 解码器不再受有效 JSON 对象之后的任何数据影响</p>
<h3 id="3-自定义规则-x2F-解码器"><a href="#3-自定义规则-x2F-解码器" class="headerlink" title="3. 自定义规则&#x2F;解码器"></a>3. 自定义规则&#x2F;解码器</h3><p>可以修改 Wazuh 规则集中的默认规则和解码器，也可以添加新规则和解码器以提高 Wazuh 的检测能力。</p>
<h4 id="a-添加新的解码器和规则"><a href="#a-添加新的解码器和规则" class="headerlink" title="a. 添加新的解码器和规则"></a>a. 添加新的解码器和规则</h4><ul>
<li><p>使用 local_decoder.xml 和 local_rules.xml 来实现小改动，大规模更改&#x2F;添加最好创建一个新的解码器和&#x2F;或规则文件</p>
</li>
<li><p>自定义规则的 <code>&lt;id&gt;</code> 将在 100000 到 120000 的范围内</p>
</li>
</ul>
<p>示例</p>
<pre class="language-none"><code class="language-none">Dec 25 20:45:02 MyHost example[12345]: User &#39;admin&#39; logged from &#39;192.168.1.100&#39;</code></pre>

<p>首先，需要解码这些信息，将新的解码器添加到<code>/var/ossec/etc/decoders/local_decoder.xml</code></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>example<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>program_name</span><span class="token punctuation">></span></span>^example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>program_name</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>example<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regex</span><span class="token punctuation">></span></span>User '(\w+)' logged from '(\d+.\d+.\d+.\d+)'<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regex</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>order</span><span class="token punctuation">></span></span>user, srcip<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>order</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">></span></span></code></pre>

<p>然后，将以下规则添加到<code>/var/ossec/etc/rules/local_rules.xml</code></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100010<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>program_name</span><span class="token punctuation">></span></span>example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>program_name</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>User logged<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<p>使用 &#x2F;var&#x2F;ossec&#x2F;bin&#x2F;wazuh-logtest 检查它是否有效：</p>
<pre class="language-none"><code class="language-none">Type one log per line

Dec 25 20:45:02 MyHost example[12345]: User &#39;admin&#39; logged from &#39;192.168.1.100&#39;

**Phase 1: Completed pre-decoding.
        full event: &#39;Dec 25 20:45:02 MyHost example[12345]: User &#39;admin&#39; logged from &#39;192.168.1.100&#39;&#39;
        timestamp: &#39;Dec 25 20:45:02&#39;
        hostname: &#39;MyHost&#39;
        program_name: &#39;example&#39;

**Phase 2: Completed decoding.
        name: &#39;example&#39;
        dstuser: &#39;admin&#39;
        srcip: &#39;192.168.1.100&#39;

**Phase 3: Completed filtering (rules).
        id: &#39;100010&#39;
        level: &#39;0&#39;
        description: &#39;User logged&#39;
        groups: &#39;[&#39;local&#39;, &#39;syslog&#39;, &#39;sshd&#39;]&#39;
        firedtimes: &#39;1&#39;
        mail: &#39;False&#39;</code></pre>

<h4 id="b-更改现有规则"><a href="#b-更改现有规则" class="headerlink" title="b. 更改现有规则"></a>b. 更改现有规则</h4><p>对 <code>/var/ossec/ruleset/rules</code> 文件夹中任何规则文件的更改将在更新过程中丢失。使用以下过程来保留更改</p>
<p><strong>示例：将SSH 规则 5710 的级别值从 5 更改为 10</strong></p>
<ol>
<li>打开 <code>/var/ossec/ruleset/rules/0095-sshd_rules.xml</code></li>
</ol>
<p>2）从规则文件中查找并复制以下代码</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5710<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>5700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>illegal user|invalid user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>sshd: Attempt to login using a non-existent user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mitre</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>T1110<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mitre</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span>invalid_login,authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_10.6.1,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,nist_800_53_AU.6,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<p>3）将代码粘贴到<code>/var/ossec/etc/rules/local_rules.xml</code>中，修改level值，添加<code>overwrite=&quot;yes&quot;</code>表示这条规则覆盖了一个已经定义好的规则</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5710<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">overwrite</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>5700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>illegal user|invalid user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>sshd: Attempt to login using a non-existent user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mitre</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>T1110<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mitre</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span>invalid_login,authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_10.6.1,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,nist_800_53_AU.6,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<h4 id="c-更改现有解码器"><a href="#c-更改现有解码器" class="headerlink" title="c. 更改现有解码器"></a>c. 更改现有解码器</h4><p><code>/var/ossec/ruleset/decoders</code> 文件夹中的任何解码器文件的更改都将在更新过程中丢失。使用以下过程来保留您的更改。</p>
<p><strong>示例：更改解码器文件 0310-ssh_decoders.xml 中的某些内容</strong></p>
<ol>
<li><p>将解码器文件 <code>/var/ossec/ruleset/decoders/0310-ssh_decoders.xml</code> 从默认文件夹复制到用户文件夹 <code>/var/ossec/etc/decoders</code> 以保留更改。</p>
</li>
<li><p>从 OSSEC 加载列表中排除原始解码器文件 <code>ruleset/decoders/0310-ssh_decoders.xml</code>。为此，请在 ossec.conf 文件中使用标签 <code>&lt;decoder_exclude&gt;</code>，这样就不会从默认的解码器文件夹中加载指定的解码器，而是加载保存在用户文件夹中的解码器文件</p>
</li>
</ol>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ruleset</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- Default ruleset --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder_dir</span><span class="token punctuation">></span></span>ruleset/decoders<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder_dir</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule_dir</span><span class="token punctuation">></span></span>ruleset/rules<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule_dir</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule_exclude</span><span class="token punctuation">></span></span>0215-policy_rules.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule_exclude</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">></span></span>etc/lists/audit-keys<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">></span></span>

  <span class="token comment">&lt;!-- User-defined ruleset --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder_dir</span><span class="token punctuation">></span></span>etc/decoders<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder_dir</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule_dir</span><span class="token punctuation">></span></span>etc/rules<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule_dir</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder_exclude</span><span class="token punctuation">></span></span>ruleset/decoders/0310-ssh_decoders.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder_exclude</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ruleset</span><span class="token punctuation">></span></span></code></pre>

<ol start="3">
<li>执行文件 <code>/var/ossec/etc/decoders/0310-ssh_decoders.xml</code> 中的更改</li>
</ol>
<h3 id="4-动态字段"><a href="#4-动态字段" class="headerlink" title="4. 动态字段"></a>4. 动态字段</h3><h4 id="a-传统解码器"><a href="#a-传统解码器" class="headerlink" title="a. 传统解码器"></a>a. 传统解码器</h4><p>检测和处理威胁的一个重要步骤是从收到的每个事件中提取信息。Wazuh 使用解码器来识别事件类型，然后提取最相关的字段，从而丰富事件并允许对它们进行更深入的分析和索引。</p>
<p>OSSEC提供了十三个预定义字段用于存储提取的信息（user、srcip、dstip、srcport、dstport、protocol、action、id、url、data、extra_data、status、system_name），其中只有八个可以同时提取</p>
<p><strong>静态字段：</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>web-accesslog<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>web-log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prematch</span><span class="token punctuation">></span></span>^\d+.\d+.\d+.\d+ - <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prematch</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regex</span><span class="token punctuation">></span></span>^(\d+.\d+.\d+.\d+) - \S+ [\S+ -\d+] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regex</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regex</span><span class="token punctuation">></span></span>"\w+ (\S+) HTTP\S+ (\d+) <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regex</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>order</span><span class="token punctuation">></span></span>srcip,url,id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>order</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">></span></span></code></pre>

<h4 id="b-动态解码器"><a href="#b-动态解码器" class="headerlink" title="b. 动态解码器"></a>b. 动态解码器</h4><p>当需要从一个事件中提取八个以上的相关字段，而且提取的实际数据项通常与有限的预定义字段名称列表无关时用到。Wazuh扩展了 OSSEC 以允许解码无限数量的字段，这些字段的字段名称与正在提取的内容明确相关。</p>
<p><strong>动态字段：</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>auditd-config_change<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>auditd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regex</span> <span class="token attr-name">offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>after_regex<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>^auid=(\S+) ses=(\S+) op="(\.+)"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regex</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>order</span><span class="token punctuation">></span></span>audit.auid,audit.session,audit.op<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>order</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">></span></span></code></pre>

<p>Wazuh 将 <code>&lt;order&gt;</code> 标签中包含的任何字段名称转换为 JSON 字段</p>
<p>示例显示 auditd 解码器如何从警报中提取信息：</p>
<pre class="language-none"><code class="language-none">** Alert 1486483073.60589: - audit,audit_configuration,
2017 Feb 07 15:57:53 wazuh-example-&gt;&#x2F;var&#x2F;log&#x2F;audit&#x2F;audit.log
Rule: 80705 (level 3) -&gt; &#39;Auditd: Configuration changed&#39;
type&#x3D;CONFIG_CHANGE msg&#x3D;audit(1486483072.194:20): auid&#x3D;0 ses&#x3D;6 op&#x3D;&quot;add rule&quot; key&#x3D;&quot;audit-wazuh-a&quot; list&#x3D;4 res&#x3D;1
audit.type: CONFIG_CHANGE
audit.id: 20
audit.auid: 0
audit.session: 6
audit.op: add rule
audit.key: audit
audit.list: 4
audit.res: 1</code></pre>

<p>JSON 输出：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"rule"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"level"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Auditd: Configuration changed"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">80705</span><span class="token punctuation">,</span>
    <span class="token property">"firedtimes"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"audit"</span><span class="token punctuation">,</span>
      <span class="token string">"audit_configuration"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"agent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"000"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"wazuh-example"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"manager"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"wazuh-example"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"full_log"</span><span class="token operator">:</span> <span class="token string">"type=CONFIG_CHANGE msg=audit(1486483072.194:20): auid=0 ses=6 op=\"add rule\" key=\"audit-wazuh-a\" list=4 res=1"</span><span class="token punctuation">,</span>
  <span class="token property">"audit"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"CONFIG_CHANGE"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"20"</span><span class="token punctuation">,</span>
    <span class="token property">"auid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
    <span class="token property">"session"</span><span class="token operator">:</span> <span class="token string">"6"</span><span class="token punctuation">,</span>
    <span class="token property">"op"</span><span class="token operator">:</span> <span class="token string">"add rule"</span><span class="token punctuation">,</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"audit"</span><span class="token punctuation">,</span>
    <span class="token property">"list"</span><span class="token operator">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>
    <span class="token property">"res"</span><span class="token operator">:</span> <span class="token string">"1"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"decoder"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"parent"</span><span class="token operator">:</span> <span class="token string">"auditd"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"auditd"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2017 Feb 07 15:57:53"</span><span class="token punctuation">,</span>
  <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"/var/log/audit/audit.log"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="5-XML格式规则集"><a href="#5-XML格式规则集" class="headerlink" title="5. XML格式规则集"></a>5. XML格式规则集</h3><h4 id="a-解码器语法"><a href="#a-解码器语法" class="headerlink" title="a. 解码器语法"></a>a. 解码器语法</h4><p>解码器从接收到的事件中提取信息。当接收到事件时，解码器将信息分成块，为后续分析做准备。</p>
<p><strong>解码器中的配置选项</strong></p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">decoder</td>
<td align="left">Name of the decoder</td>
<td align="left">此属性定义解码器</td>
</tr>
<tr>
<td align="left">parent</td>
<td align="left">Any decoder’s name</td>
<td align="left">引用父解码器，当前解码器将成为子解码器</td>
</tr>
<tr>
<td align="left">accumulate</td>
<td align="left">None</td>
<td align="left">允许通过多个日志消息跟踪事件</td>
</tr>
<tr>
<td align="left">program_name</td>
<td align="left">Any regex, sregex or pcre2 expression.</td>
<td align="left">定义了与解码器关联的程序的名称</td>
</tr>
<tr>
<td align="left">prematch</td>
<td align="left">Any regex or pcre2 expression.</td>
<td align="left">预匹配，在日志中查找匹配项</td>
</tr>
<tr>
<td align="left">regex</td>
<td align="left">Any regex or pcre2 expression.</td>
<td align="left">查找所需的字段并提取它们。</td>
</tr>
<tr>
<td align="left">order</td>
<td align="left">See order table</td>
<td align="left">正则表达式将提取的值将存储在这些组中</td>
</tr>
<tr>
<td align="left">fts</td>
<td align="left">See fts table</td>
<td align="left">首次出现</td>
</tr>
<tr>
<td align="left">ftscomment</td>
<td align="left">Any String</td>
<td align="left">为 fts 添加注解</td>
</tr>
<tr>
<td align="left">plugin_decoder</td>
<td align="left">See below</td>
<td align="left">指定一个将进行解码的插件</td>
</tr>
<tr>
<td align="left">use_own_name</td>
<td align="left">TRUE</td>
<td align="left">仅适用于子解码器</td>
</tr>
<tr>
<td align="left">json_null_field</td>
<td align="left">String</td>
<td align="left">添加决定如何存储 JSON 中的空值的选项</td>
</tr>
<tr>
<td align="left">json_array_structure</td>
<td align="left">String</td>
<td align="left">添加决定如何存储来自 JSON 的数组结构的选项</td>
</tr>
<tr>
<td align="left">var</td>
<td align="left">Name for the variable.</td>
<td align="left">定义可以在同一个文件中重复使用的变量</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">See type table</td>
<td align="left">设置解码器要匹配的日志类型</td>
</tr>
</tbody></table>
<p><em>详细用法：</em> <a target="_blank" rel="noopener" href="https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/decoders.html">ruleset&#x2F;ruleset-xml-syntax&#x2F;decoders.html</a></p>
<h4 id="b-规则语法"><a href="#b-规则语法" class="headerlink" title="b. 规则语法"></a>b. 规则语法</h4><p>Wazuh 规则集与任何常用规则相结合，用于分析传入事件并在适当时生成警报。</p>
<p><strong>用于配置规则的 xml 标签</strong></p>
<table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">rule</td>
<td align="left">See table below.</td>
<td align="left">启动一个新规则及其定义选项</td>
</tr>
<tr>
<td align="left">match</td>
<td align="left">Any regular expression.</td>
<td align="left">使用 sregex 在日志中查找匹配项，从而决定是否应触发规则</td>
</tr>
<tr>
<td align="left">regex</td>
<td align="left">Any regular expression.</td>
<td align="left">与match相同，但默认使用正则表达式</td>
</tr>
<tr>
<td align="left">decoded_as</td>
<td align="left">Any decoder’s name.</td>
<td align="left">与已被特定解码器解码的日志匹配</td>
</tr>
<tr>
<td align="left">category</td>
<td align="left">Any type.</td>
<td align="left">匹配解码器类型一致的日志</td>
</tr>
<tr>
<td align="left">field</td>
<td align="left">Name and any regular expression.</td>
<td align="left">将解码器按顺序提取的字段与正则表达式进行比较</td>
</tr>
<tr>
<td align="left">srcip</td>
<td align="left">Any IP address.</td>
<td align="left">将 IP 地址与解码为 srcip 的 IP 进行比较。利用 ！否定它</td>
</tr>
<tr>
<td align="left">dstip</td>
<td align="left">Any IP address.</td>
<td align="left">它将 IP 地址与解码为 dstip 的 IP 进行比较。利用 ！否定它</td>
</tr>
<tr>
<td align="left">srcport</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示端口的正则表达式与解码为 srcport 的值进行比较</td>
</tr>
<tr>
<td align="left">dstport</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示端口的正则表达式与解码为 dstport 的值进行比较</td>
</tr>
<tr>
<td align="left">data</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示数据的正则表达式与解码为data的值进行比较</td>
</tr>
<tr>
<td align="left">extra_data</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示额外数据的正则表达式与解码为 extra_data 的值进行比较</td>
</tr>
<tr>
<td align="left">user</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示用户的正则表达式与解码为user的值进行比较</td>
</tr>
<tr>
<td align="left">system_name</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示系统名称的正则表达式与解码为 system_name 的值进行比较</td>
</tr>
<tr>
<td align="left">program_name</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示程序名称的正则表达式与预解码为 program_name 的值进行比较</td>
</tr>
<tr>
<td align="left">protocol</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示协议的正则表达式与解码为协议的值进行比较</td>
</tr>
<tr>
<td align="left">hostname</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示主机名的正则表达式与预解码为主机名的值进行比较</td>
</tr>
<tr>
<td align="left">time</td>
<td align="left">Any time range. e.g. (hh:mm-hh:mm)</td>
<td align="left">检查事件是否在该时间范围内生成</td>
</tr>
<tr>
<td align="left">weekday</td>
<td align="left">monday - sunday, weekdays, weekends</td>
<td align="left">检查事件是否在某些工作日生成</td>
</tr>
<tr>
<td align="left">id</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示 ID 的正则表达式与解码为 id 的值进行比较</td>
</tr>
<tr>
<td align="left">url</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示 URL 的正则表达式与解码为 url 的值进行比较</td>
</tr>
<tr>
<td align="left">location</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示位置的正则表达式与预解码为位置的值进行比较</td>
</tr>
<tr>
<td align="left">action</td>
<td align="left">Any String or regular expression.</td>
<td align="left">将表示动作的字符串或正则表达式与解码为动作的值进行比较</td>
</tr>
<tr>
<td align="left">status</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示状态的正则表达式与解码为状态的值进行比较</td>
</tr>
<tr>
<td align="left">srcgeoip</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示 GeoIP 源的正则表达式与解码为 srcgeoip 的值进行比较</td>
</tr>
<tr>
<td align="left">dstgeoip</td>
<td align="left">Any regular expression.</td>
<td align="left">将表示 GeoIP 目的地的正则表达式与解码为 dstgeoip 的值进行比较</td>
</tr>
<tr>
<td align="left">if_sid</td>
<td align="left">A list of rule IDs separated by commas or spaces.</td>
<td align="left">工作原理类似于父解码器。当列表中的规则 ID 先前已匹配时，它将匹配</td>
</tr>
<tr>
<td align="left">if_group</td>
<td align="left">Any group name.</td>
<td align="left">如果指定的组之前匹配过，它将匹配</td>
</tr>
<tr>
<td align="left">if_level</td>
<td align="left">Any level from 1 to 16.</td>
<td align="left">如果该级别已经被另一个规则触发，它将匹配</td>
</tr>
<tr>
<td align="left">if_matched_sid</td>
<td align="left">Any rule ID (Number).</td>
<td align="left">与if_sid类似，但只有在一段时间内触发过ID才会匹配</td>
</tr>
<tr>
<td align="left">if_matched_group</td>
<td align="left">Any group name.</td>
<td align="left">与 if_group 类似，但它只会在该组在一段时间内被触发时才会匹配</td>
</tr>
<tr>
<td align="left">same_id</td>
<td align="left">None.</td>
<td align="left">解码后的 id 必须相同</td>
</tr>
<tr>
<td align="left">different_id</td>
<td align="left">None.</td>
<td align="left">解码后的 id 必须不同</td>
</tr>
<tr>
<td align="left">same_srcip</td>
<td align="left">None.</td>
<td align="left">解码后的 srcip 必须相同</td>
</tr>
<tr>
<td align="left">different_srcip</td>
<td align="left">None.</td>
<td align="left">解码后的 srcip 必须不同</td>
</tr>
<tr>
<td align="left">same_dstip</td>
<td align="left">None.</td>
<td align="left">解码后的 dsrcip 必须相同</td>
</tr>
<tr>
<td align="left">different_dstip</td>
<td align="left">None.</td>
<td align="left">解码后的 dsrcip 必须不同</td>
</tr>
<tr>
<td align="left">same_srcport</td>
<td align="left">None.</td>
<td align="left">解码后的 srcport 必须相同</td>
</tr>
<tr>
<td align="left">different_srcport</td>
<td align="left">None.</td>
<td align="left">解码后的 srcport 必须不同</td>
</tr>
<tr>
<td align="left">same_dstport</td>
<td align="left">None.</td>
<td align="left">解码后的 dstport 必须相同</td>
</tr>
<tr>
<td align="left">different_dstport</td>
<td align="left">None.</td>
<td align="left">解码后的 dstport 必须不同</td>
</tr>
<tr>
<td align="left">same_location</td>
<td align="left">None.</td>
<td align="left">location必须相同</td>
</tr>
<tr>
<td align="left">different_location</td>
<td align="left">None.</td>
<td align="left">location必须不同</td>
</tr>
<tr>
<td align="left">same_srcuser</td>
<td align="left">None.</td>
<td align="left">解码后的 srcuser 必须相同</td>
</tr>
<tr>
<td align="left">different_srcuser</td>
<td align="left">None.</td>
<td align="left">解码后的 srcuser 必须不同</td>
</tr>
<tr>
<td align="left">same_user</td>
<td align="left">None.</td>
<td align="left">解码后的user必须相同</td>
</tr>
<tr>
<td align="left">different_user</td>
<td align="left">None.</td>
<td align="left">解码后的user必须不同</td>
</tr>
<tr>
<td align="left">same_field</td>
<td align="left">None.</td>
<td align="left">解码field必须与前面的字段相同</td>
</tr>
<tr>
<td align="left">different_field</td>
<td align="left">None.</td>
<td align="left">解码field必须与之前的字段不同</td>
</tr>
<tr>
<td align="left">same_protocol</td>
<td align="left">None.</td>
<td align="left">解码后的protocol必须相同</td>
</tr>
<tr>
<td align="left">different_protocol</td>
<td align="left">None.</td>
<td align="left">解码后的protocol必须不同</td>
</tr>
<tr>
<td align="left">same_action</td>
<td align="left">None.</td>
<td align="left">解码后的action必须相同</td>
</tr>
<tr>
<td align="left">different_action</td>
<td align="left">None.</td>
<td align="left">解码后的action必须不同</td>
</tr>
<tr>
<td align="left">same_data</td>
<td align="left">None.</td>
<td align="left">解码后的data必须相同</td>
</tr>
<tr>
<td align="left">different_data</td>
<td align="left">None.</td>
<td align="left">解码后的data必须不同</td>
</tr>
<tr>
<td align="left">same_extra_data</td>
<td align="left">None.</td>
<td align="left">解码后的extra_data必须相同</td>
</tr>
<tr>
<td align="left">different_extra_data</td>
<td align="left">None.</td>
<td align="left">解码后的extra_data必须不同</td>
</tr>
<tr>
<td align="left">same_status</td>
<td align="left">None.</td>
<td align="left">解码后的status必须相同</td>
</tr>
<tr>
<td align="left">different_status</td>
<td align="left">None.</td>
<td align="left">解码后的status必须不同</td>
</tr>
<tr>
<td align="left">same_system_name</td>
<td align="left">None.</td>
<td align="left">解码后的system_name必须相同</td>
</tr>
<tr>
<td align="left">different_system_name</td>
<td align="left">None.</td>
<td align="left">解码后的system_name必须不同</td>
</tr>
<tr>
<td align="left">same_url</td>
<td align="left">None.</td>
<td align="left">解码后的url必须相同</td>
</tr>
<tr>
<td align="left">different_url</td>
<td align="left">None.</td>
<td align="left">解码后的url必须不同</td>
</tr>
<tr>
<td align="left">same_srcgeoip</td>
<td align="left">None.</td>
<td align="left">解码后的 srcgeoip 必须相同</td>
</tr>
<tr>
<td align="left">different_srcgeoip</td>
<td align="left">None.</td>
<td align="left">解码后的 srcgeoip 必须不同</td>
</tr>
<tr>
<td align="left">same_dstgeoip</td>
<td align="left">None.</td>
<td align="left">解码后的 dstgeoip 必须相同</td>
</tr>
<tr>
<td align="left">different_dstgeoip</td>
<td align="left">None.</td>
<td align="left">解码后的 dstgeoip 必须不同</td>
</tr>
<tr>
<td align="left">description</td>
<td align="left">Any String.</td>
<td align="left">规则描述</td>
</tr>
<tr>
<td align="left">list</td>
<td align="left">Path to the CDB file.</td>
<td align="left">使用 ossec 列表执行 CDB 查找</td>
</tr>
<tr>
<td align="left">info</td>
<td align="left">Any String.</td>
<td align="left">用某些属性的额外信息</td>
</tr>
<tr>
<td align="left">options</td>
<td align="left">See the table below.</td>
<td align="left">可以使用的附加规则选项</td>
</tr>
<tr>
<td align="left">check_diff</td>
<td align="left">None.</td>
<td align="left">确定命令的输出何时更改</td>
</tr>
<tr>
<td align="left">group</td>
<td align="left">Any String.</td>
<td align="left">向警报添加其他组</td>
</tr>
<tr>
<td align="left">mitre</td>
<td align="left">See Mitre table below.</td>
<td align="left">包含符合规则的Mitre Technique IDs</td>
</tr>
<tr>
<td align="left">var</td>
<td align="left">Name for the variable. Most used: BAD_WORDS</td>
<td align="left">定义一个可以在同一文件内的任何地方使用的变量</td>
</tr>
</tbody></table>
<p><em>详细用法：</em> <a target="_blank" rel="noopener" href="https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/rules.html">ruleset&#x2F;ruleset-xml-syntax&#x2F;rules.html</a></p>
<h2 id="0x04-安全能力"><a href="#0x04-安全能力" class="headerlink" title="0x04 安全能力"></a>0x04 安全能力</h2><table>
<thead>
<tr>
<th align="left">英文</th>
<th align="left">中文</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Log data analysis</td>
<td align="left">日志数据分析</td>
</tr>
<tr>
<td align="left">File integrity monitoring</td>
<td align="left">文件完整性监控</td>
</tr>
<tr>
<td align="left">Rootkits detection</td>
<td align="left">Rootkit检测</td>
</tr>
<tr>
<td align="left">Active response</td>
<td align="left">主动防御</td>
</tr>
<tr>
<td align="left">Security Configuration Assessment</td>
<td align="left">安全配置评估</td>
</tr>
<tr>
<td align="left">System inventory</td>
<td align="left">资产盘点</td>
</tr>
<tr>
<td align="left">Vulnerability detection</td>
<td align="left">漏洞检测</td>
</tr>
<tr>
<td align="left">Cloud security</td>
<td align="left">云安全</td>
</tr>
<tr>
<td align="left">Container security</td>
<td align="left">容器安全</td>
</tr>
<tr>
<td align="left">Regulatory compliance</td>
<td align="left">合规检测</td>
</tr>
</tbody></table>
<h3 id="1-日志数据分析"><a href="#1-日志数据分析" class="headerlink" title="1. 日志数据分析"></a>1. 日志数据分析</h3><p>日志数据收集是感知服务器或设备生成的记录的实时过程，该组件可以通过文本文件或 Windows 事件日志接收日志。它还可以通过远程系统日志直接接收日志，适用于防火墙和其他此类设备。</p>
<p>此过程的目的是识别应用程序或系统错误、配置错误、入侵行为、违反策略或安全问题。</p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/log-analysis-flow1.png"></p>
<h4 id="a-日志文件"><a href="#a-日志文件" class="headerlink" title="a. 日志文件"></a>a. 日志文件</h4><p>日志分析引擎可以配置为监控服务器上的特定文件。</p>
<p>Linux:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/example.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<p>Windows:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>C:\myapp\example.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<p>macOS ULS logs:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>macos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>macos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>query</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>log,activity<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>debug<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>process == "sshd" OR message CONTAINS "invalid"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>query</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<h4 id="b-远程syslog"><a href="#b-远程syslog" class="headerlink" title="b. 远程syslog"></a>b. 远程syslog</h4><p>日志分析组件可以配置为通过 syslog 接收日志事件，有两种方式：</p>
<ul>
<li><p>在自定义端口接收 syslog 日志</p>
</li>
<li><p>将 syslog 日志存储在一个纯文本文件中并使用 Wazuh 进行监控</p>
</li>
</ul>
<p><strong>配置 Wazuh 以在给定端口接收日志：</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remote</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>connection</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>connection</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">></span></span>513<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>protocol</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>protocol</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>allowed-ips</span><span class="token punctuation">></span></span>192.168.2.0/24<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>allowed-ips</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>remote</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<ul>
<li><code>&lt;connection&gt;syslog&lt;/connection&gt;</code> 表示管理器将接受来自网络传入的系统日志消息</li>
<li><code>&lt;port&gt;513&lt;/port&gt;</code> 定义 Wazuh 将监听以检索日志的端口，需未占用</li>
<li><code>&lt;allowed-ips&gt;192.168.2.0/24&lt;/allowed-ips&gt;</code> 定义将从中接受系统日志消息的网络或 IP 地址</li>
</ul>
<p><strong>将 syslog 日志存储在一个纯文本文件中并使用 Wazuh 进行监控:</strong></p>
<p>此方法将日志存储在纯文本文件中并监视该文件, 需先 &#x2F;etc&#x2F;rsyslog.conf 配置文件并且定义存储系统日志的位置, 配置一个以 syslog 作为日志格式的 <code>&lt;localfile&gt;</code> 块来监控</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/custom/file/path<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<ul>
<li><code>&lt;log_format&gt;syslog&lt;/log_format&gt;</code> 表示源日志格式</li>
<li><code>&lt;location&gt;/custom/file/path&lt;/location&gt;</code> 表示存储 syslog 日志的位置</li>
</ul>
<h4 id="c-日志分析"><a href="#c-日志分析" class="headerlink" title="c. 日志分析"></a>c. 日志分析</h4><p><strong>预解码</strong></p>
<p>在分析的预解码阶段，从日志头中提取字段的静态信息</p>
<pre class="language-none"><code class="language-none">Feb 14 12:19:04 localhost sshd[25474]: Accepted password for rromero from 192.168.1.133 port 49765 ssh2</code></pre>

<p>提取的信息：</p>
<ul>
<li><p>hostname: ‘localhost’</p>
</li>
<li><p>program_name: ‘sshd’</p>
</li>
</ul>
<p><strong>解码</strong></p>
<p>在解码阶段，判断日志消息以确定它是什么类型的日志，然后提取该特定日志类型的已知字段</p>
<pre class="language-none"><code class="language-none">Feb 14 12:19:04 localhost sshd[25474]: Accepted password for rromero from 192.168.1.133 port 49765 ssh2</code></pre>

<p>提取的信息：</p>
<ul>
<li><p>program name: sshd</p>
</li>
<li><p>dstuser: rromero</p>
</li>
<li><p>srcip: 192.168.1.133</p>
</li>
</ul>
<p><strong>规则匹配</strong></p>
<p>在下一阶段，将提取的日志信息与规则集进行比较以寻找匹配项，如下示例匹配ssh登录成功的事件：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5715<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>5700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>^Accepted|authenticated.$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>sshd: authentication success.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span>authentication_success,pci_dss_10.2.5,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<p><strong>告警</strong></p>
<p>匹配规则后，管理器将创建如下警报：</p>
<pre class="language-none"><code class="language-none">** Alert 1487103546.21448: - syslog,sshd,authentication_success,pci_dss_10.2.5,
2017 Feb 14 12:19:06 localhost-&gt;&#x2F;var&#x2F;log&#x2F;secure
Rule: 5715 (level 3) -&gt; &#39;sshd: authentication success.&#39;
Src IP: 192.168.1.133
User: rromero
Feb 14 12:19:04 localhost sshd[25474]: Accepted password for rromero from 192.168.1.133 port 49765 ssh2</code></pre>

<p>警报将存储在 <code>/var/ossec/logs/alerts/alerts.(json|log)</code> 中，事件存储在 <code>/var/ossec/logs/archives/archives.(json|log)</code> 中</p>
<h4 id="4-日志配置"><a href="#4-日志配置" class="headerlink" title="4. 日志配置"></a>4. 日志配置</h4><p><strong>基本用法</strong></p>
<p>日志数据采集配置在<code>ossec.conf</code>文件中，主要用到 localfile、remote和global部分；也可以在 <code>agent.conf</code> 文件中完成配置，以将这些配置集中分发给对应agent</p>
<p>设置要监视的文件的名称和格式：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/messages<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<p><strong>使用文件名的通配符模式监控日志</strong></p>
<p>Wazuh 支持 posix 通配符模式，例如分析 &#x2F;var&#x2F;log 目录中以 .log 结尾的每个文件，使用以下配置：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/*.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<p><strong>监控基于日期的日志</strong></p>
<p>对于根据日期变化的日志文件，还可以指定strftime格式来代替日、月、年等，例如监控<code>C:\Windows\app\log-08-12-15.log</code> 类似日志文件，使用如下配置：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>C:\Windows\app\log-%y-%m-%d.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<p><strong>使用环境变量</strong></p>
<p>可以在位置模式中使用 <code>%WinDir%</code> 等环境变量。以下是从 IIS 服务器读取日志的示例：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>%SystemDrive%\inetpub\logs\LogFiles\W3SVC1\u_ex%y%m%d.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>iis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<p><strong>使用多个输出</strong></p>
<p>默认情况下，日志数据发送到agent socket，但也可以指定其他socket作为输出。 wazuh-logcollector 使用 UNIX 类型socket进行通信，允许 TCP 或 UDP 协议。</p>
<p>要添加一个新的输出socket，我们需要使用标签<code> &lt;socket&gt;</code> 来指定:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>socket</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>custom_socket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/run/custom.sock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mode</span><span class="token punctuation">></span></span>tcp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mode</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prefix</span><span class="token punctuation">></span></span>custom_syslog: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prefix</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>socket</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>socket</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>test_socket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/run/test.sock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>socket</span><span class="token punctuation">></span></span></code></pre>

<p>当定义了socket，就可以为每个 localfile 添加目标socket：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/messages<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">></span></span>agent,test_socket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/messages<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">></span></span>custom_socket,test_socket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<h3 id="2-文件完整性监控"><a href="#2-文件完整性监控" class="headerlink" title="2. 文件完整性监控"></a>2. 文件完整性监控</h3><h4 id="a-实现原理"><a href="#a-实现原理" class="headerlink" title="a. 实现原理"></a>a. 实现原理</h4><p>Wazuh 文件完整性监控 (FIM) 系统监视选定的文件并在这些文件被修改时触发警报。负责此任务的组件称为 <code>syscheck</code>。</p>
<p>FIM 模块位于 Wazuh agent中，定期扫描并将受监控文件和 Windows 注册表项的校验和与属性存储在本地 FIM 数据库中。该模块通过将新文件的校验和与旧校验和进行比较来查找修改。所有检测到的变化都会报告给 Wazuh agent。</p>
<p>新的 FIM 同步机制确保 Wazuh 管理器中的文件清单始终根据 Wazuh agent进行更新，FIM 同步基于定期计算 Wazuh agent和 Wazuh 管理器数据库之间的完整性，在 Wazuh 管理器中仅更新变化的文件。只要在受监视的文件和&#x2F;或注册表项中检测到修改，就会生成警报。</p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/fim-flow1.png"></p>
<p>FIM 生成的示例警报：</p>
<pre class="language-none"><code class="language-none">** Alert 1540815355.847397: - ossec,syscheck,pci_dss_11.5,gpg13_4.11,gdpr_II_5.1.f,
2018 Oct 29 13:15:55 (ubuntu) 10.0.0.144-&gt;syscheck
Rule: 550 (level 7) -&gt; &#39;Integrity checksum changed.&#39;
File &#39;&#x2F;test&#x2F;hello&#39; checksum changed.
Old md5sum was: &#39;2a4732b1de5db823e94d662d207b8fb2&#39;
New md5sum is : &#39;146c07ef2479cedcd54c7c2af5cf3a80&#39;
Old sha1sum was: &#39;b89f4786dcf00fb1c4ddc6ad282ca0feb3e18e1b&#39;
New sha1sum is : &#39;e1efc99729beb17560e02d1f5c15a42a985fe42c&#39;
Old sha256sum was: &#39;a8a3ea3ddbea6b521e4c0e8f2cca8405e75c042b2a7ed848baaa03e867355bc2&#39;
New sha256sum is : &#39;a7998f247bd965694ff227fa325c81169a07471a8b6808d3e002a486c4e65975&#39;
Old modification time was: &#39;Mon Oct 29 13:15:19 2018&#39;, now it is &#39;Mon Oct 29 13:15:54 2018&#39;
(Audit) User: &#39;root (0)&#39;
(Audit) Login user: &#39;test (1000)&#39;
(Audit) Effective user: &#39;root (0)&#39;
(Audit) Group: &#39;root (0)&#39;
(Audit) Process id: &#39;26089&#39;
(Audit) Process name: &#39;&#x2F;bin&#x2F;nano&#39;

Attributes:
- Size: 4
- Permissions: 100644
- Date: Mon Oct 29 13:15:54 2018
- Inode: 537259
- User: root (0)
- Group: root (0)
- MD5: 146c07ef2479cedcd54c7c2af5cf3a80
- SHA1: e1efc99729beb17560e02d1f5c15a42a985fe42c
- SHA256: a7998f247bd965694ff227fa325c81169a07471a8b6808d3e002a486c4e65975</code></pre>

<h4 id="b-FIM-字段-规则映射"><a href="#b-FIM-字段-规则映射" class="headerlink" title="b. FIM 字段-规则映射"></a>b. FIM 字段-规则映射</h4><p><strong>FIM - Alerts字段映射</strong></p>
<table>
<thead>
<tr>
<th align="left">FIM字段</th>
<th align="left">Alert字段</th>
<th align="left">字段描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">file</td>
<td align="left">path</td>
<td align="left">当前事件中的文件路径</td>
</tr>
<tr>
<td align="left">size</td>
<td align="left">size_after</td>
<td align="left">当前事件中的文件大小</td>
</tr>
<tr>
<td align="left">hard_links</td>
<td align="left">hard_links</td>
<td align="left">文件的硬链接列表</td>
</tr>
<tr>
<td align="left">mode</td>
<td align="left">mode</td>
<td align="left">FIM 事件模式</td>
</tr>
<tr>
<td align="left">perm</td>
<td align="left">perm_after,win_perm_after</td>
<td align="left">文件权限</td>
</tr>
<tr>
<td align="left">uid</td>
<td align="left">uid_after</td>
<td align="left">文件所有者的用户 ID</td>
</tr>
<tr>
<td align="left">gid</td>
<td align="left">gid_after</td>
<td align="left">共享文件所有权的组的组 ID</td>
</tr>
<tr>
<td align="left">uname</td>
<td align="left">uname_after</td>
<td align="left">文件所有者的用户名</td>
</tr>
<tr>
<td align="left">gname</td>
<td align="left">gname_after</td>
<td align="left">共享文件所有权的组的组名</td>
</tr>
<tr>
<td align="left">md5</td>
<td align="left">md5_after</td>
<td align="left">当前事件中文件的 MD5 哈希（更改后）</td>
</tr>
<tr>
<td align="left">sha1</td>
<td align="left">sha1_after</td>
<td align="left">当前事件中文件的 SHA1 哈希（更改后）</td>
</tr>
<tr>
<td align="left">sha256</td>
<td align="left">sha256_after</td>
<td align="left">当前事件中文件的 SHA256 哈希（更改后）</td>
</tr>
<tr>
<td align="left">mtime</td>
<td align="left">mtime_after</td>
<td align="left">文件更改的时间戳</td>
</tr>
<tr>
<td align="left">inode</td>
<td align="left">inode_after</td>
<td align="left">当前事件中文件的inode</td>
</tr>
<tr>
<td align="left">changed_content</td>
<td align="left">diff</td>
<td align="left">当前事件文件更改报告</td>
</tr>
<tr>
<td align="left">changed_fields</td>
<td align="left">changed_attributes</td>
<td align="left">文件中的更改字段（权限、内容等…）</td>
</tr>
<tr>
<td align="left">win_attributes</td>
<td align="left">attrs_after</td>
<td align="left">文件属性（隐藏、只读等…）</td>
</tr>
<tr>
<td align="left">tag</td>
<td align="left">tag</td>
<td align="left">添加到一个特定事件的自定义标签</td>
</tr>
<tr>
<td align="left">user_id</td>
<td align="left">audit.user.id</td>
<td align="left">触发事件的用户的实际ID</td>
</tr>
<tr>
<td align="left">user_name</td>
<td align="left">audit.user.name</td>
<td align="left">触发事件的用户的实际名称</td>
</tr>
<tr>
<td align="left">group_id</td>
<td align="left">audit.group.id</td>
<td align="left">触发事件的用户的实际组 ID</td>
</tr>
<tr>
<td align="left">group_name</td>
<td align="left">audit.group.name</td>
<td align="left">触发事件的用户的实际组名</td>
</tr>
<tr>
<td align="left">process_name</td>
<td align="left">audit.process.name</td>
<td align="left">触发事件的用户运行的进程的名称</td>
</tr>
<tr>
<td align="left">process_id</td>
<td align="left">audit.process.id</td>
<td align="left">触发事件的用户运行的进程的 ID</td>
</tr>
<tr>
<td align="left">ppid</td>
<td align="left">audit.process.ppid</td>
<td align="left">触发事件的父进程 ID</td>
</tr>
<tr>
<td align="left">effective_uid</td>
<td align="left">audit.effective.user_id</td>
<td align="left">触发事件的进程使用的有效用户 ID</td>
</tr>
<tr>
<td align="left">effective_name</td>
<td align="left">audit.effective_user.name</td>
<td align="left">触发事件的进程使用的有效用户名</td>
</tr>
<tr>
<td align="left">parent_name</td>
<td align="left">audit.process.parent_name</td>
<td align="left">触发事件的进程的父进程的进程名称</td>
</tr>
<tr>
<td align="left">cwd</td>
<td align="left">audit.process.cwd</td>
<td align="left">触发事件的进程的当前工作目录</td>
</tr>
<tr>
<td align="left">parent_cwd</td>
<td align="left">audit.process.parent_cwd</td>
<td align="left">父进程的当前工作目录</td>
</tr>
<tr>
<td align="left">audit_uid</td>
<td align="left">audit.login_user.id</td>
<td align="left">触发事件的登录到系统的用户 ID</td>
</tr>
<tr>
<td align="left">audit_name</td>
<td align="left">audit.login_user.name</td>
<td align="left">触发事件的登录到系统的用户名</td>
</tr>
<tr>
<td align="left">arch</td>
<td align="left">arch</td>
<td align="left">注册表架构（32 或 64 位）</td>
</tr>
<tr>
<td align="left">value_name</td>
<td align="left">value_name</td>
<td align="left">注册表值名称</td>
</tr>
<tr>
<td align="left">value_type</td>
<td align="left">value_type</td>
<td align="left">注册表值类型</td>
</tr>
<tr>
<td align="left">entry_type</td>
<td align="left">entry_type</td>
<td align="left">注册表项类型</td>
</tr>
</tbody></table>
<p><strong>规则映射示例</strong></p>
<p>监控文件从600 到640 的权限更改:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100002<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>550<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>.log$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>changed_fields<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>^permission$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>perm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>rw-r--r--r--<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>rw-------<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Silence perm changes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"event"</span><span class="token punctuation">,</span>
  <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/specialdir/file.log"</span><span class="token punctuation">,</span>
    <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"whodata"</span><span class="token punctuation">,</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"modified"</span><span class="token punctuation">,</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1623745234</span><span class="token punctuation">,</span>
    <span class="token property">"attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"perm"</span><span class="token operator">:</span> <span class="token string">"rw-------"</span><span class="token punctuation">,</span>
      <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"gid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"group_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"inode"</span><span class="token operator">:</span> <span class="token number">4352002</span><span class="token punctuation">,</span>
      <span class="token property">"mtime"</span><span class="token operator">:</span> <span class="token number">1623665041</span><span class="token punctuation">,</span>
      <span class="token property">"hash_md5"</span><span class="token operator">:</span> <span class="token string">"d41d8cd98f00b204e9800998ecf8427e"</span><span class="token punctuation">,</span>
      <span class="token property">"hash_sha1"</span><span class="token operator">:</span> <span class="token string">"da39a3ee5e6b4b0d3255bfef95601890afd80709"</span><span class="token punctuation">,</span>
      <span class="token property">"hash_sha256"</span><span class="token operator">:</span> <span class="token string">"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"</span><span class="token punctuation">,</span>
      <span class="token property">"checksum"</span><span class="token operator">:</span> <span class="token string">"25e338d1eca897691bacd33246c38650bdcd5630"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"changed_attributes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"permission"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"old_attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"perm"</span><span class="token operator">:</span> <span class="token string">"rw-r--r--"</span><span class="token punctuation">,</span>
      <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"gid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"group_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"inode"</span><span class="token operator">:</span> <span class="token number">4352002</span><span class="token punctuation">,</span>
      <span class="token property">"mtime"</span><span class="token operator">:</span> <span class="token number">1623665041</span><span class="token punctuation">,</span>
      <span class="token property">"hash_md5"</span><span class="token operator">:</span> <span class="token string">"d41d8cd98f00b204e9800998ecf8427e"</span><span class="token punctuation">,</span>
      <span class="token property">"hash_sha1"</span><span class="token operator">:</span> <span class="token string">"da39a3ee5e6b4b0d3255bfef95601890afd80709"</span><span class="token punctuation">,</span>
      <span class="token property">"hash_sha256"</span><span class="token operator">:</span> <span class="token string">"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"</span><span class="token punctuation">,</span>
      <span class="token property">"checksum"</span><span class="token operator">:</span> <span class="token string">"a1e1975f6f2799cb9f7e25af0b8f0bd1c4e183e4"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"audit"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"user_id"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"process_name"</span><span class="token operator">:</span> <span class="token string">"/usr/bin/chmod"</span><span class="token punctuation">,</span>
      <span class="token property">"process_id"</span><span class="token operator">:</span> <span class="token number">8866</span><span class="token punctuation">,</span>
      <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"/specialdir"</span><span class="token punctuation">,</span>
      <span class="token property">"group_id"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"group_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"audit_uid"</span><span class="token operator">:</span> <span class="token string">"1000"</span><span class="token punctuation">,</span>
      <span class="token property">"audit_name"</span><span class="token operator">:</span> <span class="token string">"vagrant"</span><span class="token punctuation">,</span>
      <span class="token property">"effective_uid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"effective_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"parent_name"</span><span class="token operator">:</span> <span class="token string">"/usr/bin/bash"</span><span class="token punctuation">,</span>
      <span class="token property">"parent_cwd"</span><span class="token operator">:</span> <span class="token string">"/specialdir"</span><span class="token punctuation">,</span>
      <span class="token property">"ppid"</span><span class="token operator">:</span> <span class="token number">3275</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>当受监控目录下的 .txt 文件被修改并在其中包含关键字关键字时触发规则：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100010<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>550<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>.txt$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>changed_content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>keyword<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>modified<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Fire alert when .txt file is modified and contains word "keyword"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"event"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/test/file.txt"</span><span class="token punctuation">,</span>
      <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"realtime"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"modified"</span><span class="token punctuation">,</span>
      <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1623660202</span><span class="token punctuation">,</span>
      <span class="token property">"attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
        <span class="token property">"perm"</span><span class="token operator">:</span> <span class="token string">"rw-r--r--"</span><span class="token punctuation">,</span>
        <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"gid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
        <span class="token property">"group_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
        <span class="token property">"inode"</span><span class="token operator">:</span> <span class="token number">4096002</span><span class="token punctuation">,</span>
        <span class="token property">"mtime"</span><span class="token operator">:</span> <span class="token number">1623660202</span><span class="token punctuation">,</span>
        <span class="token property">"hash_md5"</span><span class="token operator">:</span> <span class="token string">"126b42ce036035a50516f067aae33418"</span><span class="token punctuation">,</span>
        <span class="token property">"hash_sha1"</span><span class="token operator">:</span> <span class="token string">"5b0c286906ea60075d47b22ceab830681e906365"</span><span class="token punctuation">,</span>
        <span class="token property">"hash_sha256"</span><span class="token operator">:</span> <span class="token string">"d3c558c76a0c62e0917516a3aaf02d0512beb4ef6c1af19ca3c79e913cefcdfe"</span><span class="token punctuation">,</span>
        <span class="token property">"checksum"</span><span class="token operator">:</span> <span class="token string">"6c895291c3c9c20acee3f822c429a0901a77f7b4"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"changed_attributes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"size"</span><span class="token punctuation">,</span>
        <span class="token string">"mtime"</span><span class="token punctuation">,</span>
        <span class="token string">"md5"</span><span class="token punctuation">,</span>
        <span class="token string">"sha1"</span><span class="token punctuation">,</span>
        <span class="token string">"sha256"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"old_attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">"perm"</span><span class="token operator">:</span> <span class="token string">"rw-r--r--"</span><span class="token punctuation">,</span>
        <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"gid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
        <span class="token property">"group_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
        <span class="token property">"inode"</span><span class="token operator">:</span> <span class="token number">4096002</span><span class="token punctuation">,</span>
        <span class="token property">"mtime"</span><span class="token operator">:</span> <span class="token number">1623660184</span><span class="token punctuation">,</span>
        <span class="token property">"hash_md5"</span><span class="token operator">:</span> <span class="token string">"d41d8cd98f00b204e9800998ecf8427e"</span><span class="token punctuation">,</span>
        <span class="token property">"hash_sha1"</span><span class="token operator">:</span> <span class="token string">"da39a3ee5e6b4b0d3255bfef95601890afd80709"</span><span class="token punctuation">,</span>
        <span class="token property">"hash_sha256"</span><span class="token operator">:</span> <span class="token string">"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"</span><span class="token punctuation">,</span>
        <span class="token property">"checksum"</span><span class="token operator">:</span> <span class="token string">"eed9691633569779f515786b6eccbdbfd3dc1e1a"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"content_changes"</span><span class="token operator">:</span> <span class="token string">"0a1\n> 12313213215681568 keyword\n"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2021-06-14T08:43:22.999+0000"</span><span class="token punctuation">,</span>
    <span class="token property">"rule"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"level"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Fire alert when .txt file is modified and contains word \"keyword\""</span><span class="token punctuation">,</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"100010"</span><span class="token punctuation">,</span>
      <span class="token property">"firedtimes"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"mail"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"local"</span><span class="token punctuation">,</span>
        <span class="token string">"syslog"</span><span class="token punctuation">,</span>
        <span class="token string">"sshd"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"agent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"004"</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"ubuntu201"</span><span class="token punctuation">,</span>
      <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"10.0.2.15"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"manager"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"ubuntu20"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"1623660202.17987"</span><span class="token punctuation">,</span>
    <span class="token property">"full_log"</span><span class="token operator">:</span> <span class="token string">"File '/test/file.txt' modified\nMode: realtime\nChanged attributes: size,mtime,md5,sha1,sha256\nSize changed from '0' to '26'\nOld modification time was: '1623660184', now it is '1623660202'\nOld md5sum was: 'd41d8cd98f00b204e9800998ecf8427e'\nNew md5sum is : '126b42ce036035a50516f067aae33418'\nOld sha1sum was: 'da39a3ee5e6b4b0d3255bfef95601890afd80709'\nNew sha1sum is : '5b0c286906ea60075d47b22ceab830681e906365'\nOld sha256sum was: 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'\nNew sha256sum is : 'd3c558c76a0c62e0917516a3aaf02d0512beb4ef6c1af19ca3c79e913cefcdfe'\n"</span><span class="token punctuation">,</span>
    <span class="token property">"syscheck"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/test/file.txt"</span><span class="token punctuation">,</span>
      <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"realtime"</span><span class="token punctuation">,</span>
      <span class="token property">"size_before"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"size_after"</span><span class="token operator">:</span> <span class="token string">"26"</span><span class="token punctuation">,</span>
      <span class="token property">"perm_after"</span><span class="token operator">:</span> <span class="token string">"rw-r--r--"</span><span class="token punctuation">,</span>
      <span class="token property">"uid_after"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"gid_after"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
      <span class="token property">"md5_before"</span><span class="token operator">:</span> <span class="token string">"d41d8cd98f00b204e9800998ecf8427e"</span><span class="token punctuation">,</span>
      <span class="token property">"md5_after"</span><span class="token operator">:</span> <span class="token string">"126b42ce036035a50516f067aae33418"</span><span class="token punctuation">,</span>
      <span class="token property">"sha1_before"</span><span class="token operator">:</span> <span class="token string">"da39a3ee5e6b4b0d3255bfef95601890afd80709"</span><span class="token punctuation">,</span>
      <span class="token property">"sha1_after"</span><span class="token operator">:</span> <span class="token string">"5b0c286906ea60075d47b22ceab830681e906365"</span><span class="token punctuation">,</span>
      <span class="token property">"sha256_before"</span><span class="token operator">:</span> <span class="token string">"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"</span><span class="token punctuation">,</span>
      <span class="token property">"sha256_after"</span><span class="token operator">:</span> <span class="token string">"d3c558c76a0c62e0917516a3aaf02d0512beb4ef6c1af19ca3c79e913cefcdfe"</span><span class="token punctuation">,</span>
      <span class="token property">"uname_after"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"gname_after"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      <span class="token property">"mtime_before"</span><span class="token operator">:</span> <span class="token string">"2021-06-14T08:43:04"</span><span class="token punctuation">,</span>
      <span class="token property">"mtime_after"</span><span class="token operator">:</span> <span class="token string">"2021-06-14T08:43:22"</span><span class="token punctuation">,</span>
      <span class="token property">"inode_after"</span><span class="token operator">:</span> <span class="token number">4096002</span><span class="token punctuation">,</span>
      <span class="token property">"diff"</span><span class="token operator">:</span> <span class="token string">"0a1\n> 12313213215681568 keyword\n"</span><span class="token punctuation">,</span>
      <span class="token property">"changed_attributes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"size"</span><span class="token punctuation">,</span>
        <span class="token string">"mtime"</span><span class="token punctuation">,</span>
        <span class="token string">"md5"</span><span class="token punctuation">,</span>
        <span class="token string">"sha1"</span><span class="token punctuation">,</span>
        <span class="token string">"sha256"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"event"</span><span class="token operator">:</span> <span class="token string">"modified"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"decoder"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"syscheck_integrity_changed"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"syscheck"</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>禁止具有管理员权限的 Windows explorer.exe 进程删除文件的规则：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100011<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>553<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>process_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>explorer.exe$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>uname<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Administradores$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>deleted<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Silence delete events triggered by windows explorer with admin privileges<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"event"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"c:\\test\\adasdasd.txt"</span><span class="token punctuation">,</span>
      <span class="token property">"version"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"whodata"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"deleted"</span><span class="token punctuation">,</span>
      <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1623666683</span><span class="token punctuation">,</span>
      <span class="token property">"attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
        <span class="token property">"perm"</span><span class="token operator">:</span> <span class="token string">"Administradores (allowed): delete|read_control|write_dac|write_owner|synchronize|read_data|write_data|append_data|read_ea|write_ea|execute|read_attributes|write_attributes, SYSTEM (allowed): delete|read_control|write_dac|write_owner|synchronize|read_data|write_data|append_data|read_ea|write_ea|execute|read_attributes|write_attributes, Usuarios (allowed): read_control|synchronize|read_data|read_ea|execute|read_attributes, Usuarios autentificados (allowed): delete|read_control|synchronize|read_data|write_data|append_data|read_ea|write_ea|execute|read_attributes|write_attributes"</span><span class="token punctuation">,</span>
        <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"S-1-5-32-544"</span><span class="token punctuation">,</span>
        <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"Administradores"</span><span class="token punctuation">,</span>
        <span class="token property">"inode"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">"mtime"</span><span class="token operator">:</span> <span class="token number">1623408349</span><span class="token punctuation">,</span>
        <span class="token property">"hash_md5"</span><span class="token operator">:</span> <span class="token string">"786e0bf0ffc3c466b19d4e68d7c6f155"</span><span class="token punctuation">,</span>
        <span class="token property">"hash_sha1"</span><span class="token operator">:</span> <span class="token string">"99028323b4d6b4b2db9c7fc73d3887163598865c"</span><span class="token punctuation">,</span>
        <span class="token property">"hash_sha256"</span><span class="token operator">:</span> <span class="token string">"c0fc9e1e16ea610b3627af0b91eb623ac74dfde6943e40361de9a3447fed81b4"</span><span class="token punctuation">,</span>
        <span class="token property">"attributes"</span><span class="token operator">:</span> <span class="token string">"ARCHIVE"</span><span class="token punctuation">,</span>
        <span class="token property">"checksum"</span><span class="token operator">:</span> <span class="token string">"9384acf30012c15bd72f5ca435b4b0d41ec55ae2"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"audit"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"user_id"</span><span class="token operator">:</span> <span class="token string">"S-1-5-21-3527455827-79240758-596275861-1001"</span><span class="token punctuation">,</span>
        <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"jmv74211"</span><span class="token punctuation">,</span>
        <span class="token property">"process_name"</span><span class="token operator">:</span> <span class="token string">"C:\\Windows\\explorer.exe"</span><span class="token punctuation">,</span>
        <span class="token property">"process_id"</span><span class="token operator">:</span> <span class="token number">2484</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>监控使用touch命令创建文件，且该文件的父目录为&#x2F;specialdir，添加该文件的用户组id和有效uid为0，用户audit_uid为1000，审计名称为vagrant：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100012<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>554<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent_cwd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/specialdir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>process_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/usr/bin/touch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>group_id<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>effective_uid<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>audit_name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>vagrant<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>audit_uid<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>added<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Silence added event created with touch command in parent's current directory /specialdir with group ID 0,
  effective user ID 0, audit ID 1000 and audit user name vagrant<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"event"</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/specialdir/file.txt"</span><span class="token punctuation">,</span>
        <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"whodata"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"added"</span><span class="token punctuation">,</span>
        <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1623665041</span><span class="token punctuation">,</span>
        <span class="token property">"attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
          <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          <span class="token property">"perm"</span><span class="token operator">:</span> <span class="token string">"rw-r--r--"</span><span class="token punctuation">,</span>
          <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
          <span class="token property">"gid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
          <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
          <span class="token property">"group_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
          <span class="token property">"inode"</span><span class="token operator">:</span> <span class="token number">4352002</span><span class="token punctuation">,</span>
          <span class="token property">"mtime"</span><span class="token operator">:</span> <span class="token number">1623665041</span><span class="token punctuation">,</span>
          <span class="token property">"hash_md5"</span><span class="token operator">:</span> <span class="token string">"d41d8cd98f00b204e9800998ecf8427e"</span><span class="token punctuation">,</span>
          <span class="token property">"hash_sha1"</span><span class="token operator">:</span> <span class="token string">"da39a3ee5e6b4b0d3255bfef95601890afd80709"</span><span class="token punctuation">,</span>
          <span class="token property">"hash_sha256"</span><span class="token operator">:</span> <span class="token string">"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"</span><span class="token punctuation">,</span>
          <span class="token property">"checksum"</span><span class="token operator">:</span> <span class="token string">"a1e1975f6f2799cb9f7e25af0b8f0bd1c4e183e4"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"audit"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"user_id"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
          <span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
          <span class="token property">"process_name"</span><span class="token operator">:</span> <span class="token string">"/usr/bin/touch"</span><span class="token punctuation">,</span>
          <span class="token property">"process_id"</span><span class="token operator">:</span> <span class="token number">53794</span><span class="token punctuation">,</span>
          <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"/specialdir"</span><span class="token punctuation">,</span>
          <span class="token property">"group_id"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
          <span class="token property">"group_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
          <span class="token property">"audit_uid"</span><span class="token operator">:</span> <span class="token string">"1000"</span><span class="token punctuation">,</span>
          <span class="token property">"audit_name"</span><span class="token operator">:</span> <span class="token string">"vagrant"</span><span class="token punctuation">,</span>
          <span class="token property">"effective_uid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
          <span class="token property">"effective_name"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
          <span class="token property">"parent_name"</span><span class="token operator">:</span> <span class="token string">"/usr/bin/bash"</span><span class="token punctuation">,</span>
          <span class="token property">"parent_cwd"</span><span class="token operator">:</span> <span class="token string">"/specialdir"</span><span class="token punctuation">,</span>
          <span class="token property">"ppid"</span><span class="token operator">:</span> <span class="token number">44025</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="c-FIM配置"><a href="#c-FIM配置" class="headerlink" title="c. FIM配置"></a>c. FIM配置</h4><p>Syscheck 组件在 Wazuh 管理器和 Wazuh agent 的 ossec.conf 文件中配置，也可以在 agent.conf 文件中配置此功能。所有 syscheck 配置选项的列表在 syscheck 部分中可用。</p>
<p><strong>配置 syscheck - 基本用法</strong></p>
<p>配置 syscheck，必须确定文件和目录列表，directories 选项的 check_all 属性允许检查文件大小、权限、所有者、最后修改日期、索引节点和所有哈希（MD5、SHA1 和 SHA256）</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">check_all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/etc,/usr/bin,/usr/sbin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">check_all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/root/users.txt,/bsd,/root/db.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p>Wazuh 4.3.0版本后，FIM 目录可以使用 * 和 ?通配符方式配置：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">check_all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/home/*/Downloads<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置定时扫描</strong></p>
<p>syscheck 使用 frequency 选项来配置系统扫描的频率，如下配置为每 10 小时运行一次：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>frequency</span><span class="token punctuation">></span></span>36000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>frequency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span><span class="token punctuation">></span></span>/etc,/usr/bin,/usr/sbin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span><span class="token punctuation">></span></span>/bin,/sbin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p>也可以使用 scan_time 和 scan_day 选项配置扫描，如在每周六晚上 10 点进行扫描：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scan_time</span><span class="token punctuation">></span></span>10pm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scan_time</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scan_day</span><span class="token punctuation">></span></span>saturday<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scan_day</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span><span class="token punctuation">></span></span>/etc,/usr/bin,/usr/sbin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span><span class="token punctuation">></span></span>/bin,/sbin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置实时监控</strong></p>
<p>使用directories 选项的 realtime 属性配置实时监控，此属性仅适用于目录而不适用于单个文件</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">check_all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span> <span class="token attr-name">realtime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>c:/tmp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置 who-data 监控</strong></p>
<p>配置directories选项的whodata属性进行监控，该属性取代了realtime属性，即whodata隐含实时监控但增加了who-data信息</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">check_all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span> <span class="token attr-name">whodata</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/etc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置报告新文件</strong></p>
<p>使用 alert_new_files 选项配置 syscheck报告添加到系统的新文件</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alert_new_files</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>alert_new_files</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p>新文件创建的示例警报:</p>
<pre class="language-none"><code class="language-none">** Alert 1585943821.46978: - ossec,syscheck,pci_dss_11.5,gpg13_4.11,gdpr_II_5.1.f,hipaa_164.312.c.1,hipaa_164.312.c.2,nist_800_53_SI.7,
2020 Apr 03 19:57:01 (agent) any-&gt;syscheck
Rule: 554 (level 5) -&gt; &#39;File added to the system.&#39;
File &#39;&#x2F;etc&#x2F;new_file&#39; added
Mode: scheduledAttributes:
- Size: 2
- Permissions: rw-r--r--
- Date: Fri Apr 3 19:56:50 2020
- Inode: 23194
- User: root (0)
- Group: root (0)
- MD5: 9a8ad92c50cae39aa2c5604fd0ab6d8c
- SHA1: a9fcd54b25e7e863d72cd47c08af46e61b74b561
- SHA256: 092fcfbbcfca3b5be7ae1b5e58538e92c35ab273ae13664fed0d67484c8e78a6</code></pre>

<p><strong>通过规则配置忽略文件</strong></p>
<p>忽略 syscheck 扫描特定文件的一种方法是使用规则并将规则级别设置为 0：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100345<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_group</span><span class="token punctuation">></span></span>syscheck<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_group</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>/var/www/htdocs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Ignore changes to /var/www/htdocs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置受监视文件的警报级别</strong></p>
<p>可以在检测到对特定文件或文件模式的更改时更改 syscheck 警报的级别</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100345<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_group</span><span class="token punctuation">></span></span>syscheck<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_group</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>/var/www/htdocs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Changes to /var/www/htdocs - Critical file!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置允许的最大递归级别</strong></p>
<p>使用 directories 选项的 recursion_level 属性配置特定目录允许的最大递归级别，recursion_level 值必须是 0 到 320 之间的整数，要禁用递归并仅为受监视文件夹中的文件生成警报，必须将 recursion_level 值设置为 0：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">check_all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/etc,/usr/bin,/usr/sbin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">check_all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/root/users.txt,/bsd,/root/db.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">check_all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span> <span class="token attr-name">recursion_level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>folder_test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置 syscheck 进程优先级</strong></p>
<p>要调整受监控系统上的 syscheck CPU 使用率，可以使用 process_priority 选项。它为 syscheck 进程设置了 nice 值，默认 process_priority 设置为 10</p>
<p>将 process_priority 值设置为高于默认值，会给 syscheck 较低的优先级、较少的 CPU 资源并使其运行速度变慢，将syscheck 进程的 nice 值设置为最大值：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>process_priority</span><span class="token punctuation">></span></span>19<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>process_priority</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p>将 process_priority 值设置为低于默认值，将为 syscheck 提供更高的优先级、更多的 CPU 资源并使其运行更快，将syscheck 进程的 nice 值设置为最小值：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>process_priority</span><span class="token punctuation">></span></span>-20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>process_priority</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置数据库的存储位置</strong></p>
<p>当 Wazuh agent启动时，它会执行第一次扫描并生成其数据库。默认情况下，数据库是在磁盘中创建的：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">></span></span>disk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p>Syscheck 可以配置为将数据库存储在内存中:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">></span></span>memory<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>配置同步</strong></p>
<p>Synchronization可以配置同步以更改同步间隔、每秒事件数、队列大小和响应超时：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>syscheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>synchronization</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interval</span><span class="token punctuation">></span></span>5m<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interval</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_interval</span><span class="token punctuation">></span></span>1h<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_interval</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>response_timeout</span><span class="token punctuation">></span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>response_timeout</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>queue_size</span><span class="token punctuation">></span></span>16384<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>queue_size</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_eps</span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_eps</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>synchronization</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>syscheck</span><span class="token punctuation">></span></span></code></pre>

<h3 id="3-异常和恶意软件检测"><a href="#3-异常和恶意软件检测" class="headerlink" title="3. 异常和恶意软件检测"></a>3. 异常和恶意软件检测</h3><p>异常检测是指在系统中发现与预期行为不匹配的模式的动作，当系统上安装了恶意软件（例如，rootkit），就会修改系统以对用户隐藏自己。负责此任务的主要组件是 rootcheck，但 Syscheck 也起着重要的作用。</p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/rootcheck-flow1.png"></p>
<p><strong>rootkit检测项</strong></p>
<p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/rootkitcheck.png"></p>
<h4 id="a-文件完整性监控"><a href="#a-文件完整性监控" class="headerlink" title="a. 文件完整性监控"></a>a. 文件完整性监控</h4><p>恶意软件可以替换主机系统上的文件、目录和命令。执行文件完整性监控，用户可以检查系统的指定目录以检测这些操作。</p>
<pre class="language-none"><code class="language-none">** Alert 1460948255.25442: mail  - ossec,syscheck,pci_dss_11.5,
2016 Apr 17 19:57:35 (ubuntu) 10.0.0.144-&gt;syscheck
Rule: 550 (level 7) -&gt; &#39;Integrity checksum changed.&#39;
Integrity checksum changed for: &#39;&#x2F;bin&#x2F;bash&#39;
Size changed from &#39;12&#39; to &#39;17&#39;
Old md5sum was: &#39;e59ff97941044f85df5297e1c302d260&#39;
New md5sum is : &#39;7947eba5d9cc58d440fb06912e302949&#39;
Old sha1sum was: &#39;648a6a6ffffdaa0badb23b8baf90b6168dd16b3a&#39;
New sha1sum is : &#39;379b74ac9b2d2b09ff6ad7fa876c79f914a755e1&#39;</code></pre>

<h4 id="b-检查运行的进程"><a href="#b-检查运行的进程" class="headerlink" title="b. 检查运行的进程"></a>b. 检查运行的进程</h4><p>恶意进程可以防止自己出现在系统的进程列表中（木马版本的 ps 命令）。 Rootcheck 检查所有进程 ID (PID)，寻找与不同系统调用（getsid、getpgid）的差异。</p>
<p>例：Diamorphine 是一种内核模式 rootkit，它能够对 ps 隐藏自身和其他进程</p>
<pre class="language-none"><code class="language-none">** Alert 1460225922.841535: mail  - ossec,rootcheck
2017 Feb 15 10:00:42 (localhost) 192.168.1.240-&gt;rootcheck
Rule: 510 (level 7) -&gt; &#39;Host-based anomaly detection event (rootcheck).&#39;
Process &#39;495&#39; hidden from &#x2F;proc. Possible kernel level rootkit.</code></pre>

<h4 id="c-检查隐藏端口"><a href="#c-检查隐藏端口" class="headerlink" title="c. 检查隐藏端口"></a>c. 检查隐藏端口</h4><p>恶意软件可以使用隐藏端口与攻击者通信。 Rootcheck 使用 bind() 检查系统中的每个端口。如果它无法绑定到端口并且该端口不在 netstat 输出中，则可能存在恶意软件。</p>
<h4 id="d-检查异常文件和权限"><a href="#d-检查异常文件和权限" class="headerlink" title="d. 检查异常文件和权限"></a>d. 检查异常文件和权限</h4><p>Wazuh 扫描整个文件系统以查找异常文件和权限。 检查有root权限的文件以及其他用户帐户可写权限的文件，如 suid 文件、隐藏目录和文件。</p>
<h4 id="e-使用系统调用检查隐藏文件"><a href="#e-使用系统调用检查隐藏文件" class="headerlink" title="e. 使用系统调用检查隐藏文件"></a>e. 使用系统调用检查隐藏文件</h4><p>Wazuh 扫描整个系统，比较使用 fopen + read 每个目录中的节点数也与opendir + readdir 的输出进行比较。如果任何结果不匹配，则可能存在恶意软件。</p>
<p><strong>告警示例</strong></p>
<pre class="language-none"><code class="language-none">** Alert 1460225922.51190: mail  - ossec,rootcheck
2017 Feb 15 10:30:42 (localhost) 192.168.1.240-&gt;rootcheck
Rule: 510 (level 7) -&gt; &#39;Host-based anomaly detection event (rootcheck).&#39;
Files hidden inside directory &#39;&#x2F;etc&#39;. Link count does not match number of files (128,129)</code></pre>

<p><strong>监控目录</strong></p>
<table>
<thead>
<tr>
<th align="left">平台</th>
<th align="left">目录</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Unix</td>
<td align="left">&#x2F;bin, &#x2F;sbin, &#x2F;usr&#x2F;bin, &#x2F;usr&#x2F;sbin, &#x2F;dev, &#x2F;lib, &#x2F;etc, &#x2F;root, &#x2F;var&#x2F;log, &#x2F;var&#x2F;mail, &#x2F;var&#x2F;lib, &#x2F;var&#x2F;www, &#x2F;usr&#x2F;lib, &#x2F;usr&#x2F;include, &#x2F;tmp, &#x2F;boot, &#x2F;usr&#x2F;local, &#x2F;var&#x2F;tmp and &#x2F;sys</td>
</tr>
<tr>
<td align="left">Windows</td>
<td align="left">C:\WINDOWS and C:\Program Files</td>
</tr>
</tbody></table>
<h4 id="f-扫描-x2F-dev-目录"><a href="#f-扫描-x2F-dev-目录" class="headerlink" title="f. 扫描 &#x2F;dev 目录"></a>f. 扫描 &#x2F;dev 目录</h4><p>&#x2F;dev 目录应该只包含特定设备的文件。应检查任何其他文件，因为恶意软件使用此分区来隐藏文件。</p>
<p>在 &#x2F;dev 上创建隐藏文件，警报示例：</p>
<pre class="language-none"><code class="language-none">** Alert 1487182293.37491: - ossec,rootcheck,
2017 Feb 15 10:11:33 localhost-&gt;rootcheck
Rule: 510 (level 7) -&gt; &#39;Host-based anomaly detection event (rootcheck).&#39;
File &#39;&#x2F;dev&#x2F;.hiddenfile&#39; present on &#x2F;dev. Possible hidden file.
title: File present on &#x2F;dev.
file: &#x2F;dev&#x2F;.hiddenfile</code></pre>

<h4 id="g-检测网卡混杂模式"><a href="#g-检测网卡混杂模式" class="headerlink" title="g. 检测网卡混杂模式"></a>g. 检测网卡混杂模式</h4><p>Wazuh 会在启用混杂模式的情况下扫描系统上的任何网络接口。如果接口处于混杂模式，ifconfig 命令的输出将指示它，这可能表明存在恶意软件。</p>
<h4 id="h-Rootkit-文件检查"><a href="#h-Rootkit-文件检查" class="headerlink" title="h. Rootkit 文件检查"></a>h. Rootkit 文件检查</h4><p>Rootcheck 使用其 rootkit 签名数据库执行多项检查：rootkit_files.txt、rootkit_trojans.txt 和 win_malware_rcl.txt。</p>
<h4 id="i-rootkit检测配置"><a href="#i-rootkit检测配置" class="headerlink" title="i. rootkit检测配置"></a>i. rootkit检测配置</h4><p><strong>基本示例</strong></p>
<p>在ossec.conf文件中配置 syscheck 和 rootcheck 选项，或使用frequency、rootkit_files 和 rootkit_trojans等选项进行配置</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootcheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootkit_files</span><span class="token punctuation">></span></span>etc/shared/rootkit_files.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootkit_files</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootkit_trojans</span><span class="token punctuation">></span></span>etc/shared/rootkit_trojans.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootkit_trojans</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootcheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>忽略误报</strong></p>
<pre class="language-none"><code class="language-none">&lt;rule id&#x3D;&quot;100100&quot; level&#x3D;&quot;0&quot;&gt;
    &lt;if_group&gt;rootcheck&lt;&#x2F;if_group&gt;
    &lt;match&gt;&#x2F;dev&#x2F;.blkid.tab&lt;&#x2F;match&gt;
    &lt;description&gt;Ignore false positive for &#x2F;dev&#x2F;.blkid.tab&lt;&#x2F;description&gt;
&lt;&#x2F;rule&gt;</code></pre>

<h3 id="4-监控系统调用"><a href="#4-监控系统调用" class="headerlink" title="4. 监控系统调用"></a>4. 监控系统调用</h3><p>使用linux上的auditd进行审计,修改agent上ossec.conf</p>
<pre class="language-none"><code class="language-none">&lt;localfile&gt;
  &lt;log_format&gt;audit&lt;&#x2F;log_format&gt;
  &lt;location&gt;&#x2F;var&#x2F;log&#x2F;audit&#x2F;audit.log&lt;&#x2F;location&gt;
&lt;&#x2F;localfile&gt;</code></pre>

<h4 id="a-Audit规则类型"><a href="#a-Audit规则类型" class="headerlink" title="a. Audit规则类型"></a>a. Audit规则类型</h4><pre class="language-none"><code class="language-none">控制规则：允许修改Audit系统的行为及其某些配置
文件系统规则： 允许Audit对特定文件或目录的访问
系统调用规则： 允许记录指定程序进行的系统调用</code></pre>

<h4 id="b-Audit命令"><a href="#b-Audit命令" class="headerlink" title="b. Audit命令"></a>b. Audit命令</h4><pre class="language-none"><code class="language-none">auditctl -b :设置内核中现有审计缓冲区的最大数量
auditctl -e :启用&#x2F;禁用审核系统或锁定其配置
auditctl -s :报告审核系统的状态
auditctl -l :列出所有当前加载的审核规则
auditctl -D :删除所有当前加载的审核规则</code></pre>

<h4 id="c-定义文件系统规则"><a href="#c-定义文件系统规则" class="headerlink" title="c. 定义文件系统规则"></a>c. 定义文件系统规则</h4><pre class="language-none"><code class="language-none">语法：

-w &lt;path&gt; -p &lt;permissions&gt; -k &lt;key_name&gt;

说明：

-w :指定需要审核的路径
-p :指定审核的权限,rwxa(r:文件或目录只读,w：文件或目录写入,x: 文件或目录执行,a: 更改文件或目录的属性)
-k :可选字段,用于描述规则生成特定的日志行,wazuh要求使用此选项以便更好的分析日志

定义一个监视&#x2F;etc&#x2F;test目录的规则

auditctl -w &#x2F;etc&#x2F;test -p w -k audit-wazuh-w
auditctl -w &#x2F;etc&#x2F;test -p a -k audit-wazuh-a
auditctl -w &#x2F;etc&#x2F;test -p r -k audit-wazuh-r
auditctl -w &#x2F;etc&#x2F;test -p x -k audit-wazuh-x

在&#x2F;etc&#x2F;test目录下创建一个文件进行测试

目录下文件属性发生任何改变都会进行报警(创建文件,修改属主,写入数据等等)

auditctl -w &#x2F;etc&#x2F;test&#x2F;audit -p wa -k audit_file_change
echo &quot;audit_test&quot; &gt;&#x2F;etc&#x2F;test&#x2F;audit</code></pre>

<h4 id="d-定义系统调用规则"><a href="#d-定义系统调用规则" class="headerlink" title="d. 定义系统调用规则"></a>d. 定义系统调用规则</h4><p><strong>语法</strong></p>
<pre class="language-none"><code class="language-none">语法：

-a action,filter -S system_call -F field&#x3D;value -k key_name

说明：

-a  &lt;action&gt; &lt;filter&gt;: 告诉内核的规则匹配引擎在规则列表的末尾附加一个规则,必须指定要附加到哪个规则列表，以及在触发时要执行的操作
    &lt;action&gt;: always(文件或目录的读权限),never(文件或目录的写权限)
    &lt;filter&gt;: 值指定将哪个内核规则匹配过滤器应用于事件,task(仅审核事件可以fork或clone系统调用),exit(对所有的系统调用或文件系统规则进行评估),user(用于删除一些源自用户空间的事件,默认情况下，允许源于用户空间的任何事件),exclude(用于从记录中排除某些事件）,msgtype用于告诉内核要过滤掉哪个消息,要更精细地控制要审核的事件,使用用户过滤器并退出过滤器)

-S &lt;system_call&gt;: 这指定要审核的system_call,可以在单个规则中指定多个系统调用, ausyscall --dump:找到所有系统调用的列表

-F &lt;field&#x3D;value&gt;: 使用field &#x3D; value可以指定其他条件来缩小要审核的事件的范围：系统架构,group id, process id等,单个规则可以使用多个-F选项

-k &lt;key_name&gt;: 可选字符串，用于描述规则生成特定的日志行,Wazuh要求使用此参数,以便更准确地分析日志</code></pre>

<p><strong>示例</strong></p>
<pre class="language-none"><code class="language-none">定义一个监测ID为1000的系统用户,指定系统架构为64位的规则

auditctl -a exit,always -F euid&#x3D;1000 -F arch&#x3D;b64 -S execve -k audit-wazuh-c
su - test&amp;&amp;mkdir 1

audit-wazuh-c: 默认的CDB列表,可在cat &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;lists&#x2F;audit-keys下查看</code></pre>

<h3 id="5-监控命令执行"><a href="#5-监控命令执行" class="headerlink" title="5. 监控命令执行"></a>5. 监控命令执行</h3><h4 id="a-配置-Wazuh-agent以接受来自管理器的远程命令"><a href="#a-配置-Wazuh-agent以接受来自管理器的远程命令" class="headerlink" title="a. 配置 Wazuh agent以接受来自管理器的远程命令"></a>a. 配置 Wazuh agent以接受来自管理器的远程命令</h4><p>agent能够运行从管理器推送的命令（通过shared目录中的文件）, 可以通过在每个agent的 local_internal_options.conf 文件中设置 logcollector.remote_commands 来完成</p>
<pre class="language-none"><code class="language-none">logcollector.remote_commands&#x3D;1</code></pre>

<h4 id="b-配置监控命令"><a href="#b-配置监控命令" class="headerlink" title="b. 配置监控命令"></a>b. 配置监控命令</h4><p>运行和监控的命令可以在各个agent的本地ossec.conf文件中配置，但推荐在管理器上的 agent.conf 文件进行配置</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>full_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>.....<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>frequency</span><span class="token punctuation">></span></span>120<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>frequency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<h4 id="c-检查输出是否改变"><a href="#c-检查输出是否改变" class="headerlink" title="c. 检查输出是否改变"></a>c. 检查输出是否改变</h4><p>使用Linux netstat命令与 check_diff 选项一起使用来监控监听 tcp 套接字中的变化</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>full_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>netstat -tulpn | sed 's/\([[:alnum:]]\+\)\ \+[[:digit:]]\+\ \+[[:digit:]]\+\ \+\(.*\):\([[:digit:]]*\)\ \+\([0-9\.\:\*]\+\).\+\ \([[:digit:]]*\/[[:alnum:]\-]*\).*/\1 \2 == \3 == \4 \5/' | sort -k 4 -g | sed 's/ == \(.*\) ==/:\1/' | sed 1,2d<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alias</span><span class="token punctuation">></span></span>netstat listening ports<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>alias</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>frequency</span><span class="token punctuation">></span></span>360<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>frequency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>533<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>7<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>530<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>ossec: output: 'netstat listening ports<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_diff</span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Listened ports status (netstat) changed (new port opened or closed).<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span>pci_dss_10.2.7,pci_dss_10.6.1,gpg13_10.1,gdpr_IV_35.7.d,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<p>如果输出发生变化，系统将生成警报，指示网络监听器已消失或出现了新的监听器，这表明某些东西已损坏或已安装网络后门</p>
<h3 id="6-主动防御"><a href="#6-主动防御" class="headerlink" title="6. 主动防御"></a>6. 主动防御</h3><p>主动响应执行各种反制措施来应对威胁，当满足特定条件时阻止从威胁源访问agent。主动响应执行脚本以响应基于警报级别或规则组的特定警报的触发.</p>
<h4 id="a-工作原理"><a href="#a-工作原理" class="headerlink" title="a. 工作原理"></a>a. 工作原理</h4><p><img src="https://blog-1254410573.cos.ap-beijing.myqcloud.com/Image/automatic-remediation1.png"></p>
<p><strong>何时触发</strong></p>
<p>主动响应是配置为在触发特定警报、警报级别或规则组时执行的脚本。主动响应是有状态或无状态响应</p>
<ul>
<li>Stateful(有状态)：配置为在指定时间段后撤消操作</li>
<li>Stateless(无状态)：被配置为一次性操作，没有事件来恢复原始效果</li>
</ul>
<p><strong>在何处执行</strong></p>
<p>每个活动响应指定将在何处执行其关联命令：在触发警报的agent上、在管理器上、在另一个指定的agent上或在所有agent上。location选项：</p>
<ul>
<li><code>Local</code>：在生成警报的代理上运行脚本</li>
<li><code>Server</code>：在 Wazuh 管理器上运行脚本</li>
<li><code>Defined agent</code>：指定运行脚本的agent的 ID，而不管在何处观察到事件</li>
<li><code>All</code>：环境中的每个agent都将运行该脚本，谨慎使用</li>
</ul>
<h4 id="b-主动响应配置"><a href="#b-主动响应配置" class="headerlink" title="b. 主动响应配置"></a>b. 主动响应配置</h4><p>通过修改<code>ossec.conf</code>文件在管理器中配置主动响应:</p>
<p><strong>创建命令</strong></p>
<p>配置主动响应，必须定义一个命令来启动特定脚本以响应触发器，使用下面的模式定义命令的名称，然后引用要启动的脚本</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>host-deny<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>host-deny<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout_allowed</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout_allowed</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span></code></pre>

<p>在此示例中，该命令称为 host-deny 并启动 host-deny 脚本。此命令配置为允许在指定时间段后超时，使其成为有状态响应</p>
<p><strong>定义主动响应</strong></p>
<p>主动响应配置定义命令将在何时何地执行。当具有特定 ID、严重级别或源的特定规则与活动响应标准匹配时，将触发命令，此配置将进一步定义命令的操作将在何处启动</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>host-deny<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>local<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">></span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout</span><span class="token punctuation">></span></span>600<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">></span></span></code></pre>

<p>在此示例中，主动响应配置为执行上一步中定义的命令。动作的地点定义为本地主机，时间定义为规则级别高于 6 的任何时间。</p>
<p>可以在 <code>/var/ossec/logs/active-responses.log</code> 查看主动响应日志</p>
<h4 id="c-默认主动响应脚本"><a href="#c-默认主动响应脚本" class="headerlink" title="c. 默认主动响应脚本"></a>c. 默认主动响应脚本</h4><p>Wazuh 预配置了以下 Linux 脚本，位于 <code>/var/ossec/active-response/bin</code></p>
<table>
<thead>
<tr>
<th align="left">脚本名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">disable-account</td>
<td align="left">通过设置 passwd-l 禁用帐户</td>
</tr>
<tr>
<td align="left">firewall-drop</td>
<td align="left">将 IP 添加到 iptables 拒绝列表</td>
</tr>
<tr>
<td align="left">firewalld-drop</td>
<td align="left">将 IP 添加到 firewalld drop列表</td>
</tr>
<tr>
<td align="left">host-deny</td>
<td align="left">将 IP 添加到 &#x2F;etc&#x2F;hosts.deny 文件</td>
</tr>
<tr>
<td align="left">ip-customblock</td>
<td align="left">自定义 OSSEC 块，可轻松修改以实现自定义响应</td>
</tr>
<tr>
<td align="left">ipfw</td>
<td align="left">ipfw 创建的防火墙drop响应脚本</td>
</tr>
<tr>
<td align="left">npf</td>
<td align="left">npf 创建的防火墙drop响应脚本</td>
</tr>
<tr>
<td align="left">wazuh-slack</td>
<td align="left">在 Slack 上发布修改</td>
</tr>
<tr>
<td align="left">pf</td>
<td align="left">pf 创建的防火墙drop响应脚本</td>
</tr>
<tr>
<td align="left">restart-wazuh</td>
<td align="left">ossec.conf 更改后自动重启 Wazuh</td>
</tr>
<tr>
<td align="left">route-null</td>
<td align="left">将 IP 地址添加到空路由</td>
</tr>
</tbody></table>
<h4 id="d-配置示例"><a href="#d-配置示例" class="headerlink" title="d. 配置示例"></a>d. 配置示例</h4><p><strong>基本用法</strong></p>
<p>在 ossec.conf 文件中的 Active Response 和 Command 部分配置主动响应</p>
<p>restart-wazuh 命令配置为使用没有数据元素的 restart-wazuh 脚本</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>restart-wazuh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>restart-wazuh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span></code></pre>

<p>主动响应配置为在 ID 为 10005 的规则触发时在本地主机上启动 restart-wazuh 命令。这是一个无状态响应</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>restart-wazuh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>local<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rules_id</span><span class="token punctuation">></span></span>10005<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rules_id</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">></span></span></code></pre>

<p><strong>使用 PF 阻止 IP</strong></p>
<p>pf-block 命令配置为使用 pf 脚本</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>pf-block<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>pf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span></code></pre>

<p>当”authentication_failed”或”authentication_failures”规则组中的规则触发时，主动响应配置为在代理 001 上启动 pf-block 命令。这是一个无状态响应</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>pf-block<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>defined-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent_id</span><span class="token punctuation">></span></span>001<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent_id</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rules_group</span><span class="token punctuation">></span></span>authentication_failed|authentication_failures<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rules_group</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">></span></span></code></pre>

<p><strong>将 IP 添加到 iptables 拒绝列表</strong></p>
<p>firewall-drop 命令配置为使用 firewall-drop 脚本。</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>firewall-drop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>firewall-drop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span></code></pre>

<p>当”authentication_failed”或”authentication_failures”规则组中的规则触发时，主动响应配置为在所有系统上启动 firewall-drop 命令。这是一个超时为 700 秒的有状态响应。 <code>&lt;repeated_offenders&gt; </code>标记通过特定 IP 地址增加每个后续攻击的超时期限</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>firewall-drop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rules_group</span><span class="token punctuation">></span></span>authentication_failed|authentication_failures<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rules_group</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout</span><span class="token punctuation">></span></span>700<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repeated_offenders</span><span class="token punctuation">></span></span>30,60,120<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repeated_offenders</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">></span></span></code></pre>

<h4 id="e-自定义主动响应"><a href="#e-自定义主动响应" class="headerlink" title="e. 自定义主动响应"></a>e. 自定义主动响应</h4><p><strong>无状态主动响应</strong></p>
<p>无状态主动响应具有两种类型 AR 的最简单配置，并且被配置为一次性操作，没有事件来恢复原始效果。该过程需要通过 JSON 对象中的 STDIN 将完整警报传递给 AR，每个 AR 负责提取其执行所需的信息。</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"version"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"origin"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"worker01"</span><span class="token punctuation">,</span>
        <span class="token property">"module"</span><span class="token operator">:</span><span class="token string">"wazuh-execd"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"command"</span><span class="token operator">:</span><span class="token string">"add/delete"</span><span class="token punctuation">,</span>
    <span class="token property">"parameters"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"extra_args"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"alert"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"program"</span><span class="token operator">:</span><span class="token string">"program-name"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>Wazuh允许任何语言编写自定义主动响应，但至少需要能够执行如下操作才能正确执行。</p>
<ul>
<li>读取 STDIN 以获取警报</li>
<li>解析读取的 JSON 对象</li>
<li>分析命令字段以检查它是否必须添加操作或删除它</li>
<li>提取执行所需的信息</li>
</ul>
<p><strong>有状态的主动响应</strong></p>
<p>有状态 AR 在活动响应中指定的时间段后撤消其原始操作。作为超时行为的一部分，当收到的命令是 add 时，AR 必须执行此操作。需满足以下步骤：</p>
<ul>
<li>读取STDIN 以获取警报</li>
<li>解析读取的 JSON 对象</li>
<li>分析命令字段以检查它是否必须添加操作或删除它</li>
<li>提取其执行所需的信息</li>
<li>使用从 JSON 格式的警报中提取的密钥构建控制消息</li>
<li>写入 STDOUT 以发送控制消息</li>
<li>等待通过 STDIN 的响应</li>
<li>解析读取的 JSON 对象</li>
<li>分析命令字段以检查它是否必须继续执行或中止执行</li>
</ul>
<p>控制消息格式如下：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"version"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"origin"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"program-name"</span><span class="token punctuation">,</span>
        <span class="token property">"module"</span><span class="token operator">:</span><span class="token string">"active-response"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"command"</span><span class="token operator">:</span><span class="token string">"check_keys"</span><span class="token punctuation">,</span>
    <span class="token property">"parameters"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"keys"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"10.0.0.1"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>响应信息如下：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"version"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"origin"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
      <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"node01"</span><span class="token punctuation">,</span>
      <span class="token property">"module"</span><span class="token operator">:</span><span class="token string">"wazuh-execd"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"command"</span><span class="token operator">:</span><span class="token string">"continue/abort"</span><span class="token punctuation">,</span>
  <span class="token property">"parameters"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="7-系统资产盘点"><a href="#7-系统资产盘点" class="headerlink" title="7. 系统资产盘点"></a>7. 系统资产盘点</h3><p>Wazuh agent能够收集重要的系统信息，并将其存储到管理端每个agent的 SQLite 数据库中。Syscollector 模块负责此任务</p>
<p>agent启动后，Syscollector 会定期扫描定义的目标（硬件、操作系统、程序包等），将新收集的数据转发给管理器，管理器更新数据库的相应表，可通过查询 Wazuh API 从数据库中检索数据</p>
<h4 id="a-硬件信息"><a href="#a-硬件信息" class="headerlink" title="a. 硬件信息"></a>a. 硬件信息</h4><table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">描述</th>
<th align="left">示例</th>
<th align="left">支持平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">scan_id</td>
<td align="left">扫描标识符</td>
<td align="left">573872577</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_time</td>
<td align="left">扫描时间</td>
<td align="left">2018&#x2F;7&#x2F;31 15:31</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">board_serial</td>
<td align="left">主板序列号</td>
<td align="left">XDR840TUGM65E03171</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">cpu_name</td>
<td align="left">CPU 名称</td>
<td align="left">Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">cpu_cores</td>
<td align="left">CPU核心数</td>
<td align="left">4</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">cpu_mhz</td>
<td align="left">当前处理器频率</td>
<td align="left">900.106</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">ram_total</td>
<td align="left">总内存 (KB)</td>
<td align="left">16374572</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">ram_free</td>
<td align="left">可用内存 (KB)</td>
<td align="left">2111928</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">ram_usage</td>
<td align="left">已使用内存占比</td>
<td align="left">87</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">完整性同步值</td>
<td align="left">503709147600c8e0023cf2b9995772280eee30</td>
<td align="left">All</td>
</tr>
</tbody></table>
<h4 id="b-操作系统"><a href="#b-操作系统" class="headerlink" title="b. 操作系统"></a>b. 操作系统</h4><table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">描述</th>
<th align="left">示例</th>
<th align="left">支持平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">scan_id</td>
<td align="left">扫描标识符</td>
<td align="left">468455719</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_time</td>
<td align="left">扫描时间</td>
<td align="left">2018&#x2F;7&#x2F;31 15:31</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">hostname</td>
<td align="left">机器主机名</td>
<td align="left">ag-ubuntu-16	All</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">architecture</td>
<td align="left">操作系统架构</td>
<td align="left">x86_64</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">os_name</td>
<td align="left">操作系统名称</td>
<td align="left">Ubuntu</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">os_version</td>
<td align="left">操作系统版本</td>
<td align="left">16.04.5 LTS (Xenial Xerus)</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">os_codename</td>
<td align="left">操作系统版本号</td>
<td align="left">Xenial Xerus</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">os_major</td>
<td align="left">主要发行版本</td>
<td align="left">16</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">os_minor</td>
<td align="left">次要发型版本</td>
<td align="left">4</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">os_patch</td>
<td align="left">补丁发行版本</td>
<td align="left">5</td>
<td align="left">macOS</td>
</tr>
<tr>
<td align="left">os_build</td>
<td align="left">可选build-specific</td>
<td align="left">14393</td>
<td align="left">Windows</td>
</tr>
<tr>
<td align="left">os_release</td>
<td align="left">Windwos版本号</td>
<td align="left">SP2</td>
<td align="left">Windows</td>
</tr>
<tr>
<td align="left">os_display_version</td>
<td align="left">Windows 显示版本</td>
<td align="left">20H2</td>
<td align="left">Windows</td>
</tr>
<tr>
<td align="left">os_platform</td>
<td align="left">操作系统平台</td>
<td align="left">ubuntu</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">sysname</td>
<td align="left">系统名称</td>
<td align="left">Linux</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">release</td>
<td align="left">发行名称</td>
<td align="left">4.15.0-29-generic</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">发行版本</td>
<td align="left">#31~16.04.1-Ubuntu SMP Wed Jul 18 08:54:04 UTC 2018</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">完整性同步值</td>
<td align="left">503709147600c8e0023cf2b9995772280eee30</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">reference</td>
<td align="left">主键</td>
<td align="left">94b6f7b3c1d905aae22a652448df6372da98e5b8</td>
<td align="left">All</td>
</tr>
</tbody></table>
<h4 id="c-Packege信息"><a href="#c-Packege信息" class="headerlink" title="c. Packege信息"></a>c. Packege信息</h4><p>在 Linux 系统上，检索到的包可以是 deb、pacman 或 rpm 类型</p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">描述</th>
<th align="left">示例</th>
<th align="left">支持平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">scan_id</td>
<td align="left">扫描标识符</td>
<td align="left">1454946158</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_time</td>
<td align="left">扫描时间</td>
<td align="left">2018&#x2F;7&#x2F;27 7:27</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">format</td>
<td align="left">package格式</td>
<td align="left">deb</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">package名</td>
<td align="left">linux-headers-generic</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">priority</td>
<td align="left">package优先级</td>
<td align="left">optional</td>
<td align="left">deb</td>
</tr>
<tr>
<td align="left">section</td>
<td align="left">package section</td>
<td align="left">kernel</td>
<td align="left">deb&#x2F;rpm&#x2F;pkg</td>
</tr>
<tr>
<td align="left">size</td>
<td align="left">已安装包的大小（以字节为单位）</td>
<td align="left">14</td>
<td align="left">deb&#x2F;rpm&#x2F;pacman</td>
</tr>
<tr>
<td align="left">vendor</td>
<td align="left">供应商名称</td>
<td align="left">Ubuntu Kernel Team</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">install_time</td>
<td align="left">安装包的日期</td>
<td align="left">2018&#x2F;2&#x2F;8 18:45</td>
<td align="left">rpm&#x2F;pacman&#x2F;win</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">package版本</td>
<td align="left">4.4.0.130.136</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">architecture</td>
<td align="left">package架构</td>
<td align="left">amd64</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">multiarch</td>
<td align="left">多架构支持</td>
<td align="left">same</td>
<td align="left">deb</td>
</tr>
<tr>
<td align="left">source</td>
<td align="left">package源</td>
<td align="left">linux-meta</td>
<td align="left">deb&#x2F;rpm&#x2F;pkg</td>
</tr>
<tr>
<td align="left">description</td>
<td align="left">package描述</td>
<td align="left">Generic Linux kernel headers</td>
<td align="left">deb&#x2F;rpm&#x2F;pacman&#x2F;pkg</td>
</tr>
<tr>
<td align="left">location</td>
<td align="left">package位置</td>
<td align="left">C:\Program Files\VMware\VMware Tools\</td>
<td align="left">win&#x2F;pkg</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">完整性同步值</td>
<td align="left">78503709147600c8e0023cf2b9995772280eee30</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">item_id</td>
<td align="left">主键</td>
<td align="left">4323709147600c8e0023cf2b9995772280eef451</td>
<td align="left">All</td>
</tr>
</tbody></table>
<h4 id="d-网络接口信息"><a href="#d-网络接口信息" class="headerlink" title="d. 网络接口信息"></a>d. 网络接口信息</h4><p><strong>sys_netiface 表</strong></p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">描述</th>
<th align="left">示例</th>
<th align="left">支持平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">id</td>
<td align="left">Id</td>
<td align="left">1</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_id</td>
<td align="left">扫描标识符</td>
<td align="left">160615720</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_time</td>
<td align="left">扫描时间</td>
<td align="left">2018&#x2F;7&#x2F;31 16:46</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">Interface名称</td>
<td align="left">eth0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">adapter</td>
<td align="left">物理适配器名称</td>
<td align="left">Intel(R) PRO&#x2F;1000 MT Desktop Adapter</td>
<td align="left">Windows</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">网络适配器</td>
<td align="left">ethernet</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">接口状态</td>
<td align="left">up</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">mtu</td>
<td align="left">最大传输单元</td>
<td align="left">1500</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">mac</td>
<td align="left">MAC地址</td>
<td align="left">08:00:27:C0:14:A5</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">tx_packets</td>
<td align="left">传输的数据包</td>
<td align="left">30279</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">rx_packets</td>
<td align="left">接收的数据包</td>
<td align="left">12754</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">tx_bytes</td>
<td align="left">已传输字节</td>
<td align="left">10034626</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">rx_bytes</td>
<td align="left">已接收字节</td>
<td align="left">1111175</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">tx_errors</td>
<td align="left">传输错误</td>
<td align="left">0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">rx_errors</td>
<td align="left">接收错误</td>
<td align="left">0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">tx_dropped</td>
<td align="left">丢弃的传输包</td>
<td align="left">0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">rx_dropped</td>
<td align="left">丢弃的接收包</td>
<td align="left">0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">完整性同步值</td>
<td align="left">8503709147600c8e0023cf2b9995772280eee30</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">item_id</td>
<td align="left">主键</td>
<td align="left">4323709147600c8e0023cf2b9995772280eef41</td>
<td align="left">All</td>
</tr>
</tbody></table>
<p><strong>sys_netaddr 表</strong></p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">描述</th>
<th align="left">示例</th>
<th align="left">支持平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">id</td>
<td align="left">来自 sys_netiface 的参考ID</td>
<td align="left">1</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_id</td>
<td align="left">扫描标识符</td>
<td align="left">160615720</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">proto</td>
<td align="left">协议名称</td>
<td align="left">ipv4</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">address</td>
<td align="left">IPv4&#x2F;IPv6 地址</td>
<td align="left">192.168.1.87</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">netmask</td>
<td align="left">网络掩码地址</td>
<td align="left">255.255.255.0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">broadcast</td>
<td align="left">广播地址</td>
<td align="left">192.168.1.255</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">完整性同步值</td>
<td align="left">78503709147600c8e0023cf2b9995772280eee30</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">item_id</td>
<td align="left">主键</td>
<td align="left">4323709147600c8e0023cf2b9995772280eef4</td>
<td align="left">All</td>
</tr>
</tbody></table>
<p><strong>sys_netproto 表</strong></p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">描述</th>
<th align="left">示例</th>
<th align="left">支持平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">id</td>
<td align="left">来自 sys_netiface 的参考ID</td>
<td align="left">1</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_id</td>
<td align="left">扫描标识符</td>
<td align="left">160615720</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">iface</td>
<td align="left">Interface 名称</td>
<td align="left">eth0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">接口数据协议</td>
<td align="left">ipv4</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">gateway</td>
<td align="left">默认网关</td>
<td align="left">192.168.1.1</td>
<td align="left">Linux&#x2F;Windows&#x2F;macOS</td>
</tr>
<tr>
<td align="left">dhcp</td>
<td align="left">DHCP 状态</td>
<td align="left">enabled</td>
<td align="left">Linux&#x2F;Windows</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">完整性同步值</td>
<td align="left">78503709147600c8e0023cf2b9995772280eee30</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">item_id</td>
<td align="left">主键</td>
<td align="left">4323709147600c8e0023cf2b9995772280eef4</td>
<td align="left">All</td>
</tr>
</tbody></table>
<h4 id="e-端口信息"><a href="#e-端口信息" class="headerlink" title="e. 端口信息"></a>e. 端口信息</h4><table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">描述</th>
<th align="left">示例</th>
<th align="left">支持平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">scan_id</td>
<td align="left">扫描标识符</td>
<td align="left">1618114744</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_time</td>
<td align="left">扫描时间</td>
<td align="left">2018&#x2F;7&#x2F;27 7:27</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">protocol</td>
<td align="left">端口协议</td>
<td align="left">tcp</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">local_ip</td>
<td align="left">本地IP地址</td>
<td align="left">0.0.0.0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">local_port</td>
<td align="left">本地端口</td>
<td align="left">22</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">remote_ip</td>
<td align="left">远程IP地址</td>
<td align="left">0.0.0.0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">remote_port</td>
<td align="left">远程端口</td>
<td align="left">0</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">tx_queue</td>
<td align="left">等待传输的数据包</td>
<td align="left">0</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">rx_queue</td>
<td align="left">接收队列中的数据包</td>
<td align="left">0</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">inode</td>
<td align="left">端口inode</td>
<td align="left">16974</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">端口状态</td>
<td align="left">listening</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">PID</td>
<td align="left">已开放端口pid</td>
<td align="left">4</td>
<td align="left">Windows&#x2F;macOS</td>
</tr>
<tr>
<td align="left">process</td>
<td align="left">进程名称</td>
<td align="left">System</td>
<td align="left">Windows&#x2F;macOS</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">完整性同步值</td>
<td align="left">78503709147600c8e0023cf2b9995772280eee30</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">item_id</td>
<td align="left">主键</td>
<td align="left">4323709147600c8e0023cf2b9995772280eef412</td>
<td align="left">All</td>
</tr>
</tbody></table>
<h4 id="f-进程信息"><a href="#f-进程信息" class="headerlink" title="f. 进程信息"></a>f. 进程信息</h4><table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">描述</th>
<th align="left">示例</th>
<th align="left">支持平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">scan_id</td>
<td align="left">扫描标识符</td>
<td align="left">215303769</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">scan_time</td>
<td align="left">扫描时间</td>
<td align="left">2018&#x2F;8&#x2F;3 12:57</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">pid</td>
<td align="left">进程PID</td>
<td align="left">603</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">进程名称</td>
<td align="left">rsyslogd</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">state</td>
<td align="left">进程状态</td>
<td align="left">S</td>
<td align="left">Linux&#x2F;macOS</td>
</tr>
<tr>
<td align="left">ppid</td>
<td align="left">进程PPID</td>
<td align="left">1</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">utime</td>
<td align="left">执行用户代码所用时间</td>
<td align="left">157</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">stime</td>
<td align="left">执行系统代码所用时间</td>
<td align="left">221</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">cmd</td>
<td align="left">进程执行命令行</td>
<td align="left">&#x2F;usr&#x2F;sbin&#x2F;rsyslogd</td>
<td align="left">Linux&#x2F;Windows</td>
</tr>
<tr>
<td align="left">argvs</td>
<td align="left">命令执行参数</td>
<td align="left">-n</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">euser</td>
<td align="left">Effective用户</td>
<td align="left">root</td>
<td align="left">Linux&#x2F;macOS</td>
</tr>
<tr>
<td align="left">ruser</td>
<td align="left">Real 用户</td>
<td align="left">root</td>
<td align="left">Linux&#x2F;macOS</td>
</tr>
<tr>
<td align="left">suser</td>
<td align="left">Saved-set 用户</td>
<td align="left">root</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">egroup</td>
<td align="left">Effective 组</td>
<td align="left">root</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">rgroup</td>
<td align="left">Real 组</td>
<td align="left">root</td>
<td align="left">Linux&#x2F;macOS</td>
</tr>
<tr>
<td align="left">sgroup</td>
<td align="left">Saved-set 组</td>
<td align="left">root</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">fgroup</td>
<td align="left">文件系统组名</td>
<td align="left">root</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">priority</td>
<td align="left">内核调度优先级</td>
<td align="left">20</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">nice</td>
<td align="left">进程Nice值</td>
<td align="left">0</td>
<td align="left">Linux&#x2F;macOS</td>
</tr>
<tr>
<td align="left">size</td>
<td align="left">进程大小</td>
<td align="left">53030</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">vm_size</td>
<td align="left">VM 总大小 (KB)</td>
<td align="left">212120</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">resident</td>
<td align="left">进程的驻留大小（以字节为单位）</td>
<td align="left">902</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">share</td>
<td align="left">共享内存</td>
<td align="left">814</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">start_time</td>
<td align="left">进程启动时间</td>
<td align="left">1893</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">pgrp</td>
<td align="left">进程组</td>
<td align="left">603</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">session</td>
<td align="left">进程会话</td>
<td align="left">603</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">nlwp</td>
<td align="left">轻量级进程数</td>
<td align="left">3</td>
<td align="left">All</td>
</tr>
<tr>
<td align="left">tgid</td>
<td align="left">线程组ID</td>
<td align="left">603</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">tty</td>
<td align="left">进程TTY数</td>
<td align="left">0</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">processor</td>
<td align="left">处理器数</td>
<td align="left">0</td>
<td align="left">Linux</td>
</tr>
<tr>
<td align="left">checksum</td>
<td align="left">完整性同步值</td>
<td align="left">78503709147600c8e0023cf2b9995772280eee30</td>
<td align="left">All</td>
</tr>
</tbody></table>
<h4 id="g-配置使用"><a href="#g-配置使用" class="headerlink" title="g. 配置使用"></a>g. 配置使用</h4><p>在规则声明中将 <code>&lt;decoded_as&gt;</code> 字段设置为 syscollector，开启配置</p>
<p>示例：当启用agent的接口 eth0 时将触发此规则，并显示具有该接口的 IPv4</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100001<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>221<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoded_as</span><span class="token punctuation">></span></span>syscollector<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoded_as</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>netinfo.iface.name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>eth0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>eth0 interface enabled. IP: $(netinfo.iface.ipv4.address)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span></code></pre>

<p>Syscollector 模块默认在所有兼容系统中启用，包括所有可用的扫描</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- System inventory --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>wodle</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>syscollector<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disabled</span><span class="token punctuation">></span></span>no<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disabled</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interval</span><span class="token punctuation">></span></span>1h<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interval</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scan_on_start</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scan_on_start</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hardware</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hardware</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>os</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packages</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packages</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ports</span> <span class="token attr-name">all</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ports</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>processes</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>processes</span><span class="token punctuation">></span></span>

  <span class="token comment">&lt;!-- Database synchronization settings --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>synchronization</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>max_eps</span><span class="token punctuation">></span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>max_eps</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>synchronization</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>wodle</span><span class="token punctuation">></span></span></code></pre>

<h3 id="8-容器安全监控"><a href="#8-容器安全监控" class="headerlink" title="8. 容器安全监控"></a>8. 容器安全监控</h3><p>可使用 Wazuh 监控 Docker 服务器和容器事件</p>
<h4 id="a-安装依赖项"><a href="#a-安装依赖项" class="headerlink" title="a. 安装依赖项"></a>a. 安装依赖项</h4><p>Docker 监听器模块可以在 Wazuh 管理器（也充当代理）或直接在 Wazuh agent中配置，管理器包括所有已安装的依赖项，agent需安装依赖项</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">yum update <span class="token operator">&amp;&amp;</span> yum <span class="token function">install</span> python3

pip3 <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip

yum update <span class="token operator">&amp;&amp;</span> yum <span class="token function">install</span> python3-pip

pip3 <span class="token function">install</span> <span class="token assign-left variable">docker</span><span class="token operator">==</span><span class="token number">4.2</span>.0</code></pre>

<h4 id="b-监控容器活动"><a href="#b-监控容器活动" class="headerlink" title="b. 监控容器活动"></a>b. 监控容器活动</h4><p>Docker wodle 收集 Docker 容器上的事件，例如启动、停止或暂停。</p>
<p><strong>配置</strong></p>
<p>为了使用 Docker 侦听器模块，需要在运行 docker 的服务器的 <code>/var/ossec/etc/ossec.conf</code> 文件中启用 wodle</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>wodle</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>docker-listener<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disabled</span><span class="token punctuation">></span></span>no<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disabled</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>wodle</span><span class="token punctuation">></span></span></code></pre>

<p>配置后重新启动 Wazuh 服务</p>
<p><strong>监控示例</strong></p>
<p>1）启动一个 Docker 容器</p>
<p>命令 docker start apache 启动一个名为 apache 的容器，生成以下警报</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
<span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2018-10-05T17:15:33.892+0200"</span><span class="token punctuation">,</span>
<span class="token property">"rule"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"level"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Container apache started"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"87903"</span><span class="token punctuation">,</span>
    <span class="token property">"mail"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"docker"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"agent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"002"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"agent001"</span><span class="token punctuation">,</span>
    <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"192.168.122.19"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"manager"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"localhost.localdomain"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"1538752533.76076"</span><span class="token punctuation">,</span>
<span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"wazuh"</span><span class="token punctuation">,</span>
    <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">"master"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"full_log"</span><span class="token operator">:</span> <span class="token string">"&#123;\"integration\": \"docker\", \"docker\": &#123;\"status\": \"start\", \"id\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"from\": \"httpd\", \"Type\": \"container\", \"Action\": \"start\", \"Actor\": &#123;\"ID\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"Attributes\": &#123;\"image\": \"httpd\", \"name\": \"apache\"&#125;&#125;, \"time\": 1538752533, \"timeNano\": 1538752533877226210&#125;&#125;"</span><span class="token punctuation">,</span>
<span class="token property">"decoder"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"json"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"integration"</span><span class="token operator">:</span> <span class="token string">"docker"</span><span class="token punctuation">,</span>
    <span class="token property">"docker"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"start"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620"</span><span class="token punctuation">,</span>
    <span class="token property">"from"</span><span class="token operator">:</span> <span class="token string">"httpd"</span><span class="token punctuation">,</span>
    <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"container"</span><span class="token punctuation">,</span>
    <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"start"</span><span class="token punctuation">,</span>
    <span class="token property">"Actor"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token string">"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620"</span><span class="token punctuation">,</span>
        <span class="token property">"Attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"httpd"</span><span class="token punctuation">,</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"apache"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"1538752533"</span><span class="token punctuation">,</span>
    <span class="token property">"timeNano"</span><span class="token operator">:</span> <span class="token string">"1538752533877226240.000000"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"Wazuh-Docker"</span>
<span class="token punctuation">&#125;</span></code></pre>

<ol start="2">
<li>停止 Docker 容器</li>
</ol>
<p>使用命令 docker stop apache 生成警报：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
<span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2018-10-05T17:16:53.412+0200"</span><span class="token punctuation">,</span>
<span class="token property">"rule"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"level"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Container apache stopped"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"87904"</span><span class="token punctuation">,</span>
    <span class="token property">"mail"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"docker"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"agent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"002"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"agent001"</span><span class="token punctuation">,</span>
    <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"192.168.122.19"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"manager"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"localhost.localdomain"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"1538752613.100231"</span><span class="token punctuation">,</span>
<span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"wazuh"</span><span class="token punctuation">,</span>
    <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">"master"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"full_log"</span><span class="token operator">:</span> <span class="token string">"&#123;\"integration\": \"docker\", \"docker\": &#123;\"status\": \"stop\", \"id\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"from\": \"httpd\", \"Type\": \"container\", \"Action\": \"stop\", \"Actor\": &#123;\"ID\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"Attributes\": &#123;\"image\": \"httpd\", \"name\": \"apache\"&#125;&#125;, \"time\": 1538752613, \"timeNano\": 1538752613407075872&#125;&#125;"</span><span class="token punctuation">,</span>
<span class="token property">"decoder"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"json"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"integration"</span><span class="token operator">:</span> <span class="token string">"docker"</span><span class="token punctuation">,</span>
    <span class="token property">"docker"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"stop"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620"</span><span class="token punctuation">,</span>
    <span class="token property">"from"</span><span class="token operator">:</span> <span class="token string">"httpd"</span><span class="token punctuation">,</span>
    <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"container"</span><span class="token punctuation">,</span>
    <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"stop"</span><span class="token punctuation">,</span>
    <span class="token property">"Actor"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token string">"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620"</span><span class="token punctuation">,</span>
        <span class="token property">"Attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"httpd"</span><span class="token punctuation">,</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"apache"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"1538752613"</span><span class="token punctuation">,</span>
    <span class="token property">"timeNano"</span><span class="token operator">:</span> <span class="token string">"1538752613407075840.000000"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"Wazuh-Docker"</span>
<span class="token punctuation">&#125;</span></code></pre>

<ol start="3">
<li>暂停 Docker 容器</li>
</ol>
<p>使用命令 docker pause apache：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
<span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2018-10-05T17:17:54.988+0200"</span><span class="token punctuation">,</span>
<span class="token property">"rule"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"level"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Container apache paused"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"87905"</span><span class="token punctuation">,</span>
    <span class="token property">"mail"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"docker"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"agent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"002"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"agent001"</span><span class="token punctuation">,</span>
    <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"192.168.122.19"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"manager"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"localhost.localdomain"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"1538752674.104889"</span><span class="token punctuation">,</span>
<span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"wazuh"</span><span class="token punctuation">,</span>
    <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">"master"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"full_log"</span><span class="token operator">:</span> <span class="token string">"&#123;\"integration\": \"docker\", \"docker\": &#123;\"status\": \"pause\", \"id\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"from\": \"httpd\", \"Type\": \"container\", \"Action\": \"pause\", \"Actor\": &#123;\"ID\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"Attributes\": &#123;\"image\": \"httpd\", \"name\": \"apache\"&#125;&#125;, \"time\": 1538752674, \"timeNano\": 1538752674984734790&#125;&#125;"</span><span class="token punctuation">,</span>
<span class="token property">"decoder"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"json"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"integration"</span><span class="token operator">:</span> <span class="token string">"docker"</span><span class="token punctuation">,</span>
    <span class="token property">"docker"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"pause"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620"</span><span class="token punctuation">,</span>
    <span class="token property">"from"</span><span class="token operator">:</span> <span class="token string">"httpd"</span><span class="token punctuation">,</span>
    <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"container"</span><span class="token punctuation">,</span>
    <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"pause"</span><span class="token punctuation">,</span>
    <span class="token property">"Actor"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token string">"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620"</span><span class="token punctuation">,</span>
        <span class="token property">"Attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"httpd"</span><span class="token punctuation">,</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"apache"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"1538752674"</span><span class="token punctuation">,</span>
    <span class="token property">"timeNano"</span><span class="token operator">:</span> <span class="token string">"1538752674984734720.000000"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"Wazuh-Docker"</span>
<span class="token punctuation">&#125;</span></code></pre>

<ol start="4">
<li>取消暂停 Docker 容器</li>
</ol>
<p>运行docker unpause apache 命令的警报：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
<span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2018-10-05T17:18:35.373+0200"</span><span class="token punctuation">,</span>
<span class="token property">"rule"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"level"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Container apache unpaused"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"87906"</span><span class="token punctuation">,</span>
    <span class="token property">"mail"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"docker"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"agent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"002"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"agent001"</span><span class="token punctuation">,</span>
    <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"192.168.122.19"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"manager"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"localhost.localdomain"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"1538752715.105822"</span><span class="token punctuation">,</span>
<span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"wazuh"</span><span class="token punctuation">,</span>
    <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">"master"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"full_log"</span><span class="token operator">:</span> <span class="token string">"&#123;\"integration\": \"docker\", \"docker\": &#123;\"status\": \"unpause\", \"id\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"from\": \"httpd\", \"Type\": \"container\", \"Action\": \"unpause\", \"Actor\": &#123;\"ID\": \"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620\", \"Attributes\": &#123;\"image\": \"httpd\", \"name\": \"apache\"&#125;&#125;, \"time\": 1538752715, \"timeNano\": 1538752715369717277&#125;&#125;"</span><span class="token punctuation">,</span>
<span class="token property">"decoder"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"json"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"integration"</span><span class="token operator">:</span> <span class="token string">"docker"</span><span class="token punctuation">,</span>
    <span class="token property">"docker"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"unpause"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620"</span><span class="token punctuation">,</span>
    <span class="token property">"from"</span><span class="token operator">:</span> <span class="token string">"httpd"</span><span class="token punctuation">,</span>
    <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"container"</span><span class="token punctuation">,</span>
    <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"unpause"</span><span class="token punctuation">,</span>
    <span class="token property">"Actor"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"ID"</span><span class="token operator">:</span> <span class="token string">"018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620"</span><span class="token punctuation">,</span>
        <span class="token property">"Attributes"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"httpd"</span><span class="token punctuation">,</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"apache"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"1538752715"</span><span class="token punctuation">,</span>
    <span class="token property">"timeNano"</span><span class="token operator">:</span> <span class="token string">"1538752715369717248.000000"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"Wazuh-Docker"</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="9-集成Osquery"><a href="#9-集成Osquery" class="headerlink" title="9. 集成Osquery"></a>9. 集成Osquery</h3><p>Wazuh 管理模块允许从agent集成 Osquery 工具，它允许设置 Osquery 配置并收集 Osquery 生成的信息以将其发送给管理器，并在必要时生成相应的警报。</p>
<h4 id="a-安装Osquery"><a href="#a-安装Osquery" class="headerlink" title="a. 安装Osquery"></a>a. 安装Osquery</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-L</span> https://pkg.osquery.io/rpm/GPG <span class="token operator">|</span> <span class="token function">tee</span> /etc/pki/rpm-gpg/RPM-GPG-KEY-osquery
yum-config-manager --add-repo https://pkg.osquery.io/rpm/osquery-s3-rpm.repo
yum-config-manager <span class="token parameter variable">--enable</span> osquery-s3-rpm-repo
yum <span class="token function">install</span> osquery</code></pre>

<p>安装后，需要 Osquery 的配置文件。如果没有，可使用Osquery 提供的默认配置</p>
<pre class="language-none"><code class="language-none">cp &#x2F;opt&#x2F;osquery&#x2F;share&#x2F;osquery&#x2F;osquery.example.conf &#x2F;etc&#x2F;osquery&#x2F;osquery.conf</code></pre>

<p>启动osquery 守护进程</p>
<pre class="language-none"><code class="language-none">systemctl enable osqueryd
systemctl start osqueryd</code></pre>

<p>通过添加以下命令为运行 osquery 的agent启用 osquery 模块，配置文件<code>/var/ossec/etc/ossec.conf</code></p>
<pre class="language-none"><code class="language-none">&lt;wodle name&#x3D;&quot;osquery&quot;&#x2F;&gt;</code></pre>

<h4 id="b-配置示例"><a href="#b-配置示例" class="headerlink" title="b. 配置示例"></a>b. 配置示例</h4><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"options"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"config_plugin"</span><span class="token operator">:</span> <span class="token string">"filesystem"</span><span class="token punctuation">,</span>
        <span class="token property">"logger_plugin"</span><span class="token operator">:</span> <span class="token string">"filesystem"</span><span class="token punctuation">,</span>
        <span class="token property">"utc"</span><span class="token operator">:</span> <span class="token string">"true"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

    <span class="token property">"schedule"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"system_info"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"SELECT hostname, cpu_brand, physical_memory FROM system_info;"</span><span class="token punctuation">,</span>
        <span class="token property">"interval"</span><span class="token operator">:</span> <span class="token number">3600</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"high_load_average"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"SELECT period, average, '70%' AS 'threshold' FROM load_average WHERE period = '15m' AND average > '0.7';"</span><span class="token punctuation">,</span>
        <span class="token property">"interval"</span><span class="token operator">:</span> <span class="token number">900</span><span class="token punctuation">,</span>
        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Report if load charge is over 70 percent."</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"low_free_memory"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"SELECT memory_total, memory_free, CAST(memory_free AS real) / memory_total AS memory_free_perc, '10%' AS threshold FROM memory_info WHERE memory_free_perc &lt; 0.1;"</span><span class="token punctuation">,</span>
        <span class="token property">"interval"</span><span class="token operator">:</span> <span class="token number">1800</span><span class="token punctuation">,</span>
        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Free RAM is under 10%."</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

    <span class="token property">"packs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"osquery-monitoring"</span><span class="token operator">:</span> <span class="token string">"/opt/osquery/share/osquery/packs/osquery-monitoring.conf"</span><span class="token punctuation">,</span>
        <span class="token property">"incident-response"</span><span class="token operator">:</span> <span class="token string">"/opt/osquery/share/osquery/packs/incident-response.conf"</span><span class="token punctuation">,</span>
        <span class="token property">"it-compliance"</span><span class="token operator">:</span> <span class="token string">"/opt/osquery/share/osquery/packs/it-compliance.conf"</span><span class="token punctuation">,</span>
        <span class="token property">"vuln-management"</span><span class="token operator">:</span> <span class="token string">"/opt/osquery/share/osquery/packs/vuln-management.conf"</span><span class="token punctuation">,</span>
        <span class="token property">"hardware-monitoring"</span><span class="token operator">:</span> <span class="token string">"/opt/osquery/share/osquery/packs/hardware-monitoring.conf"</span><span class="token punctuation">,</span>
        <span class="token property">"ossec-rootkit"</span><span class="token operator">:</span> <span class="token string">"/opt/osquery/share/osquery/packs/ossec-rootkit.conf"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="c-告警示例"><a href="#c-告警示例" class="headerlink" title="c. 告警示例"></a>c. 告警示例</h4><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
<span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2018-07-30T13:54:46.476+0000"</span><span class="token punctuation">,</span>
<span class="token property">"rule"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"level"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"osquery data grouped"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"24010"</span><span class="token punctuation">,</span>
    <span class="token property">"firedtimes"</span><span class="token operator">:</span> <span class="token number">207</span><span class="token punctuation">,</span>
    <span class="token property">"mail"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"osquery"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"agent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"000"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"manager"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"manager"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"manager"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"1532958886.437707"</span><span class="token punctuation">,</span>
<span class="token property">"full_log"</span><span class="token operator">:</span> <span class="token string">"&#123;\"name\":\"system_info\",\"hostIdentifier\":\"manager\",\"calendarTime\":\"Mon Jul 30 13:54:45 2018 UTC\",\"unixTime\":1532958885,\"epoch\":0,\"counter\":461,\"columns\":&#123;\"cgroup_namespace\":\"4026531835\",\"cmdline\":\"\",\"cwd\":\"/\",\"disk_bytes_read\":\"0\",\"disk_bytes_written\":\"0\",\"egid\":\"0\",\"euid\":\"0\",\"gid\":\"0\",\"ipc_namespace\":\"4026531839\",\"mnt_namespace\":\"4026531840\",\"name\":\"migration/0\",\"net_namespace\":\"4026531957\",\"nice\":\"0\",\"on_disk\":\"-1\",\"parent\":\"2\",\"path\":\"\",\"pgroup\":\"0\",\"pid\":\"9\",\"pid_namespace\":\"4026531836\",\"resident_size\":\"\",\"root\":\"/\",\"sgid\":\"0\",\"start_time\":\"0\",\"state\":\"S\",\"suid\":\"0\",\"system_time\":\"2\",\"threads\":\"1\",\"total_size\":\"\",\"uid\":\"0\",\"user_namespace\":\"4026531837\",\"user_time\":\"0\",\"uts_namespace\":\"4026531838\",\"wired_size\":\"0\"&#125;,\"action\":\"added\"&#125;"</span><span class="token punctuation">,</span>
<span class="token property">"decoder"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"json"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"added"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"system_info"</span><span class="token punctuation">,</span>
    <span class="token property">"hostIdentifier"</span><span class="token operator">:</span> <span class="token string">"manager"</span><span class="token punctuation">,</span>
    <span class="token property">"calendarTime"</span><span class="token operator">:</span> <span class="token string">"Mon Jul 30 13:54:45 2018 UTC"</span><span class="token punctuation">,</span>
    <span class="token property">"unixTime"</span><span class="token operator">:</span> <span class="token string">"1532958885"</span><span class="token punctuation">,</span>
    <span class="token property">"epoch"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
    <span class="token property">"counter"</span><span class="token operator">:</span> <span class="token string">"461"</span><span class="token punctuation">,</span>
    <span class="token property">"columns"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"cgroup_namespace"</span><span class="token operator">:</span> <span class="token string">"4026531835"</span><span class="token punctuation">,</span>
        <span class="token property">"cmdline"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token property">"cwd"</span><span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
        <span class="token property">"disk_bytes_read"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"disk_bytes_written"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"egid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"euid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"gid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"ipc_namespace"</span><span class="token operator">:</span> <span class="token string">"4026531839"</span><span class="token punctuation">,</span>
        <span class="token property">"mnt_namespace"</span><span class="token operator">:</span> <span class="token string">"4026531840"</span><span class="token punctuation">,</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"migration/0"</span><span class="token punctuation">,</span>
        <span class="token property">"net_namespace"</span><span class="token operator">:</span> <span class="token string">"4026531957"</span><span class="token punctuation">,</span>
        <span class="token property">"nice"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"on_disk"</span><span class="token operator">:</span> <span class="token string">"-1"</span><span class="token punctuation">,</span>
        <span class="token property">"parent"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
        <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token property">"pgroup"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"pid"</span><span class="token operator">:</span> <span class="token string">"9"</span><span class="token punctuation">,</span>
        <span class="token property">"pid_namespace"</span><span class="token operator">:</span> <span class="token string">"4026531836"</span><span class="token punctuation">,</span>
        <span class="token property">"resident_size"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token property">"root"</span><span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
        <span class="token property">"sgid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"start_time"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"S"</span><span class="token punctuation">,</span>
        <span class="token property">"suid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"system_time"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
        <span class="token property">"threads"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token property">"total_size"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"user_namespace"</span><span class="token operator">:</span> <span class="token string">"4026531837"</span><span class="token punctuation">,</span>
        <span class="token property">"user_time"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"uts_namespace"</span><span class="token operator">:</span> <span class="token string">"4026531838"</span><span class="token punctuation">,</span>
        <span class="token property">"wired_size"</span><span class="token operator">:</span> <span class="token string">"0"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"predecoder"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"hostname"</span><span class="token operator">:</span> <span class="token string">"manager"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"osquery"</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="0x05-实战用例"><a href="#0x05-实战用例" class="headerlink" title="0x05 实战用例"></a>0x05 实战用例</h2><h3 id="1-文件完整性监控"><a href="#1-文件完整性监控" class="headerlink" title="1. 文件完整性监控"></a>1. 文件完整性监控</h3><p>配置 Wazuh agent以监视 &#x2F;root 目录中的文件系统更改，编辑 Wazuh 代理 &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;ossec.conf 配置文件，在 <code>&lt;syscheck&gt;</code> 块中添加用于监视的目录</p>
<pre class="language-none"><code class="language-none">&lt;directories check_all&#x3D;&quot;yes&quot; report_changes&#x3D;&quot;yes&quot; realtime&#x3D;&quot;yes&quot;&gt;&#x2F;root&lt;&#x2F;directories&gt;</code></pre>

<p>重启 Wazuh agent生效</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<h3 id="2-检测暴力破解攻击"><a href="#2-检测暴力破解攻击" class="headerlink" title="2. 检测暴力破解攻击"></a>2. 检测暴力破解攻击</h3><p><strong>SSH暴力破解</strong></p>
<pre class="language-none"><code class="language-none"># 攻击模拟
sudo hydra -l user -P &lt;PASSWD_LIST.txt&gt; &lt;RHEL_IP&gt; ssh</code></pre>

<p><strong>RDP暴力破解</strong></p>
<pre class="language-none"><code class="language-none"># 攻击模拟
sudo hydra -l user -P &lt;PASSWD_LIST.txt&gt; rdp:&#x2F;&#x2F;&lt;WINDOWS_IP&gt;</code></pre>

<h3 id="3-检测异常进程"><a href="#3-检测异常进程" class="headerlink" title="3. 检测异常进程"></a>3. 检测异常进程</h3><p>使用 Wazuh 命令监控功能来检测 Netcat 在 Linux 端点上运行</p>
<p><strong>agent配置</strong></p>
<p>将以下配置块添加到 Wazuh agent <code>/var/ossec/etc/ossec.conf</code> 文件中，允许获取正在运行的进程列表：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>full_command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alias</span><span class="token punctuation">></span></span>process list<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>alias</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>ps -e -o pid,uname,command<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>frequency</span><span class="token punctuation">></span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>frequency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>重启 Wazuh agent生效</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<p><strong>服务端配置</strong></p>
<p>创建每次 Netcat 程序启动时触发的规则，在Wazuh服务器的<code>/var/ossec/etc/rules/local_rules.xml</code>文件创建规则：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ossec,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100050<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>530<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>^ossec: output: 'process list'<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>List of running processes.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span>process_monitor,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100051<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>7<span class="token punctuation">"</span></span> <span class="token attr-name">ignore</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>900<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>100050<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>nc -l<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>netcat listening for incoming connections.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span>process_monitor,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span></code></pre>

<p>重启 Wazuh 管理器生效：</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-manager</code></pre>

<p><strong>攻击模拟</strong></p>
<pre class="language-none"><code class="language-none">nc -l 8000</code></pre>

<h3 id="4-检测-SQL-注入攻击"><a href="#4-检测-SQL-注入攻击" class="headerlink" title="4. 检测 SQL 注入攻击"></a>4. 检测 SQL 注入攻击</h3><p>可以使用 Wazuh 从包含select, union和其他常见 SQL 注入模式等的 Web 服务器日志中检测 SQL 注入攻击</p>
<p><strong>搭建web服务器</strong></p>
<pre class="language-none"><code class="language-none">sudo yum -y install apache2

sudo systemctl start apache2

curl http:&#x2F;&#x2F;&lt;LINUX_IP&gt;</code></pre>

<p><strong>日志监控配置</strong></p>
<p>将以下行添加到 Wazuh agent <code>/var/ossec/etc/ossec.conf</code> 文件中。允许 Wazuh agent监控 Apache 服务器的访问日志：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">></span></span>apache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/var/log/apache2/access.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>重启 Wazuh agent生效</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<p><strong>攻击模拟</strong></p>
<p>sql注入攻击</p>
<pre class="language-none"><code class="language-none">curl -XGET &quot;http:&#x2F;&#x2F;&lt;HOST_IP&gt;&#x2F;users&#x2F;?id&#x3D;SELECT+*+FROM+users&quot;;</code></pre>

<p>Shellshock 攻击</p>
<pre class="language-none"><code class="language-none">sudo curl -H &quot;User-Agent: () &#123; :; &#125;; &#x2F;bin&#x2F;cat &#x2F;etc&#x2F;passwd&quot; &lt;WEBSERVER-IP&gt;</code></pre>

<h3 id="5-检测可疑的二进制文件"><a href="#5-检测可疑的二进制文件" class="headerlink" title="5. 检测可疑的二进制文件"></a>5. 检测可疑的二进制文件</h3><p>Wazuh 具有异常和恶意软件检测功能，可以检测端点上的可疑二进制文件。</p>
<p>使用Wazuh rootcheck 模块检测 Linux 端点上的木马系统二进制文件，Wazuh rootcheck 模块还检查隐藏的进程、端口和文件</p>
<p><strong>配置</strong></p>
<p>检查被监控端点的 <code>/var/ossec/etc/ossec.conf</code> 配置文件中的 <code>&lt;rootcheck&gt;</code> 块，确保其具有以下配置：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootcheck</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disabled</span><span class="token punctuation">></span></span>no<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disabled</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_files</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_files</span><span class="token punctuation">></span></span>

    <span class="token comment">&lt;!-- Line for trojans detection --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_trojans</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_trojans</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_dev</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_dev</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_sys</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_sys</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_pids</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_pids</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_ports</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_ports</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_if</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_if</span><span class="token punctuation">></span></span>

    <span class="token comment">&lt;!-- Frequency that rootcheck is executed - every 12 hours --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>frequency</span><span class="token punctuation">></span></span>43200<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>frequency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootkit_files</span><span class="token punctuation">></span></span>/var/ossec/etc/shared/rootkit_files.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootkit_files</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootkit_trojans</span><span class="token punctuation">></span></span>/var/ossec/etc/shared/rootkit_trojans.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootkit_trojans</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>skip_nfs</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>skip_nfs</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootcheck</span><span class="token punctuation">></span></span></code></pre>

<p><strong>攻击模拟</strong></p>
<pre class="language-none"><code class="language-none">sudo cp -p &#x2F;usr&#x2F;bin&#x2F;w &#x2F;usr&#x2F;bin&#x2F;w.copy

sudo tee &#x2F;usr&#x2F;bin&#x2F;w &lt;&lt; EOF
!&#x2F;bin&#x2F;bash
echo &quot;&#96;date&#96; this is evil&quot; &gt; &#x2F;tmp&#x2F;trojan_created_file
echo &#39;test for &#x2F;usr&#x2F;bin&#x2F;w trojaned file&#39; &gt;&gt; &#x2F;tmp&#x2F;trojan_created_file
Now running original binary
&#x2F;usr&#x2F;bin&#x2F;w.copy
EOF</code></pre>

<p>默认情况下，rootcheck 扫描每 12 小时运行一次。通过重新启动 Wazuh agent来强制扫描以查看相关警报：</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<h3 id="6-监控恶意命令执行"><a href="#6-监控恶意命令执行" class="headerlink" title="6. 监控恶意命令执行"></a>6. 监控恶意命令执行</h3><p>配置 Auditd 以监视恶意命令的执行，利用 Wazuh CDB 列表查找功能创建可在其上运行的潜在恶意命令列表。</p>
<p><strong>端点配置</strong></p>
<ol>
<li>安装、启动并启用 Auditd</li>
</ol>
<pre class="language-none"><code class="language-none">sudo yum -y install auditd
sudo systemctl start auditd
sudo systemctl enable auditd</code></pre>

<p>2）root用户执行以下命令将审计规则附加到 <code>/etc/audit/audit.rules</code> 文件</p>
<pre class="language-none"><code class="language-none">echo &quot;-a exit,always -F auid&#x3D;1000 -F egid!&#x3D;994 -F auid!&#x3D;-1 -F arch&#x3D;b32 -S execve -k audit-wazuh-c&quot; &gt;&gt; &#x2F;etc&#x2F;audit&#x2F;audit.rules
echo &quot;-a exit,always -F auid&#x3D;1000 -F egid!&#x3D;994 -F auid!&#x3D;-1 -F arch&#x3D;b64 -S execve -k audit-wazuh-c&quot; &gt;&gt; &#x2F;etc&#x2F;audit&#x2F;audit.rules</code></pre>

<p>3）重新加载规则并确认启用</p>
<pre class="language-none"><code class="language-none">sudo auditctl -R &#x2F;etc&#x2F;audit&#x2F;audit.rules
sudo auditctl -l</code></pre>

<p>4）重启 Wazuh agent生效</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<p><strong>服务端配置</strong></p>
<p>在server创建CDB恶意程序列表和规则来检测列表中程序的执行</p>
<p>1）查看lookup文件 <code>/var/ossec/etc/lists/audit-keys</code> 中的键值对</p>
<pre class="language-none"><code class="language-none">audit-wazuh-w:write
audit-wazuh-r:read
audit-wazuh-a:attribute
audit-wazuh-x:execute
audit-wazuh-c:command</code></pre>

<p>此 CDB 列表包含以冒号分隔的键和值，这些被编译成特殊的二进制格式，方便Wazuh 规则中的高性能查找，除了文本文件<code>/var/ossec/etc/lists/audit-keys</code>，还有一个二进制文件<code>/var/ossec/etc/lists/audit-keys.cdb</code>可用于查找</p>
<p>2）创建一个 CDB 列表 <code>/var/ossec/etc/lists/suspicious-programs</code> 并用以下内容填充其内容</p>
<pre class="language-none"><code class="language-none">ncat:yellow
nc:red
tcpdump:orange</code></pre>

<p>3）将列表添加到 Wazuh 服务器 <code>/var/ossec/etc/ossec.conf</code> 文件的 <code>&lt;ruleset&gt;</code></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">></span></span>etc/lists/suspicious-programs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">></span></span></code></pre>

<p>4）创建一个高严重性规则以在执行”red”程序时触发。将此新规则添加到 Wazuh 服务器上的 <code>/var/ossec/etc/rules/local_rules.xml</code> 文件中</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>audit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100210<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>80792<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span> <span class="token attr-name">field</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>audit.command<span class="token punctuation">"</span></span> <span class="token attr-name">lookup</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_key_value<span class="token punctuation">"</span></span> <span class="token attr-name">check_value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>red<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>etc/lists/suspicious-programs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Audit: Highly Suspicious Command executed: $(audit.exe)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span>audit_command,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span></code></pre>

<p>5）重启 Wazuh 管理器使配置生效</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-manager</code></pre>

<p><strong>攻击模拟</strong></p>
<pre class="language-none"><code class="language-none">sudo yum -y install netcat
nc -v</code></pre>

<h3 id="7-检测隐藏进程"><a href="#7-检测隐藏进程" class="headerlink" title="7. 检测隐藏进程"></a>7. 检测隐藏进程</h3><p>Wazuh 检测 Linux 端点上的 Rootkit 创建的隐藏进程，这个 rootkit 隐藏在内核模块列表中。</p>
<p>它还从 ps 中隐藏选定的进程，但Wazuh 使用 setsid()、getpid() 和 kill() 系统调用来检测</p>
<p><strong>检测配置</strong></p>
<p>1）切换到 root 用户并更新此端点的内核</p>
<pre class="language-none"><code class="language-none">sudo su
yum update</code></pre>

<p>2）安装构建 rootkit 所需的包</p>
<pre class="language-none"><code class="language-none">yum -y install gcc git</code></pre>

<p>3）将 Wazuh agent配置为每 2 分钟运行一次 rootcheck 扫描。在 <code>/var/ossec/etc/ossec.conf</code> 文件中，将 <code>&lt;rootcheck&gt;</code> 中的 frequency 选项设置为 120</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootcheck</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disabled</span><span class="token punctuation">></span></span>no<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disabled</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_files</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_files</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_trojans</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_trojans</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_dev</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_dev</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_sys</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_sys</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_pids</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_pids</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_ports</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_ports</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>check_if</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>check_if</span><span class="token punctuation">></span></span>

  <span class="token comment">&lt;!-- rootcheck execution frequency - every 12 hours by default--></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>frequency</span><span class="token punctuation">></span></span>120<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>frequency</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootkit_files</span><span class="token punctuation">></span></span>etc/shared/rootkit_files.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootkit_files</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rootkit_trojans</span><span class="token punctuation">></span></span>etc/shared/rootkit_trojans.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootkit_trojans</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>skip_nfs</span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>skip_nfs</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rootcheck</span><span class="token punctuation">></span></span></code></pre>

<p>4）重启 Wazuh agent生效</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<p><strong>攻击模拟</strong></p>
<p>1）下载、编译并加载Diamorphine rootkit内核模块</p>
<pre class="language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;m0nad&#x2F;Diamorphine

cd Diamorphine &amp;&amp; make

insmod diamorphine.ko </code></pre>

<p>2）使用在端点上运行的随机进程的 PID 运行 kill signal 63。这会取消隐藏 Diamorphine rootkit。默认情况下，Diamorphine 会隐藏自身，无法通过运行 lsmod 命令检测到</p>
<pre class="language-none"><code class="language-none">lsmod | grep diamorphine
kill -63 509
lsmod | grep diamorphine</code></pre>

<p>输出</p>
<pre class="language-none"><code class="language-none">diamorphine            13155  0</code></pre>

<p>使用最后的命令时，会得到一个空输出。在 Diamorphine 的情况下，任何发送到任意进程的 kill 信号 -63（无论是否存在）都会切换 Diamorphine 内核模块以隐藏或取消隐藏</p>
<p>3）运行以下命令以查看 rsyslogd 进程，开始可见然后不再可见。该 rootkit 允许从 ps 命令中隐藏选定的进程，发送终止信号 -31 隐藏&#x2F;取消隐藏任何进程</p>
<pre class="language-none"><code class="language-none">ps auxw | grep rsyslogd | grep -v grep</code></pre>

<p>输出</p>
<pre class="language-none"><code class="language-none">root       732  0.0  0.7 214452  3572 ?        Ssl  14:53   0:00 &#x2F;usr&#x2F;sbin&#x2F;rsyslogd -n</code></pre>

<p>使用最后一个命令时，会得到一个空输出</p>
<pre class="language-none"><code class="language-none">kill -31 &lt;PID_OF_RSYSLOGD&gt;
ps auxw | grep rsyslog | grep -v grep</code></pre>

<p>下一次 rootcheck 扫描将运行并提醒我们有关隐藏在 Diamorphine rootkit 中的 rsyslogd 进程</p>
<h3 id="8-集成-Yara-检测恶意软件"><a href="#8-集成-Yara-检测恶意软件" class="headerlink" title="8. 集成 Yara 检测恶意软件"></a>8. 集成 Yara 检测恶意软件</h3><p>可以使用 YARA 与 Wazuh 的集成来扫描在端点上添加或修改的文件中是否存在恶意软件，当Wazuh FIM 模块触发警报，YARA 主动响应模块就会扫描新文件或修改过的文件</p>
<p><strong>端点配置</strong></p>
<p>1）下载、编译和安装 YARA</p>
<pre class="language-none"><code class="language-none">sudo yum makecache
sudo yum install epel-release
sudo yum update
sudo yum install -y make automake gcc autoconf libtool openssl-devel pkg-config jq
sudo curl -LO https:&#x2F;&#x2F;github.com&#x2F;VirusTotal&#x2F;yara&#x2F;archive&#x2F;v4.2.3.tar.gz
sudo tar -xvzf v4.2.3.tar.gz -C &#x2F;usr&#x2F;local&#x2F;bin&#x2F; &amp;&amp; rm -f v4.2.3.tar.gz
cd &#x2F;usr&#x2F;local&#x2F;bin&#x2F;yara-4.2.3&#x2F;
sudo .&#x2F;bootstrap.sh &amp;&amp; sudo .&#x2F;configure &amp;&amp; sudo make &amp;&amp; sudo make install &amp;&amp; sudo make check</code></pre>

<p>2）下载YARA检测规则</p>
<pre class="language-none"><code class="language-none">sudo mkdir -p &#x2F;tmp&#x2F;yara&#x2F;rules
sudo curl &#39;https:&#x2F;&#x2F;valhalla.nextron-systems.com&#x2F;api&#x2F;v1&#x2F;get&#39; \
-H &#39;Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8&#39; \
-H &#39;Accept-Language: en-US,en;q&#x3D;0.5&#39; \
--compressed \
-H &#39;Referer: https:&#x2F;&#x2F;valhalla.nextron-systems.com&#x2F;&#39; \
-H &#39;Content-Type: application&#x2F;x-www-form-urlencoded&#39; \
-H &#39;DNT: 1&#39; -H &#39;Connection: keep-alive&#39; -H &#39;Upgrade-Insecure-Requests: 1&#39; \
--data &#39;demo&#x3D;demo&amp;apikey&#x3D;1111111111111111111111111111111111111111111111111111111111111111&amp;format&#x3D;text&#39; \
-o &#x2F;tmp&#x2F;yara&#x2F;rules&#x2F;yara_rules.yar</code></pre>

<p>3）在<code>/var/ossec/active-response/bin/</code>目录下创建yara.sh脚本</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># Wazuh - Yara active response</span>
<span class="token comment"># Copyright (C) 2015-2022, Wazuh Inc.</span>
<span class="token comment">#</span>
<span class="token comment"># This program is free software; you can redistribute it</span>
<span class="token comment"># and/or modify it under the terms of the GNU General Public</span>
<span class="token comment"># License (version 2) as published by the FSF - Free Software</span>
<span class="token comment"># Foundation.</span>


<span class="token comment">#------------------------- Gather parameters -------------------------#</span>

<span class="token comment"># Extra arguments</span>
<span class="token builtin class-name">read</span> INPUT_JSON
<span class="token assign-left variable">YARA_PATH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $INPUT_JSON <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .parameters.extra_args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token variable">)</span></span>
<span class="token assign-left variable">YARA_RULES</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $INPUT_JSON <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .parameters.extra_args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token variable">)</span></span>
<span class="token assign-left variable">FILENAME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $INPUT_JSON <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .parameters.alert.syscheck.path<span class="token variable">)</span></span>

<span class="token comment"># Set LOG_FILE path</span>
<span class="token assign-left variable">LOG_FILE</span><span class="token operator">=</span><span class="token string">"logs/active-responses.log"</span>

<span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">actual_size</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">stat</span> <span class="token parameter variable">-c</span> %s $<span class="token punctuation">&#123;</span>FILENAME<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
<span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$&#123;size&#125;</span> <span class="token parameter variable">-ne</span> <span class="token variable">$&#123;actual_size&#125;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token function">sleep</span> <span class="token number">1</span>
    <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token variable">$&#123;actual_size&#125;</span>
    <span class="token assign-left variable">actual_size</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">stat</span> <span class="token parameter variable">-c</span> %s $<span class="token punctuation">&#123;</span>FILENAME<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
<span class="token keyword">done</span>

<span class="token comment">#----------------------- Analyze parameters -----------------------#</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token variable">$YARA_PATH</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token variable">$YARA_RULES</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"wazuh-yara: ERROR - Yara active response error. Yara path and rules parameters are mandatory."</span> <span class="token operator">>></span> <span class="token variable">$&#123;LOG_FILE&#125;</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token comment">#------------------------- Main workflow --------------------------#</span>

<span class="token comment"># Execute Yara scan on the specified filename</span>
<span class="token assign-left variable">yara_output</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>"$<span class="token punctuation">&#123;</span>YARA_PATH<span class="token punctuation">&#125;</span><span class="token string">"/yara -w -r "</span>$YARA_RULES<span class="token string">" "</span>$FILENAME"<span class="token variable">)</span></span>"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$yara_output</span> <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">then</span>
    <span class="token comment"># Iterate every detected rule and append it to the LOG_FILE</span>
    <span class="token keyword">while</span> <span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> line<span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"wazuh-yara: INFO - Scan result: <span class="token variable">$line</span>"</span> <span class="token operator">>></span> <span class="token variable">$&#123;LOG_FILE&#125;</span>
    <span class="token keyword">done</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"<span class="token variable">$yara_output</span>"</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span></code></pre>

<p>4）将 yara.sh 文件所有者更改为 root:wazuh 并将文件权限更改为 0750</p>
<pre class="language-none"><code class="language-none">sudo chown root:wazuh &#x2F;var&#x2F;ossec&#x2F;active-response&#x2F;bin&#x2F;yara.sh
sudo chmod 750 &#x2F;var&#x2F;ossec&#x2F;active-response&#x2F;bin&#x2F;yara.sh</code></pre>

<p>5）在 Wazuh agent <code>/var/ossec/etc/ossec.conf</code> 配置文件的 <code>&lt;syscheck&gt;</code> 块中添加以下内容以监控 <code>/tmp/yara/malware</code> 目录</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directories</span> <span class="token attr-name">realtime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/tmp/yara/malware<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directories</span><span class="token punctuation">></span></span></code></pre>

<p>6）重新启动 Wazuh agent以应用配置更改</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<p><strong>server配置</strong></p>
<p>配置 Wazuh 以提醒端点监控目录中的文件更改，再配置一个主动响应脚本，以便在检测到可疑文件时触发</p>
<p>1）在 <code>/var/ossec/etc/rules/local_rules.xml</code> 文件中添加如下规则，规则检测受监控目录中的 FIM 事件。当 YARA 集成发现恶意软件时，会发出警报</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>syscheck,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100300<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>7<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>550<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/tmp/yara/malware/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>File modified in /tmp/yara/malware/ directory.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100301<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>7<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>554<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>/tmp/yara/malware/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>File added to /tmp/yara/malware/ directory.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yara,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>108000<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoded_as</span><span class="token punctuation">></span></span>yara_decoder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoded_as</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>Yara grouping rule<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>108001<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">></span></span>108000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span><span class="token punctuation">></span></span>wazuh-yara: INFO - Scan result: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>match</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>File "$(yara_scanned_file)" is a positive match. Yara rule: $(yara_rule)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span></code></pre>

<p>2）将以下解码器添加到 Wazuh 服务器 <code>/var/ossec/etc/decoders/local_decoder.xml</code> 文件中。允许从 YARA 扫描结果中提取信息</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yara_decoder<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prematch</span><span class="token punctuation">></span></span>wazuh-yara:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prematch</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yara_decoder1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>yara_decoder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regex</span><span class="token punctuation">></span></span>wazuh-yara: (\S+) - Scan result: (\S+) (\S+)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regex</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>order</span><span class="token punctuation">></span></span>log_type, yara_rule, yara_scanned_file<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>order</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">></span></span></code></pre>

<p>3）在Wazuh服务器<code>/var/ossec/etc/ossec.conf</code>配置文件中添加如下配置。使主动响应模块配置为在触发规则 100300 和 100301 后触发</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>yara_linux<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executable</span><span class="token punctuation">></span></span>yara.sh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executable</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extra_args</span><span class="token punctuation">></span></span>-yara_path /usr/local/bin -yara_rules /tmp/yara/rules/yara_rules.yar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extra_args</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeout_allowed</span><span class="token punctuation">></span></span>no<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeout_allowed</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>active-response</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>command</span><span class="token punctuation">></span></span>yara_linux<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>command</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>local<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rules_id</span><span class="token punctuation">></span></span>100300,100301<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rules_id</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>active-response</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">></span></span></code></pre>

<p>4）重启 Wazuh 管理器以应用配置更改</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-manager</code></pre>

<p><strong>攻击模拟</strong></p>
<p>1）在受监控端点上创建脚本 <code>/tmp/yara/malware/malware_downloader.sh</code> 以下载恶意软件样本：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># Wazuh - Malware Downloader for test purposes</span>
<span class="token comment"># Copyright (C) 2015-2022, Wazuh Inc.</span>
<span class="token comment">#</span>
<span class="token comment"># This program is free software; you can redistribute it</span>
<span class="token comment"># and/or modify it under the terms of the GNU General Public</span>
<span class="token comment"># License (version 2) as published by the FSF - Free Software</span>
<span class="token comment"># Foundation.</span>

<span class="token keyword">function</span> <span class="token function-name function">fetch_sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

  <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XGET</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token parameter variable">-o</span> <span class="token string">"<span class="token variable">$2</span>"</span>

<span class="token punctuation">&#125;</span>

<span class="token builtin class-name">echo</span> <span class="token string">"WARNING: Downloading Malware samples, please use this script with  caution."</span>
<span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"  Do you want to continue? (y/n)"</span> <span class="token parameter variable">-n</span> <span class="token number">1</span> <span class="token parameter variable">-r</span> ANSWER
<span class="token builtin class-name">echo</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$ANSWER</span> <span class="token operator">=~</span> ^<span class="token punctuation">[</span>Yy<span class="token punctuation">]</span>$ <span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span>
    <span class="token comment"># Mirai</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"# Mirai: https://en.wikipedia.org/wiki/Mirai_(malware)"</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Downloading malware sample..."</span>
    fetch_sample <span class="token string">"https://wazuh-demo.s3-us-west-1.amazonaws.com/mirai"</span> <span class="token string">"/tmp/yara/malware/mirai"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"Done!"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Error while downloading."</span>
    <span class="token builtin class-name">echo</span>

    <span class="token comment"># Xbash</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"# Xbash: https://unit42.paloaltonetworks.com/unit42-xbash-combines-botnet-ransomware-coinmining-worm-targets-linux-windows/"</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Downloading malware sample..."</span>
    fetch_sample <span class="token string">"https://wazuh-demo.s3-us-west-1.amazonaws.com/xbash"</span> <span class="token string">"/tmp/yara/malware/xbash"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"Done!"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Error while downloading."</span>
    <span class="token builtin class-name">echo</span>

    <span class="token comment"># VPNFilter</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"# VPNFilter: https://news.sophos.com/en-us/2018/05/24/vpnfilter-botnet-a-sophoslabs-analysis/"</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Downloading malware sample..."</span>
    fetch_sample <span class="token string">"https://wazuh-demo.s3-us-west-1.amazonaws.com/vpn_filter"</span> <span class="token string">"/tmp/yara/malware/vpn_filter"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"Done!"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Error while downloading."</span>
    <span class="token builtin class-name">echo</span>

    <span class="token comment"># Webshell</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"# WebShell: https://github.com/SecWiki/WebShell-2/blob/master/Php/Worse%20Linux%20Shell.php"</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Downloading malware sample..."</span>
    fetch_sample <span class="token string">"https://wazuh-demo.s3-us-west-1.amazonaws.com/webshell"</span> <span class="token string">"/tmp/yara/malware/webshell"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">"Done!"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Error while downloading."</span>
    <span class="token builtin class-name">echo</span>
<span class="token keyword">fi</span></code></pre>

<p>2）运行 <code>malware_downloader.sh</code> 脚本将恶意软件样本下载到 <code>/tmp/yara/malware</code> 目录：</p>
<pre class="language-none"><code class="language-none">sudo bash &#x2F;tmp&#x2F;yara&#x2F;malware&#x2F;malware_downloader.sh</code></pre>

<h3 id="9-集成-Network-IDS"><a href="#9-集成-Network-IDS" class="headerlink" title="9. 集成 Network IDS"></a>9. 集成 Network IDS</h3><p>Wazuh 与基于网络的入侵检测系统 (NIDS) 集成，通过监控网络流量来增强威胁检测。示例将 Suricata 与 Wazuh 集成。</p>
<p><strong>检测配置</strong></p>
<p>1）在 CentOS 上安装 Suricata</p>
<pre class="language-none"><code class="language-none">yum -y install epel-release yum-plugin-copr
yum copr enable @oisf&#x2F;suricata-6.0
yum -y install suricata</code></pre>

<p>2）下载并提取 Suricata 规则集</p>
<pre class="language-none"><code class="language-none">cd &#x2F;tmp&#x2F; &amp;&amp; curl -LO https:&#x2F;&#x2F;rules.emergingthreats.net&#x2F;open&#x2F;suricata-6.0.8&#x2F;emerging.rules.tar.gz
sudo tar -xvzf emerging.rules.tar.gz &amp;&amp; sudo mv rules&#x2F;*.rules &#x2F;etc&#x2F;suricata&#x2F;rules&#x2F;
sudo chmod 640 &#x2F;etc&#x2F;suricata&#x2F;rules&#x2F;*.rules</code></pre>

<p>3）修改 <code>/etc/suricata/suricata.yaml</code> 文件中的 Suricata 配置并设置以下变量</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">HOME_NET</span><span class="token punctuation">:</span> <span class="token string">"&lt;UBUNTU_IP>"</span>
<span class="token key atrule">EXTERNAL_NET</span><span class="token punctuation">:</span> <span class="token string">"any"</span>

<span class="token key atrule">default-rule-path</span><span class="token punctuation">:</span> /etc/suricata/rules
<span class="token key atrule">rule-files</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token string">"*.rules"</span>

<span class="token comment"># Global stats configuration</span>
<span class="token key atrule">stats</span><span class="token punctuation">:</span>
<span class="token key atrule">enabled</span><span class="token punctuation">:</span> no

<span class="token comment"># Linux high speed capture support</span>
<span class="token key atrule">af-packet</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">interface</span><span class="token punctuation">:</span> eth0</code></pre>

<p>4）重启 Suricata 服务</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart suricata</code></pre>

<p>5）在 Wazuh agent的<code>/var/ossec/etc/ossec.conf</code>文件中添加如下配置。允许 Wazuh agent读取 Suricata 日志文件：</p>
<pre class="language-conf" data-language="conf"><code class="language-conf">&lt;ossec_config&gt;
  &lt;localfile&gt;
    &lt;log_format&gt;syslog&lt;&#x2F;log_format&gt;
    &lt;location&gt;&#x2F;var&#x2F;log&#x2F;suricata&#x2F;eve.json&lt;&#x2F;location&gt;
  &lt;&#x2F;localfile&gt;
&lt;&#x2F;ossec_config&gt;</code></pre>

<p>6）重新启动 Wazuh agent以应用配置更改</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<p><strong>攻击模拟</strong></p>
<p>Wazuh 自动解析来自 <code>/var/log/suricata/eve.json</code> 的数据，并在 Wazuh 仪表板上生成相关警报</p>
<p>从 Wazuh 服务器 Ping 端点 IP 地址</p>
<pre class="language-none"><code class="language-none">ping -c 20 &quot;&lt;Endpoint_IP&gt;&quot;</code></pre>

<p>Suricata 日志 - <code>/var/log/suricata/suricata.log</code></p>
<p>Suricata 配置文件：<code>/etc/sysconfig/suricata</code> 或 <code>/etc/suricata/suricata.yaml</code></p>
<h3 id="10-漏洞扫描与检测"><a href="#10-漏洞扫描与检测" class="headerlink" title="10. 漏洞扫描与检测"></a>10. 漏洞扫描与检测</h3><p>Wazuh 使用漏洞检测器模块来识别端点上运行的应用程序和操作系统中的漏洞，示例展示Wazuh 检测受监控端点中未修补的常见漏洞 (CVE)</p>
<p><strong>检测配置</strong></p>
<p>1）在 Wazuh 服务器上的 <code>/var/ossec/etc/ossec.conf</code> 文件中启用漏洞检测器模块</p>
<pre class="language-conf" data-language="conf"><code class="language-conf">&lt;ossec_config&gt;
  &lt;vulnerability-detector&gt;
    &lt;enabled&gt;yes&lt;&#x2F;enabled&gt;
    &lt;interval&gt;5m&lt;&#x2F;interval&gt;
    &lt;min_full_scan_interval&gt;6h&lt;&#x2F;min_full_scan_interval&gt;
    &lt;run_on_start&gt;yes&lt;&#x2F;run_on_start&gt;

    &lt;!-- Ubuntu OS vulnerabilities --&gt;
    &lt;provider name&#x3D;&quot;canonical&quot;&gt;
    &lt;enabled&gt;yes&lt;&#x2F;enabled&gt;
    &lt;os&gt;trusty&lt;&#x2F;os&gt;
    &lt;os&gt;xenial&lt;&#x2F;os&gt;
    &lt;os&gt;bionic&lt;&#x2F;os&gt;
    &lt;os&gt;focal&lt;&#x2F;os&gt;
    &lt;os&gt;jammy&lt;&#x2F;os&gt;
    &lt;update_interval&gt;1h&lt;&#x2F;update_interval&gt;
    &lt;&#x2F;provider&gt;

    &lt;!-- Debian OS vulnerabilities --&gt;
    &lt;provider name&#x3D;&quot;debian&quot;&gt;
    &lt;enabled&gt;yes&lt;&#x2F;enabled&gt;
    &lt;os&gt;stretch&lt;&#x2F;os&gt;
    &lt;os&gt;buster&lt;&#x2F;os&gt;
    &lt;os&gt;bullseye&lt;&#x2F;os&gt;
    &lt;update_interval&gt;1h&lt;&#x2F;update_interval&gt;
    &lt;&#x2F;provider&gt;

    &lt;!-- RedHat OS vulnerabilities --&gt;
    &lt;provider name&#x3D;&quot;redhat&quot;&gt;
    &lt;enabled&gt;yes&lt;&#x2F;enabled&gt;
    &lt;os&gt;5&lt;&#x2F;os&gt;
    &lt;os&gt;6&lt;&#x2F;os&gt;
    &lt;os&gt;7&lt;&#x2F;os&gt;
    &lt;os&gt;8&lt;&#x2F;os&gt;
    &lt;os allow&#x3D;&quot;CentOS Linux-8&quot;&gt;8&lt;&#x2F;os&gt;
    &lt;os&gt;9&lt;&#x2F;os&gt;
    &lt;update_interval&gt;1h&lt;&#x2F;update_interval&gt;
    &lt;&#x2F;provider&gt;

    &lt;!-- Windows OS vulnerabilities --&gt;
    &lt;provider name&#x3D;&quot;msu&quot;&gt;
    &lt;enabled&gt;yes&lt;&#x2F;enabled&gt;
    &lt;update_interval&gt;1h&lt;&#x2F;update_interval&gt;
    &lt;&#x2F;provider&gt;

    &lt;!-- Aggregate vulnerabilities --&gt;
    &lt;provider name&#x3D;&quot;nvd&quot;&gt;
    &lt;enabled&gt;yes&lt;&#x2F;enabled&gt;
    &lt;update_from_year&gt;2019&lt;&#x2F;update_from_year&gt;
    &lt;update_interval&gt;1h&lt;&#x2F;update_interval&gt;
    &lt;&#x2F;provider&gt;
  &lt;&#x2F;vulnerability-detector&gt;
&lt;&#x2F;ossec_config&gt;</code></pre>

<p>2）重启 Wazuh 管理器以应用配置更改</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-manager</code></pre>

<p><strong>测试配置</strong></p>
<p>Wazuh 服务器在 <code>/var/ossec/queue/vulnerabilities/cve.db</code> 中创建一个 CVE 数据库，定期对每个受监控端点上的应用程序和操作系统执行漏洞检测扫描</p>
<h3 id="11-阻断已知的恶意行为"><a href="#11-阻断已知的恶意行为" class="headerlink" title="11. 阻断已知的恶意行为"></a>11. 阻断已知的恶意行为</h3><p>使用 Wazuh CDB 列表和主动响应功能，演示如何阻止恶意 IP 地址访问 Web 服务器上的 Web 资源</p>
<p><strong>端点配置</strong></p>
<p>1）搭建web服务器</p>
<pre class="language-none"><code class="language-none">sudo yum -y install apache2

sudo systemctl start apache2

curl http:&#x2F;&#x2F;&lt;LINUX_IP&gt;</code></pre>

<p>2）将以下内容添加到 <code>/var/ossec/etc/ossec.conf</code> 文件以配置 Wazuh agent并监控 Apache 访问日志</p>
<pre class="language-conf" data-language="conf"><code class="language-conf">&lt;localfile&gt;
  &lt;log_format&gt;syslog&lt;&#x2F;log_format&gt;
  &lt;location&gt;&#x2F;var&#x2F;log&#x2F;apache2&#x2F;access.log&lt;&#x2F;location&gt;
&lt;&#x2F;localfile&gt;</code></pre>

<p>3）重新启动 Wazuh agent以应用配置更改</p>
<pre class="language-none"><code class="language-none">sudo systemctl restart wazuh-agent</code></pre>

<p><strong>server配置</strong></p>
<p>在 Wazuh 服务器上执行以下步骤，将 RHEL 端点的 IP 地址添加到 CDB 列表中，然后配置规则和主动响应</p>
<p>1）下载实用程序并配置 CDB 列表</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F; 下载 Alienvault IP 信誉数据库

sudo wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;firehol&#x2F;blocklist-ipsets&#x2F;master&#x2F;alienvault_reputation.ipset -O &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;lists&#x2F;alienvault_reputation.ipset

&#x2F;&#x2F; 将攻击者端点的 IP 地址附加到 IP 信誉数据库。将 &lt;ATTACKER_IP&gt; 替换为以下命令中的 RHEL IP 地址

sudo echo &quot;&lt;ATTACKER_IP&gt;&quot; &gt;&gt; &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;lists&#x2F;alienvault_reputation.ipset

&#x2F;&#x2F; 下载脚本以将 .ipset 格式转换为 .cdb 列表格式

sudo wget https:&#x2F;&#x2F;wazuh.com&#x2F;resources&#x2F;iplist-to-cdblist.py -O &#x2F;tmp&#x2F;iplist-to-cdblist.py

&#x2F;&#x2F; 使用之前下载的脚本将 alienvault_reputation.ipset 文件转换为 .cdb 格式

sudo &#x2F;var&#x2F;ossec&#x2F;framework&#x2F;python&#x2F;bin&#x2F;python3 &#x2F;tmp&#x2F;iplist-to-cdblist.py &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;lists&#x2F;alienvault_reputation.ipset &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;lists&#x2F;blacklist-alienvault

&#x2F;&#x2F; 为生成的文件分配正确的权限和所有权

sudo chown wazuh:wazuh &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;lists&#x2F;blacklist-alienvault</code></pre>

<p>2）配置主动响应模块拦截恶意IP地址</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F; 在 Wazuh 服务器 &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;rules&#x2F;local_rules.xml 自定义规则集文件中执行此操作

&lt;group name&#x3D;&quot;attack,&quot;&gt;
  &lt;rule id&#x3D;&quot;100100&quot; level&#x3D;&quot;10&quot;&gt;
    &lt;if_group&gt;web|attack|attacks&lt;&#x2F;if_group&gt;
    &lt;list field&#x3D;&quot;srcip&quot; lookup&#x3D;&quot;address_match_key&quot;&gt;etc&#x2F;lists&#x2F;blacklist-alienvault&lt;&#x2F;list&gt;
    &lt;description&gt;IP address found in AlienVault reputation database.&lt;&#x2F;description&gt;
  &lt;&#x2F;rule&gt;
&lt;&#x2F;group&gt;

&#x2F;&#x2F; 编辑 Wazuh 服务器 &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;ossec.conf 配置文件，将 etc&#x2F;lists&#x2F;blacklist-alienvault 列表添加到 &lt;ruleset&gt; 部分

&lt;ossec_config&gt;
  &lt;ruleset&gt;
    &lt;!-- Default ruleset --&gt;
    &lt;decoder_dir&gt;ruleset&#x2F;decoders&lt;&#x2F;decoder_dir&gt;
    &lt;rule_dir&gt;ruleset&#x2F;rules&lt;&#x2F;rule_dir&gt;
    &lt;rule_exclude&gt;0215-policy_rules.xml&lt;&#x2F;rule_exclude&gt;
    &lt;list&gt;etc&#x2F;lists&#x2F;audit-keys&lt;&#x2F;list&gt;
    &lt;list&gt;etc&#x2F;lists&#x2F;blacklist-alienvault&lt;&#x2F;list&gt;

    &lt;!-- User-defined ruleset --&gt;
    &lt;decoder_dir&gt;etc&#x2F;decoders&lt;&#x2F;decoder_dir&gt;
    &lt;rule_dir&gt;etc&#x2F;rules&lt;&#x2F;rule_dir&gt;
  &lt;&#x2F;ruleset&gt;
&lt;&#x2F;ossec_config&gt;

&#x2F;&#x2F; 将主动响应块添加到 Wazuh 服务器 &#x2F;var&#x2F;ossec&#x2F;etc&#x2F;ossec.conf 文件

&lt;ossec_config&gt;
  &lt;active-response&gt;
    &lt;command&gt;firewall-drop&lt;&#x2F;command&gt;
    &lt;location&gt;local&lt;&#x2F;location&gt;
    &lt;rules_id&gt;100100&lt;&#x2F;rules_id&gt;
    &lt;timeout&gt;60&lt;&#x2F;timeout&gt;
  &lt;&#x2F;active-response&gt;
&lt;&#x2F;ossec_config&gt;

&#x2F;&#x2F; 重新启动 Wazuh 管理器以应用更改

sudo systemctl restart wazuh-manager</code></pre>

<p><strong>攻击模拟</strong></p>
<p>使用相应的 IP 地址从 RHEL 端点访问 Web 服务器，将 <code>&lt;WEBSERVER_IP&gt;</code> 替换为适当的值并从攻击者端点执行以下命令</p>
<pre class="language-none"><code class="language-none">curl http:&#x2F;&#x2F;&lt;WEBSERVER_IP&gt;</code></pre>

<p>攻击者端点第一次连接到受害者的 Web 服务器。首次连接后，Wazuh 主动响应模块会暂时阻止与 Web 服务器的任何后续连接 60 秒。</p>
<h2 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF Reference"></a>0xFF Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/wazuh/wazuh">https://github.com/wazuh/wazuh</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ossec/ossec-hids">https://github.com/ossec/ossec-hids</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/OpenSCAP/openscap">https://github.com/OpenSCAP/openscap</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/osquery/osquery">https://github.com/osquery/osquery</a></li>
<li><a target="_blank" rel="noopener" href="https://documentation.wazuh.com/current/index.html">https://documentation.wazuh.com/current/index.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/wazuh/wazuh/tree/4.3/ruleset">https://github.com/wazuh/wazuh/tree/4.3/ruleset</a></li>
<li><a target="_blank" rel="noopener" href="http://www.wazuh.com/resources/Wazuh_Ruleset.pdf">http://www.wazuh.com/resources/Wazuh_Ruleset.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://wazuh.com/blog/">https://wazuh.com/blog/</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Intrusion-Detection/" rel="tag" <i class="fa fa-tag"></i> Intrusion Detection</a>
              <a href="/tags/HIDS/" rel="tag" <i class="fa fa-tag"></i> HIDS</a>
              <a href="/tags/Wazuh/" rel="tag" <i class="fa fa-tag"></i> Wazuh</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
            </div>
            <div class="post-nav-item">
                <a href="/posts/88001/" rel="next" title="Windows持久化技术研究">
                  Windows持久化技术研究 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">L0n9w4y</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
